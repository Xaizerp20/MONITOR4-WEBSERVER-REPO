(window.webpackJsonp=window.webpackJsonp||[]).push([[41],{"./bundles/sf-image-editor.js":function(e,t,o){"use strict";o.r(t);o("./modules/sf-image-editor.js")},"./modules/sf-image-editor.js":function(e,t){function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}window.sfBlazor=window.sfBlazor||{},window.sfBlazor.ImageEditor=function(){"use strict";var e,t,i,a,r,n,s,l,p,h=function(){function e(e){this.croppedDegree=0,this.cropDestPoints={startX:0,startY:0,width:0,height:0},this.tempFlipPanPoint={x:0,y:0},this.isPreventScaling=!1,this.parent=e,this.addEventListener()}return e.prototype.destroy=function(){this.parent.isDestroyed||this.removeEventListener()},e.prototype.addEventListener=function(){this.parent.on("crop",this.cropping,this),this.parent.on("destroyed",this.destroy,this)},e.prototype.removeEventListener=function(){this.parent.off("crop",this.crop),this.parent.off("destroyed",this.destroy)},e.prototype.cropping=function(e){switch(this.updateCropPvtVar(),e.prop){case"cropImg":this.cropImg(e.value.isRotateCrop);break;case"cropCircle":this.cropCircle(e.value.context,e.value.isSave,e.value.isFlip);break;case"setCurrSelPoints":this.setCurrSelPoints(e.value.isSetDimension);break;case"updateRotatePan":this.updateRotatePan();break;case"crop":this.crop(e.value.obj);break;case"calcRatio":this.calcRatio(e.value.obj);break;case"isObjInImage":this.isObjInImage(e.value.obj,e.value.object);break;case"getCurrFlipState":this.getCurrFlipState(e.value.panObj);break;case"setPreviousCropCurrentObj":this.prevCropCurrObj=e.value.obj;break;case"setCropDestPoints":this.cropDestPoints=e.value.point;break;case"getTempFlipPanPoint":e.value.obj.point=this.tempFlipPanPoint;break;case"setTempFlipPanPoint":sf.base.isNullOrUndefined(e.value.isAdd)?this.tempFlipPanPoint=e.value.point:(this.tempFlipPanPoint.x+=e.value.point.x,this.tempFlipPanPoint.y+=e.value.point.y);break;case"getPreventScaling":e.value.obj.bool=this.isPreventScaling;break;case"reset":this.reset()}},e.prototype.getModuleName=function(){return"crop"},e.prototype.updateCropPvtVar=function(){var e=this.parent;e.lowerCanvas&&(this.lowerContext=e.lowerCanvas.getContext("2d")),e.upperCanvas&&(this.upperContext=e.upperCanvas.getContext("2d"))},e.prototype.reset=function(){this.prevCropCurrObj=null,this.croppedDegree=0,this.cropDestPoints={startX:0,startY:0,width:0,height:0},this.tempFlipPanPoint={x:0,y:0},this.isPreventScaling=!1},e.prototype.cropImg=function(e){var t=this.parent,o=sf.base.isNullOrUndefined(e),i=t.activeObj.activePoint;if(t.notify("draw",{prop:"setImageEdited",onPropertyChange:!1}),o&&(this.croppedDegree=t.transform.degree),o&&0!==t.transform.degree){this.updateCropObj();var a={startX:t.img.destLeft,startY:t.img.destTop,width:t.img.destWidth,height:t.img.destHeight};t.notify("transform",{prop:"setCurrDestinationPoint",onPropertyChange:!1,value:{point:a}}),this.rotateCrop()}else if(o&&""!==t.transform.currFlipState){this.updateCropObj();a={startX:t.img.destLeft,startY:t.img.destTop,width:t.img.destWidth,height:t.img.destHeight};t.notify("transform",{prop:"setCurrDestinationPoint",onPropertyChange:!1,value:{point:a}}),this.flipCrop()}else{t.notify("draw",{prop:"setTempZoomFactor",onPropertyChange:!1,value:{tempZoomFactor:t.transform.zoomFactor}});var r=this.calcRatio();if(o||!e){this.updateCropObj(),t.notify("draw",{prop:"resetPanPoints",onPropertyChange:!1}),t.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1});a={startX:t.img.destLeft,startY:t.img.destTop,width:t.img.destWidth,height:t.img.destHeight};t.notify("transform",{prop:"setCurrDestinationPoint",onPropertyChange:!1,value:{point:a}}),t.currSelectionPoint=sf.base.extend({},t.activeObj,{},!0),this.cropDestPoints={startX:t.img.destLeft,startY:t.img.destTop,width:t.img.destWidth,height:t.img.destHeight}}var n={width:0,height:0};t.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:i.width*r.width,height:i.height*r.height,obj:n}});var s=n;this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),t.img.srcLeft=i.startX*r.width-t.img.destLeft*r.width,t.img.srcTop=i.startY*r.height-t.img.destTop*r.height,t.img.srcWidth=i.width*r.width,t.img.srcHeight=i.height*r.height,t.img.destLeft=(t.lowerCanvas.clientWidth-s.width)/2,t.img.destTop=(t.lowerCanvas.clientHeight-s.height)/2,t.img.destWidth=s.width,t.img.destHeight=s.height;var l=this.lowerContext.filter;t.notify("finetune",{prop:"updateBrightFilter",onPropertyChange:!1}),this.lowerContext.drawImage(t.baseImg,t.img.srcLeft,t.img.srcTop,t.img.srcWidth,t.img.srcHeight,t.img.destLeft,t.img.destTop,t.img.destWidth,t.img.destHeight),this.lowerContext.filter="none";var p=sf.base.extend({},t.activeObj,{},!0);this.cropObjColl(),t.notify("shape",{prop:"zoomObjColl",onPropertyChange:!1,value:{isPreventApply:null}});for(var h=0,c=t.objColl.length;h<c;h++)this.isObjInImage(t.objColl[h])&&(t.notify("shape",{prop:"apply",onPropertyChange:!1,value:{shape:t.objColl[h].shape,obj:t.objColl[h],canvas:null}}),t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}));t.activeObj=p,this.cropFreehandDrawColl(),t.notify("freehand-draw",{prop:"zoomFHDColl",onPropertyChange:!1,value:{isPreventApply:null}}),t.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),t.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),"crop-circle"===t.currSelectionPoint.shape?this.cropCircle(this.lowerContext):t.isCircleCrop=!1,this.lowerContext.filter=l,t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),t.currObjType.isCustomCrop=!1,t.pan(!1),t.transform.defaultZoomFactor=0}},e.prototype.updateCropObj=function(){this.parent.afterCropActions=[];var e={currObj:{}};this.parent.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:e}});var t=e.currObj;this.parent.cropObj=sf.base.extend({},t,{},!0)},e.prototype.rotateCrop=function(){var e=this.parent,t=e.activeObj.shape||"",o=e.transform.degree;e.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),e.currSelectionPoint=sf.base.extend({},e.activeObj,{},!0),e.objColl.push(e.activeObj),e.activeObj=sf.base.extend({},e.objColl[e.objColl.length-1],{},!0),this.lowerContext.setTransform(1,0,0,1,0,0),e.notify("draw",{prop:"setClientTransDim",onPropertyChange:!1,value:{isPreventDimension:null}}),this.lowerContext.clearRect(0,0,e.lowerCanvas.width,e.lowerCanvas.height),e.transform.degree=0;var i=this.lowerContext.filter;e.notify("finetune",{prop:"updateBrightFilter",onPropertyChange:!1}),this.lowerContext.drawImage(e.baseImg,e.img.srcLeft,e.img.srcTop,e.img.srcWidth,e.img.srcHeight,e.img.destLeft,e.img.destTop,e.img.destWidth,e.img.destHeight),this.lowerContext.filter=i;var a=0;90===o||-270===o?a=3:180===o||-180===o?a=2:270!==o&&-90!==o||(a=1);for(var r=0;r<a;r++)e.notify("shape",{prop:"rotateObjColl",onPropertyChange:!1}),e.notify("freehand-draw",{prop:"rotateFhdColl",onPropertyChange:!1});var n=sf.base.extend({},e.objColl[e.objColl.length-1],{},!0);if(""!==e.transform.currFlipState){r=0;for(var s=e.objColl.length;r<s;r++)e.objColl[r].shapeFlip="";for(r=0;r<e.freehandCounter;r++)e.pointColl[r].shapeFlip="";e.transform.degree=o;var l=this.getCurrCropState("initial");e.transform.degree=0,e.notify("shape",{prop:"redrawObj",onPropertyChange:!1,value:{degree:l}}),e.notify("freehand-draw",{prop:"flipFHDColl",onPropertyChange:!1,value:{value:l}})}e.notify("shape",{prop:"zoomObjColl",onPropertyChange:!1,value:{isPreventApply:null}}),e.notify("freehand-draw",{prop:"zoomFHDColl",onPropertyChange:!1,value:{isPreventApply:null}}),n=sf.base.extend({},e.objColl[e.objColl.length-1],{},!0),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:n}}),e.objColl.pop(),e.transform.degree=0,this.cropImg(!0),e.notify("transform",{prop:"setReverseRotate",onPropertyChange:!1,value:{bool:!0}}),this.lowerContext.setTransform(1,0,0,1,0,0),e.transform.degree=o,e.notify("draw",{prop:"setDestPoints",onPropertyChange:!1}),e.notify("draw",{prop:"currTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,context:null,isPreventCircleCrop:null}}),e.notify("finetune",{prop:"updateBrightFilter",onPropertyChange:!1}),this.lowerContext.drawImage(e.baseImg,e.img.srcLeft,e.img.srcTop,e.img.srcWidth,e.img.srcHeight,e.img.destLeft,e.img.destTop,e.img.destWidth,e.img.destHeight),this.lowerContext.filter=i,e.notify("draw",{prop:"currTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,context:null,isPreventCircleCrop:null}}),a=0,90===o||-270===o?a=1:180===o||-180===o?a=2:270!==o&&-90!==o||(a=3);for(r=0;r<a;r++)e.notify("shape",{prop:"rotateObjColl",onPropertyChange:!1}),e.notify("freehand-draw",{prop:"rotateFhdColl",onPropertyChange:!1});if(""!==this.getCurrFlipState()){for(r=0,s=e.objColl.length;r<s;r++)e.objColl[r].shapeFlip="";for(r=0;r<e.freehandCounter;r++)e.pointColl[r].shapeFlip="";l=this.getCurrCropState("reverse");e.notify("shape",{prop:"redrawObj",onPropertyChange:!1,value:{degree:l}}),e.notify("freehand-draw",{prop:"flipFHDColl",onPropertyChange:!1,value:{value:l}})}e.notify("transform",{prop:"setReverseRotate",onPropertyChange:!1,value:{bool:!1}}),this.lowerContext.filter="none";for(r=0,s=e.objColl.length;r<s;r++)this.isObjInImage(e.objColl[r])&&(e.notify("shape",{prop:"apply",onPropertyChange:!1,value:{shape:e.objColl[r].shape,obj:e.objColl[r],canvas:null}}),e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}));e.notify("freehand-draw",{prop:"zoomFHDColl",onPropertyChange:!1,value:{isPreventApply:null}}),this.lowerContext.filter=i,e.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),e.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),"crop-circle"===t&&this.cropCircle(this.lowerContext),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.notify("draw",{prop:"resetPanPoints",onPropertyChange:!1})},e.prototype.flipCrop=function(){var e=this.parent;e.notify("transform",{prop:"setReverseFlip",onPropertyChange:!1,value:{isReverseFlip:!0}}),e.panPoint.totalPannedPoint.x+=this.tempFlipPanPoint.x,e.panPoint.totalPannedPoint.y+=this.tempFlipPanPoint.y;var t=e.transform.currFlipState,o={flipColl:null};e.notify("transform",{prop:"getFlipColl",onPropertyChange:!1,value:{obj:o}});var i=o.flipColl;if(e.notify("transform",{prop:"setFlipColl",onPropertyChange:!1,value:{flipColl:[]}}),e.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),e.objColl.push(e.activeObj),e.transform.zoomFactor>0){for(var a=e.transform.zoomFactor,r=e.isUndoRedo,n=0;n<10*a;n++)e.isUndoRedo=!0,e.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.1,zoomPoint:null}});e.isUndoRedo=r,e.notify("draw",{prop:"resetPanPoints",onPropertyChange:!1})}e.currSelectionPoint=sf.base.extend({},e.objColl[e.objColl.length-1],{},!0),this.lowerContext.clearRect(0,0,e.lowerCanvas.width,e.lowerCanvas.height),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height);var s=this.lowerContext.filter;e.notify("finetune",{prop:"updateBrightFilter",onPropertyChange:!1}),this.lowerContext.drawImage(e.baseImg,e.img.srcLeft,e.img.srcTop,e.img.srcWidth,e.img.srcHeight,e.img.destLeft,e.img.destTop,e.img.destWidth,e.img.destHeight);n=0;for(var l=e.objColl.length;n<l;n++)e.objColl[n].shapeFlip="";for(n=0;n<e.freehandCounter;n++)e.pointColl[n].shapeFlip="";e.notify("shape",{prop:"redrawObj",onPropertyChange:!1,value:{degree:this.getCurrFlipState()}}),e.notify("freehand-draw",{prop:"flipFHDColl",onPropertyChange:!1,value:{value:this.getCurrFlipState()}}),e.activeObj=sf.base.extend({},e.objColl[e.objColl.length-1],{},!0),e.objColl.pop(),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),this.cropImg(!0),e.notify("transform",{prop:"setReverseRotate",onPropertyChange:!1,value:{bool:!0}}),this.lowerContext.setTransform(1,0,0,1,0,0),e.notify("draw",{prop:"setDestPoints",onPropertyChange:!1}),e.notify("draw",{prop:"currTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,context:null,isPreventCircleCrop:null}}),e.notify("finetune",{prop:"updateBrightFilter",onPropertyChange:!1}),this.lowerContext.drawImage(e.baseImg,e.img.srcLeft,e.img.srcTop,e.img.srcWidth,e.img.srcHeight,e.img.destLeft,e.img.destTop,e.img.destWidth,e.img.destHeight),this.lowerContext.filter=s,e.notify("draw",{prop:"setRotateZoom",onPropertyChange:!1,value:{isRotateZoom:!1}}),e.notify("draw",{prop:"currTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,context:null,isPreventCircleCrop:null}}),e.transform.currFlipState=t,e.notify("transform",{prop:"setFlipColl",onPropertyChange:!1,value:{flipColl:i}}),this.lowerContext.filter="none";for(n=0,l=e.objColl.length;n<l;n++)e.objColl[n].shapeFlip="";for(n=0;n<e.freehandCounter;n++)e.pointColl[n].shapeFlip="";e.notify("shape",{prop:"redrawObj",onPropertyChange:!1,value:{degree:this.getCurrFlipState()}}),e.notify("freehand-draw",{prop:"flipFHDColl",onPropertyChange:!1,value:{value:this.getCurrFlipState()}}),e.notify("shape",{prop:"zoomObjColl",onPropertyChange:!1,value:{isPreventApply:null}}),e.notify("freehand-draw",{prop:"zoomFHDColl",onPropertyChange:!1,value:{isPreventApply:null}}),this.lowerContext.filter=s,(e.currSelectionPoint&&"crop-circle"===e.currSelectionPoint.shape||e.isCircleCrop)&&this.cropCircle(this.lowerContext),e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),e.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),e.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.notify("transform",{prop:"setReverseFlip",onPropertyChange:!1,value:{isReverseFlip:!1}}),e.notify("draw",{prop:"resetPanPoints",onPropertyChange:!1}),this.tempFlipPanPoint={x:0,y:0}},e.prototype.cropObjColl=function(){var e,t,o,i=this.parent;if(i.objColl.length>0)for(var a=0,r=i.objColl.length;a<r;a++){e=i.objColl[a].activePoint,t=i.activeObj.activePoint,o=i.objColl[a].shape,i.objColl[a].imageRatio={startX:(e.startX-t.startX)/t.width,startY:(e.startY-t.startY)/t.height,endX:(e.endX-t.startX)/t.width,endY:(e.endY-t.startY)/t.height,width:t.width/e.width,height:t.height/e.height};var n=void 0,s=void 0;switch(o){case"text":s=0===(n=0===i.objColl[a].shapeDegree?this.parent.transform.degree:this.parent.transform.degree-i.objColl[a].shapeDegree)||180===Math.abs(n)?e.width:e.height,i.objColl[a].textSettings.fontRatio=s/i.objColl[a].textSettings.fontSize;break;case"line":case"arrow":this.cropPointCollection(a),"arrow"===o&&i.notify("shape",{prop:"updateArrowRatio",onPropertyChange:!1,value:{obj:i.objColl[a]}});break;case"path":this.cropPointCollection(a)}}},e.prototype.cropPointCollection=function(e){var t,o,i,a,r=this.parent,n=r.objColl[e].shape,s=r.activeObj.activePoint;"path"===n?(t=s.startX,o=s.startY,i=s.width,a=s.height):(t=r.img.destLeft,o=r.img.destTop,i=r.img.destWidth,a=r.img.destHeight);for(var l=r.objColl[e],p=0,h=l.pointColl.length;p<h;p++)l.pointColl[p].ratioX=(l.pointColl[p].x-t)/i,l.pointColl[p].ratioY=(l.pointColl[p].y-o)/a},e.prototype.cropFreehandDrawColl=function(){for(var e=this.parent,t=0;t<e.freehandCounter;t++){e.points=sf.base.extend([],e.pointColl[t].points,[]),e.notify("freehand-draw",{prop:"setPointCounter",onPropertyChange:!1,value:{value:0}});for(var o=e.points.length,i=0;i<o;i++)e.points[i].ratioX=(e.points[i].x-e.activeObj.activePoint.startX)/e.activeObj.activePoint.width,e.points[i].ratioY=(e.points[i].y-e.activeObj.activePoint.startY)/e.activeObj.activePoint.height}e.notify("freehand-draw",{prop:"updateCropPtsForSel",onPropertyChange:!1})},e.prototype.setCurrSelPoints=function(e){var t=this.parent,o=this.cropDestPoints;if(t.img.srcLeft=0,t.img.srcTop=0,t.img.srcWidth=t.baseImg.width,t.img.srcHeight=t.baseImg.height,t.img.destLeft=o.startX,t.img.destTop=o.startY,t.img.destWidth=o.width,t.img.destHeight=o.height,this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),e&&t.notify("draw",{prop:"setDestPoints",onPropertyChange:!1}),t.notify("draw",{prop:"currTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,context:null,isPreventCircleCrop:null}}),0===this.croppedDegree&&0===t.transform.degree&&t.currSelectionPoint&&"crop-circle"!==t.currSelectionPoint.shape&&"crop-square"!==t.currSelectionPoint.shape&&(t.img.destLeft=o.startX,t.img.destTop=o.startY,t.img.destWidth=o.width,t.img.destHeight=o.height),0===t.transform.degree&&(t.img.destLeft+=t.panPoint.totalPannedInternalPoint.x,t.img.destTop+=t.panPoint.totalPannedInternalPoint.y),t.notify("filter",{prop:"updateBrightFilter",onPropertyChange:!1}),this.lowerContext.drawImage(t.baseImg,t.img.srcLeft,t.img.srcTop,t.img.srcWidth,t.img.srcHeight,t.img.destLeft,t.img.destTop,t.img.destWidth,t.img.destHeight),t.notify("draw",{prop:"currTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,context:null,isPreventCircleCrop:!0}}),t.cropObj.activeObj.shape){var i={startX:t.img.destLeft,startY:t.img.destTop,width:t.img.destWidth,height:t.img.destHeight};t.currSelectionPoint&&t.currSelectionPoint.activePoint&&(t.img.destLeft=t.currSelectionPoint.activePoint.startX,t.img.destTop=t.currSelectionPoint.activePoint.startY,t.img.destWidth=t.currSelectionPoint.activePoint.width,t.img.destHeight=t.currSelectionPoint.activePoint.height),t.notify("shape",{prop:"zoomObjColl",onPropertyChange:!1,value:{isPreventApply:null}}),t.notify("freehand-draw",{prop:"zoomFHDColl",onPropertyChange:!1,value:{isPreventApply:null}}),t.img.destLeft=i.startX,t.img.destTop=i.startY,t.img.destWidth=i.width,t.img.destHeight=i.height,t.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1});var a=sf.base.extend([],t.objColl,null,!0),r=sf.base.extend([],t.pointColl,null,!0);t.objColl=[],t.pointColl=[],t.freehandCounter=0;var n={selPointColl:null};t.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:n}});var s=n.selPointColl;t.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),t.cropObj.filter=this.lowerContext.filter,t.notify("draw",{prop:"setCurrentObj",onPropertyChange:!1,value:{obj:null}});var l=sf.base.extend({},t.activeObj,null,!0);t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),t.objColl=a,t.pointColl=r,t.freehandCounter=t.pointColl.length,t.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:s}}}),t.notify("shape",{prop:"iterateObjColl",onPropertyChange:!1}),t.notify("freehand-draw",{prop:"freehandRedraw",onPropertyChange:!1,value:{context:this.lowerContext,points:null}}),t.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1}),t.notify("shape",{prop:"zoomObjColl",onPropertyChange:!1,value:{isPreventApply:null}}),t.notify("freehand-draw",{prop:"zoomFHDColl",onPropertyChange:!1,value:{isPreventApply:null}}),t.currSelectionPoint=null,0===t.transform.degree&&t.notify("transform",{prop:"drawPannImage",onPropertyChange:!1,value:{point:{x:0,y:0}}}),t.activeObj=l,t.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),t.notify("transform",{prop:"setTempPanMove",onPropertyChange:!1,value:{point:null}})}else{var p=this.lowerContext.filter;this.lowerContext.filter="none",t.notify("shape",{prop:"iterateObjColl",onPropertyChange:!1}),t.notify("freehand-draw",{prop:"freehandRedraw",onPropertyChange:!1,value:{context:this.lowerContext,points:null}}),this.lowerContext.filter=p,t.currSelectionPoint=null}},e.prototype.cropCircle=function(e,t,o){var i=this.parent;o&&""!==i.transform.currFlipState&&i.notify("draw",{prop:"setTransform",onPropertyChange:!1,value:{context:e,value:i.transform.currFlipState,isReverse:null}}),e.globalCompositeOperation="destination-in",e.beginPath();var a=sf.base.isNullOrUndefined(t)?i.img.destLeft+i.img.destWidth/2:i.img.destWidth/2,r=sf.base.isNullOrUndefined(t)?i.img.destTop+i.img.destHeight/2:i.img.destHeight/2,n=i.img.destWidth/2;e.arc(a,r,n,0,2*Math.PI),e.closePath(),e.fill(),e.restore(),e.globalCompositeOperation="source-over",i.currObjType.isActiveObj=i.isCircleCrop=!0,o&&""!==i.transform.currFlipState&&i.notify("draw",{prop:"setTransform",onPropertyChange:!1,value:{context:e,value:i.transform.currFlipState,isReverse:null}})},e.prototype.getCurrCropState=function(e,t){var o=this.parent,i="",a=[],r={flipColl:null};if(o.notify("transform",{prop:"getFlipColl",onPropertyChange:!1,value:{obj:r}}),"initial"===e)if(180===Math.abs(o.transform.degree))i=r.flipColl.length>1?this.getCurrFlipState():o.transform.currFlipState;else{for(var n=0,s=o.rotateFlipColl.length;n<s;n++)"number"==typeof o.rotateFlipColl[n]?a.push("number"):"string"==typeof o.rotateFlipColl[n]&&a.push("string");a.length>1&&"string"===a[a.length-1]&&"number"===a[a.length-2]?"horizontal"===o.transform.currFlipState?i="vertical":"vertical"===o.transform.currFlipState&&(i="horizontal"):a.length>1&&"number"===a[a.length-1]&&"string"===a[a.length-2]&&(i=r.flipColl.length>1?this.getCurrFlipState():o.transform.currFlipState)}else i=this.getCurrFlipState(),!t&&this.isInitialRotate()||-90!==o.transform.degree&&-270!==o.transform.degree||("horizontal"===i?i="vertical":"vertical"===i&&(i="horizontal"));return""===i&&(i=r.flipColl.length>1?this.getCurrFlipState():o.transform.currFlipState),i},e.prototype.isInitialRotate=function(){var e=!1;return this.parent.rotateFlipColl.length>0&&"number"==typeof this.parent.rotateFlipColl[0]&&(e=!0),e},e.prototype.updateRotatePan=function(){var e=this.parent;if(!sf.base.isNullOrUndefined(e.panPoint.currentPannedPoint)){var t="";t=e.rotateFlipColl.length>0&&"number"==typeof e.rotateFlipColl[0]&&e.transform.degree<0?this.getCurrCropState("reverse",!0):this.getCurrFlipState(),e.transform.degree%90==0&&e.transform.degree%180!=0?90===e.transform.degree||-90===e.transform.degree&&("horizontal"===t||"vertical"===t)||-270===e.transform.degree&&(""===t||"verticalHorizontal"===t||"horizontalVertical"===t)?("horizontal"===t||""===t?e.img.destLeft+=e.panPoint.currentPannedPoint.y:e.img.destLeft-=e.panPoint.currentPannedPoint.y,""===t||"vertical"===t?e.img.destTop-=e.panPoint.currentPannedPoint.x:e.img.destTop+=e.panPoint.currentPannedPoint.x):270!==e.transform.degree&&(-270!==e.transform.degree||"horizontal"!==t&&"vertical"!==t)&&(-90!==e.transform.degree||""!==t&&"verticalHorizontal"!==t&&"horizontalVertical"!==t)||(""===t||"horizontal"===t?e.img.destLeft-=e.panPoint.currentPannedPoint.y:e.img.destLeft+=e.panPoint.currentPannedPoint.y,""===t||"vertical"===t?e.img.destTop+=e.panPoint.currentPannedPoint.x:e.img.destTop-=e.panPoint.currentPannedPoint.x):180!==e.transform.degree&&-180!==e.transform.degree||(""===t||"vertical"===t?e.img.destLeft-=e.panPoint.currentPannedPoint.x:e.img.destLeft+=e.panPoint.currentPannedPoint.x,""===t||"horizontal"===t?e.img.destTop-=e.panPoint.currentPannedPoint.y:e.img.destTop+=e.panPoint.currentPannedPoint.y)}},e.prototype.crop=function(e){var t=this,o=this.parent;if(!o.disabled&&o.isImageLoaded){var i={isCropToolbar:o.isCropToolbar};o.currObjType.isUndoAction&&!i.isCropToolbar&&o.notify("undo-redo",{prop:"refreshUrc",value:{bool:null}});var a={cancel:!1,startPoint:{x:o.activeObj.activePoint.startX,y:o.activeObj.activePoint.startY},endPoint:{x:o.activeObj.activePoint.endX,y:o.activeObj.activePoint.endY},preventScaling:!1};!i.isCropToolbar&&sf.base.isBlazor()&&o.events&&!0===o.events.cropping.hasDelegate?o.dotNetRef.invokeMethodAsync("CropEventAsync","OnCrop",a).then((function(o){t.cropEvent(o,e,i)})):(i.isCropToolbar||o.trigger("cropping",a),this.cropEvent(a,e,i))}},e.prototype.cropEvent=function(e,t,o){var i,a=this.parent;if(!e.cancel&&(i=a.activeObj.shape?a.activeObj.shape.split("-"):[],!a.disabled&&a.activeObj.horTopLine&&(a.currObjType.isCustomCrop||i.length>0&&"crop"===i[0]))){t.isCrop=!0;var r=sf.base.extend({},a.cropObj,{},!0),n=sf.base.extend({},this.prevCropCurrObj,{},!0);e.preventScaling?this.isPreventScaling=!0:this.isPreventScaling=!1,this.cropImg(),a.transform.zoomFactor=0,a.zoomSettings.zoomFactor=1,a.setProperties({zoomSettings:{zoomFactor:1}},!0),a.notify("transform",{prop:"setPreviousZoomValue",onPropertyChange:!1,value:{previousZoomValue:a.zoomSettings.zoomFactor}});var s={prevCurrSelectionPoint:this.parent.prevCurrSelectionPoint};n.currSelectionPoint=sf.base.extend({},s.prevCurrSelectionPoint,{},!0),a.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"crop",previousObj:n,previousObjColl:n.objColl,previousPointColl:n.pointColl,previousSelPointColl:n.selPointColl,previousCropObj:r,previousText:null,currentText:null,previousFilter:null,isCircleCrop:a.isCircleCrop}}),o.isCropToolbar||a.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),a.notify("transform",{prop:"setCropDimension",onPropertyChange:!1,value:{width:a.cropObj.destPoints.width,height:a.cropObj.destPoints.height}}),sf.base.isBlazor()||o.isCropToolbar?o.isCropToolbar||this.parent.updateToolbar(this.parent.element,"imageLoaded"):a.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:!1,isCropping:!1,isZooming:null,cType:null}})}},e.prototype.calcRatio=function(e){var t,o,i=this.parent;return 0===i.transform.degree||i.transform.degree%180==0?(t=i.baseImg.width/i.img.destWidth,o=i.baseImg.height/i.img.destHeight):(t=i.baseImg.height/i.img.destWidth,o=i.baseImg.width/i.img.destHeight),e&&(e.width=t,e.height=o),{width:t,height:o}},e.prototype.isObjInImage=function(e,t){var o=this.parent,i=!1,a=e.activePoint.startX,r=e.activePoint.endX,n=e.activePoint.startY,s=e.activePoint.endY;return(a>=o.img.destLeft&&r<=o.img.destLeft+o.img.destWidth||a<=o.img.destLeft&&r>=o.img.destLeft||a<=o.img.destLeft+o.img.destWidth&&r>=o.img.destLeft+o.img.destWidth||n>=o.img.destTop&&s<=o.img.destTop+o.img.destHeight||n<=o.img.destTop&&s>=o.img.destTop||n<=o.img.destTop+o.img.destHeight&&s>=o.img.destTop+o.img.destHeight)&&(i=!0),t&&(t.isInside=i),i},e.prototype.getCurrFlipState=function(e){var t=this.parent,o={panRegion:""},i={collection:t.rotateFlipColl};t.notify("shape",{prop:"alignRotateFlipColl",onPropertyChange:!1,value:{collection:t.rotateFlipColl,isRotateFlipCollection:!0,obj:i}}),t.rotateFlipColl=i.collection;for(var a=0,r=t.rotateFlipColl.length;a<r;a++)t.notify("transform",{prop:"setCurrPanRegion",onPropertyChange:!1,value:{region:o.panRegion,type:t.rotateFlipColl[a],obj:o}});return e&&(e.panRegion=o.panRegion),o.panRegion},e}(),c=function(){function e(e){this.cancelObjColl=[],this.cancelPointColl=[],this.isInitialLoading=!1,this.fileName="",this.isErrorImage=!1,this.isShapeTextInserted=!1,this.isRotateZoom=!1,this.tempStrokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null},this.tempTextSettings={text:"Enter Text",fontFamily:"Arial",fontSize:null,fontRatio:null,bold:!1,italic:!1,underline:!1},this.tempAdjValue="",this.tempFilter="",this.tempUndoRedoStep=0,this.tempFreehandCounter=0,this.tempCurrFhdIndex=0,this.tempZoomFactor=null,this.isCancelAction=!1,this.rotatedFlipCropSel=!1,this.zoomCrop={width:0,height:0},this.isImageEdited=!1,this.isFileChanged=!1,this.isNewPath=!1,this.arrowDimension={bar:{width:10,height:32,ratioX:null,ratioY:null},arrow:{width:24,height:24,ratioX:null,ratioY:null},arrowSolid:{width:32,height:32,ratioX:null,ratioY:null},circle:{width:10,height:10,ratioX:null,ratioY:null},square:{width:20,height:20,ratioX:null,ratioY:null}},this.parent=e,this.addEventListener()}return e.prototype.destroy=function(){this.parent.isDestroyed||this.removeEventListener()},e.prototype.addEventListener=function(){this.parent.on("draw",this.draw,this),this.parent.on("destroyed",this.destroy,this)},e.prototype.removeEventListener=function(){this.parent.off("draw",this.draw),this.parent.off("destroyed",this.destroy)},e.prototype.draw=function(e){switch(this.updatePrivateVariables(),e.prop){case"drawObject":this.drawObject(e.value.canvas,e.value.obj,e.value.isCropRatio,e.value.points,e.value.isPreventDrag,e.value.saveContext,e.value.isPreventSelection);break;case"updateActiveObject":this.updateActiveObject(e.value.actPoint,e.value.obj,e.value.isMouseMove,e.value.x,e.value.y);break;case"clearOuterCanvas":this.clearOuterCanvas(e.value.context);break;case"setDestPoints":this.setDestPoints();break;case"updateCurrTransState":this.updateCurrTransState(e.value.type,e.value.isPreventDestination,e.value.isRotatePan);break;case"currTransState":this.currTransState(e.value.type,e.value.isPreventDestination,e.value.context,e.value.isPreventCircleCrop);break;case"setTransform":this.setTransform(e.value.context,e.value.value,e.value.isReverse);break;case"render-image":this.renderImage(e.value.isMouseWheel);break;case"draw-image-to-canvas":this.drawImgToCanvas(e.value.dimension);break;case"update-canvas":this.updateCanvas();break;case"performCancel":this.performCancel(e.value.isContextualToolbar);break;case"updateFlipPan":this.updateFlipPan(e.value.tempSelectionObj);break;case"select":this.select(e.value.type,e.value.startX,e.value.startY,e.value.width,e.value.height);break;case"callUpdateCurrTransState":this.callUpdateCurrTransState();break;case"resetPanPoints":this.resetPanPoints();break;case"setClientTransDim":this.setClientTransDim(e.value.isPreventDimension);break;case"redrawImgWithObj":this.redrawImgWithObj();break;case"setCurrentObj":this.setCurrentObj(e.value.obj);break;case"performPointZoom":this.performPointZoom(e.value.x,e.value.y,e.value.type);break;case"open":this.open(e.value.data);break;case"isInitialLoading":this.isInitialLoading=e.value.isInitialLoading;break;case"isInitialLoaded":this.getInitialLoaded(e.value.object);break;case"fileSelect":this.fileSelect(e.value.inputElement,e.value.args);break;case"getFileName":e.value.obj.fileName=this.fileName,e.value.obj.fileType=this.fileType;break;case"getErrorImage":e.value.obj.isErrorImage=this.isErrorImage;break;case"getInitialZoomValue":e.value.obj.initialZoomValue=this.initZoomValue;break;case"setShapeTextInsert":this.isShapeTextInserted=e.value.bool;break;case"resetCurrentSelectionPoint":this.currSelPoint=null;break;case"setRotateZoom":this.isRotateZoom=e.value.isRotateZoom;break;case"setTempStrokeSettings":this.tempStrokeSettings=e.value.tempStrokeSettings;break;case"setTempTextSettings":this.tempTextSettings=e.value.tempTextSettings;break;case"setTempAdjustmentValue":this.tempAdjValue=e.value.tempAdjustmentValue;break;case"getTempAdjustmentValue":e.value.obj.value=this.tempAdjValue;break;case"setTempFilter":this.tempFilter=e.value.tempFilter;break;case"setTempUndoRedoStep":this.tempUndoRedoStep=e.value.tempUndoRedoStep;break;case"setTempFreehandCounter":this.tempFreehandCounter=e.value.tempFreehandCounter;break;case"setTempCurrentFreehandDrawIndex":this.tempCurrFhdIndex=e.value.tempCurrentFreehandDrawIndex;break;case"setTempZoomFactor":this.tempZoomFactor=e.value.tempZoomFactor;break;case"setCancelAction":this.isCancelAction=e.value.bool;break;case"getRotatedFlipCropSelection":e.value.bool.isSelected=this.rotatedFlipCropSel;break;case"getPrevActObj":e.value.obj.prevActObj=this.prevActObj;break;case"setPrevActObj":this.prevActObj=e.value.prevActObj;break;case"getZoomCrop":e.value.obj.width=this.zoomCrop.width,e.value.obj.height=this.zoomCrop.height;break;case"setZoomCropWidth":this.zoomCrop.width=e.value.width,this.zoomCrop.height=e.value.height;break;case"setImageEdited":this.isImageEdited=!0;break;case"reset":this.reset();break;case"dlgBtnClick":this.dlgBtnClick();break;case"dlgCloseBtnClick":this.dlgCloseBtnClick();break;case"setNewPath":this.isNewPath=e.value.bool;break;case"getNewPath":e.value.obj.isNewPath=this.isNewPath;break;case"getArrowDimension":e.value.obj.arrowDimension=this.arrowDimension;break;case"setArrowDimension":this.arrowDimension=e.value.arrowDimension;break;case"moveToSelectionRange":this.moveToSelectionRange(e.value.type,e.value.activeObj)}},e.prototype.getModuleName=function(){return"draw"},e.prototype.updatePrivateVariables=function(){var e=this.parent;e.lowerCanvas&&(this.lowerContext=e.lowerCanvas.getContext("2d")),e.upperCanvas&&(this.upperContext=e.upperCanvas.getContext("2d")),sf.base.isNullOrUndefined(this.tempZoomFactor)&&(this.tempZoomFactor=e.transform.zoomFactor)},e.prototype.reset=function(){this.isInitialLoading=this.isErrorImage=this.isNewPath=!1,this.cancelObjColl=this.cancelPointColl=[],this.isShapeTextInserted=!1,this.initZoomValue=null,this.tempFilter="",this.currSelPoint=null,this.isRotateZoom=!1,this.tempAdjValue="",this.tempStrokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null},this.tempTextSettings={text:"Enter Text",fontFamily:"Arial",fontSize:null,fontRatio:null,bold:!1,italic:!1,underline:!1},this.tempUndoRedoStep=this.tempFreehandCounter=this.tempCurrFhdIndex=0,this.tempZoomFactor=null,this.isCancelAction=!1,this.rotatedFlipCropSel=!1,this.prevActObj=null,this.arrowDimension={bar:{width:10,height:32,ratioX:null,ratioY:null},arrow:{width:24,height:24,ratioX:null,ratioY:null},arrowSolid:{width:32,height:32,ratioX:null,ratioY:null},circle:{width:10,height:10,ratioX:null,ratioY:null},square:{width:20,height:20,ratioX:null,ratioY:null}}},e.prototype.drawObject=function(e,t,o,i,a,r,n){var s,l=this.parent,p=l.activeObj.activePoint;(this.upperContext.clearRect(0,0,l.upperCanvas.width,l.upperCanvas.height),"original"===e.toLowerCase()?s=this.lowerContext:"duplicate"===e.toLowerCase()?s=this.upperContext:r&&(s=r),!a&&l.activeObj.shape&&this.setDragLimit(),l.currObjType.shape)&&("crop"===l.currObjType.shape.split("-")[0].toLowerCase()&&o&&this.drawCropRatio());if(i&&(p.startX=i.startX,p.startY=i.startY,p.endX=i.endX,p.endY=i.endY,p.width=i.width,p.height=i.height),sf.base.isNullOrUndefined(l.activeObj.strokeSettings)){var h={strokeSettings:{}};l.notify("shape",{prop:"getStrokeSettings",onPropertyChange:!1,value:{obj:h}}),l.activeObj.strokeSettings=h.strokeSettings}if(sf.base.isNullOrUndefined(l.activeObj.strokeSettings.strokeWidth)&&(l.activeObj.strokeSettings.strokeWidth=2),t&&(l.activeObj=sf.base.extend({},t,{},!0)),this.updateActiveObject(),l.currObjType.isText){var c={keyHistory:""};l.notify("shape",{prop:"getKeyHistory",onPropertyChange:!1,value:{obj:c}}),l.activeObj.keyHistory=c.keyHistory}if("original"!==e.toLowerCase()){var d=!1;l.activeObj.shape&&"crop"===l.activeObj.shape.split("-")[0]&&(d=!0),d&&(this.upperContext.fillStyle="rgb(0, 0, 0, 0.25)",this.upperContext.fillRect(0,0,l.lowerCanvas.width,l.lowerCanvas.height),this.upperContext.clearRect(p.startX,p.startY,p.width,p.height)),!sf.base.isNullOrUndefined(n)||s!==this.lowerContext&&s!==this.upperContext||(this.rotateContext("initial",s),this.drawOuterSelection(s),this.rotateContext("reverse",s))}l.currObjType.isActiveObj=!0;var v={keyHistory:""};l.notify("shape",{prop:"getKeyHistory",onPropertyChange:!1,value:{obj:v}}),t?this.drawShapeObj(e,t.shape,r,n):""!==v.keyHistory&&l.currObjType.isText?this.drawShapeObj(e,"text",r,n):l.activeObj.shape?this.drawShapeObj(e,l.activeObj.shape,r,n):this.drawShapeObj(e,void 0,r,n)},e.prototype.rotateContext=function(e,t){var o=this.parent,i=sf.base.extend({},o.activeObj.activePoint,{},!0);if("line"!==o.activeObj.shape&&"arrow"!==o.activeObj.shape){var a="initial"===e?o.activeObj.rotatedAngle:-o.activeObj.rotatedAngle;t.translate(i.startX+i.width/2,i.startY+i.height/2),t.rotate(a),t.translate(-(i.startX+i.width/2),-(i.startY+i.height/2))}},e.prototype.setDragLimit=function(){var e=this.parent,t=e.activeObj.activePoint;t&&0===e.activeObj.rotatedAngle&&(t.startX<e.img.destLeft?(t.startX=e.img.destLeft,t.endX=t.startX+t.width):t.endX>e.img.destLeft+e.img.destWidth&&(t.endX=e.img.destLeft+e.img.destWidth,t.startX=t.endX-t.width),t.startY<e.img.destTop?t.startY=e.img.destTop:t.endY>e.img.destTop+e.img.destHeight&&(t.endY=e.img.destTop+e.img.destHeight,t.startY=t.endY-t.height),e.activeObj=this.updateWidthHeight(e.activeObj))},e.prototype.drawCropRatio=function(){var e,t,o,i,a=this.parent,r=a.activeObj.activePoint;if(a.transform.zoomFactor>0&&this.currSelPoint){var n=sf.base.extend({},a.activeObj,{},!0);this.drawCustomSelection("crop-custom",null,null,null,null),a.transform.degree%90==0&&a.transform.degree%180!=0?i=o=a.activeObj.activePoint.width<a.activeObj.activePoint.height?a.activeObj.activePoint.width:a.activeObj.activePoint.height:(o=a.img.destLeft+a.img.destLeft+a.img.destWidth<=a.lowerCanvas.clientWidth?r.width:a.lowerCanvas.clientWidth-a.img.destLeft,i=a.img.destTop+a.img.destTop+a.img.destHeight<=a.lowerCanvas.clientHeight?r.height:a.lowerCanvas.clientHeight-a.img.destTop),a.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),a.activeObj=n,a.currObjType.shape=n.shape,this.upperContext.clearRect(0,0,a.upperCanvas.width,a.upperCanvas.height),a.currObjType.isCustomCrop=!1}else o=a.img.destWidth,i=a.img.destHeight,a.img.destLeft<0&&(o+=a.img.destLeft),a.img.destTop<0&&(i+=a.img.destTop),"crop-square"!==a.currObjType.shape.toLowerCase()&&"crop-circle"!==a.currObjType.shape.toLowerCase()&&(a.img.destLeft+a.img.destWidth>a.lowerCanvas.width&&(o-=a.img.destLeft+a.img.destWidth-a.lowerCanvas.width),a.img.destTop+a.img.destHeight>a.lowerCanvas.height&&(i-=a.img.destTop+a.img.destHeight-a.lowerCanvas.height));switch(a.currObjType.shape.toLowerCase()){case"crop-square":case"crop-circle":a.notify("selection",{prop:"setDragDirection",onPropertyChange:!1,value:{width:o,height:i}}),r=a.activeObj.activePoint,a.lowerCanvas.width<r.endX-r.startX&&(r.startX=7.5,r.endX=a.lowerCanvas.width-7.5),a.lowerCanvas.height<r.endY-r.startY&&(r.startY=7.5,r.endY=a.lowerCanvas.height-7.5),o===a.img.destWidth&&i===a.img.destHeight&&(r.startX+=a.img.destLeft,r.startY+=a.img.destTop,r.endX+=a.img.destLeft,r.endY+=a.img.destTop),a.lowerCanvas.width>a.lowerCanvas.height?(r.height=r.endY-r.startY,r.width=r.height,r.endX=r.startX+r.width):(r.width=r.endX-r.startX,r.height=r.width,r.endY=r.startY+r.height);break;case"crop-3:2":e=3,t=2;break;case"crop-4:3":e=4,t=3;break;case"crop-5:4":e=5,t=4;break;case"crop-7:5":e=7,t=5;break;case"crop-16:9":e=16,t=9}if(void 0!==e&&void 0!==t&&(a.notify("selection",{prop:"calcShapeRatio",onPropertyChange:!1,value:{x:e,y:t,imgWidth:o,imgHeight:i}}),o===a.img.destWidth&&i===a.img.destHeight&&this.updatePoints(),r=a.activeObj.activePoint),r.startX<a.img.destLeft){var s=a.img.destLeft-r.startX+7.5;r.startX+=s,r.endX+=s}if(r.startY<a.img.destTop){s=a.img.destTop-r.startY+7.5;r.startY+=s,r.endY+=s}a.activeObj=this.updateWidthHeight(a.activeObj),this.adjToCenter()},e.prototype.adjToCenter=function(){var e=this.parent,t=e.lowerCanvas.width/2-(e.activeObj.activePoint.endX-e.activeObj.activePoint.width/2),o=e.lowerCanvas.height/2-(e.activeObj.activePoint.endY-e.activeObj.activePoint.height/2);if(e.activeObj.activePoint.startX+=t,e.activeObj.activePoint.endX+=t,e.activeObj.activePoint.startY+=o,e.activeObj.activePoint.endY+=o,e.activeObj.activePoint.startX<(e.img.destLeft>=7.5?e.img.destLeft:7.5)){var i=(e.img.destLeft>=7.5?e.img.destLeft:0)-e.activeObj.activePoint.startX+7.5;e.activeObj.activePoint.startX+=i,e.activeObj.activePoint.endX+=i}else if(e.activeObj.activePoint.endX>e.img.destLeft+e.img.destWidth){i=e.activeObj.activePoint.endX-(e.img.destLeft+e.img.destWidth)+7.5;e.activeObj.activePoint.startX-=i,e.activeObj.activePoint.endX-=i}if(e.activeObj.activePoint.startY<(e.img.destTop>7.5?e.img.destTop:7.5)){i=(e.img.destTop>7.5?e.img.destTop:0)-e.activeObj.activePoint.startY+7.5;e.activeObj.activePoint.startY+=i,e.activeObj.activePoint.endY+=i}else if(e.activeObj.activePoint.endY>e.img.destTop+e.img.destHeight){i=e.activeObj.activePoint.endY-(e.img.destTop+e.img.destHeight)+7.5;e.activeObj.activePoint.startY-=i,e.activeObj.activePoint.endY-=i}},e.prototype.updateActiveObject=function(e,t,o,i,a){e=e||sf.base.extend({},this.parent.activeObj.activePoint,{},!0),t=t||sf.base.extend({},this.parent.activeObj,{},!0),e.width=e.endX-e.startX,e.height=e.endY-e.startY,i=i||0,a=a||0;var r=e.width/2,n=e.height/2;t.horTopLine={startX:e.startX+i,startY:e.startY-a,endX:e.endX+i,endY:e.endY+a},t.horBottomLine={startX:e.startX-i,startY:e.endY-a,endX:e.endX-i,endY:e.endY+a},t.verLeftLine={startX:e.startX+i,startY:e.startY-a,endX:e.startX-a,endY:e.endY-a},t.verRightLine={startX:e.endX+i,startY:e.startY+a,endX:e.endX-i,endY:e.endY+a},t.topLeftCircle={startX:e.startX,startY:e.startY,radius:t.horTopLine.endX?7.5:0},t.topCenterCircle={startX:e.startX+r,startY:e.startY,radius:t.horTopLine.endX?7.5:0},t.topRightCircle={startX:e.endX,startY:e.startY,radius:t.horTopLine.endX?7.5:0},t.centerLeftCircle={startX:e.startX,startY:e.startY+n,radius:t.horTopLine.endX?7.5:0},t.centerRightCircle={startX:e.endX,startY:e.startY+n,radius:t.horTopLine.endX?7.5:0},t.bottomLeftCircle={startX:e.startX,startY:e.endY,radius:t.horTopLine.endX?7.5:0},t.bottomCenterCircle={startX:e.startX+r,startY:e.endY,radius:t.horTopLine.endX?7.5:0},t.bottomRightCircle={startX:e.endX,startY:e.endY,radius:t.horTopLine.endX?7.5:0},0===t.rotatedAngle&&(t.rotationCirclePoint={x:t.bottomCenterCircle.startX,y:t.bottomCenterCircle.startY+25},t.rotationCirclePoint.ratioX=(t.rotationCirclePoint.x-this.parent.img.destLeft)/this.parent.img.destWidth,t.rotationCirclePoint.ratioY=(t.rotationCirclePoint.y-this.parent.img.destTop)/this.parent.img.destHeight),t.activePoint=e,sf.base.isNullOrUndefined(o)&&(this.parent.activeObj=sf.base.extend({},t,{},!0))},e.prototype.drawOuterSelection=function(e,t){var o,i=this.parent,a=i.activeObj.activePoint;e.lineWidth=.5,void 0!==i.activeObj.shape&&(o=i.activeObj.shape.split("-"));var r,n=sf.base.extend({},i.activeObj,{},!0);if(void 0!==i.activeObj.shape&&(o=i.activeObj.shape.split("-")),(void 0===o||"crop"!==o[0])&&void 0!==i.activeObj.shape||t||(this.upperContext.fillStyle="rgb(0, 0, 0, 0.25)",this.upperContext.fillRect(0,0,i.lowerCanvas.width,i.lowerCanvas.height),this.upperContext.clearRect(a.startX,a.startY,a.width,a.height)),e.strokeStyle=i.themeColl[i.theme].primaryColor,e.fillStyle=i.themeColl[i.theme].secondaryColor,(r=0===n.shapeDegree?i.transform.degree:i.transform.degree-n.shapeDegree)<0&&(r=360+r),"arrow"===i.activeObj.shape||"line"===i.activeObj.shape)e.beginPath(),e.moveTo(a.startX,a.startY),e.lineTo(a.endX,a.endY),e.stroke();else if("path"===i.activeObj.shape){e.beginPath();var s=sf.base.extend({},i.activeObj,{},!0);if(e.moveTo(s.pointColl[0].x,s.pointColl[0].y),s.pointColl.length>1)for(var l=1,p=s.pointColl.length;l<p;l++)a.endX=s.pointColl[l].x,a.endY=s.pointColl[l].y,e.lineTo(a.endX,a.endY);var h={shape:null};i.notify("selection",{prop:"getCurrentDrawingShape",value:{obj:h}}),"path"===h.shape&&(i.activeObj=s),e.lineTo(a.endX,a.endY),e.stroke()}else if(e.beginPath(),e.rect(n.activePoint.startX,n.activePoint.startY,n.activePoint.width,n.activePoint.height),e.stroke(),e.closePath(),i.selectionSettings.showCircle){var c=e.strokeStyle,d=e.fillStyle;e.strokeStyle=i.selectionSettings.strokeColor,e.fillStyle=i.selectionSettings.fillColor,e.lineWidth*=2,e.beginPath(),e.moveTo(n.topLeftCircle.startX,n.topLeftCircle.startY),e.arc(n.topLeftCircle.startX,n.topLeftCircle.startY,n.topLeftCircle.radius,0,2*Math.PI),e.moveTo(n.topRightCircle.startX,n.topRightCircle.startY),e.arc(n.topRightCircle.startX,n.topRightCircle.startY,n.topRightCircle.radius,0,2*Math.PI),e.moveTo(n.bottomLeftCircle.startX,n.bottomLeftCircle.startY),e.arc(n.bottomLeftCircle.startX,n.bottomLeftCircle.startY,n.bottomLeftCircle.radius,0,2*Math.PI),e.moveTo(n.bottomRightCircle.startX,n.bottomRightCircle.startY),e.arc(n.bottomRightCircle.startX,n.bottomRightCircle.startY,n.bottomRightCircle.radius,0,2*Math.PI),e.stroke(),e.fill(),e.closePath(),e.lineWidth/=2,e.strokeStyle=c,e.fillStyle=d}if(i.selectionSettings.showCircle&&(void 0===o||"crop"!==o[0])){c=e.strokeStyle,d=e.fillStyle;e.strokeStyle=i.selectionSettings.strokeColor,e.fillStyle=i.selectionSettings.fillColor,"text"===i.activeObj.shape||this.drawCenterCircles(e),e.strokeStyle=c,e.fillStyle=d}n.rotationCircleLine=i.activeObj.rotationCircleLine,i.activeObj=sf.base.extend({},n,{},!0)},e.prototype.drawArrowHead=function(e,t){switch(t?this.parent.activeObj.start:this.parent.activeObj.end){case"arrowSolid":t?this.arrowSolid(e,!0):this.arrowSolid(e,!1);break;case"arrow":t?this.arrow(e,!0):this.arrow(e,!1);break;case"circleSolid":t?this.arrowCircleSolid(e,!0):this.arrowCircleSolid(e,!1);break;case"circle":t?this.arrowCircle(e,!0):this.arrowCircle(e,!1);break;case"bar":t?this.arrowBar(e,!0):this.arrowBar(e,!1);break;case"square":case"squareSolid":t?this.arrowSquareStart(e):this.arrowSquareEnd(e)}},e.prototype.drawShapeObj=function(e,t,o,i){var a,r=this.parent,n=r.activeObj.activePoint,s=void 0!==t?t:r.currObjType.shape;r.currObjType.shape=s,"original"===e.toLowerCase()?a=this.lowerContext:"duplicate"===e.toLowerCase()?a=this.upperContext:o&&(a=o),"rectangle"!==r.currObjType.shape.toLowerCase()&&"ellipse"!==r.currObjType.shape.toLowerCase()&&"line"!==r.currObjType.shape.toLowerCase()&&"arrow"!==r.activeObj.shape&&"path"!==r.activeObj.shape||(r.activeObj.shape=r.currObjType.shape),a.strokeStyle=r.activeObj.strokeSettings.strokeColor,a.fillStyle="text"===t||"freehanddraw"===t?r.activeObj.strokeSettings.strokeColor:r.activeObj.strokeSettings.fillColor;var l,p=n.width/3,h=n.height/3,c=n.endX-n.startX,d=n.endY-n.startY;this.rotateContext("initial",a);var v,u=a.fillStyle;switch(r.currObjType.shape.toLowerCase()){case"rectangle":this.drawSquareLines(a),sf.base.isNullOrUndefined(i)&&a===this.upperContext&&this.drawOuterSelection(a);break;case"ellipse":c=Math.abs(c),d=Math.abs(d),a.beginPath(),a.ellipse(n.startX+c/2,n.startY+d/2,c/2,d/2,0,0,2*Math.PI,!1),""!==r.activeObj.strokeSettings.fillColor&&(a.fillStyle=r.activeObj.strokeSettings.fillColor,a.fill()),a.ellipse(n.startX+c/2,n.startY+d/2,Math.abs(c/2-r.activeObj.strokeSettings.strokeWidth),Math.abs(d/2-r.activeObj.strokeSettings.strokeWidth),0,0,2*Math.PI,!1),a.fillStyle=r.activeObj.strokeSettings.strokeColor,a.fill("evenodd"),a.closePath(),sf.base.isNullOrUndefined(i)&&a===this.upperContext&&this.drawOuterSelection(a);break;case"crop-circle":a===this.lowerContext&&(a=this.upperContext),this.shapeCircle(a,c,d);break;case"line":this.shapeLine(a,n.startX,n.startY,n.endX,n.endY),sf.base.isNullOrUndefined(i)&&a===this.upperContext&&this.drawOuterSelection(a);break;case"arrow":(l=0===r.activeObj.shapeDegree?r.transform.degree:r.transform.degree-r.activeObj.shapeDegree)<0&&(l=360+l),a.fillStyle=a.strokeStyle,sf.base.isNullOrUndefined(r.activeObj.triangleDirection)&&(r.activeObj.triangleDirection="right"),sf.base.isNullOrUndefined(r.activeObj.start)&&(r.activeObj.start="none"),sf.base.isNullOrUndefined(r.activeObj.end)&&(r.activeObj.end="arrowSolid"),this.drawArrowHead(a,!0),this.drawArrowHead(a,!1),"none"===r.activeObj.end&&this.shapeLine(a,n.startX,n.startY,n.endX,n.endY),a.fillStyle=u,sf.base.isNullOrUndefined(i)&&a===this.upperContext&&this.drawOuterSelection(a);break;case"path":if((v=sf.base.extend({},r.activeObj,{},!0)).pointColl.length>1){var b={shape:null};if(r.notify("selection",{prop:"getCurrentDrawingShape",value:{obj:b}}),"path"===b.shape)for(var g={x:0,y:0},f=0,C=v.pointColl.length;f<C;f++)sf.base.isNullOrUndefined(v.pointColl[f+1])?(g.x=v.activePoint.endX,g.y=v.activePoint.endY):(g.x=v.pointColl[f+1].x,g.y=v.pointColl[f+1].y),n.startX=v.pointColl[f].x,n.startY=v.pointColl[f].y,n.endX=g.x,n.endY=g.y,r.activeObj=this.updateWidthHeight(r.activeObj),this.shapeLine(a,n.startX,n.startY,n.endX,n.endY);else for(f=1,C=v.pointColl.length;f<C;f++)n.startX=v.pointColl[f-1].x,n.startY=v.pointColl[f-1].y,n.endX=v.pointColl[f].x,n.endY=v.pointColl[f].y,r.activeObj=this.updateWidthHeight(r.activeObj),this.shapeLine(a,n.startX,n.startY,n.endX,n.endY);r.activeObj=v}else this.shapeLine(a,n.startX,n.startY,n.endX,n.endY);a===this.upperContext&&this.drawOuterSelection(a);break;case"text":this.shapeText(a);break;case"crop-square":case"crop-3:4":case"crop-4:3":case"crop-6:9":case"crop-9:6":case"crop-9:16":case"crop-16:9":a===this.lowerContext&&(a=this.upperContext),this.drawSelection(p,h),r.currObjType.shape="";break;default:this.drawSelection(p,h)}this.rotateContext("reverse",a)},e.prototype.updatePoints=function(){var e=this.parent;e.activeObj.activePoint.startX+=e.img.destLeft,e.activeObj.activePoint.startY+=e.img.destTop,e.activeObj.activePoint.endX+=e.img.destLeft,e.activeObj.activePoint.endY+=e.img.destTop,e.activeObj=this.updateWidthHeight(e.activeObj)},e.prototype.updateWidthHeight=function(e){return e.activePoint.width=e.activePoint.endX-e.activePoint.startX,e.activePoint.height=e.activePoint.endY-e.activePoint.startY,e},e.prototype.drawCenterCircles=function(e){var t=this.parent,o=t.activeObj.activePoint;if(e.lineWidth*=2,e.beginPath(),"arrow"===t.activeObj.shape||"line"===t.activeObj.shape)e.moveTo(o.startX,o.startY),e.arc(o.startX,o.startY,t.activeObj.topCenterCircle.radius,0,2*Math.PI),e.moveTo(o.endX,o.endY),e.arc(o.endX,o.endY,t.activeObj.bottomCenterCircle.radius,0,2*Math.PI);else if("path"===t.activeObj.shape){var i=sf.base.extend({},t.activeObj,{},!0);if(i.pointColl.length>1)for(var a=1,r=i.pointColl.length;a<r;a++)o.startX=i.pointColl[a-1].x,o.startY=i.pointColl[a-1].y,o.endX=i.pointColl[a].x,o.endY=i.pointColl[a].y,e.moveTo(o.startX,o.startY),e.arc(o.startX,o.startY,t.activeObj.topCenterCircle.radius,0,2*Math.PI),e.moveTo(o.endX,o.endY),e.arc(o.endX,o.endY,t.activeObj.bottomCenterCircle.radius,0,2*Math.PI);var n={shape:null};t.notify("selection",{prop:"getCurrentDrawingShape",value:{obj:n}}),"path"===n.shape&&(t.activeObj=i),e.moveTo(o.startX,o.startY),e.arc(o.startX,o.startY,t.activeObj.topCenterCircle.radius,0,2*Math.PI),e.moveTo(o.endX,o.endY),e.arc(o.endX,o.endY,t.activeObj.bottomCenterCircle.radius,0,2*Math.PI)}else this.drawRotationArcLine(e),e.lineTo(t.activeObj.rotationCirclePoint.x,t.activeObj.rotationCirclePoint.y);e.stroke(),e.fill(),e.closePath(),"arrow"!==t.activeObj.shape&&"line"!==t.activeObj.shape&&"path"!==t.activeObj.shape&&(e.beginPath(),e.moveTo(t.activeObj.rotationCirclePoint.x,t.activeObj.rotationCirclePoint.y),e.arc(t.activeObj.rotationCirclePoint.x,t.activeObj.rotationCirclePoint.y,t.activeObj.bottomCenterCircle.radius,0,2*Math.PI),e.stroke(),e.fill(),e.closePath()),e.lineWidth/=2},e.prototype.drawRotationArcLine=function(e){var t,o=this.parent;sf.base.isNullOrUndefined(o.activeObj.rotationCircleLine)&&(o.activeObj.rotationCircleLine=22.5);var i=!1,a=!1;(t=0===o.activeObj.shapeDegree?o.transform.degree:o.transform.degree-o.activeObj.shapeDegree)<0&&(t=360+t);for(var r=0,n=o.activeObj.flipObjColl.length;r<n;r++)"horizontal"===o.activeObj.flipObjColl[r].toLowerCase()?i=!0:"vertical"===o.activeObj.flipObjColl[r].toLowerCase()&&(a=!0);switch(t){case 0:case 360:a?(o.activeObj.rotationCirclePoint={x:o.activeObj.topCenterCircle.startX,y:o.activeObj.topCenterCircle.startY-o.activeObj.rotationCircleLine},e.moveTo(o.activeObj.rotationCirclePoint.x,o.activeObj.rotationCirclePoint.y+o.activeObj.rotationCircleLine)):(o.activeObj.rotationCirclePoint={x:o.activeObj.bottomCenterCircle.startX,y:o.activeObj.bottomCenterCircle.startY+o.activeObj.rotationCircleLine},e.moveTo(o.activeObj.rotationCirclePoint.x,o.activeObj.rotationCirclePoint.y-o.activeObj.rotationCircleLine));break;case 90:case-270:i?(o.activeObj.rotationCirclePoint={x:o.activeObj.centerRightCircle.startX+o.activeObj.rotationCircleLine,y:o.activeObj.centerLeftCircle.startY},e.moveTo(o.activeObj.rotationCirclePoint.x-o.activeObj.rotationCircleLine,o.activeObj.rotationCirclePoint.y)):(o.activeObj.rotationCirclePoint={x:o.activeObj.centerLeftCircle.startX-o.activeObj.rotationCircleLine,y:o.activeObj.centerLeftCircle.startY},e.moveTo(o.activeObj.rotationCirclePoint.x+o.activeObj.rotationCircleLine,o.activeObj.rotationCirclePoint.y));break;case 180:case-180:a?(o.activeObj.rotationCirclePoint={x:o.activeObj.bottomCenterCircle.startX,y:o.activeObj.bottomCenterCircle.startY+o.activeObj.rotationCircleLine},e.moveTo(o.activeObj.rotationCirclePoint.x,o.activeObj.rotationCirclePoint.y-o.activeObj.rotationCircleLine)):(o.activeObj.rotationCirclePoint={x:o.activeObj.topCenterCircle.startX,y:o.activeObj.topCenterCircle.startY-o.activeObj.rotationCircleLine},e.moveTo(o.activeObj.rotationCirclePoint.x,o.activeObj.rotationCirclePoint.y+o.activeObj.rotationCircleLine));break;case 270:case-90:i?(o.activeObj.rotationCirclePoint={x:o.activeObj.centerLeftCircle.startX-o.activeObj.rotationCircleLine,y:o.activeObj.centerLeftCircle.startY},e.moveTo(o.activeObj.rotationCirclePoint.x+o.activeObj.rotationCircleLine,o.activeObj.rotationCirclePoint.y)):(o.activeObj.rotationCirclePoint={x:o.activeObj.centerRightCircle.startX+o.activeObj.rotationCircleLine,y:o.activeObj.centerLeftCircle.startY},e.moveTo(o.activeObj.rotationCirclePoint.x-o.activeObj.rotationCircleLine,o.activeObj.rotationCirclePoint.y))}},e.prototype.drawSquareLines=function(e){var t,o=this.parent,i=o.activeObj.activePoint;void 0!==o.activeObj.shape&&(t=o.activeObj.shape.split("-")),"crop"===t[0]?e.strokeStyle="#fff":e.strokeStyle=o.activeObj.strokeSettings.strokeColor,e.beginPath(),e.rect(i.startX,i.startY,i.width,i.height),""!==o.activeObj.strokeSettings.fillColor&&(e.fillStyle=o.activeObj.strokeSettings.fillColor,e.fill()),e.rect(i.startX+o.activeObj.strokeSettings.strokeWidth,i.startY+o.activeObj.strokeSettings.strokeWidth,i.width-2*o.activeObj.strokeSettings.strokeWidth,i.height-2*o.activeObj.strokeSettings.strokeWidth),e.fillStyle=o.activeObj.strokeSettings.strokeColor,e.fill("evenodd"),e.closePath()},e.prototype.drawSelection=function(e,t){var o=this.parent,i=o.activeObj.activePoint;this.upperContext.strokeStyle=o.themeColl[o.theme].primaryColor,this.upperContext.beginPath(),o.activeObj.horTopInnerLine={startX:i.startX,startY:i.startY+t,endX:i.endX,endY:i.endY+t},o.activeObj.horBottomInnerLine={startX:i.startX,startY:i.startY+2*t,endX:i.endX,endY:i.endY+2*t},o.activeObj.verLeftInnerLine={startX:i.startX+e,startY:i.startY,endX:i.startX+e,endY:i.endY},o.activeObj.verRightInnerLine={startX:i.startX+2*e,startY:i.startY,endX:i.startX+2*e,endY:i.endY},this.upperContext.moveTo(o.activeObj.horTopInnerLine.startX,o.activeObj.horTopInnerLine.startY),this.upperContext.lineTo(o.activeObj.horTopInnerLine.endX,o.activeObj.horTopInnerLine.startY),this.upperContext.moveTo(o.activeObj.horBottomInnerLine.startX,o.activeObj.horBottomInnerLine.startY),this.upperContext.lineTo(o.activeObj.horBottomInnerLine.endX,o.activeObj.horBottomInnerLine.startY),this.upperContext.moveTo(o.activeObj.verLeftInnerLine.startX,o.activeObj.verLeftInnerLine.startY),this.upperContext.lineTo(o.activeObj.verLeftInnerLine.endX,o.activeObj.verLeftInnerLine.endY),this.upperContext.moveTo(o.activeObj.verRightInnerLine.startX,o.activeObj.verRightInnerLine.startY),this.upperContext.lineTo(o.activeObj.verRightInnerLine.endX,o.activeObj.verRightInnerLine.endY),this.upperContext.stroke(),this.upperContext.closePath()},e.prototype.shapeCircle=function(e,t,o){var i=this.parent,a=i.activeObj.activePoint;e.strokeStyle=i.themeColl[i.theme].primaryColor,e.clearRect(0,0,i.lowerCanvas.width,i.lowerCanvas.height),e.fillStyle="rgb(0, 0, 0, 0.25)",e.fillRect(0,0,i.lowerCanvas.width,i.lowerCanvas.height);var r=e.lineWidth;e.lineWidth=2,e.beginPath(),e.ellipse(i.activeObj.horTopLine.startX+t/2,i.activeObj.horTopLine.startY+o/2,t/2,o/2,0,0,2*Math.PI,!1),e.stroke(),e.closePath(),e.save(),e.beginPath(),e.arc((a.endX-a.startX)/2+a.startX,(a.endY-a.startY)/2+a.startY,a.width/2,0,2*Math.PI),e.closePath(),e.clip(),e.clearRect(0,0,i.lowerCanvas.width,i.lowerCanvas.height),e.restore(),e.lineWidth=r,this.drawOuterSelection(e,!0),i.currObjType.shape=""},e.prototype.shapeLine=function(e,t,o,i,a){var r=e.lineWidth;e.lineWidth=this.parent.activeObj.strokeSettings.strokeWidth,e.beginPath(),e.moveTo(t,o),e.lineTo(i,a),e.stroke(),e.lineWidth=r},e.prototype.arrow=function(e,t){var o=this.parent,i=o.activeObj.activePoint;e.lineWidth=o.activeObj.strokeSettings.strokeWidth;var a=this.arrowDimension.arrow.width+o.activeObj.strokeSettings.strokeWidth,r=this.arrowDimension.arrow.height+o.activeObj.strokeSettings.strokeWidth;this.dx=i.endX-i.startX,this.dy=i.endY-i.startY,e.fillStyle=o.activeObj.strokeSettings.strokeColor;var n=Math.atan2(this.dy,this.dx);(t&&("left"===o.activeObj.triangleDirection||"right"===o.activeObj.triangleDirection)&&"arrow"===o.activeObj.start&&"none"===o.activeObj.end||"arrow"===o.activeObj.start&&"circle"!==o.activeObj.end&&"square"!==o.activeObj.end||!t&&("arrow"===o.activeObj.end&&"none"===o.activeObj.start||"circle"!==o.activeObj.start&&"square"!==o.activeObj.start))&&this.shapeLine(e,i.startX,i.startY,i.endX,i.endY),t&&"left"===o.activeObj.triangleDirection||!t&&"right"===o.activeObj.triangleDirection?(e.translate(i.endX,i.endY),e.rotate(n),this.shapeLine(e,0,0,-a,r/2),this.shapeLine(e,0,0,-a,-r/2),e.rotate(-n),e.translate(-i.endX,-i.endY)):(t&&"right"===o.activeObj.triangleDirection||!t&&"left"===o.activeObj.triangleDirection)&&(e.translate(i.startX,i.startY),e.rotate(n),this.shapeLine(e,0,0,a,r/2),this.shapeLine(e,0,0,a,-r/2),e.rotate(-n),e.translate(-i.startX,-i.startY))},e.prototype.arrowSolid=function(e,t){var o=this.parent,i=o.activeObj.activePoint,a=this.arrowDimension.arrowSolid.width+o.activeObj.strokeSettings.strokeWidth,r=this.arrowDimension.arrowSolid.height+o.activeObj.strokeSettings.strokeWidth;this.dx=i.endX-i.startX,this.dy=i.endY-i.startY;var n=Math.atan2(this.dy,this.dx);(t&&"arrowSolid"===o.activeObj.start&&"none"===o.activeObj.end||"arrowSolid"===o.activeObj.start&&"circle"!==o.activeObj.end&&"square"!==o.activeObj.end||!t&&("arrowSolid"===o.activeObj.end&&"none"===o.activeObj.start||"circle"!==o.activeObj.start&&"square"!==o.activeObj.start))&&this.shapeLine(e,i.startX,i.startY,i.endX,i.endY),t&&"left"===o.activeObj.triangleDirection||!t&&"right"===o.activeObj.triangleDirection?(e.translate(i.endX,i.endY),e.rotate(n),e.beginPath(),e.moveTo(o.activeObj.strokeSettings.strokeWidth,0),e.lineTo(r/2-a,r/2),e.lineTo(r/2-a,-r/2),e.closePath(),e.fill(),e.rotate(-n),e.translate(-i.endX,-i.endY),o.activeObj.rotatedAngle=n):(t&&"right"===o.activeObj.triangleDirection||!t&&"left"===o.activeObj.triangleDirection)&&(e.translate(i.startX,i.startY),e.rotate(n),e.beginPath(),e.moveTo(0-o.activeObj.strokeSettings.strokeWidth,0),e.lineTo(a-r/2,r/2),e.lineTo(a-r/2,-r/2),e.closePath(),e.fill(),e.rotate(-n),e.translate(-i.startX,-i.startY),o.activeObj.rotatedAngle=n)},e.prototype.arrowSquareStart=function(e){var t=this.parent,o=t.activeObj.activePoint;("square"===t.activeObj.start&&"none"===t.activeObj.end||"square"===t.activeObj.start&&"circle"!==t.activeObj.end&&"square"!==t.activeObj.start||"squareSolid"===t.activeObj.start&&"circleSolid"===t.activeObj.end)&&this.shapeLine(e,o.startX,o.startY,o.endX,o.endY),e.lineWidth=t.activeObj.strokeSettings.strokeWidth,e.beginPath(),e.fillStyle=t.activeObj.strokeSettings.strokeColor;var i=this.arrowDimension.square.width+t.activeObj.strokeSettings.strokeWidth,a=this.arrowDimension.square.height+t.activeObj.strokeSettings.strokeWidth;this.dx=o.endX-o.startX,this.dy=o.endY-o.startY;var r=Math.atan2(this.dy,this.dx);"left"===t.activeObj.triangleDirection?(e.translate(o.endX,o.endY),e.rotate(r),"squareSolid"===t.activeObj.start&&e.fillRect(a/2-i,-a/2,i,a),e.strokeRect(a/2-i,-a/2,i,a),e.rotate(-r),e.translate(-o.endX,-o.endY),this.squareStartIntersectX1=o.endX-a/2*Math.cos(r),this.squareStartIntersectY1=o.endY-a/2*Math.sin(r),"square"===t.activeObj.start&&"square"!==t.activeObj.end&&"circle"!==t.activeObj.end&&"square"!==t.activeObj.end&&this.shapeLine(e,o.startX,o.startY,this.squareStartIntersectX1,this.squareStartIntersectY1),"square"===t.activeObj.start&&"circle"===t.activeObj.end&&this.shapeLine(e,this.endCircleIntersectX1,this.endCircleIntersectY1,this.squareStartIntersectX1,this.squareStartIntersectY1),"squareSolid"===t.activeObj.start&&"squareSolid"===t.activeObj.end&&this.shapeLine(e,o.startX,o.startY,o.endX,o.endY)):"right"===t.activeObj.triangleDirection&&(e.lineWidth=t.activeObj.strokeSettings.strokeWidth,e.fillStyle=t.activeObj.strokeSettings.strokeColor,"squareSolid"===t.activeObj.start&&"squareSolid"===t.activeObj.end&&this.shapeLine(e,o.startX,o.startY,o.endX,o.endY),e.translate(o.startX,o.startY),e.rotate(r),"squareSolid"===t.activeObj.start&&e.fillRect(a/2-i,-a/2,i,a),e.strokeRect(a/2-i,-a/2,i,a),e.rotate(-r),e.translate(-o.startX,-o.startY),t.activeObj.rotatedAngle=r,this.squareStartIntersectX1=o.startX+a/2*Math.cos(r),this.squareStartIntersectY1=o.startY+a/2*Math.sin(r),"square"===t.activeObj.start&&"square"!==t.activeObj.end&&"circle"!==t.activeObj.end&&"square"!==t.activeObj.end&&this.shapeLine(e,o.endX,o.endY,this.squareStartIntersectX1,this.squareStartIntersectY1),"square"===t.activeObj.start&&"circle"===t.activeObj.end&&this.shapeLine(e,this.endCircleIntersectX1,this.endCircleIntersectY1,this.squareStartIntersectX1,this.squareStartIntersectY1))},e.prototype.arrowSquareEnd=function(e){var t=this.parent,o=t.activeObj.activePoint,i=this.arrowDimension.square.width+t.activeObj.strokeSettings.strokeWidth,a=this.arrowDimension.square.height+t.activeObj.strokeSettings.strokeWidth;this.dx=o.endX-o.startX,this.dy=o.endY-o.startY;var r=Math.atan2(this.dy,this.dx);e.lineWidth=t.activeObj.strokeSettings.strokeWidth,"right"===t.activeObj.triangleDirection?(e.fillStyle=t.activeObj.strokeSettings.strokeColor,"squareSolid"===t.activeObj.end&&"none"===t.activeObj.start&&this.shapeLine(e,o.startX,o.startY,o.endX,o.endY),e.translate(o.endX,o.endY),e.rotate(r),"squareSolid"===t.activeObj.end&&e.fillRect(a/2-i,-a/2,i,a),e.strokeRect(a/2-i,-a/2,i,a),e.rotate(-r),e.translate(-o.endX,-o.endY),t.activeObj.rotatedAngle=r,this.squareEndIntersectX1=o.endX-a/2*Math.cos(r),this.squareEndIntersectY1=o.endY-a/2*Math.sin(r),"square"===t.activeObj.end&&"square"!==t.activeObj.start&&"circle"!==t.activeObj.start&&"square"===t.activeObj.end?this.shapeLine(e,o.startX,o.startY,this.squareEndIntersectX1,this.squareEndIntersectY1):"circle"===t.activeObj.start&&"square"===t.activeObj.end?this.shapeLine(e,this.squareEndIntersectX1,this.squareEndIntersectY1,this.startCircleIntersectX1,this.startCircleIntersectY1):"square"===t.activeObj.start&&"square"===t.activeObj.end&&this.shapeLine(e,this.squareEndIntersectX1,this.squareEndIntersectY1,this.squareStartIntersectX1,this.squareStartIntersectY1)):"left"===t.activeObj.triangleDirection&&(e.translate(o.startX,o.startY),e.rotate(r),"squareSolid"===t.activeObj.end&&e.fillRect(a/2-i,-a/2,i,a),e.strokeRect(a/2-i,-a/2,i,a),e.rotate(-r),e.translate(-o.startX,-o.startY),t.activeObj.rotatedAngle=r,this.squareEndIntersectX1=o.startX+a/2*Math.cos(r),this.squareEndIntersectY1=o.startY+a/2*Math.sin(r),"square"===t.activeObj.end&&"square"!==t.activeObj.start&&"circle"!==t.activeObj.start&&"square"===t.activeObj.end?this.shapeLine(e,o.endX,o.endY,this.squareEndIntersectX1,this.squareEndIntersectY1):"circle"===t.activeObj.start&&"square"===t.activeObj.end?this.shapeLine(e,this.squareEndIntersectX1,this.squareEndIntersectY1,this.startCircleIntersectX1,this.startCircleIntersectY1):"square"===t.activeObj.start&&"square"===t.activeObj.end&&this.shapeLine(e,this.squareEndIntersectX1,this.squareEndIntersectY1,this.squareStartIntersectX1,this.squareStartIntersectY1))},e.prototype.arrowCircle=function(e,t){var o=this.parent,i=o.activeObj.activePoint;if(t&&"left"===o.activeObj.triangleDirection||!t&&"right"===o.activeObj.triangleDirection){e.lineWidth=o.activeObj.strokeSettings.strokeWidth;var a=this.arrowDimension.circle.width+o.activeObj.strokeSettings.strokeWidth;e.beginPath(),e.arc(i.endX,i.endY,a,0,2*Math.PI),e.stroke(),e.closePath(),this.dx=i.endX-i.startX,this.dy=i.endY-i.startY;var r=this.dx*this.dx+this.dy*this.dy;if((c=(h=2*(this.dx*(i.startX-i.endX)+this.dy*(i.startY-i.endY)))*h-4*r*((i.startX-i.endX)*(i.startX-i.endX)+(i.startY-i.endY)*(i.startY-i.endY)-a*a))>=0){e.fillStyle=o.activeObj.strokeSettings.strokeColor;var n=(-h-Math.sqrt(c))/(2*r),s=i.startX+this.dx*n,l=i.startY+this.dy*n;t?(this.startCircleIntersectX1=s,this.startCircleIntersectY1=l,e.beginPath(),e.fill(),e.beginPath(),"circle"===o.activeObj.start&&"circle"===o.activeObj.end?this.shapeLine(e,this.startCircleIntersectX1,this.startCircleIntersectY1,this.endCircleIntersectX1,this.endCircleIntersectY1):"circle"===o.activeObj.start&&"circle"!==o.activeObj.end&&"square"!==o.activeObj.end&&this.shapeLine(e,i.startX,i.startY,this.startCircleIntersectX1,this.startCircleIntersectY1),e.stroke(),e.closePath()):(this.endCircleIntersectX1=s,this.endCircleIntersectY1=l,"circle"===o.activeObj.end&&"circle"!==o.activeObj.start&&"square"!==o.activeObj.start&&this.shapeLine(e,i.startX,i.startY,this.endCircleIntersectX1,this.endCircleIntersectY1))}var p=Math.atan2(this.dy,this.dx);o.activeObj.rotatedAngle=p}else if(t&&"right"===o.activeObj.triangleDirection||!t&&"left"===o.activeObj.triangleDirection){e.lineWidth=o.activeObj.strokeSettings.strokeWidth;a=this.arrowDimension.circle.width+o.activeObj.strokeSettings.strokeWidth;e.beginPath(),e.arc(i.startX,i.startY,a,0,2*Math.PI),e.stroke(),e.closePath(),this.dx=i.startX-i.endX,this.dy=i.startY-i.endY;var h,c;r=this.dx*this.dx+this.dy*this.dy;if((c=(h=2*(this.dx*(i.endX-i.startX)+this.dy*(i.endY-i.startY)))*h-4*r*((i.endX-i.startX)*(i.endX-i.startX)+(i.endY-i.startY)*(i.endY-i.startY)-a*a))>=0){e.fillStyle=o.activeObj.strokeSettings.strokeColor;n=(-h-Math.sqrt(c))/(2*r),s=i.endX+this.dx*n,l=i.endY+this.dy*n;t?(this.startCircleIntersectX1=s,this.startCircleIntersectY1=l,"circle"===o.activeObj.start&&"circle"===o.activeObj.end?this.shapeLine(e,this.endCircleIntersectX1,this.endCircleIntersectY1,this.startCircleIntersectX1,this.startCircleIntersectY1):"circle"===o.activeObj.start&&"circle"!==o.activeObj.end&&"square"!==o.activeObj.end&&this.shapeLine(e,i.endX,i.endY,this.startCircleIntersectX1,this.startCircleIntersectY1)):(this.endCircleIntersectX1=s,this.endCircleIntersectY1=l,e.beginPath(),e.fill(),e.beginPath(),"circle"===o.activeObj.end&&"circle"!==o.activeObj.start&&"square"!==o.activeObj.start&&this.shapeLine(e,i.endX,i.endY,this.endCircleIntersectX1,this.endCircleIntersectY1))}p=Math.atan2(this.dy,this.dx);o.activeObj.rotatedAngle=p}},e.prototype.arrowCircleSolid=function(e,t){var o=this.parent,i=o.activeObj.activePoint;if(t&&"left"===o.activeObj.triangleDirection||!t&&"right"===o.activeObj.triangleDirection){e.lineWidth=o.activeObj.strokeSettings.strokeWidth,e.beginPath(),e.fillStyle=o.activeObj.strokeSettings.strokeColor,(t&&"circleSolid"===o.activeObj.start&&"none"===o.activeObj.end||"circleSolid"===o.activeObj.start&&"circle"!==o.activeObj.end&&"square"!==o.activeObj.end||!t&&"circleSolid"===o.activeObj.end&&"none"===o.activeObj.start)&&this.shapeLine(e,i.startX,i.startY,i.endX,i.endY);var a=this.arrowDimension.circle.width+o.activeObj.strokeSettings.strokeWidth;this.dx=i.endX-i.startX,this.dy=i.endY-i.startY,e.save(),e.beginPath(),e.arc(i.endX,i.endY,a,0,2*Math.PI),e.stroke(),e.fill(),e.closePath(),o.activeObj.rotatedAngle=Math.atan2(this.dy,this.dx)}else if(t&&"right"===o.activeObj.triangleDirection||!t&&"left"===o.activeObj.triangleDirection){e.lineWidth=o.activeObj.strokeSettings.strokeWidth,e.beginPath(),e.fillStyle=o.activeObj.strokeSettings.strokeColor,(t&&"circleSolid"===o.activeObj.start&&"none"===o.activeObj.end||"circleSolid"===o.activeObj.start&&"circle"!==o.activeObj.end&&"square"!==o.activeObj.end||!t&&"circleSolid"===o.activeObj.end&&"none"===o.activeObj.start)&&this.shapeLine(e,i.startX,i.startY,i.endX,i.endY);a=this.arrowDimension.circle.width+o.activeObj.strokeSettings.strokeWidth;this.dx=i.endX-i.startX,this.dy=i.endY-i.startY,e.save(),e.beginPath(),e.arc(i.startX,i.startY,a,0,2*Math.PI),e.stroke(),e.fill(),e.closePath(),o.activeObj.rotatedAngle=Math.atan2(this.dy,this.dx)}},e.prototype.arrowBar=function(e,t){var o=this.parent,i=o.activeObj.activePoint;if(t&&"left"===o.activeObj.triangleDirection||!t&&"right"===o.activeObj.triangleDirection){e.lineWidth=o.activeObj.strokeSettings.strokeWidth,e.beginPath(),e.fillStyle=o.activeObj.strokeSettings.strokeColor,(t&&"bar"===o.activeObj.start&&"none"===o.activeObj.end||"bar"===o.activeObj.start&&"circle"!==o.activeObj.end&&"square"!==o.activeObj.end||!t&&("bar"===o.activeObj.end&&"none"===o.activeObj.start||"bar"===o.activeObj.end&&"circle"!==o.activeObj.start&&"square"!==o.activeObj.start))&&this.shapeLine(e,i.startX,i.startY,i.endX,i.endY);var a=this.arrowDimension.bar.width+o.activeObj.strokeSettings.strokeWidth,r=this.arrowDimension.bar.height+o.activeObj.strokeSettings.strokeWidth;this.dx=i.endX-i.startX,this.dy=i.endY-i.startY;var n=Math.atan2(this.dy,this.dx);e.translate(i.endX,i.endY),e.rotate(n),e.fillRect(r/4-a,-r/2,a,r),e.rotate(-n),e.translate(-i.endX,-i.endY),o.activeObj.rotatedAngle=n}else if(t&&"right"===o.activeObj.triangleDirection||!t&&"left"===o.activeObj.triangleDirection){e.lineWidth=o.activeObj.strokeSettings.strokeWidth,e.beginPath(),e.fillStyle=o.activeObj.strokeSettings.strokeColor,(t&&"bar"===o.activeObj.start&&"none"===o.activeObj.end||"bar"===o.activeObj.start&&"circle"!==o.activeObj.end&&"square"!==o.activeObj.end||!t&&"bar"===o.activeObj.end&&"none"===o.activeObj.start)&&this.shapeLine(e,i.startX,i.startY,i.endX,i.endY);a=this.arrowDimension.bar.width+o.activeObj.strokeSettings.strokeWidth,r=this.arrowDimension.bar.height+o.activeObj.strokeSettings.strokeWidth;this.dx=i.endX-i.startX,this.dy=i.endY-i.startY;n=Math.atan2(this.dy,this.dx);e.translate(i.startX,i.startY),e.rotate(n),e.fillRect(r/4-a,-r/2,a,r),e.rotate(-n),e.translate(-i.startX,-i.startY),o.activeObj.rotatedAngle=n}},e.prototype.shapeText=function(e){for(var t=this.parent,o=t.activeObj.activePoint,i=t.activeObj.keyHistory.split("\n"),a=((t.activeObj.textSettings.fontSize+.25*t.activeObj.textSettings.fontSize)*i.length-t.activeObj.textSettings.fontSize*i.length)/i.length,r=0;r<i.length;r++){var n=i[r],s=(r+1)*t.activeObj.textSettings.fontSize*.85+r*a;-360===t.transform.degree&&(t.transform.degree=0),0===t.transform.degree||180===t.transform.degree?t.activeObj.textSettings.fontSize>o.height&&(t.activeObj.textSettings.fontSize=o.height-.1*o.height):t.activeObj.textSettings.fontSize>o.width&&(t.activeObj.textSettings.fontSize=o.width-.1*o.width),e.strokeStyle=t.activeObj.strokeSettings.strokeColor,e.fillStyle=t.activeObj.strokeSettings.strokeColor;var l="";t.activeObj.textSettings.bold&&(l="bold "),t.activeObj.textSettings.italic&&(l="italic "),t.activeObj.textSettings.bold&&t.activeObj.textSettings.italic&&(l="italic bold "),e.font=l+t.activeObj.textSettings.fontSize+"px "+t.activeObj.textSettings.fontFamily,4===t.activeObj.flipObjColl.length&&(t.activeObj.flipObjColl=[]);for(var p=0,h=t.activeObj.flipObjColl.length;p<h;p++)"horizontal"===t.activeObj.flipObjColl[p].toLowerCase()?(e.translate(e.canvas.width,0),e.scale(-1,1),this.updateActPoint("horizontal",e)):"vertical"===t.activeObj.flipObjColl[p].toLowerCase()&&(e.translate(0,e.canvas.height),e.scale(1,-1),this.updateActPoint("vertical",e));t.activeObj.shapeDegree!==t.transform.degree?this.rotateText(e):e.fillText(n,o.startX+.1*t.activeObj.textSettings.fontSize,o.startY+s);var c=0;for(h=t.activeObj.flipObjColl.length;c<h;c++)"horizontal"===t.activeObj.flipObjColl[c].toLowerCase()?(e.translate(e.canvas.width,0),e.scale(-1,1),this.updateActPoint("horizontal",e)):"vertical"===t.activeObj.flipObjColl[c].toLowerCase()&&(e.translate(0,e.canvas.height),e.scale(1,-1),this.updateActPoint("vertical",e))}t.currObjType.isText=!1},e.prototype.updateActPoint=function(e,t){var o=this.parent,i=o.activeObj.activePoint;"horizontal"===e.toLowerCase()?i.startX<=t.canvas.width/2?(i.startX=t.canvas.width/2+(t.canvas.width/2-i.endX),i.endX=i.startX+i.width,this.updateActiveObject(i,o.activeObj)):i.startX>=t.canvas.width/2&&(i.startX=t.canvas.width-i.endX,i.endX=i.startX+i.width,this.updateActiveObject(i,o.activeObj)):"vertical"===e.toLowerCase()&&(i.startY<=t.canvas.height/2?(i.startY=t.canvas.height/2+(t.canvas.height/2-i.endY),i.endY=i.startY+i.height,this.updateActiveObject(i,o.activeObj)):i.startY>=t.canvas.height/2&&(i.startY=t.canvas.height-i.endY,i.endY=i.startY+i.height,this.updateActiveObject(i,o.activeObj)))},e.prototype.rotateText=function(e){var t,o=this.parent,i=o.activeObj.activePoint.startX,a=o.activeObj.activePoint.startY,r=o.activeObj.activePoint;if((t=0===o.activeObj.shapeDegree?o.transform.degree:o.transform.degree-o.activeObj.shapeDegree)<0&&(t=360+t),t%360!=0||-360===o.transform.degree&&""!==o.transform.currFlipState)t%90==0&&t%180!=0?(e.translate(o.lowerCanvas.width/2,o.lowerCanvas.height/2),e.rotate(Math.PI/180*t),e.translate(-o.lowerCanvas.height/2,-o.lowerCanvas.width/2),t%90==0&&t%270!=0?(a=o.lowerCanvas.width-r.endX+.4*o.activeObj.textSettings.fontSize,i=r.startY):t%270==0&&(i=o.lowerCanvas.height-r.endY,a=r.startX+.4*o.activeObj.textSettings.fontSize),this.textFlipDegree(e,i,a),e.translate(o.lowerCanvas.height/2,o.lowerCanvas.width/2),e.rotate(Math.PI/180*-t),e.translate(-o.lowerCanvas.width/2,-o.lowerCanvas.height/2)):(e.translate(o.lowerCanvas.width/2,o.lowerCanvas.height/2),e.rotate(Math.PI/180*t),i=o.lowerCanvas.width-r.endX,a=o.lowerCanvas.height-r.endY+.4*o.activeObj.textSettings.fontSize,e.translate(-o.lowerCanvas.width/2,-o.lowerCanvas.height/2),this.textFlipDegree(e,i,a),e.translate(o.lowerCanvas.width/2,o.lowerCanvas.height/2),e.rotate(Math.PI/180*-t),e.translate(-o.lowerCanvas.width/2,-o.lowerCanvas.height/2));else{i=r.startX+.15*o.activeObj.textSettings.fontSize,a=r.startY+(r.endY-r.startY);for(var n=o.activeObj.keyHistory.split("\n"),s=0;s<n.length;s++)a=r.startY+(s*o.activeObj.textSettings.fontSize+.25*o.activeObj.textSettings.fontSize),e.fillText(n[s],i,a)}360!==o.transform.degree&&-360!==o.transform.degree||(o.transform.degree=0)},e.prototype.textFlipDegree=function(e,t,o){for(var i=this.parent,a=i.activeObj.keyHistory.split("\n"),r=(i.activeObj.textSettings.fontSize*a.length-i.activeObj.textSettings.fontSize*a.length)/a.length,n=.85*i.activeObj.textSettings.fontSize+r,s=0;s<a.length;s++){var l=a[s];s>0&&(1===s&&(n-=.85*i.activeObj.textSettings.fontSize),n+=i.activeObj.textSettings.fontSize+.15*i.activeObj.textSettings.fontSize),e.fillText(l,t+.15*i.activeObj.textSettings.fontSize,o+n+(s>0?.25*i.activeObj.textSettings.fontSize:.35*-i.activeObj.textSettings.fontSize))}},e.prototype.clearOuterCanvas=function(e){var t=this.parent,o=t.img.destLeft,i=t.img.destTop;if(t.img.destWidth<t.lowerCanvas.width){var a=t.img.destLeft>0?t.img.destLeft:0;e.clearRect(0,0,a,t.lowerCanvas.height),e.clearRect(t.img.destLeft+t.img.destWidth,0,a,t.lowerCanvas.height)}if(t.img.destHeight<t.lowerCanvas.height){var r=t.img.destTop>0?t.img.destTop:0;e.clearRect(0,0,t.lowerCanvas.width,r),e.clearRect(0,t.img.destTop+t.img.destHeight,t.lowerCanvas.width,r)}""!==t.transform.currFlipState&&(t.img.destLeft=o,t.img.destTop=i)},e.prototype.setDestPoints=function(){var e,t=this.parent;if(t.transform.degree%90==0&&t.transform.degree%180!=0){var o={width:0,height:0};t.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:t.img.srcHeight,height:t.img.srcWidth,obj:o}}),e=o,this.isRotateZoom&&(e.width+=e.width*t.transform.zoomFactor,e.height+=e.height*t.transform.zoomFactor,t.img.destWidth=e.height,t.img.destHeight=e.width),t.img.destLeft=(t.lowerCanvas.clientWidth-e.height)/2,t.img.destTop=(t.lowerCanvas.clientHeight-e.width)/2,t.img.destWidth=e.height,t.img.destHeight=e.width}else{o={width:0,height:0};t.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:t.img.srcWidth,height:t.img.srcHeight,obj:o}}),e=o,this.isRotateZoom&&(e.width+=e.width*t.transform.zoomFactor,e.height+=e.height*t.transform.zoomFactor,t.img.destWidth=e.width,t.img.destHeight=e.height),t.img.destLeft=(t.lowerCanvas.clientWidth-e.width)/2,t.img.destTop=(t.lowerCanvas.clientHeight-e.height)/2,t.img.destWidth=e.width,t.img.destHeight=e.height}},e.prototype.updateCurrTransState=function(e,t,o){var i=this.parent,a=i.img.destLeft,r=i.img.destTop;"initial"===e&&(this.lowerContext.setTransform(1,0,0,1,0,0),sf.base.isNullOrUndefined(t)&&this.setDestPoints()),this.currTransState(e,null,null,o),0===i.transform.degree&&""===i.transform.currFlipState&&(i.img.destLeft=a,i.img.destTop=r),(i.isCircleCrop||i.currSelectionPoint&&"crop-circle"===i.currSelectionPoint.shape)&&(o&&(i.img.destLeft+=i.panPoint.totalPannedClientPoint.x,i.img.destTop+=i.panPoint.totalPannedClientPoint.y),i.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),o&&(i.img.destLeft-=i.panPoint.totalPannedClientPoint.x,i.img.destTop-=i.panPoint.totalPannedClientPoint.y))},e.prototype.currTransState=function(e,t,o,i){var a=this.parent;o=o||this.lowerContext,"initial"===e?this.setTransformColl(o,e):"reverse"===e&&(this.setTransformColl(o,e),this.setClientTransDim(t),(a.isCircleCrop||a.currSelectionPoint&&"crop-circle"===a.currSelectionPoint.shape&&sf.base.isNullOrUndefined(i))&&(i&&(a.img.destLeft+=a.panPoint.totalPannedClientPoint.x,a.img.destTop+=a.panPoint.totalPannedClientPoint.y),a.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),i&&(a.img.destLeft-=a.panPoint.totalPannedClientPoint.x,a.img.destTop-=a.panPoint.totalPannedClientPoint.y)))},e.prototype.setTransformColl=function(e,t){var o=this.parent;if("initial"===t)for(var i=0,a=o.rotateFlipColl.length;i<a;i++)this.setTransform(e,o.rotateFlipColl[i]);else if("reverse"===t)for(i=o.rotateFlipColl.length-1;i>=0;i--)this.setTransform(e,o.rotateFlipColl[i],!0)},e.prototype.setTransform=function(e,t,o){var i=this.parent;switch(o&&90===t?t=-90:o&&-90===t&&(t=90),"horizontal"===t&&i.transform.degree%90==0&&i.transform.degree%180!=0?t="vertical":"vertical"===t&&i.transform.degree%90==0&&i.transform.degree%180!=0&&(t="horizontal"),i.notify("transform",{prop:"setReverseRotate",onPropertyChange:!1,value:{bool:!0}}),i.notify("transform",{prop:"setReverseFlip",onPropertyChange:!1,value:{isReverseFlip:!0}}),sf.base.isNullOrUndefined(o)&&e.clearRect(0,0,e.canvas.width,e.canvas.height),t){case 90:case-90:e.translate(e.canvas.width/2,e.canvas.height/2),e.rotate(Math.PI/180*t),e.translate(-e.canvas.width/2,-e.canvas.height/2);break;case"horizontal":e.translate(e.canvas.width,0),e.scale(-1,1);break;case"vertical":e.translate(0,e.canvas.height),e.scale(1,-1)}i.notify("transform",{prop:"setReverseRotate",onPropertyChange:!1,value:{bool:!1}}),i.notify("transform",{prop:"setReverseFlip",onPropertyChange:!1,value:{isReverseFlip:!1}})},e.prototype.drawImgToCanvas=function(e){var t=this.parent;this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),t.img.destWidth=e.width,t.img.destHeight=e.height,this.isInitialLoading&&(t.notify("filter",{prop:"initFilter",onPropertyChange:!1}),this.isInitialLoading=!1);var o=this.lowerContext.filter;t.notify("filter",{prop:"updateBrightFilter",onPropertyChange:!1}),this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),this.lowerContext.drawImage(t.baseImg,t.img.srcLeft,t.img.srcTop,t.img.srcWidth,t.img.srcHeight,t.img.destLeft,t.img.destTop,t.img.destWidth,t.img.destHeight),(t.currSelectionPoint&&"crop-circle"===t.currSelectionPoint.shape||t.isCircleCrop)&&t.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),this.lowerContext.filter=o},e.prototype.renderImage=function(e){var t=this.parent,o=this.lowerContext.filter;t.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:null}}),this.upperContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),e?this.setTransformColl(this.lowerContext,"initial"):(t.transform.zoomFactor>0&&(this.isRotateZoom=!0),this.updateCurrTransState("initial")),t.notify("filter",{prop:"updateBrightFilter",onPropertyChange:!1}),t.notify("transform",{prop:"setDestPointsForFlipState",onPropertyChange:!1}),this.lowerContext.drawImage(t.baseImg,t.img.srcLeft,t.img.srcTop,t.img.srcWidth,t.img.srcHeight,t.img.destLeft,t.img.destTop,t.img.destWidth,t.img.destHeight),t.notify("transform",{prop:"setDestPointsForFlipState",onPropertyChange:!1}),e?this.setTransformColl(this.lowerContext,"reverse"):(this.updateCurrTransState("reverse"),this.isRotateZoom=!1),this.lowerContext.filter="none",t.notify("shape",{prop:"iterateObjColl",onPropertyChange:!1}),t.notify("freehand-draw",{prop:"freehandRedraw",onPropertyChange:!1,value:{context:this.lowerContext,points:null}}),this.lowerContext.filter=o,(t.isCircleCrop||t.currSelectionPoint&&"crop-circle"===t.currSelectionPoint.shape)&&t.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}})},e.prototype.imageOnLoad=function(e){var t=this,o=this.parent,i=this;o.baseImg.src=e,o.baseImg.onload=function(){if(o.notify("filter",{prop:"update-finetunes",onPropertyChange:!1}),i.lowerContext.drawImage(o.baseImg,0,0,i.parent.lowerCanvas.width,i.parent.lowerCanvas.height),sf.popups.hideSpinner(o.element),o.element.style.opacity="1",i.updateCanvas(),o.currObjType.isUndoZoom&&(o.currObjType.isUndoZoom=!1,i.parent.lowerCanvas.style.display="block"),o.isUndoRedo=t.isErrorImage=!1,sf.base.isBlazor())o.updateToolbar(o.element,"imageLoaded","initial"),sf.base.Browser.isDevice&&(o.element.querySelector(".e-bottom-toolbar-area").style.display="block",o.element.querySelector(".e-canvas-wrapper").style.height=o.element.offsetHeight-2*o.toolbarHeight-3+"px");else if(sf.base.Browser.isDevice){o.notify("toolbar",{prop:"destroy-top-toolbar",onPropertyChange:!1}),o.notify("toolbar",{prop:"destroy-bottom-toolbar",onPropertyChange:!1});var e={isApplyBtn:!1,isDevice:sf.base.Browser.isDevice,isOkBtn:null};o.notify("toolbar",{prop:"init-main-toolbar",onPropertyChange:!1,value:e}),o.notify("toolbar",{prop:"create-bottom-toolbar",onPropertyChange:!1})}else{o.notify("toolbar",{prop:"destroy-top-toolbar",onPropertyChange:!1});e={isApplyBtn:!1,isDevice:!1,isOkBtn:null};o.notify("toolbar",{prop:"init-main-toolbar",onPropertyChange:!1,value:e})}},o.baseImg.onerror=function(){sf.popups.hideSpinner(o.element),i.isErrorImage=!0,i.errorLoading()}},e.prototype.errorLoading=function(){var e=this.parent,t={fileName:null,fileType:null,isValidImage:!1};sf.base.isBlazor()&&e.events&&!0===e.events.fileOpened.hasDelegate?e.dotNetRef.invokeMethodAsync("FileOpenEventAsync","FileOpened",t):e.trigger("fileOpened",t)},e.prototype.updateCanvas=function(){var e=this.parent,t={fileName:this.fileName,fileType:this.fileType,isValidImage:!0};e.img.srcWidth=e.baseImg.width,e.img.srcHeight=e.baseImg.height;var o={width:0,height:0};e.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:e.img.srcWidth,height:e.img.srcHeight,obj:o}});var i=o;e.img.destLeft=(e.lowerCanvas.clientWidth-i.width)/2,e.img.destTop=(e.lowerCanvas.clientHeight-i.height)/2,this.drawImgToCanvas(i),this.zoomCrop.width=e.img.destWidth,this.zoomCrop.height=e.img.destHeight,e.notify("transform",{prop:"setCropDimension",onPropertyChange:!1,value:{width:e.img.destWidth,height:e.img.destHeight}});var a={startX:e.img.destLeft,startY:e.img.destTop,width:e.img.destWidth,height:e.img.destHeight};e.notify("crop",{prop:"setCropDestPoints",onPropertyChange:!1,value:{point:a}});var r=this.lowerContext.filter;this.lowerContext.filter="none",e.notify("shape",{prop:"iterateObjColl",onPropertyChange:!1}),e.notify("freehand-draw",{prop:"zoomFHDColl",onPropertyChange:!1,value:{isPreventApply:null}}),this.lowerContext.filter=r,e.img.destWidth>0&&e.img.destHeight>0&&(e.isImageLoaded=!0),e.isUndoRedo&&""!==e.transform.currFlipState&&e.notify("transform",{prop:"flipImage",onPropertyChange:!1,value:{direction:e.toPascalCase(e.transform.currFlipState)}}),e.disabled&&e.element.setAttribute("class","e-disabled"),e.isImageLoaded&&"0.5"!==e.element.style.opacity&&(sf.base.isBlazor()&&e.events&&!0===e.events.fileOpened.hasDelegate?e.dotNetRef.invokeMethodAsync("FileOpenEventAsync","FileOpened",t):e.trigger("fileOpened",t)),(1!==e.zoomSettings.zoomFactor||e.zoomSettings.zoomPoint)&&e.zoom(e.zoomSettings.zoomFactor,e.zoomSettings.zoomPoint),sf.base.isNullOrUndefined(this.initZoomValue)&&(this.initZoomValue=e.zoomSettings.zoomFactor),this.isImageEdited=!1},e.prototype.performCancel=function(e){var t=this.parent;e=e||!1;var o={bool:!1};if(t.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:o}}),o.bool)t.notify("freehand-draw",{prop:"cancelFhd",onPropertyChange:!1}),sf.base.isBlazor()?t.updateToolbar(t.element,"destroyQuickAccessToolbar"):t.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1}),t.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"cancel"}});else if("block"===t.textArea.style.display)t.textArea.style.display="none",t.textArea.value="",t.textArea.style.transform="",this.prevActObj?(t.activeObj=this.prevActObj,this.prevActObj=null):(t.activeObj.strokeSettings=this.tempStrokeSettings,t.activeObj.textSettings=this.tempTextSettings),t.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"cancel"}}),this.isShapeTextInserted&&t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),t.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:!0}}),sf.base.isBlazor()?t.updateToolbar(t.element,"imageLoaded"):t.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1});else if(!sf.base.isBlazor()&&document.querySelector("#"+t.element.id+"_sliderWrapper")||sf.base.isBlazor()&&!t.element.querySelector(".e-ie-contextual-slider").classList.contains("e-hidden")||t.currObjType.isFiltered){this.lowerContext.filter=this.tempAdjValue,t.canvasFilter=this.tempAdjValue,t.notify("filter",{prop:"setAdjustmentValue",onPropertyChange:!1,value:{adjustmentValue:this.tempAdjValue}}),t.initialAdjustmentValue=this.tempAdjValue,this.lowerContext.filter.split(" ").length>1&&"1"===this.lowerContext.filter.split(" ")[0].split("(")[1].split(")")[0]&&t.notify("filter",{prop:"setBrightnessAdjusted",onPropertyChange:!1,value:{isBrightnessAdjusted:!1}}),t.currentFilter=this.tempFilter,this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),this.redrawImgWithObj(),t.currObjType.isFiltered=!1;var i={tempAdjustmentLevel:null};t.notify("filter",{prop:"getTempAdjustmentLevel",onPropertyChange:!1,value:{obj:i}}),t.notify("filter",{prop:"setAdjustmentLevel",onPropertyChange:!1,value:{adjustmentLevel:sf.base.extend({},i.tempAdjustmentLevel,{},!0)}}),t.notify("undo-redo",{prop:"setUndoRedoStep",onPropertyChange:!1,value:{step:this.tempUndoRedoStep}}),t.upperCanvas.style.cursor=t.cursor="default",t.currObjType.isCustomCrop=!1,this.tempStrokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null},this.clearOuterCanvas(this.lowerContext),(t.currSelectionPoint&&"crop-circle"===t.currSelectionPoint.shape||t.isCircleCrop)&&t.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}});var a={type:"main",isApplyBtn:null,isCropping:null,isZooming:null};sf.base.isBlazor()?t.updateToolbar(t.element,"imageLoaded"):(t.element.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hide"),t.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:a})),t.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"cancel"}})}else if(e){a={type:"main",isApplyBtn:null,isCropping:null,isZooming:null};sf.base.isBlazor()?t.updateToolbar(t.element,"imageLoaded"):t.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:a})}else this.cancelItems(),t.togglePan=!1,t.notify("selection",{prop:"setDragCanvas",value:{bool:!1}});this.isShapeTextInserted=!1,this.isNewPath=!1,sf.base.isBlazor()||(t.notify("toolbar",{prop:"refresh-dropdown-btn",value:{isDisabled:!1}}),t.notify("toolbar",{prop:"setCurrentToolbar",value:{type:"main"}}))},e.prototype.cancelItems=function(){var e,t=this.parent,o=!1;void 0!==t.activeObj.shape&&(e=t.activeObj.shape.split("-")),(void 0===e&&t.currObjType.isCustomCrop||void 0!==e&&"crop"===e[0])&&(o=!0),o&&t.isCropTab&&(t.isCropTab=!1,t.transform.zoomFactor=t.transform.defaultZoomFactor),t.togglePen?this.cancelPen():"text"===t.activeObj.shape?this.cancelText(o):-1!==["rectangle","ellipse","line","arrow","path"].indexOf(t.activeObj.shape)?this.cancelShape():o?this.cancelSelection():t.transform.zoomFactor!==this.tempZoomFactor||o&&sf.base.isNullOrUndefined(t.currSelectionPoint)?this.cancelZoom():(t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"cancel"}})),t.notify("selection",{prop:"setCurrentDrawingShape",onPropertyChange:!1,value:{value:""}}),t.upperCanvas.style.cursor=t.cursor="default",t.currObjType.isCustomCrop=!1,this.tempStrokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null};sf.base.isBlazor()?t.updateToolbar(t.element,"imageLoaded"):t.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:null,isCropping:!1,isZooming:null}})},e.prototype.cancelPen=function(){var e=this.parent;this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.togglePen=!1,e.upperCanvas.style.cursor=e.cursor="default";var t=sf.base.extend([],e.pointColl,[],!0);e.pointColl={};for(var o=0;o<this.tempFreehandCounter;o++)e.pointColl[o]=t[o];e.freehandCounter=this.tempFreehandCounter,e.notify("freehand-draw",{prop:"setCurrentFreehandDrawIndex",value:{value:this.tempCurrFhdIndex}}),e.activeObj.strokeSettings=this.tempStrokeSettings,e.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:e.activeObj.strokeSettings,strokeColor:null,fillColor:null,strokeWidth:null}}),e.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"cancel"}}),e.notify("selection",{prop:"setFreehandDrawCustomized",value:{isFreehandDrawCustomized:!1}})},e.prototype.cancelText=function(e){var t=this.parent;if(t.notify("shape",{prop:"setTextSettings",onPropertyChange:!1,value:{textSettings:this.tempTextSettings,fontFamily:null,fontSize:null}}),t.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:this.tempStrokeSettings,strokeColor:null,fillColor:null,strokeWidth:null}}),sf.base.isNullOrUndefined(t.activeObj.currIndex))t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height);else{var o={appliedUndoRedoColl:[]};t.notify("undo-redo",{prop:"getAppliedUndoRedoColl",value:{obj:o}});var i=o.appliedUndoRedoColl.length;this.prevActObj&&o.appliedUndoRedoColl[i-1]&&o.appliedUndoRedoColl[i-1].currentObjColl[o.appliedUndoRedoColl[i-1].currentObjColl.length-1].currIndex===this.prevActObj.currIndex?(t.activeObj=this.prevActObj,this.prevActObj=null):(t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height)),t.activeObj.shape&&"Enter Text"===t.activeObj.keyHistory?(t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.notify("shape",{prop:"draw-shape-text"}),t.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"cancel"}}),t.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:!0}})):t.activeObj.shape&&(t.notify("shape",{prop:"redraw-text"}),t.notify("selection",{prop:"redrawShape",onPropertyChange:!1,value:{obj:t.activeObj}}),e||void 0===t.activeObj.topLeftCircle||t.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:!0}}),t.clearSelection())}sf.base.isBlazor()?t.updateToolbar(t.element,"destroyQuickAccessToolbar"):t.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1}),this.tempTextSettings={text:"Enter Text",fontFamily:"Arial",fontSize:null,fontRatio:null,bold:!1,italic:!1,underline:!1}},e.prototype.cancelShape=function(){var e=this.parent;if(e.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:this.tempStrokeSettings,strokeColor:null,fillColor:null,strokeWidth:null}}),sf.base.isNullOrUndefined(e.activeObj.currIndex))e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height);else if(this.isNewPath)e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),this.renderImage();else{var t={appliedUndoRedoColl:[]};e.notify("undo-redo",{prop:"getAppliedUndoRedoColl",value:{obj:t}});var o=t.appliedUndoRedoColl.length;this.prevActObj&&t.appliedUndoRedoColl[o-1]&&t.appliedUndoRedoColl[o-1].currentObjColl[t.appliedUndoRedoColl[o-1].currentObjColl.length-1].currIndex===this.prevActObj.currIndex?(e.activeObj=this.prevActObj,this.prevActObj=null,e.notify("selection",{prop:"redrawShape",onPropertyChange:!1,value:{obj:e.activeObj}}),e.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"cancel"}}),e.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:!0}})):(e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height))}e.currObjType.isDragging=!1,sf.base.isBlazor()?e.updateToolbar(e.element,"destroyQuickAccessToolbar"):e.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1})},e.prototype.cancelSelection=function(){var e=this.parent;e.cancelCropSelection&&(e.cropObj=sf.base.extend({},e.cancelCropSelection.previousCropObj,{},!0),e.afterCropActions=e.cancelCropSelection.previousObj.afterCropActions,e.notify("undo-redo",{prop:"undoDefault",onPropertyChange:!1,value:{obj:e.cancelCropSelection}}),e.currSelectionPoint=sf.base.extend({},e.cancelCropSelection.previousCropObj.activeObj,!0),e.currSelectionPoint&&sf.base.isNullOrUndefined(e.currSelectionPoint.shape)&&(e.currSelectionPoint=null),this.clearOuterCanvas(this.lowerContext),(e.isCircleCrop||e.currSelectionPoint&&"crop-circle"===e.currSelectionPoint.shape)&&e.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}))},e.prototype.cancelZoom=function(){var e=this.parent,t=e.transform.cropZoomFactor-this.tempZoomFactor;if(e.transform.zoomFactor=e.transform.cropZoomFactor,sf.base.isNullOrUndefined(e.cropObj.activeObj.shape)&&(0===e.transform.degree&&0===e.panPoint.totalPannedPoint.x&&0===e.panPoint.totalPannedPoint.y||0!==e.transform.degree&&0===e.panPoint.totalPannedInternalPoint.x&&0===e.panPoint.totalPannedInternalPoint.y&&0===e.panPoint.totalPannedClientPoint.x&&0===e.panPoint.totalPannedClientPoint.y)){this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),t>0?e.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-t,zoomPoint:null}}):e.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:Math.abs(t),zoomPoint:null}}),e.transform.cropZoomFactor=this.tempZoomFactor,e.currObjType.isCustomCrop=!1,e.upperCanvas.style.cursor=e.cursor="default",e.currObjType.isCustomCrop=!1,this.tempStrokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null};sf.base.isBlazor()?e.updateToolbar(e.element,"imageLoaded"):e.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:null,isCropping:!1,isZooming:null}})}else{if(sf.base.isNullOrUndefined(e.cropObj.activeObj.shape)){if(0===e.transform.degree){var o=sf.base.extend({},e.activeObj,{});e.img.destLeft+=-e.panPoint.totalPannedPoint.x,e.img.destTop+=-e.panPoint.totalPannedPoint.y,e.notify("transform",{prop:"drawPannImage",onPropertyChange:!1,value:{point:{x:-e.panPoint.totalPannedPoint.x,y:-e.panPoint.totalPannedPoint.y}}}),this.updateFlipPan(o),e.panPoint.totalPannedPoint={x:0,y:0}}else e.panPoint.totalPannedClientPoint={x:-e.panPoint.totalPannedClientPoint.x,y:-e.panPoint.totalPannedClientPoint.y},e.panPoint.totalPannedInternalPoint={x:-e.panPoint.totalPannedInternalPoint.x,y:-e.panPoint.totalPannedInternalPoint.y},e.notify("transform",{prop:"rotatePan",onPropertyChange:!1,value:{isCropSelection:!0,isDefaultZoom:null}}),e.panPoint.totalPannedClientPoint={x:0,y:0},e.panPoint.totalPannedInternalPoint={x:0,y:0},e.panPoint.currentPannedPoint={x:0,y:0};e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),t>0?e.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-t,zoomPoint:null}}):e.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:Math.abs(t),zoomPoint:null}}),e.transform.cropZoomFactor=this.tempZoomFactor}else{this.isCancelAction=!0,e.objColl=[],e.pointColl=[];var i=e.freehandCounter;e.freehandCounter=0;var a={selPointColl:null};e.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:a}});var r=a.selPointColl;e.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}});var n=sf.base.extend({},e.cropObj,{}),s=sf.base.extend([],e.afterCropActions,{},!0);this.setCurrentObj(),e.notify("crop",{prop:"cropImg",onPropertyChange:!1,value:{isRotateCrop:null}}),e.cropObj=n,e.afterCropActions=s,e.objColl=sf.base.extend([],this.cancelObjColl,[],!0),e.pointColl=sf.base.extend([],this.cancelPointColl,[],!0),e.freehandCounter=i,e.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:r}}}),e.notify("shape",{prop:"iterateObjColl",onPropertyChange:!1}),e.notify("freehand-draw",{prop:"freehandRedraw",onPropertyChange:!1,value:{context:this.lowerContext,points:null}}),this.clearOuterCanvas(this.lowerContext),e.isCircleCrop&&e.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),this.isCancelAction=!1}e.transform.zoomFactor=e.transform.defaultZoomFactor,sf.base.isBlazor()?e.updateToolbar(e.element,"enableDisableToolbarBtn"):e.notify("toolbar",{prop:"enable-disable-btns",onPropertyChange:!1})}},e.prototype.updateFlipPan=function(e){var t=this.parent;if(""!==t.transform.currFlipState){var o=this.lowerContext.filter;t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),t.notify("transform",{prop:"rotatedFlip",onPropertyChange:!1}),this.lowerContext.filter="none",t.notify("freehand-draw",{prop:"freehandRedraw",onPropertyChange:!1,value:{context:this.lowerContext,points:null}}),this.lowerContext.filter=o,this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),e&&this.drawObject("duplicate",e)}},e.prototype.select=function(e,t,o,i,a){var r=this.parent;if(!r.disabled&&r.isImageLoaded){var n={currObj:{}};r.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:n}});var s=n.currObj;s.objColl=sf.base.extend([],r.objColl,[],!0),s.pointColl=sf.base.extend([],r.pointColl,[],!0),s.afterCropActions=r.afterCropActions;var l={selPointColl:null};r.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:l}}),s.selPointColl=sf.base.extend([],l.selPointColl,[],!0),r.notify("crop",{prop:"setPreviousCropCurrentObj",onPropertyChange:!1,value:{obj:s}}),r.transform.zoomFactor>0&&r.activeObj.shape&&"crop"===r.activeObj.shape.split("-")[0]&&sf.base.isNullOrUndefined(this.currSelPoint)&&(this.currSelPoint=sf.base.extend({},r.activeObj,{},!0));var p=!1,h=void 0;void 0!==r.activeObj.shape&&(h=r.activeObj.shape.split("-")),(void 0===h&&r.currObjType.isCustomCrop||void 0!==h&&"crop"===h[0])&&(p=!0);var c={currObj:{}};r.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:c}});var d=c.currObj;if(d.objColl=sf.base.extend([],r.objColl,[],!0),d.pointColl=sf.base.extend([],r.pointColl,[],!0),d.afterCropActions=sf.base.extend([],r.afterCropActions,[],!0),r.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),r.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),r.notify("shape",{prop:"setKeyHistory",onPropertyChange:!1,value:{keyHistory:""}}),this.upperContext.clearRect(0,0,r.upperCanvas.width,r.upperCanvas.height),r.upperCanvas.style.display="block",r.currSelectionPoint||0!==r.transform.defaultZoomFactor||0!==r.transform.degree&&0!==r.panPoint.totalPannedInternalPoint.x&&0!==r.panPoint.totalPannedInternalPoint.y&&!p){if(r.isCircleCrop=!1,0!==r.transform.defaultZoomFactor){var v=r.isCropTab;r.isCropTab=!1,r.notify("transform",{prop:"resetZoom",onPropertyChange:!1}),r.isCropTab=v,this.resetPanPoints()}this.cancelObjColl=sf.base.extend([],r.objColl,[],!0),this.cancelPointColl=sf.base.extend([],r.pointColl,[],!0),r.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1}),r.isCropTab=!0,r.isCircleCrop=!1,r.notify("crop",{prop:"setCurrSelPoints",onPropertyChange:!1,value:{isSetDimension:!0}}),r.transform.zoomFactor=r.transform.cropZoomFactor,sf.base.isNullOrUndefined(r.cropObj.activeObj.shape)&&(r.currObjType.shape="crop-"+e.toLowerCase(),this.drawNewSelection(e,t,o,i,a))}else"custom"===e&&(r.currObjType.shape=""),this.drawNewSelection(e,t,o,i,a)}},e.prototype.drawNewSelection=function(e,t,o,i,a){var r,n=this.parent,s="crop-"+e;"crop-custom"===s.toLowerCase()?""!==n.currObjType.shape&&"crop-custom"!==n.currObjType.shape||this.drawCustomSelection("crop-custom",t,o,i,a):"crop-canvas"===s.toLowerCase()?(n.upperCanvas.style.display="block",n.notify("selection",{prop:"setDragCanvas",value:{bool:!0}})):(n.currObjType.isCustomCrop=!1,n.currObjType.shape=s.toLowerCase(),i&&a?r={startX:t,startY:o,endX:t+i,endY:o+a,width:i,height:a}:i&&"crop-circle"===s&&(r={startX:t,startY:o,endX:t+i,endY:o+i,width:i,height:i}),n.activeObj.shape=s.toLowerCase(),this.updateSelectionInsert(r))},e.prototype.updateSelectionInsert=function(e){var t=this,o=this.parent,i=o.activeObj.activePoint,a={shapeSettingsObj:{}};o.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:a}});var r={type:o.getSelectionType(a.shapeSettingsObj.type),startX:a.shapeSettingsObj.startX,startY:a.shapeSettingsObj.startY,width:a.shapeSettingsObj.width,height:a.shapeSettingsObj.height},n={action:"insert",previousSelectionSettings:r,currentSelectionSettings:r};sf.base.isBlazor()&&o.events&&!0===o.events.onSelectionResizeStart.hasDelegate?o.dotNetRef.invokeMethodAsync("SelectionEventAsync","OnSelectionResizeStart",n).then((function(a){o.notify("shape",{prop:"updSelChangeEventArgs",onPropertyChange:!1,value:{selectionSettings:a.currentSelectionSettings}}),"Custom"===a.currentSelectionSettings.type?t.drawObject("duplicate",o.activeObj,null,null,!0):(0===i.startX&&0===i.startY&&0===i.width&&0===i.height||(e={startX:i.startX,startY:i.startY,endX:i.endX,endY:i.endY,width:i.width,height:i.height}),t.drawObject("duplicate",null,!0,e))})):(o.trigger("selectionChanging",n),o.notify("shape",{prop:"updSelChangeEventArgs",onPropertyChange:!1,value:{selectionSettings:n.currentSelectionSettings}}),"Custom"===n.currentSelectionSettings.type?this.drawObject("duplicate",o.activeObj,null,null,!0):(0===i.startX&&0===i.startY&&0===i.width&&0===i.height||(e={startX:i.startX,startY:i.startY,endX:i.endX,endY:i.endY,width:i.width,height:i.height}),this.drawObject("duplicate",null,!0,e)))},e.prototype.drawCustomSelection=function(e,t,o,i,a){var r=this.parent,n=r.activeObj.activePoint;if(r.currObjType.isCustomCrop=!0,this.upperContext.clearRect(0,0,r.upperCanvas.width,r.upperCanvas.height),r.currObjType.shape=r.activeObj.shape=e.toLowerCase(),sf.base.isNullOrUndefined(t)||sf.base.isNullOrUndefined(o)||sf.base.isNullOrUndefined(i)||sf.base.isNullOrUndefined(a)){if(sf.base.isNullOrUndefined(r.transform.zoomFactor)||0===r.transform.zoomFactor){var s=r.img.destLeft,l=r.img.destTop,p=r.img.destWidth,h=r.img.destHeight,c=r.lowerCanvas.width,d=r.lowerCanvas.height,v=n;s>=0&&l>=0?(v.startX=s,v.startY=l,v.endX=s+p,v.endY=l+h):s>=0?(v.startX=s,v.startY=7.5,v.endX=s+p,v.endY=d-15):l>=0?(v.startX=7.5,v.startY=l,v.endX=c-15,v.endY=l+h):(v.startX=7.5,v.startY=7.5,v.endX=c-15,v.endY=d-15)}else{var u=r.img.destLeft,b=r.img.destTop,g=r.img.destWidth,f=r.img.destHeight,C=r.lowerCanvas.width,m=r.lowerCanvas.height,y=n;y.startX=Math.max(u>0?u:7.5,u),y.startY=Math.max(b>0?b:7.5,b),y.endX=Math.min(u+g+15<C?u+g-15:C-15,u+g),y.endY=Math.min(b+f+15<m?b+f-15:m-15,b+f)}var P=r.img.destLeft,j=r.img.destTop,O=r.img.destWidth,x=r.img.destHeight,w=r.lowerCanvas.clientWidth,S=r.lowerCanvas.clientHeight,T=n;T.startX=Math.max(T.startX,P),T.startY=Math.max(T.startY,j),T.endX=Math.min(T.endX,P+O),T.endY=Math.min(T.endY,j+x),T.startX===P&&P+O>w&&(T.endX=w-15),T.startY===j&&j+x>S&&(T.endY=S-15),r.activeObj=this.updateWidthHeight(r.activeObj),this.updateActiveObject(n,r.activeObj)}else n.startX=t,n.startY=o,n.endX=t+i,n.endY=o+a,n.width=i,n.height=a;this.updateSelectionInsert()},e.prototype.callUpdateCurrTransState=function(){var e=this.parent,t=sf.base.extend([],e.objColl,[],!0),o=sf.base.extend({},e.activeObj,{},!0);e.objColl=[],e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.isRotateZoom=!0,this.updateCurrTransState("initial"),this.lowerContext.clearRect(0,0,e.lowerCanvas.width,e.lowerCanvas.height),0===e.transform.degree&&e.rotateFlipColl.length>0&&(e.img.destLeft+=e.panPoint.totalPannedPoint.x,e.img.destTop+=e.panPoint.totalPannedPoint.y),e.img.destLeft+=e.panPoint.totalPannedInternalPoint.x,e.img.destTop+=e.panPoint.totalPannedInternalPoint.y;var i=this.lowerContext.filter;0===e.transform.degree&&e.notify("transform",{prop:"setDestPointsForFlipState",onPropertyChange:!1}),e.notify("filter",{prop:"updateBrightFilter",onPropertyChange:!1}),this.lowerContext.drawImage(e.baseImg,e.img.srcLeft,e.img.srcTop,e.img.srcWidth,e.img.srcHeight,e.img.destLeft,e.img.destTop,e.img.destWidth,e.img.destHeight),this.updateCurrTransState("reverse"),0===e.transform.degree&&e.rotateFlipColl.length>0&&(e.img.destLeft+=e.panPoint.totalPannedPoint.x,e.img.destTop+=e.panPoint.totalPannedPoint.y),this.isRotateZoom=!1,e.objColl=t;var a=e.togglePen;e.togglePen=!1,this.lowerContext.filter="none",e.notify("shape",{prop:"iterateObjColl",onPropertyChange:!1}),e.img.destLeft+=e.panPoint.totalPannedInternalPoint.x,e.img.destTop+=e.panPoint.totalPannedInternalPoint.y,e.notify("freehand-draw",{prop:"freehandRedraw",onPropertyChange:!1,value:{context:this.lowerContext,points:null}}),e.img.destLeft-=e.panPoint.totalPannedInternalPoint.x,e.img.destTop-=e.panPoint.totalPannedInternalPoint.y,e.togglePen=a,this.lowerContext.filter=i,e.activeObj=o},e.prototype.resetPanPoints=function(){this.parent.panPoint.totalPannedPoint={x:0,y:0},this.parent.panPoint.totalPannedClientPoint={x:0,y:0},this.parent.panPoint.totalPannedInternalPoint={x:0,y:0}},e.prototype.setClientTransDim=function(e){var t=this.parent;if(t.transform.degree%90==0&&t.transform.degree%180!=0){t.img.destLeft=(t.lowerCanvas.width-t.img.destHeight)/2,t.img.destTop=(t.lowerCanvas.height-t.img.destWidth)/2;var o=t.img.destWidth;t.img.destWidth=t.img.destHeight,t.img.destHeight=o}else sf.base.isNullOrUndefined(e)&&(t.img.destLeft=(t.lowerCanvas.width-t.img.destWidth)/2,t.img.destTop=(t.lowerCanvas.height-t.img.destHeight)/2)},e.prototype.redrawImgWithObj=function(){var e=this.parent,t={canvasFilter:e.canvasFilter};if(this.lowerContext.filter=t.canvasFilter,0!==e.rotateFlipColl.length){var o=sf.base.extend({},e.panPoint.totalPannedInternalPoint,{},!0),i={startX:e.img.destLeft,startY:e.img.destTop,width:e.img.destWidth,height:e.img.destHeight};this.callUpdateCurrTransState(),e.panPoint.totalPannedInternalPoint=o,e.img.destLeft=i.startX,e.img.destTop=i.startY,e.img.destWidth=i.width,e.img.destHeight=i.height}else this.callUpdateCurrTransState();e.isCircleCrop&&e.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}});var a=this.lowerContext.filter;this.lowerContext.filter=e.getDefaultFilter(),e.notify("shape",{prop:"iterateObjColl",onPropertyChange:!1}),e.notify("freehand-draw",{prop:"freehandRedraw",onPropertyChange:!1,value:{context:this.lowerContext,points:null}}),this.lowerContext.filter=a},e.prototype.setCurrentObj=function(e){var t=this.parent,o=!!e;e=e||t.cropObj,t.transform.cropZoomFactor=e.cropZoom,t.transform.defaultZoomFactor=e.defaultZoom,o?e.activeObj.shape&&"crop"===e.activeObj.shape.split("-")[0]?t.transform.zoomFactor=e.cropZoom:t.transform.zoomFactor=e.defaultZoom:t.transform.zoomFactor=e.cropZoom,t.setProperties({zoomSettings:{zoomFactor:e.zoomFactor}},!0),t.notify("transform",{prop:"setPreviousZoomValue",onPropertyChange:!1,value:{previousZoomValue:e.previousZoomValue}}),t.panPoint.totalPannedPoint=sf.base.extend({},e.totalPannedPoint,{},!0),t.panPoint.totalPannedClientPoint=sf.base.extend({},e.totalPannedClientPoint,{},!0),t.panPoint.totalPannedInternalPoint=sf.base.extend({},e.totalPannedInternalPoint,{},!0);var i=sf.base.extend({},e.tempFlipPanPoint,{},!0);t.notify("crop",{prop:"setTempFlipPanPoint",onPropertyChange:!1,value:{point:i}}),t.rotateFlipColl=sf.base.extend([],e.rotateFlipColl,[],!0),t.transform.degree=e.degree,t.transform.currFlipState=e.currFlipState,t.img.destLeft=e.destPoints.startX,t.img.destTop=e.destPoints.startY,t.img.destWidth=e.destPoints.width,t.img.destHeight=e.destPoints.height,t.img.srcLeft=e.srcPoints.startX,t.img.srcTop=e.srcPoints.startY,t.img.srcWidth=e.srcPoints.width,t.img.srcHeight=e.srcPoints.height,e.afterCropActions&&(t.afterCropActions=e.afterCropActions),this.lowerContext.filter=e.filter,t.notify("filter",{prop:"setBrightnessAdjusted",onPropertyChange:!1,value:{isBrightnessAdjusted:!1}});var a,r=t.isCircleCrop;sf.base.isNullOrUndefined(t.currSelectionPoint)?a=null:(a=sf.base.extend({},t.currSelectionPoint,{},!0),t.currSelectionPoint=null),t.isCircleCrop=!1,this.drawCropSelectionImage(e,!1),0!==t.transform.degree&&(""===t.transform.currFlipState?t.notify("transform",{prop:"rotatePan",onPropertyChange:!1,value:{isCropSelection:null,isDefaultZoom:null}}):t.notify("transform",{prop:"drawPannedImage",value:{xDiff:0,yDiff:0}}),t.img.destLeft=e.destPoints.startX,t.img.destTop=e.destPoints.startY,t.panPoint.totalPannedClientPoint=sf.base.extend({},e.totalPannedClientPoint,{},!0),t.panPoint.totalPannedInternalPoint=sf.base.extend({},e.totalPannedInternalPoint,{},!0)),t.activeObj=sf.base.extend({},e.activeObj,{},!0),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),0!==t.activeObj.activePoint.width&&0!==t.activeObj.activePoint.height&&this.drawObject("duplicate",null,null,null,!0);var n=sf.base.extend({},e.activeObj,{},!0),s=!1;if(t.afterCropActions.length>0){var l={collection:t.afterCropActions};t.notify("shape",{prop:"alignRotateFlipColl",onPropertyChange:!1,value:{collection:t.afterCropActions,isRotateFlipCollection:null,obj:l}}),t.afterCropActions=l.collection}var p=sf.base.extend([],t.afterCropActions,[],!0);if(!o&&p.length>0){s=!0;for(var h=0;h<p.length;h++)"horizontalflip"!==p[h]&&"verticalflip"!==p[h]||(t.activeObj=sf.base.extend({},a,{},!0),this.rotatedFlipCropSel=!0),t.notify("transform",{prop:"updateTransform",onPropertyChange:!1,value:{text:p[h]}});n=sf.base.extend({},t.activeObj,{},!0),this.resetPanPoints(),t.activeObj=n,this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),0!==t.activeObj.activePoint.width&&0!==t.activeObj.activePoint.height&&this.drawObject("duplicate",null,null,null,!0),e.degree!==t.transform.degree&&(t.transform.cropZoomFactor=null,t.transform.zoomFactor=0),t.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1}),this.rotatedFlipCropSel&&(this.rotatedFlipCropSel=!1)}t.afterCropActions=p,this.isCancelAction||s||(t.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1}),t.notify("freehand-draw",{prop:"zoomFHDColl",onPropertyChange:!1,value:{isPreventApply:null}}),t.img.destLeft=e.destPoints.startX,t.img.destTop=e.destPoints.startY),t.activeObj=n,t.isCircleCrop=r,sf.base.isNullOrUndefined(a)?t.currSelectionPoint=null:(t.currSelectionPoint=sf.base.extend({},a,{},!0),t.currSelectionPoint&&sf.base.isNullOrUndefined(t.currSelectionPoint.shape)&&(t.currSelectionPoint=null))},e.prototype.drawCropSelectionImage=function(e,t){var o=this.parent,i=this.lowerContext.filter;o.clearContext(this.lowerContext),o.clearContext(this.upperContext),this.lowerContext.setTransform(1,0,0,1,0,0),t?this.updateCurrTransState("initial"):this.setTransformColl(this.lowerContext,"initial"),o.notify("transform",{prop:"setDestPointsForFlipState",onPropertyChange:!1}),this.lowerContext.drawImage(o.baseImg,o.img.srcLeft,o.img.srcTop,o.img.srcWidth,o.img.srcHeight,o.img.destLeft,o.img.destTop,o.img.destWidth,o.img.destHeight),t?this.updateCurrTransState("reverse"):this.setTransformColl(this.lowerContext,"reverse"),o.img.destLeft=o.cropObj.destPoints.startX,o.img.destTop=o.cropObj.destPoints.startY;var a=sf.base.extend({},e.activeObj,{},!0);if(this.lowerContext.filter="none",this.isCancelAction)o.notify("shape",{prop:"zoomObjColl",onPropertyChange:!1,value:{isPreventApply:null}}),o.notify("freehand-draw",{prop:"zoomFHDColl",onPropertyChange:!1,value:{isPreventApply:null}});else{o.img.destLeft=e.destPoints.startX,o.img.destTop=e.destPoints.startY,o.img.destWidth=e.destPoints.width,o.img.destHeight=e.destPoints.height,o.img.srcLeft=e.srcPoints.startX,o.img.srcTop=e.srcPoints.startY,o.img.srcWidth=e.srcPoints.width,o.img.srcHeight=e.srcPoints.height;var r={startX:o.img.destLeft,startY:o.img.destTop,width:o.img.destWidth,height:o.img.destHeight};o.img.destLeft=e.activeObj.activePoint.startX,o.img.destTop=e.activeObj.activePoint.startY,o.img.destWidth=e.activeObj.activePoint.width,o.img.destHeight=e.activeObj.activePoint.height,o.notify("shape",{prop:"zoomObjColl",onPropertyChange:!1,value:{isPreventApply:null}}),o.notify("freehand-draw",{prop:"zoomFHDColl",onPropertyChange:!1,value:{isPreventApply:null}}),o.img.destLeft=r.startX,o.img.destTop=r.startY,o.img.destWidth=r.width,o.img.destHeight=r.height}o.activeObj=a,this.lowerContext.filter=i},e.prototype.performPointZoom=function(e,t,o){var i=this.parent,a=(e-i.img.destLeft)/i.img.destWidth,r=(t-i.img.destTop)/i.img.destHeight,n=i.isUndoRedo;if(i.isUndoRedo=!0,i.setProperties({zoomSettings:{zoomPoint:{x:e,y:t}}},!0),"zoomIn"===o?i.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:.1,zoomPoint:null}}):"zoomOut"===o&&i.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.1,zoomPoint:null}}),i.isUndoRedo=n,i.transform.zoomFactor>0){var s=i.img.destLeft,l=i.img.destTop,p=sf.base.extend({},i.activeObj,{},!0);if(0===i.transform.degree)i.img.destLeft=e-a*i.img.destWidth,i.img.destTop=t-r*i.img.destHeight,this.drawZoomPanImage(i.img.destLeft-s,i.img.destTop-l);else{var h=i.isCropTab;i.isCropTab=!0;var c=sf.base.extend([],i.objColl,[],!0),d=sf.base.extend([],i.pointColl,[],!0);i.objColl=[],i.pointColl=[],i.freehandCounter=0;var v={selPointColl:null};i.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:v}});var u=v.selPointColl;i.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),i.panPoint.currentPannedPoint={x:e-a*i.img.destWidth-s,y:t-r*i.img.destHeight-l},i.notify("transform",{prop:"rotatePan",onPropertyChange:!1,value:{isCropSelection:null,isDefaultZoom:null}}),i.isCropTab=h,i.objColl=c,i.pointColl=d,i.freehandCounter=i.pointColl.length,i.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:u}}}),i.notify("shape",{prop:"panObjColl",onPropertyChange:!1,value:{xDiff:i.panPoint.currentPannedPoint.x,yDiff:i.panPoint.currentPannedPoint.y,panRegion:""}}),i.notify("freehand-draw",{prop:"panFHDColl",onPropertyChange:!1,value:{xDiff:i.panPoint.currentPannedPoint.x,yDiff:i.panPoint.currentPannedPoint.y,panRegion:""}})}this.adjustPanning(p),i.activeObj=p,0!==i.activeObj.activePoint.width&&0!==i.activeObj.activePoint.height&&this.drawObject("duplicate",null,null,null,!0)}},e.prototype.adjustPanning=function(e){var t=this.parent;if(0!==e.activePoint.width&&0!==e.activePoint.height){var o=t.img.destLeft,i=t.img.destTop,a={x:0,y:0};if(t.img.destLeft>e.activePoint.startX?a.x=t.img.destLeft-e.activePoint.startX:t.img.destLeft+t.img.destWidth<e.activePoint.startX+e.activePoint.width&&(a.x=t.img.destLeft+t.img.destWidth-(e.activePoint.startX+e.activePoint.width)),t.img.destTop>e.activePoint.startY?a.y=t.img.destTop-e.activePoint.startY:t.img.destTop+t.img.destHeight<e.activePoint.startY+e.activePoint.height&&(a.y=t.img.destTop+t.img.destHeight-(e.activePoint.startY+e.activePoint.height)),0===t.transform.degree)t.img.destLeft-=a.x,t.img.destTop-=a.y,this.drawZoomPanImage(t.img.destLeft-o,t.img.destTop-i);else{var r=t.isCropTab;t.isCropTab=!0;var n=sf.base.extend([],t.objColl,[],!0),s=sf.base.extend([],t.pointColl,[],!0);t.objColl=[],t.pointColl=[],t.freehandCounter=0;var l={selPointColl:null};t.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:l}});var p=l.selPointColl;t.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),t.img.destLeft-=a.x,t.img.destTop-=a.y,t.panPoint.currentPannedPoint={x:t.img.destLeft-o,y:t.img.destTop-i},t.notify("transform",{prop:"rotatePan",onPropertyChange:!1,value:{isCropSelection:null,isDefaultZoom:null}}),t.isCropTab=r,t.objColl=n,t.pointColl=s,t.freehandCounter=t.pointColl.length,t.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:p}}}),t.notify("shape",{prop:"panObjColl",onPropertyChange:!1,value:{xDiff:t.panPoint.currentPannedPoint.x,yDiff:t.panPoint.currentPannedPoint.y,panRegion:""}}),t.notify("freehand-draw",{prop:"panFHDColl",onPropertyChange:!1,value:{xDiff:t.panPoint.currentPannedPoint.x,yDiff:t.panPoint.currentPannedPoint.y,panRegion:""}})}}},e.prototype.drawZoomPanImage=function(e,t){var o=this.parent;o.notify("shape",{prop:"panObjColl",onPropertyChange:!1,value:{xDiff:e,yDiff:t,panRegion:""}}),o.notify("freehand-draw",{prop:"panFHDColl",onPropertyChange:!1,value:{xDiff:e,yDiff:t,panRegion:""}}),this.renderImage(!0);var i={width:0,height:0};o.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:o.img.srcWidth,height:o.img.srcHeight,obj:i}});var a=i;a.width+=a.width*o.transform.zoomFactor,a.height+=a.height*o.transform.zoomFactor,o.panPoint.totalPannedPoint.x+=e,o.panPoint.totalPannedPoint.y+=t,o.notify("crop",{prop:"setTempFlipPanPoint",onPropertyChange:!1,value:{point:{x:0,y:0}}})},e.prototype.openNewImage=function(){var e=this.parent,t=e.inMemoryCanvas.getContext("2d");sf.popups.showSpinner(e.element),e.element.style.opacity="0.5";var i=document.querySelector("#"+e.element.id+"_currPos");i&&(i.style.display="none");var a={defToolbarItems:null};if(sf.base.isBlazor())e.element.querySelector("#"+e.element.id+"_toolbar")?e.toolbarHeight=e.element.querySelector("#"+e.element.id+"_toolbar").clientHeight:e.toolbarHeight=0;else if(e.notify("toolbar",{prop:"getDefToolbarItems",value:{obj:a}}),0===a.defToolbarItems.length&&sf.base.isNullOrUndefined(document.getElementById(e.element.id+"_toolbar"))){var r=e.element.querySelector("#"+e.element.id+"_toolbarArea").clientHeight;e.notify("toolbar",{prop:"setToolbarHeight",value:{height:r}})}if(e.reset(),e.update(),e.transform.degree=0,e.transform.zoomFactor=0,e.isImageLoaded=!1,e.currSelectionPoint=null,"string"===o(this.openURL)){var n=this.openURL.split(".");if(n.length>1?(n=n[n.length-2].split("/"),this.fileName=n[n.length-1]):this.fileName="ImageEditor",this.fileType=this.getFileExtensionFromURL(this.openURL),this.fileType){this.fileType=e.toPascalCase(this.fileType);var s=this.fileType.toLowerCase();"jpg"!==s&&"jpeg"!==s||(this.fileType="Jpeg",s="jpeg"),"jpeg"!==s&&"png"!==s&&"svg"!==s&&(this.fileType=null)}this.imageOnLoad(this.openURL)}else this.fileName="ImageEditor",this.fileType=null,e.lowerCanvas=document.querySelector("#"+e.element.id+"_lowerCanvas"),e.upperCanvas=document.querySelector("#"+e.element.id+"_upperCanvas"),this.lowerContext=e.lowerCanvas.getContext("2d"),this.upperContext=e.upperCanvas.getContext("2d"),e.clearContext(this.lowerContext),e.clearContext(this.upperContext),e.clearContext(t),e.inMemoryCanvas.width=e.baseImg.width=this.openURL.width,e.inMemoryCanvas.height=e.baseImg.height=this.openURL.height,t.putImageData(this.openURL,0,0),e.baseImg.src=e.inMemoryCanvas.toDataURL()},e.prototype.dlgBtnClick=function(){var e=this.parent;e.export(),this.isFileChanged?(e.isImageLoaded=this.isFileChanged=!1,e.reset(),this.checkToolbarTemplate(this.inputElem,this.openURL)):(this.reset(),this.openNewImage()),sf.base.isBlazor()||sf.base.getComponent(document.getElementById(e.element.id+"_dialog"),"dialog").destroy(),this.isImageEdited=!1},e.prototype.dlgCloseBtnClick=function(){var e=this.parent;this.baseImgSrc=e.baseImg.src,this.isFileChanged?(e.isImageLoaded=this.isFileChanged=!1,e.reset(),this.checkToolbarTemplate(this.inputElem,this.openURL)):(this.reset(),this.openNewImage()),sf.base.isBlazor()||sf.base.getComponent(document.getElementById(e.element.id+"_dialog"),"dialog").destroy(),this.isImageEdited=!1},e.prototype.showDialogPopup=function(){this.parent.element.querySelector("#"+this.parent.element.id+"_dialog").style.display="block",new sf.popups.Dialog({header:"Confirm Save Changes",closeOnEscape:!0,content:"<span>Do you want to save the changes you made to the image?</span>",target:document.getElementById("target"),width:"285px",isModal:!0,animationSettings:{effect:"Zoom"},close:this.dlgCloseBtnClick.bind(this),buttons:[{click:this.dlgCloseBtnClick.bind(this),buttonModel:{content:"No",iconCss:"e-icons e-close"}},{click:this.dlgBtnClick.bind(this),buttonModel:{content:"Yes",isPrimary:!0,iconCss:"e-icons e-check"}}]}).appendTo("#"+this.parent.element.id+"_dialog")},e.prototype.restoreOldImage=function(){this.parent.isImageLoaded?(this.reset(),this.openNewImage()):this.openNewImage()},e.prototype.open=function(e){this.parent.disabled||(this.openURL=e,this.restoreOldImage())},e.prototype.getInitialLoaded=function(e){e.isInitialLoaded=this.isInitialLoading},e.prototype.getFileExtensionFromURL=function(e){var t=e.lastIndexOf(".");return-1!==t?e.slice(t+1).toLowerCase():null},e.prototype.fileSelect=function(e,t){var o=this.parent;if(!o.disabled){var i=t.target.files[0],a=i,r=a.name&&a.name.split(".")[1].toLowerCase();if(r&&-1===["jpg","jpeg","png","svg"].indexOf(r))return void this.errorLoading();if(sf.popups.showSpinner(o.element),o.element.style.opacity="0.5",this.inputElem=e,r=a.name&&a.name.split(".")[1]){var n=o.toPascalCase(r);this.fileType="JPG"===n||"Jpg"===n?"Jpeg":n}else this.fileType=null;var s=window.URL.createObjectURL(i);this.openURL=s,o.isImageLoaded&&(this.isImageEdited||o.pointColl.length>0||o.objColl.length>0)?(this.isFileChanged=!0,sf.base.isBlazor()?o.dotNetRef.invokeMethodAsync("UpdateDialog"):this.showDialogPopup()):this.checkToolbarTemplate(e,s)}},e.prototype.checkToolbarTemplate=function(e,t){var o=this.parent;sf.base.isNullOrUndefined(o.toolbarTemplate)&&(o.reset(),o.update()),this.fileName=e.value.split("\\")[e.value.split("\\").length-1],this.fileName=this.fileName.split(".")[0],this.imageOnLoad(t.toString()),e.value=""},e.prototype.moveToSelectionRange=function(e,t){var o=this.parent;if(o.activeObj.shape&&("rotateleft"===e||"rotateright"===e)){var i=o.transform.zoomFactor;if(o.objColl.push(o.activeObj),o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),o.transform.degree%90==0&&o.transform.degree%180!=0)if(o.objColl[o.objColl.length-1].activePoint.width<t.activePoint.height)for(var a=2;a<o.zoomSettings.maxZoomFactor;a++){if(o.objColl[o.objColl.length-1].activePoint.width>=t.activePoint.height||this.isSelectionBiggerThanCanvas(o.objColl[o.objColl.length-1])||this.isSelectionOutsideCanvas(o.objColl[o.objColl.length-1])){sf.base.isNullOrUndefined(i)||o.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.1,zoomPoint:null}});break}i+=.1,o.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:i,zoomPoint:null}})}else for(a=2;a<o.zoomSettings.maxZoomFactor;a++){if(o.objColl[o.objColl.length-1].activePoint.width>=t.activePoint.height||this.isSelectionBiggerThanCanvas(o.objColl[o.objColl.length-1])||this.isSelectionOutsideCanvas(o.objColl[o.objColl.length-1])){sf.base.isNullOrUndefined(i)||o.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:.1,zoomPoint:null}});break}i-=.1,o.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:i,zoomPoint:null}})}else if(o.objColl[o.objColl.length-1].activePoint.height<t.activePoint.width)for(a=2;a<o.zoomSettings.maxZoomFactor;a++){if(o.objColl[o.objColl.length-1].activePoint.height>=t.activePoint.width||this.isSelectionBiggerThanCanvas(o.objColl[o.objColl.length-1])||this.isSelectionOutsideCanvas(o.objColl[o.objColl.length-1])){sf.base.isNullOrUndefined(i)||o.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.1,zoomPoint:null}});break}i+=.1,o.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:i,zoomPoint:null}})}else for(a=2;a<o.zoomSettings.maxZoomFactor;a++){if(o.objColl[o.objColl.length-1].activePoint.height>=t.activePoint.width||this.isSelectionBiggerThanCanvas(o.objColl[o.objColl.length-1])||this.isSelectionOutsideCanvas(o.objColl[o.objColl.length-1])){sf.base.isNullOrUndefined(i)||o.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:.1,zoomPoint:null}});break}i-=.1,o.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:i,zoomPoint:null}})}var r=o.lowerCanvas.clientWidth/2-(o.objColl[o.objColl.length-1].activePoint.startX+o.objColl[o.objColl.length-1].activePoint.width/2),n=o.lowerCanvas.clientHeight/2-(o.objColl[o.objColl.length-1].activePoint.startY+o.objColl[o.objColl.length-1].activePoint.height/2);0===o.transform.degree?(o.img.destLeft+=r,o.img.destTop+=n,o.notify("transform",{prop:"drawPannImage",value:{point:{x:r,y:n}}})):(o.panPoint.currentPannedPoint={x:r,y:n},o.notify("transform",{prop:"drawPannedImage",value:{xDiff:r,yDiff:n}}),o.panPoint.currentPannedPoint={x:0,y:0}),o.notify("transform",{prop:"setTempPanMove",onPropertyChange:!1,value:{point:null}}),o.activeObj=sf.base.extend({},o.objColl[o.objColl.length-1]),o.objColl.pop(),o.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:o.activeObj}})}},e.prototype.isSelectionBiggerThanCanvas=function(e){var t=!1;return(e.activePoint.startX<=this.parent.img.destLeft||e.activePoint.startY<=this.parent.img.destTop||e.activePoint.endX>=this.parent.img.destLeft+this.parent.img.destWidth||e.activePoint.endY>=this.parent.img.destTop+this.parent.img.destHeight)&&(t=!0),t},e.prototype.isSelectionOutsideCanvas=function(e){var t=!1;return(e.activePoint.height<this.parent.lowerCanvas.height-this.parent.toolbarHeight||e.activePoint.width<this.parent.lowerCanvas.width)&&(t=!0),t},e}(),d=function(){function e(e){this.parent=e,this.addEventListener()}return e.prototype.destroy=function(){this.parent.isDestroyed||this.removeEventListener()},e.prototype.addEventListener=function(){this.parent.on("export",this.export,this),this.parent.on("destroyed",this.destroy,this)},e.prototype.removeEventListener=function(){this.parent.off("export",this.export),this.parent.off("destroyed",this.destroy)},e.prototype.export=function(e){if(sf.base.isBlazor()){var t={shape:""};this.parent.notify("selection",{prop:"getCurrentDrawingShape",onPropertyChange:!1,value:{obj:t}}),""!==t.shape&&(this.parent.notify("selection",{prop:"setCurrentDrawingShape",onPropertyChange:!1,value:{value:""}}),this.parent.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}))}else this.parent.notify("toolbar",{prop:"refreshShapeDrawing",onPropertyChange:!1});switch(this.updatePvtVar(),e.prop){case"export":this.exportImg(e.value.type,e.value.fileName);break;case"exportToCanvas":this.exportToCanvas(e.value.object)}},e.prototype.getModuleName=function(){return"export"},e.prototype.updatePvtVar=function(){var e=this.parent;e.lowerCanvas&&(this.lowerContext=e.lowerCanvas.getContext("2d"))},e.prototype.exportImg=function(e,t){var o=this,i=this.parent,a={fileName:""};i.notify("draw",{prop:"getFileName",onPropertyChange:!1,value:{obj:a}});var r=a.fileName;if(!i.disabled&&i.isImageLoaded){var n={bool:!1};i.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:n}}),n.bool&&i.notify("freehand-draw",{prop:"applyFhd",onPropertyChange:!1}),i.togglePen&&(i.currObjType.isZoomed=!0,i.notify("shape",{prop:"apply",onPropertyChange:!1,value:{shape:null,obj:null,canvas:null}})),"block"===i.textArea.style.display&&i.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),i.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:null}});var s={canvasFilter:this.parent.canvasFilter};this.lowerContext.filter=s.canvasFilter,e=e||"Png",i.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}});var l={cancel:!1,fileName:t||r,fileType:e};sf.base.isBlazor()&&i.events&&!0===i.events.saving.hasDelegate?i.dotNetRef.invokeMethodAsync("BeforeSaveEventAsync","BeforeSave",l).then((function(i){o.beforeSaveEvent(i,e,t,r)})):(i.trigger("beforeSave",l),this.beforeSaveEvent(l,e,t,r))}},e.prototype.beforeSaveEvent=function(e,t,o,i){var a=this.parent;if(!e.cancel){a.currObjType.isSave=!0,o=e.fileName?e.fileName:o;var r=t.toLowerCase();o=o||i,"svg"===r?this.toSVGImg(o):this.toBlobFn(o,r);var n={fileName:o||i,fileType:t};a.trigger("saved",n),sf.base.isBlazor()||a.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1}),a.lowerCanvas.style.left=a.upperCanvas.style.left="",a.lowerCanvas.style.top=a.upperCanvas.style.top="",a.lowerCanvas.style.maxWidth=a.upperCanvas.style.maxWidth="",a.lowerCanvas.style.maxHeight=a.upperCanvas.style.maxHeight=""}},e.prototype.toSVGImg=function(e){var t=this.parent;sf.popups.showSpinner(t.element),t.element.style.opacity="0.5";var o=this.exportToCanvas(),i=o.toDataURL();sf.popups.hideSpinner(t.element),t.element.style.opacity="1";var a=document.createElementNS("http://www.w3.org/2000/svg","svg");a.setAttribute("width",o.style.maxWidth),a.setAttribute("height",o.style.maxHeight);var r=document.createElementNS("http://www.w3.org/2000/svg","image");r.setAttributeNS(null,"height",o.height.toString()),r.setAttributeNS(null,"width",o.width.toString()),r.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",i),a.appendChild(r);var n='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="'+o.width+'" height="'+o.height+'">',s=a.innerHTML,l="data:image/svg+xml;base64,"+btoa(n+s+"</svg>");return null===e?l:(this.downloadImg(l,e+".svg"),null)},e.prototype.toBlobFn=function(e,t){var o=this,i=this.parent;sf.popups.showSpinner(i.element),i.element.style.opacity="0.5",this.exportToCanvas().toBlob((function(a){var r=URL.createObjectURL(a);o.downloadImg(r,e+"."+t),sf.popups.hideSpinner(i.element),i.element.style.opacity="1"}),"image/png")},e.prototype.exportToCanvas=function(e){var t=this.parent,o={width:0,height:0};t.notify("crop",{prop:"calcRatio",onPropertyChange:!1,value:{obj:o}});var i,a=o,r=this.lowerContext.filter;if("none"!==this.lowerContext.filter){var n=this.lowerContext.filter.split(" "),s=parseFloat(n[5].split("(")[1]);s*=(a.width+a.height)/2,n[5]="blur("+s+"px)",this.lowerContext.filter=n.join(" ")}var l=t.createElement("canvas",{id:t.element.id+"_tempCanvas",attrs:{name:"canvasImage"}}),p=l.getContext("2d");if(p.filter=this.lowerContext.filter,t.currSelectionPoint){l.width=t.img.destWidth,l.height=t.img.destHeight,p.filter=this.lowerContext.filter;var h=this.lowerContext.filter;t.notify("filter",{prop:"updateBrightFilter",onPropertyChange:!1}),p.drawImage(t.baseImg,t.img.srcLeft,t.img.srcTop,t.img.srcWidth,t.img.srcHeight,0,0,t.img.destWidth,t.img.destHeight),this.lowerContext.filter=h}else{l.width=t.baseImg.width,l.height=t.baseImg.height;var c={width:0,height:0};t.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:t.baseImg.width,height:t.baseImg.height,obj:c}}),i=c,l.style.maxWidth=i.width+"px",l.style.maxHeight=i.height+"px",p.filter=this.lowerContext.filter;h=this.lowerContext.filter;t.notify("filter",{prop:"updateBrightFilter",onPropertyChange:!1}),p.drawImage(t.baseImg,t.img.srcLeft,t.img.srcTop,t.img.srcWidth,t.img.srcHeight,0,0,t.baseImg.width,t.baseImg.height),this.lowerContext.filter=h}if(0===t.transform.degree&&""===t.transform.currFlipState||(this.updateSaveContext(p),this.exportTransformedImage(p)),t.objColl.length>0){h=p.filter;p.filter="none";for(var d=sf.base.extend([],t.objColl,[],!0),v=0,u=t.objColl.length;v<u;v++){var b=t.objColl[v].activePoint;b.startX-=t.img.destLeft,b.startY-=t.img.destTop,b.endX-=t.img.destLeft,b.endY-=t.img.destTop,b.width=b.endX-b.startX,b.height=b.endY-b.startY,sf.base.isNullOrUndefined(t.currSelectionPoint)&&(b.startX*=a.width,b.startY*=a.height,b.endX*=a.width,b.endY*=a.height,b.width=b.endX-b.startX,b.height=b.endY-b.startY,t.objColl[v].strokeSettings.strokeWidth*=(a.width+a.height)/2,"text"===t.objColl[v].shape&&(t.objColl[v].textSettings.fontSize*=(a.width+a.height)/2)),t.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"saveContext",obj:t.objColl[v],isCropRatio:null,points:null,isPreventDrag:!0,saveContext:p,isPreventSelection:null}})}p.filter=h,t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),t.objColl=d}if(t.freehandCounter>0){for(var g=sf.base.extend({},t.pointColl,{},!0),f=0;f<t.freehandCounter;f++){t.points=sf.base.extend([],t.pointColl[f].points,[]),t.notify("freehand-draw",{prop:"setPointCounter",onPropertyChange:!1,value:{value:0}});u=t.points.length;if(t.currSelectionPoint)for(var C=0;C<u;C++)t.points[C].x-=t.img.destLeft,t.points[C].y-=t.img.destTop;else{t.pointColl[f].strokeWidth*=(a.width+a.height)/2;for(C=0;C<u;C++)t.points[C].x=(t.points[C].x-t.img.destLeft)*a.width,t.points[C].y=(t.points[C].y-t.img.destTop)*a.height}}t.notify("freehand-draw",{prop:"freehandRedraw",onPropertyChange:!1,value:{context:p,points:null}}),t.pointColl=g}return t.isCircleCrop&&t.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:p,isSave:!0,isFlip:null}}),this.lowerContext.filter=r,e&&(e.canvas=l),l},e.prototype.downloadImg=function(e,t){var o=document.createElement("a");o.href=e,o.target="_parent",o.download=t,(document.body||document.documentElement).appendChild(o),o.click(),o.parentNode.removeChild(o)},e.prototype.exportTransformedImage=function(e){for(var t=this.parent,o=t.transform.degree,i=0,a=t.rotateFlipColl.length;i<a;i++){var r=t.rotateFlipColl[i];"number"==typeof r?this.exportRotate(e,r):"horizontal"===r?this.exportFlip(e,!0,!1):"vertical"===r&&this.exportFlip(e,!1,!0)}t.transform.degree=o},e.prototype.exportRotate=function(e,t){var o=this.parent;sf.base.isNullOrUndefined(o.currSelectionPoint)?(this.setMaxDim(o.transform.degree,e.canvas),e.translate(e.canvas.width/2,e.canvas.height/2),e.rotate(Math.PI/180*t),e.drawImage(o.inMemoryCanvas,o.img.srcLeft,o.img.srcTop,o.img.srcWidth,o.img.srcHeight,-e.canvas.height/2,-e.canvas.width/2,e.canvas.height,e.canvas.width)):(e.translate(e.canvas.width/2,e.canvas.height/2),e.rotate(Math.PI/180*t),e.drawImage(o.inMemoryCanvas,-e.canvas.height/2,-e.canvas.width/2,e.canvas.height,e.canvas.width)),this.updateSaveContext(e)},e.prototype.exportFlip=function(e,t,o){t&&(e.translate(e.canvas.width,0),e.scale(-1,1)),o&&(e.translate(0,e.canvas.height),e.scale(1,-1)),e.drawImage(this.parent.inMemoryCanvas,0,0),this.updateSaveContext(e)},e.prototype.updateSaveContext=function(e){var t=this.parent.inMemoryCanvas.getContext("2d");e.setTransform(1,0,0,1,0,0);var o=e.getImageData(0,0,e.canvas.width,e.canvas.height);this.parent.inMemoryCanvas.width=o.width,this.parent.inMemoryCanvas.height=o.height,t.putImageData(o,0,0)},e.prototype.setMaxDim=function(e,t){var o,i;e%90==0&&e%180!=0?(o=this.parent.baseImg.height,i=this.parent.baseImg.width):e%180!=0&&0!==e||(o=this.parent.baseImg.width,i=this.parent.baseImg.height),t.width=o,t.height=i;var a={width:0,height:0};this.parent.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:o,height:i,obj:a}});var r=a;t.style.maxWidth=r.width+"px",t.style.maxHeight=r.height+"px"},e}(),v=function(){function e(e){this.adjustmentLevel={brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,sharpen:!1,bw:!1},this.tempAdjustmentLevel={brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,sharpen:!1,bw:!1},this.adjustmentValue="",this.isBrightnessAdjusted=!1,this.appliedFilter="",this.parent=e,this.addEventListener()}return e.prototype.destroy=function(){this.parent.isDestroyed||this.removeEventListener()},e.prototype.addEventListener=function(){this.parent.on("filter",this.filter,this),this.parent.on("destroyed",this.destroy,this)},e.prototype.removeEventListener=function(){this.parent.off("filter",this.filter),this.parent.off("destroyed",this.destroy)},e.prototype.filter=function(e){switch(this.updatePrivateVariables(),e.prop){case"finetuneImage":this.finetuneImage(e.value.option,e.value.value);break;case"applyImageFilter":this.setFilter(e.value.option);break;case"update-finetunes":this.updateFinetunes();break;case"updateBrightFilter":this.updateBrightFilter();break;case"set-adjustment":this.setAdjustment(e.value.operation);break;case"update-filter":this.updateFilter(e.value.operation,e.value.filter);break;case"initFilter":this.initFilter();break;case"setCurrAdjValue":this.setCurrAdjValue(e.value.type,e.value.value);break;case"updateAdj":this.updateAdj(e.value.type,e.value.value,e.value.isPreview,e.value.ctx);break;case"getCurrentObj":this.getCurrentObj(e.value.object);break;case"getAdjustmentLevel":e.value.obj.adjustmentLevel=this.adjustmentLevel;break;case"setAdjustmentLevel":this.adjustmentLevel=e.value.adjustmentLevel;break;case"getTempAdjustmentLevel":e.value.obj.tempAdjustmentLevel=this.tempAdjustmentLevel;break;case"setTempAdjustmentLevel":this.tempAdjustmentLevel=e.value.tempAdjustmentLevel;break;case"setAdjustmentValue":this.adjustmentValue=e.value.adjustmentValue;break;case"getBrightnessAdjusted":e.value.obj.isBrightnessAdjusted=this.isBrightnessAdjusted;break;case"setBrightnessAdjusted":this.isBrightnessAdjusted=e.value.isBrightnessAdjusted,this.parent.currentFilter.split("_")&&"cold"===this.parent.currentFilter.split("_")[1]&&(this.isBrightnessAdjusted=!1);break;case"reset":this.reset()}},e.prototype.updatePrivateVariables=function(){var e=this.parent;e.lowerCanvas&&(this.lowerContext=e.lowerCanvas.getContext("2d"))},e.prototype.getModuleName=function(){return"filter"},e.prototype.updateBrightFilter=function(){var e=this.lowerContext.filter.split(" ");if(this.isBrightnessAdjusted&&e.length>0&&!sf.base.isNullOrUndefined(e[4])){var t=parseFloat(e[4].split("(")[1]);e[4]="opacity("+(t-.3)+")",this.lowerContext.filter=e.join(" ")}},e.prototype.reset=function(){this.adjustmentLevel={brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,sharpen:!1,bw:!1},this.tempAdjustmentLevel={brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,sharpen:!1,bw:!1},this.adjustmentValue=this.parent.getDefaultFilter(),this.isBrightnessAdjusted=!1,this.appliedFilter=""},e.prototype.updateFinetunes=function(){var e=this.parent,t=e.finetuneSettings;t&&(t.brightness&&(this.adjustmentLevel.brightness=t.brightness.defaultValue,this.tempAdjustmentLevel.brightness=t.brightness.defaultValue),t.contrast&&(this.adjustmentLevel.contrast=t.contrast.defaultValue,this.tempAdjustmentLevel.contrast=t.contrast.defaultValue),t.hue&&(this.adjustmentLevel.hue=t.hue.defaultValue,this.tempAdjustmentLevel.hue=t.hue.defaultValue),t.saturation&&(this.adjustmentLevel.saturation=t.saturation.defaultValue,this.tempAdjustmentLevel.saturation=t.saturation.defaultValue),t.exposure&&(this.adjustmentLevel.exposure=t.exposure.defaultValue,this.tempAdjustmentLevel.exposure=t.exposure.defaultValue),t.opacity&&(this.adjustmentLevel.opacity=t.opacity.defaultValue,this.tempAdjustmentLevel.opacity=t.opacity.defaultValue),t.blur&&(this.adjustmentLevel.blur=t.blur.defaultValue,this.tempAdjustmentLevel.blur=t.blur.defaultValue),e.notify("draw",{prop:"isInitialLoading",onPropertyChange:!1,value:{isInitialLoading:!0}}))},e.prototype.initFilter=function(){this.setFilterAdj("brightness",this.adjustmentLevel.brightness),this.setFilterAdj("contrast",this.adjustmentLevel.contrast),this.setFilterAdj("hue",this.adjustmentLevel.hue),this.setFilterAdj("saturation",this.adjustmentLevel.saturation),this.setFilterAdj("exposure",this.adjustmentLevel.exposure),this.setFilterAdj("opacity",this.adjustmentLevel.opacity),this.setFilterAdj("blur",this.adjustmentLevel.blur)},e.prototype.updateAdj=function(e,t,o,i){var a=this.parent;this.lowerContext.clearRect(0,0,a.lowerCanvas.width,a.lowerCanvas.height);var r,n,s=this.lowerContext.filter.split(" "),l=[];s[4]&&(r=parseFloat(s[4].split("(")[1])),s[0]&&(n=parseFloat(s[0].split("(")[1]));var p,h,c,d,v,u=this.getFilterValue(this.adjustmentLevel.brightness),b=this.getFilterValue(this.adjustmentLevel.saturation);if(-1===["brightness","contrast","hue","saturation","exposure","opacity","blur"].indexOf(e)&&sf.base.isNullOrUndefined(o)&&(this.adjustmentLevel.sharpen||this.adjustmentLevel.bw)){a.isUndoRedo=!0;var g=this.lowerContext.filter;this.lowerContext.filter="none",a.notify("shape",{prop:"iterateObjColl",onPropertyChange:!1}),a.notify("freehand-draw",{prop:"freehandRedraw",onPropertyChange:!1,value:{context:this.lowerContext,points:null}}),this.lowerContext.filter=g,a.isUndoRedo=!1}switch(1!==u&&(s[4]="opacity("+(r-.3)+")"),e){case"brightness":100!==parseFloat(s[3].split("(")[1])&&(t+=.1),s[0]="brightness("+t+")",this.adjustmentValue=s.join(" ");break;case"contrast":s[1]="contrast("+t+"%)",this.adjustmentValue=s.join(" ");break;case"hue":s[2]="hue-rotate("+t+"deg)",this.adjustmentValue=s.join(" ");break;case"saturation":s[3]="saturate("+t+"%)",1!==b&&(s[0]="brightness("+(n+.09)+")"),this.adjustmentValue=s.join(" ");break;case"opacity":1!==parseFloat(s[0].split("(")[1])&&(t-=.2),s[4]="opacity("+t+")",this.adjustmentValue=s.join(" ");break;case"blur":s[5]="blur("+t+"px)",this.adjustmentValue=s.join(" ");break;case"exposure":1!==u&&(s[4]="opacity("+(r-.3)+")"),t>1?(t-=1,t+=u):t<1&&(t=u-(t=1-t)),s[0]="brightness("+t+")",this.adjustmentValue=s.join(" ");break;case"chrome":p=this.getSaturationFilterValue(this.adjustmentLevel.saturation),t=(p*=100)+.4*p,s[3]="saturate("+t+"%)",l=this.adjustmentValue.split(" "),s[0]=l[0],s[1]=l[1],s[2]=l[2],s[4]=l[4],s[5]=l[5],s[6]="sepia(0%)",s[7]="grayscale(0%)",s[8]="invert(0%)";break;case"cold":h=this.getFilterValue(this.adjustmentLevel.brightness),t=.9*(h*=100),t*=.01,s[0]="brightness("+t+")",d=this.getFilterValue(this.adjustmentLevel.contrast),t=(d*=100)+.5*d,s[1]="contrast("+t+"%)",v=this.getSaturationFilterValue(this.adjustmentLevel.saturation),t=v*=100,s[3]="saturate("+t+"%)",l=this.adjustmentValue.split(" "),s[2]=l[2],s[4]=l[4],s[5]=l[5],s[6]="sepia(0%)",s[7]="grayscale(0%)",s[8]="invert(0%)";break;case"warm":c=this.getSaturationFilterValue(this.adjustmentLevel.saturation),t=(c*=100)+.4*c,s[3]="saturate("+t+"%)",s[6]="sepia(25%)",l=this.adjustmentValue.split(" "),s[0]=l[0],s[1]=l[1],s[2]=l[2],s[4]=l[4],s[5]=l[5],s[7]="grayscale(0%)",s[8]="invert(0%)";break;case"grayscale":s[7]="grayscale(100%)",l=this.adjustmentValue.split(" "),s[0]=l[0],s[1]=l[1],s[2]=l[2],s[3]=l[3],s[4]=l[4],s[5]=l[5],s[6]="sepia(0%)",s[8]="invert(0%)";break;case"sepia":s[6]="sepia(100%)",l=this.adjustmentValue.split(" "),s[0]=l[0],s[1]=l[1],s[2]=l[2],s[3]=l[3],s[4]=l[4],s[5]=l[5],s[7]="grayscale(0%)",s[8]="invert(0%)";break;case"invert":s[8]="invert(100%)",l=this.adjustmentValue.split(" "),s[0]=l[0],s[1]=l[1],s[2]=l[2],s[3]=l[3],s[4]=l[4],s[5]=l[5],s[6]="sepia(0%)",s[7]="grayscale(0%)"}if("sharpen"!==e&&"blackandwhite"!==e){sf.base.isNullOrUndefined(o)&&("default"===e&&(s=this.getDefaultCurrentFilter(s)),this.lowerContext.filter=s.join(" ")),s=this.setTempFilterValue(u,o,s,e),a.notify("draw",{prop:"setRotateZoom",onPropertyChange:!1,value:{isRotateZoom:!0}}),a.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,isRotatePan:null}}),this.appliedFilter=this.lowerContext.filter,this.lowerContext.drawImage(a.baseImg,a.img.srcLeft,a.img.srcTop,a.img.srcWidth,a.img.srcHeight,a.img.destLeft,a.img.destTop,a.img.destWidth,a.img.destHeight),a.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,isRotatePan:null}}),a.notify("draw",{prop:"setRotateZoom",onPropertyChange:!1,value:{isRotateZoom:!1}}),1!==u?s[4]="opacity("+r+")":1!==b&&(s[0]="brightness("+n+")"),("exposure"===e&&1!==u||"saturation"===e&&1!==b)&&(s[0]="brightness("+n+")"),s=this.setTempFilterValue(u,o,s,e),sf.base.isNullOrUndefined(o)&&(this.lowerContext.filter=s.join(" ")),a.initialAdjustmentValue=s.join(" ");var f=this.lowerContext.filter;this.lowerContext.filter="brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)",a.notify("shape",{prop:"iterateObjColl",onPropertyChange:!1}),a.notify("freehand-draw",{prop:"freehandRedraw",onPropertyChange:!1,value:{context:this.lowerContext,points:null}}),this.lowerContext.filter=f,a.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),(a.currSelectionPoint&&"crop-circle"===a.currSelectionPoint.shape||a.isCircleCrop)&&a.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),this.isBrightnessAdjusted=1!==u}var C=s.join(" ");i&&(i.filter=C)},e.prototype.setTempFilterValue=function(e,t,o,i){if(t)if("default"===i)o=this.getDefaultCurrentFilter(o);else if(1!==e){var a=this.lowerContext.filter.split(" ");a[4]=o[4],this.lowerContext.filter=a.join(" ")}return o},e.prototype.getDefaultCurrentFilter=function(e){var t=this.adjustmentValue.split(" ");return[t[0],t[1],t[2],t[3],t[4],t[5],"sepia(0%)","grayscale(0%)","invert(0%)"]},e.prototype.getFilterValue=function(e){return 0===e?1:1+.5*e/100},e.prototype.getSaturationFilterValue=function(e){return 0===e?1:1+e/100},e.prototype.setFilterAdj=function(e,t){var o=this.parent;switch(o.notify("freehand-draw",{prop:"apply-pen-draw",onPropertyChange:!1}),this.adjustmentLevel[""+e]=t,e){case"brightness":case"contrast":case"exposure":t=this.getFilterValue(t),"contrast"===e&&(t*=100);break;case"hue":t*=3;break;case"saturation":t=100*this.getSaturationFilterValue(t);break;case"opacity":t>=50?t/=100:40===t?t=.45:30===t?t=.4:20===t?t=.35:10===t?t=.3:0===t&&(t=.25);break;case"blur":0!==t&&(t/=20,t+=.5)}var i=sf.base.extend({},o.cropObj,{},!0),a=this.getCurrentObj();a.objColl=sf.base.extend([],o.objColl,[],!0),a.pointColl=sf.base.extend([],o.pointColl,[],!0),a.afterCropActions=sf.base.extend([],o.afterCropActions,[],!0);var r={selPointColl:null};o.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:r}}),a.selPointColl=sf.base.extend([],r.selPointColl,[],!0),this.updateAdj(e,t);var n=this.lowerContext.filter;this.lowerContext.filter=this.appliedFilter,o.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:e,previousObj:a,previousObjColl:a.objColl,previousPointColl:a.pointColl,previousSelPointColl:a.selPointColl,previousCropObj:i,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.lowerContext.filter=n},e.prototype.setFilter=function(e){var t=this.parent;e=e.toLowerCase(),t.notify("freehand-draw",{prop:"apply-pen-draw",onPropertyChange:!1});var o={currentFilter:this.parent.currentFilter}.currentFilter,i=sf.base.extend({},t.cropObj,{},!0),a=this.getCurrentObj();a.objColl=sf.base.extend([],t.objColl,[],!0),a.pointColl=sf.base.extend([],t.pointColl,[],!0),a.afterCropActions=sf.base.extend([],t.afterCropActions,[],!0);var r={selPointColl:null};t.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:r}}),a.selPointColl=sf.base.extend([],r.selPointColl,[],!0),this.updateAdj(e,null);var n=this.lowerContext.filter;this.lowerContext.filter=this.appliedFilter,t.notify("draw",{prop:"setImageEdited",onPropertyChange:!1}),t.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:e,previousObj:a,previousObjColl:a.objColl,previousPointColl:a.pointColl,previousSelPointColl:a.selPointColl,previousCropObj:i,previousText:null,currentText:null,previousFilter:o,isCircleCrop:null}}),this.lowerContext.filter=n},e.prototype.setAdjustment=function(e){var t,o,i=this.lowerContext.filter.split(" ");switch(e){case"brightness":o=i[0].split("("),t=parseFloat(o[1].split(")")[0]),this.adjustmentLevel.brightness=this.setFilterValue(t);break;case"contrast":o=i[1].split("("),t=parseFloat(o[1].split(")")[0]),t/=100,this.adjustmentLevel.contrast=this.setFilterValue(t);break;case"hue":o=i[2].split("("),t=parseFloat(o[1].split(")")[0]),t/=3,this.adjustmentLevel.hue=t;break;case"saturation":o=i[3].split("("),t=parseFloat(o[1].split(")")[0]),t/=100,this.adjustmentLevel.saturation=this.setSaturationFilterValue(t);break;case"opacity":o=i[4].split("("),.45===(t=parseFloat(o[1].split(")")[0]))?t=40:.4===t?t=30:.35===t?t=20:.3===t?t=10:.25===t?t=0:t*=100,this.adjustmentLevel.opacity=t;break;case"blur":o=i[5].split("("),t=parseFloat(o[1].split(")")[0]),t*=20,this.adjustmentLevel.blur=t;break;case"exposure":o=i[0].split("("),t=parseFloat(o[1].split(")")[0]),this.adjustmentLevel.exposure=this.setFilterValue(t)}},e.prototype.setFilterValue=function(e){return Math.round(1===e?0:100*(e-1)/.5)},e.prototype.setSaturationFilterValue=function(e){return Math.round(1===e?0:100*(e-1))},e.prototype.updateFilter=function(e,t){var o=this.parent;if(-1!==["default","chrome","cold","warm","grayscale","blackandwhite","sepia","invert","sharpen"].indexOf(e)){var i=o.element.querySelector(".e-contextual-toolbar-wrapper .e-toolbar-item.e-selected");i&&i.classList.remove("e-selected");var a=document.getElementById(o.element.id+"_"+e+"Canvas");a&&a.parentElement.classList.add("e-selected"),this.parent.currentFilter=t||o.element.id+"_"+e}},e.prototype.finetuneImage=function(e,t){var o=this.parent;if(!o.disabled&&o.isImageLoaded){switch(e.toLowerCase()){case"brightness":this.setFilterAdj("brightness",t);break;case"contrast":this.setFilterAdj("contrast",t);break;case"hue":this.setFilterAdj("hue",t);break;case"saturation":this.setFilterAdj("saturation",t);break;case"opacity":this.setFilterAdj("opacity",t);break;case"blur":this.setFilterAdj("blur",t);break;case"exposure":this.setFilterAdj("exposure",t)}this.parent.canvasFilter=this.lowerContext.filter,o.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}})}},e.prototype.setCurrAdjValue=function(e,t){switch(this.parent.notify("draw",{prop:"setImageEdited",onPropertyChange:!1}),e){case"brightness":this.setFilterAdj("brightness",t);break;case"contrast":this.setFilterAdj("contrast",t);break;case"hue":this.setFilterAdj("hue",t);break;case"saturation":this.setFilterAdj("saturation",t);break;case"opacity":this.setFilterAdj("opacity",t);break;case"blur":this.setFilterAdj("blur",t);break;case"exposure":this.setFilterAdj("exposure",t)}},e.prototype.getCurrentObj=function(e){var t=this.parent,o={point:null};t.notify("crop",{prop:"getTempFlipPanPoint",value:{obj:o}});var i={previousZoomValue:null};t.notify("transform",{prop:"getPreviousZoomValue",value:{obj:i}});var a={cropZoom:0,defaultZoom:0,totalPannedPoint:{x:0,y:0},totalPannedClientPoint:{x:0,y:0},totalPannedInternalPoint:{x:0,y:0},tempFlipPanPoint:{x:0,y:0},activeObj:{},rotateFlipColl:[],degree:0,currFlipState:"",zoomFactor:0,previousZoomValue:0,destPoints:{startX:0,startY:0,width:0,height:0},srcPoints:{startX:0,startY:0,width:0,height:0},filter:""};return a.cropZoom=t.transform.cropZoomFactor,a.defaultZoom=t.transform.defaultZoomFactor,a.zoomFactor=t.zoomSettings.zoomFactor,a.previousZoomValue=i.previousZoomValue,a.totalPannedPoint=sf.base.extend({},t.panPoint.totalPannedPoint,{},!0),a.totalPannedClientPoint=sf.base.extend({},t.panPoint.totalPannedClientPoint,{},!0),a.totalPannedInternalPoint=sf.base.extend({},t.panPoint.totalPannedInternalPoint,{},!0),a.tempFlipPanPoint=sf.base.extend({},o.point,{},!0),a.activeObj=sf.base.extend({},t.activeObj,{},!0),a.rotateFlipColl=sf.base.extend([],t.rotateFlipColl,[],!0),a.degree=t.transform.degree,a.currFlipState=t.transform.currFlipState,a.destPoints={startX:t.img.destLeft,startY:t.img.destTop,endX:0,endY:0,width:t.img.destWidth,height:t.img.destHeight},a.srcPoints={startX:t.img.srcLeft,startY:t.img.srcTop,endX:0,endY:0,width:t.img.srcWidth,height:t.img.srcHeight},a.filter=this.lowerContext.filter,e&&(e.currObj=a),a},e}(),u=function(){function e(e){this.fhdObj={lastWidth:0,lastVelocity:0,time:0,pointX:0,pointY:0},this.isFreehandDrawing=!1,this.freehandDownPoint={x:0,y:0},this.isFreehandPointMoved=!1,this.pointCounter=0,this.selPointColl={},this.currFHDIdx=0,this.selPoints=[],this.tempFHDStyles={strokeColor:null,fillColor:null,strokeWidth:null},this.parent=e,this.addEventListener()}return e.prototype.destroy=function(){this.parent.isDestroyed||this.removeEventListener()},e.prototype.addEventListener=function(){this.parent.on("freehand-draw",this.draw,this),this.parent.on("destroyed",this.destroy,this)},e.prototype.removeEventListener=function(){this.parent.off("freehand-draw",this.draw),this.parent.off("destroyed",this.destroy)},e.prototype.draw=function(e){switch(this.updateFhdPvtVar(),e.prop){case"hoverFhd":this.hoverFhd(e.value.strokeColor,e.value.strokeWidth);break;case"freehandDownHandler":this.freehandDownHandler(e.value.e,e.value.canvas);break;case"freehandUpHandler":this.freehandUpHandler(e.value.e,e.value.canvas,e.value.context);break;case"handle-freehand-draw":var t=parseInt(e.value.id.split("_")[1],10)-1;this.isFHDIdx(t)&&this.deleteFhd(t,!0);break;case"freehandRedraw":this.freehandRedraw(e.value.context,e.value.points);break;case"deleteFhd":t=parseInt(e.value.id.split("_")[1],10)-1;this.deleteFhd(t,!0);break;case"selectFhd":t=null;e.value.id&&(t=parseInt(e.value.id.split("_")[1],10)-1),this.selectFhd(t);break;case"applyFhd":this.applyFhd();break;case"cancelFhd":this.cancelFhd();break;case"updateFHDCurPts":this.updateFHDCurPts();break;case"rotateFhdColl":this.rotateFhdColl();break;case"flipFHDColl":this.flipFHDColl(e.value.value);break;case"panFHDColl":this.panFHDColl(e.value.xDiff,e.value.yDiff,e.value.panRegion);break;case"updateFHDColl":this.updateFHDColl();break;case"zoomFHDColl":this.zoomFHDColl(e.value.isPreventApply);break;case"apply-pen-draw":this.applyPenDraw();break;case"freeHandDraw":this.freeHandDraw(e.value.value);break;case"isFHDIdx":this.isFHDIdx(e.value.index,e.value.obj);break;case"getSqPtFD":this.getSqPtFD(e.value.idx,e.value.obj);break;case"getSelPointColl":e.value.obj.selPointColl=sf.base.extend([],this.selPointColl);break;case"setSelPointColl":this.selPointColl=sf.base.extend([],e.value.obj.selPointColl);break;case"setFreehandDrawHoveredIndex":this.fhdHovIdx=e.value.index;break;case"getFreehandDrawHoveredIndex":e.value.obj.index=this.fhdHovIdx;break;case"setPointCounter":this.pointCounter=e.value.value;break;case"getPenStrokeWidth":e.value.obj.penStrokeWidth=this.penStrokeWidth;break;case"setPenStrokeWidth":this.penStrokeWidth=e.value.value;break;case"getCurrentFreehandDrawIndex":e.value.obj.currentFreehandDrawIndex=this.currFHDIdx;break;case"setCurrentFreehandDrawIndex":this.currFHDIdx=e.value.value;break;case"updateCropPtsForSel":this.updateCropPtsForSel();break;case"getFreehandDrawSelectedId":e.value.obj.freehandDrawSelectedId=this.fhdSelID;break;case"resetFreehandDrawSelectedId":this.fhdSelID=null;break;case"getTempFreeHandDrawEditingStyles":e.value.obj.tempFreeHandDrawEditingStyles=this.tempFHDStyles;break;case"setFreehandSelectedIndex":this.fhdSelIdx=e.value.index;break;case"getFreehandSelectedIndex":e.value.obj.freehandSelectedIndex=this.fhdSelIdx;break;case"reset":this.reset()}},e.prototype.updateFhdPvtVar=function(){var e=this.parent;e.lowerCanvas&&(this.lowerContext=e.lowerCanvas.getContext("2d")),e.upperCanvas&&(this.upperContext=e.upperCanvas.getContext("2d"))},e.prototype.reset=function(){this.fhdObj={lastWidth:0,lastVelocity:0,time:0,pointX:0,pointY:0},this.isFreehandDrawing=this.isFreehandPointMoved=!1,this.selPoints=[],this.freehandDownPoint={x:0,y:0},this.selPointColl={},this.fhdHovIdx=null,this.pointCounter=0,this.fhdSelID=null,this.penStrokeWidth=void 0,this.currFHDIdx=0,this.fhdSelIdx=null,this.tempFHDStyles={strokeColor:null,fillColor:null,strokeWidth:null}},e.prototype.getModuleName=function(){return"freehand-draw"},e.prototype.hoverFhd=function(e,t){var o=this.parent;o.lowerCanvas=document.querySelector("#"+o.element.id+"_lowerCanvas"),this.lowerContext=o.lowerCanvas.getContext("2d"),o.upperCanvas=document.querySelector("#"+o.element.id+"_upperCanvas"),this.upperContext=o.upperCanvas.getContext("2d");var i=this.upperContext,a=-1;a=this.fhdHovIdx>-1?this.fhdHovIdx:this.fhdSelIdx,o.points=sf.base.extend([],o.pointColl[a].points),this.pointCounter=0;var r,n,s,l,p,h,c=o.points.length;i.fillStyle=e||o.pointColl[a].strokeColor,i.strokeStyle=i.fillStyle,p=h=this.penStrokeWidth=t||o.pointColl[a].strokeWidth,1===c&&(r=n=s=l=o.points[0],this.startDraw(i,r,n,s,l,p,h));for(var d=0;d<c-3;d++)o.points[d+1]&&o.points[d+2]&&o.points[d+2]&&(r=this.calcCurveCP(o.points[d+0],o.points[d+1],o.points[d+2]).controlPoint2,n=this.calcCurveCP(o.points[d+1],o.points[d+2],o.points[d+3]).controlPoint1,s=o.points[d+1],l=o.points[d+2],this.startDraw(i,r,n,s,l,p,h));i.closePath();var v=this.getSqPtFD(a),u=i.lineWidth;i.lineWidth=2,i.strokeStyle=o.themeColl[o.theme].primaryColor,i.beginPath(),i.rect(v.startX,v.startY,v.width,v.height),i.stroke(),i.closePath(),i.lineWidth=u},e.prototype.freehandDownHandler=function(e,t){this.parent.lowerCanvas=document.querySelector("#"+this.parent.element.id+"_lowerCanvas"),this.lowerContext=this.parent.lowerCanvas.getContext("2d"),this.parent.upperCanvas=document.querySelector("#"+this.parent.element.id+"_upperCanvas"),this.upperContext=this.parent.upperCanvas.getContext("2d"),this.fhdObj.time=(new Date).getTime(),this.isFreehandDrawing=!0,"mousedown"===e.type?this.freehandDownPoint={x:e.clientX,y:e.clientY}:this.freehandDownPoint={x:e.touches[0].clientX,y:e.touches[0].clientY},this.isFreehandPointMoved=!1,sf.base.EventHandler.add(t,"mousemove touchmove",this.freehandMoveHandler,this)},e.prototype.freehandUpHandler=function(e,t,o){var i=t.getBoundingClientRect(),a=this.parent;sf.base.EventHandler.remove(t,"mousemove touchmove",this.freehandMoveHandler),0===a.points.length&&("mouseup"===e.type?this.processPoint(e.clientX-i.left,e.clientY-i.top,!0,o):this.isFreehandPointMoved||this.processPoint(this.freehandDownPoint.x-i.left,this.freehandDownPoint.y-i.top,!0,o)),o.closePath();var r=sf.base.extend({},a.cropObj,{},!0),n={currObj:{}};a.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:n}});var s=n.currObj;s.objColl=sf.base.extend([],a.objColl,[],!0),s.pointColl=sf.base.extend([],a.pointColl,[],!0),s.afterCropActions=sf.base.extend([],a.afterCropActions,[],!0);var l={selPointColl:null};a.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:l}}),s.selPointColl=sf.base.extend([],l.selPointColl,[],!0);var p=a.freehandCounter;a.pointColl[p]={},a.pointColl[p].points=sf.base.extend([],a.points),a.pointColl[p].strokeColor=a.activeObj.strokeSettings.strokeColor,a.pointColl[p].strokeWidth=this.penStrokeWidth,a.pointColl[p].flipState=a.transform.currFlipState,a.pointColl[p].id="pen_"+(this.currFHDIdx+1),a.points=[],this.selPointColl[p]={},this.selPointColl[p].points=sf.base.extend([],this.selPoints),this.selPoints=[],this.pointCounter=0,a.freehandCounter++,this.currFHDIdx++,this.isFreehandDrawing=!1,a.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"freehand-draw",previousObj:s,previousObjColl:s.objColl,previousPointColl:s.pointColl,previousSelPointColl:s.selPointColl,previousCropObj:r,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}})},e.prototype.freehandMoveHandler=function(e){this.isFreehandPointMoved=!0;var t,o,i=this.parent.upperCanvas.getBoundingClientRect();"mousemove"===e.type?(t=e.clientX-i.left,o=e.clientY-i.top):(t=e.touches[0].clientX-i.left,o=e.touches[0].clientY-i.top),this.isFreehandDrawing&&this.processPoint(t,o,!1,this.upperContext)},e.prototype.processPoint=function(e,t,o,i){var a,r,n,s,l=this.parent,p=this.point(e,t,(new Date).getTime()),h=!!(p=l.points.length>0&&l.points[l.points.length-1])&&this.distanceTo(p)<=5;if(this.selPoints.push({x:e,y:t,ratioX:(e-l.img.destLeft)/l.img.destWidth,ratioY:(t-l.img.destTop)/l.img.destHeight,time:this.fhdObj.time}),!p||!p||!h||o){if(this.fhdObj.time=(new Date).getTime(),l.points.push({x:e,y:t,ratioX:(e-l.img.destLeft)/l.img.destWidth,ratioY:(t-l.img.destTop)/l.img.destHeight,time:this.fhdObj.time}),l.points.length>3){var c=l.points[this.pointCounter],d=l.points[this.pointCounter+1],v=l.points[this.pointCounter+2],u=l.points[this.pointCounter+3];a=this.calcCurveCP(c,d,v).controlPoint2,r=this.calcCurveCP(d,v,u).controlPoint1,n=l.points[this.pointCounter+1],s=l.points[this.pointCounter+2];var b=.5,g=5;sf.base.isNullOrUndefined(this.penStrokeWidth)||(b=g=this.penStrokeWidth),this.startDraw(i,a,r,n,s,b,g),this.pointCounter++}if(o){a=r=n=s={x:e,y:t,time:(new Date).getTime()};b=.5,g=5;sf.base.isNullOrUndefined(this.penStrokeWidth)||(b=g=this.penStrokeWidth),this.startDraw(i,a,r,n,s,b,g)}}},e.prototype.calcCurveCP=function(e,t,o){t||(t=e),o||(o=t);var i=e.x-t.x,a=e.y-t.y,r=t.x-o.x,n=t.y-o.y,s=(e.x+t.x)/2,l=(e.y+t.y)/2,p=(t.x+o.x)/2,h=(t.y+o.y)/2,c=Math.sqrt(i*i+a*a),d=Math.sqrt(r*r+n*n),v=d/(c+d),u=p+(s-p)*v,b=h+(l-h)*v,g=t.x-u,f=t.y-b;return{controlPoint1:this.point(s+g,l+f,0),controlPoint2:this.point(p+g,h+f,0)}},e.prototype.point=function(e,t,o){return this.fhdObj.pointX=e,this.fhdObj.pointY=t,{x:this.fhdObj.pointX,y:this.fhdObj.pointY,time:o}},e.prototype.startDraw=function(e,t,o,i,a,r,n){var s;s=.7*(s=this.pointVelocity(i))+(1-.7)*this.fhdObj.lastVelocity;var l=Math.max(n/1.7,r);this.drawCurve(this.fhdObj.time,l,e,t,o,i,a,n),this.fhdObj.lastVelocity=s,this.fhdObj.time=l},e.prototype.pointVelocity=function(e){return this.fhdObj.time!==e.time?this.distanceTo(e)/(this.fhdObj.time-e.time):0},e.prototype.distanceTo=function(e){return Math.sqrt(Math.pow(this.fhdObj.pointX-e.x,2)+Math.pow(this.fhdObj.pointY-e.y,2))},e.prototype.drawCurve=function(e,t,o,i,a,r,n,s){var l,p,h,c,d,v,u,b,g,f,C=t-e,m=this.bezierLength(i,a,r,n),y=2*Math.ceil(m);for(o.beginPath(),p=0;p<y;p++)d=(c=(h=p/y)*h)*h,g=(b=(u=(v=1-h)*v)*v)*r.x,g+=3*u*h*i.x,g+=3*v*c*a.x,g+=d*n.x,f=b*r.y,f+=3*u*h*i.y,f+=3*v*c*a.y,f+=d*n.y,l=Math.min(e+d*C,s),this.drawArc(g,f,l,o);o.closePath(),o.fill()},e.prototype.bezierLength=function(e,t,o,i){var a,r,n,s,l,p,h,c,d=0;for(a=0;a<=10;a++)r=a/10,n=this.bezierPoint(r,o.x,e.x,t.x,i.x),s=this.bezierPoint(r,o.y,e.y,t.y,i.y),a>0&&(h=n-l,c=s-p,d+=Math.sqrt(h*h+c*c)),l=n,p=s;return d},e.prototype.bezierPoint=function(e,t,o,i,a){return t*(1-e)*(1-e)*(1-e)+3*o*(1-e)*(1-e)*e+3*i*(1-e)*e*e+a*e*e*e},e.prototype.drawArc=function(e,t,o,i){(e>this.parent.img.destLeft&&t>this.parent.img.destTop&&e<this.parent.img.destLeft+this.parent.img.destWidth&&t<this.parent.img.destTop+this.parent.img.destHeight||i!==this.lowerContext&&i!==this.upperContext)&&(i.moveTo(e,t),i.arc(e,t,o,0,2*Math.PI,!1))},e.prototype.freehandRedraw=function(e,t){var o=this.parent;o.lowerCanvas=document.querySelector("#"+o.element.id+"_lowerCanvas"),this.lowerContext=o.lowerCanvas.getContext("2d"),o.upperCanvas=document.querySelector("#"+o.element.id+"_upperCanvas"),this.upperContext=o.upperCanvas.getContext("2d");var i=e.filter;e.filter="none",t&&(o.pointColl[o.freehandCounter]={},o.pointColl[o.freehandCounter].points=t,o.pointColl[o.freehandCounter].strokeColor=o.activeObj.strokeSettings.strokeColor,o.pointColl[o.freehandCounter].strokeWidth=this.penStrokeWidth,o.pointColl[o.freehandCounter].flipState=o.transform.currFlipState,o.freehandCounter++);for(var a=0;a<o.freehandCounter;a++){o.points=sf.base.extend([],o.pointColl[a].points),this.pointCounter=0;var r=o.points.length,n=void 0,s=void 0,l=void 0,p=void 0,h=void 0,c=void 0;r>0&&(e.fillStyle=o.pointColl[a].strokeColor,h=c=this.penStrokeWidth=o.pointColl[a].strokeWidth),1===r&&(n=s=l=p=o.points[0],this.startDraw(e,n,s,l,p,h,c));for(var d=0;d<r-3;d++)o.points[d+1]&&o.points[d+2]&&o.points[d+2]&&(n=this.calcCurveCP(o.points[d+0],o.points[d+1],o.points[d+2]).controlPoint2,s=this.calcCurveCP(o.points[d+1],o.points[d+2],o.points[d+3]).controlPoint1,l=o.points[d+1],p=o.points[d+2],this.startDraw(e,n,s,l,p,h,c));e.closePath()}e.filter=i},e.prototype.getSqPtFD=function(e,t){var o={startX:0,startY:0,endX:0,endY:0,width:0,height:0},i=sf.base.extend([],this.selPointColl[e].points,[]);this.parent.points=sf.base.extend([],this.parent.pointColl[e].points),this.pointCounter=0;for(var a=i.length,r=0;r<a;r++)0===o.startX&&0===o.startY&&0===o.endX&&0===o.endY?(o.startX=i[r].x,o.startY=i[r].y,o.endX=i[r].x,o.endY=i[r].y):(o.startX=Math.min(o.startX,i[r].x),o.startY=Math.min(o.startY,i[r].y),o.endX=Math.max(o.endX,i[r].x),o.endY=Math.max(o.endY,i[r].y));return o.startX-=this.penStrokeWidth,o.startY-=this.penStrokeWidth,o.endX+=this.penStrokeWidth,o.endY+=this.penStrokeWidth,o.width=o.endX-o.startX,o.height=o.endY-o.startY,t&&(t.activePoint=o),o},e.prototype.applyPenDraw=function(){var e=this.parent;"freehanddraw"===e.currObjType.shape&&(e.notify("shape",{prop:"apply",onPropertyChange:!1,value:{shape:null,obj:null,canvas:null}}),e.upperCanvas.style.cursor=e.cursor="default",e.currObjType.shape=""),e.notify("shape",{prop:"clearActObj"})},e.prototype.applyFhd=function(){var e=this.parent,t=e.pointColl[this.fhdSelIdx];"#42a5f5"===t.strokeColor&&(t.strokeColor=this.tempFHDStyles.strokeColor),sf.base.isBlazor()||e.notify("toolbar",{prop:"setSelectedFreehandColor",value:{color:"#42a5f5"}}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),this.lowerContext.clearRect(0,0,e.lowerCanvas.width,e.lowerCanvas.height),e.notify("draw",{prop:"render-image",value:{isMouseWheel:null}}),sf.base.isBlazor()||e.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1}),t&&(t.isSelected=!1),e.notify("selection",{prop:"resetFreehandDrawVariables"}),this.fhdHovIdx=this.fhdSelIdx=null},e.prototype.cancelFhd=function(){var e=this.parent;sf.base.isBlazor()||e.notify("toolbar",{prop:"setSelectedFreehandColor",value:{color:"#42a5f5"}}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),this.pointCounter=0,e.pointColl[this.fhdSelIdx]&&(e.pointColl[this.fhdSelIdx].strokeColor=this.tempFHDStyles.strokeColor,e.pointColl[this.fhdSelIdx].strokeWidth=this.tempFHDStyles.strokeWidth,e.pointColl[this.fhdSelIdx].isSelected=!1),this.fhdHovIdx=this.fhdSelIdx=this.fhdSelID=null,e.notify("selection",{prop:"resetFreehandDrawVariables"}),e.activeObj.strokeSettings.strokeColor=this.tempFHDStyles.strokeColor,e.activeObj.strokeSettings.strokeWidth=this.penStrokeWidth=this.tempFHDStyles.strokeWidth,this.tempFHDStyles={strokeColor:null,strokeWidth:null,fillColor:null},sf.base.isBlazor()||e.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1})},e.prototype.selectFhd=function(e){var t=this.parent;if(t.notify("selection",{prop:"setFreehandDrawEditing",onPropertyChange:!1,value:{bool:!0}}),e||0===e){if(!this.isFHDIdx(e))return;this.fhdSelIdx=this.fhdHovIdx=e,this.hoverFhd(),t.upperCanvas.style.cursor=t.cursor="pointer"}this.fhdSelIdx=this.fhdHovIdx,t.pointColl[this.fhdSelIdx].isSelected=!0,this.fhdSelID=t.pointColl[this.fhdSelIdx].id,"#42a5f5"!==t.pointColl[this.fhdHovIdx].strokeColor&&(t.activeObj.strokeSettings.strokeColor=this.tempFHDStyles.strokeColor=t.pointColl[this.fhdHovIdx].strokeColor),t.activeObj.strokeSettings.strokeWidth=this.tempFHDStyles.strokeWidth=t.pointColl[this.fhdHovIdx].strokeWidth;var o={bool:!1};t.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:o}}),o.bool?sf.base.isBlazor()||t.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"pen",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}):t.okBtn()},e.prototype.deleteFhd=function(e,t){var o=this.parent;if(this.isFHDIdx(e)){this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height);var i=sf.base.extend({},o.pointColl,{},!0),a=sf.base.extend({},this.selPointColl,{},!0);o.pointColl={},this.selPointColl={};var r=0;if(sf.base.isNullOrUndefined(t))for(var n=0;n<o.freehandCounter;n++)n!==e&&(o.pointColl[r]=i[n],this.selPointColl[r]=a[n],r++);else for(n=0;n<o.freehandCounter;n++)parseInt(i[n].id.split("_")[1],10)-1!==e&&(o.pointColl[r]=i[n],this.selPointColl[r]=a[n],r++);o.freehandCounter-=1,this.fhdHovIdx=this.fhdSelIdx=null,o.notify("selection",{prop:"resetFreehandDrawVariables"}),o.notify("draw",{prop:"render-image",value:{isMouseWheel:!0}}),sf.base.isBlazor()||o.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1})}},e.prototype.zoomX=function(e){return e*this.parent.img.destWidth+this.parent.img.destLeft},e.prototype.zoomY=function(e){return e*this.parent.img.destHeight+this.parent.img.destTop},e.prototype.zoomFHDColl=function(e){for(var t=this.parent,o=0;o<t.freehandCounter;o++){t.points=sf.base.extend([],t.pointColl[o].points,[]),this.pointCounter=0;for(var i=t.points.length,a=0;a<i;a++)t.points[a].x=this.zoomX(t.points[a].ratioX),t.points[a].y=this.zoomY(t.points[a].ratioY)}this.updateFHDCurPts(),sf.base.isNullOrUndefined(e)&&this.freehandRedraw(this.lowerContext,null)},e.prototype.updateFHDCurPts=function(){for(var e=this.parent,t=0;t<e.freehandCounter;t++)if(this.selPointColl[t]){this.selPoints=sf.base.extend([],this.selPointColl[t].points,[]),this.pointCounter=0;for(var o=this.selPoints.length,i=0;i<o;i++)this.selPoints[i].x=this.zoomX(this.selPoints[i].ratioX),this.selPoints[i].y=this.zoomY(this.selPoints[i].ratioY)}},e.prototype.rotateFhdColl=function(){for(var e=this.parent,t=0;t<e.freehandCounter;t++){e.points=sf.base.extend([],e.pointColl[t].points,[]),this.pointCounter=0;for(var o=e.points.length,i=0;i<o;i++)e.points[i].y=e.img.destTop+e.img.destHeight*e.points[i].ratioX,e.points[i].x=e.img.destLeft+e.img.destWidth-e.img.destWidth*e.points[i].ratioY,e.points[i].ratioX=(e.points[i].x-e.img.destLeft)/e.img.destWidth,e.points[i].ratioY=(e.points[i].y-e.img.destTop)/e.img.destHeight}for(t=0;t<e.freehandCounter;t++)if(this.selPointColl[t]){this.selPoints=sf.base.extend([],this.selPointColl[t].points,[]),this.pointCounter=0;for(o=this.selPoints.length,i=0;i<o;i++)this.selPoints[i].y=e.img.destTop+e.img.destHeight*this.selPoints[i].ratioX,this.selPoints[i].x=e.img.destLeft+e.img.destWidth-e.img.destWidth*this.selPoints[i].ratioY,this.selPoints[i].ratioX=(this.selPoints[i].x-e.img.destLeft)/e.img.destWidth,this.selPoints[i].ratioY=(this.selPoints[i].y-e.img.destTop)/e.img.destHeight}this.updateFHDCurPts()},e.prototype.flipFHDColl=function(e){var t=e.toLowerCase();if("horizontal"===t)this.pointsHorizontalFlip();else if("vertical"===t)this.pointsVerticalFlip();else{this.pointsHorizontalFlip();for(var o=0;o<this.parent.freehandCounter;o++)this.parent.pointColl[o].shapeFlip="";this.pointsVerticalFlip()}},e.prototype.pointsHorizontalFlip=function(){for(var e=this.parent,t=0;t<e.freehandCounter;t++)if(e.pointColl[t].shapeFlip!==e.transform.currFlipState){e.points=sf.base.extend([],e.pointColl[t].points,[]),this.pointCounter=0;for(var o=e.points.length,i=0;i<o;i++)e.points[i].x<=e.img.destLeft+e.img.destWidth/2?e.points[i].x=e.img.destLeft+e.img.destWidth-(e.points[i].x-e.img.destLeft):e.points[i].x>=e.img.destLeft+e.img.destWidth/2&&(e.points[i].x=e.img.destLeft+(e.img.destLeft+e.img.destWidth-e.points[i].x)),e.points[i].ratioX=(e.points[i].x-e.img.destLeft)/e.img.destWidth,e.points[i].ratioY=(e.points[i].y-e.img.destTop)/e.img.destHeight;e.pointColl[t].shapeFlip=e.transform.currFlipState}for(t=0;t<e.freehandCounter;t++)if(this.selPointColl[t]&&this.selPointColl[t].shapeFlip!==e.transform.currFlipState){this.selPoints=sf.base.extend([],this.selPointColl[t].points,[]),this.pointCounter=0;for(o=this.selPoints.length,i=0;i<o;i++)this.selPoints[i].x<=e.img.destLeft+e.img.destWidth/2?this.selPoints[i].x=e.img.destLeft+e.img.destWidth-(this.selPoints[i].x-e.img.destLeft):this.selPoints[i].x>=e.img.destLeft+e.img.destWidth/2&&(this.selPoints[i].x=e.img.destLeft+(e.img.destLeft+e.img.destWidth-this.selPoints[i].x)),this.selPoints[i].ratioX=(this.selPoints[i].x-e.img.destLeft)/e.img.destWidth,this.selPoints[i].ratioY=(this.selPoints[i].y-e.img.destTop)/e.img.destHeight}this.updateFHDCurPts()},e.prototype.pointsVerticalFlip=function(){for(var e=this.parent,t=0;t<e.freehandCounter;t++)if(e.pointColl[t].shapeFlip!==e.transform.currFlipState){e.points=sf.base.extend([],e.pointColl[t].points,[]),this.pointCounter=0;for(var o=e.points.length,i=0;i<o;i++)e.points[i].y<=e.img.destTop+e.img.destHeight/2?e.points[i].y=e.img.destTop+e.img.destHeight-(e.points[i].y-e.img.destTop):e.points[i].y>=e.img.destTop+e.img.destHeight/2&&(e.points[i].y=e.img.destTop+(e.img.destTop+e.img.destHeight-e.points[i].y)),e.points[i].ratioX=(e.points[i].x-e.img.destLeft)/e.img.destWidth,e.points[i].ratioY=(e.points[i].y-e.img.destTop)/e.img.destHeight;e.pointColl[t].shapeFlip=e.transform.currFlipState}for(t=0;t<e.freehandCounter;t++)if(this.selPointColl[t]&&this.selPointColl[t].shapeFlip!==e.transform.currFlipState){this.selPoints=sf.base.extend([],this.selPointColl[t].points,[]),this.pointCounter=0;for(o=this.selPoints.length,i=0;i<o;i++)this.selPoints[i].y<=e.img.destTop+e.img.destHeight/2?this.selPoints[i].y=e.img.destTop+e.img.destHeight-(this.selPoints[i].y-e.img.destTop):this.selPoints[i].y>=e.img.destTop+e.img.destHeight/2&&(this.selPoints[i].y=e.img.destTop+(e.img.destTop+e.img.destHeight-this.selPoints[i].y)),this.selPoints[i].ratioX=(this.selPoints[i].x-e.img.destLeft)/e.img.destWidth,this.selPoints[i].ratioY=(this.selPoints[i].y-e.img.destTop)/e.img.destHeight}this.updateFHDCurPts()},e.prototype.updateFHDColl=function(){for(var e=this.parent,t=0;t<e.objColl.length;t++){if(e.objColl[t].imageRatio={startX:(e.objColl[t].activePoint.startX-e.img.destLeft)/e.img.destWidth,startY:(e.objColl[t].activePoint.startY-e.img.destTop)/e.img.destHeight,endX:(e.objColl[t].activePoint.endX-e.img.destLeft)/e.img.destWidth,endY:(e.objColl[t].activePoint.endY-e.img.destTop)/e.img.destHeight,width:e.img.destWidth/e.objColl[t].activePoint.width,height:e.img.destHeight/e.objColl[t].activePoint.height},"path"===e.objColl[t].shape)for(var o=0;o<e.objColl[t].pointColl.length;o++)e.objColl[t].pointColl[o].ratioX=(e.objColl[t].pointColl[o].x-e.img.destLeft)/e.img.destWidth,e.objColl[t].pointColl[o].ratioY=(e.objColl[t].pointColl[o].y-e.img.destTop)/e.img.destHeight;e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1})}for(var i=0;i<e.freehandCounter;i++){e.points=sf.base.extend([],e.pointColl[i].points,[]),this.pointCounter=0;for(var a=e.points.length,r=0;r<a;r++)e.points[r].ratioX=(e.points[r].x-e.img.destLeft)/e.img.destWidth,e.points[r].ratioY=(e.points[r].y-e.img.destTop)/e.img.destHeight}for(i=0;i<e.freehandCounter;i++)if(this.selPointColl[i]){this.selPoints=sf.base.extend([],this.selPointColl[i].points,[]),this.pointCounter=0;for(a=this.selPoints.length,r=0;r<a;r++)this.selPoints[r].ratioX=(this.selPoints[r].x-e.img.destLeft)/e.img.destWidth,this.selPoints[r].ratioY=(this.selPoints[r].y-e.img.destTop)/e.img.destHeight}},e.prototype.panFHDColl=function(e,t,o){for(var i=this.parent,a=0;a<i.freehandCounter;a++){i.points=sf.base.extend([],i.pointColl[a].points,[]),this.pointCounter=0;for(var r=i.points.length,n=0;n<r;n++)""===o||"vertical"===o?i.points[n].x+=e:i.points[n].x-=e,""===o||"horizontal"===o?i.points[n].y+=t:i.points[n].y-=t}for(a=0;a<i.freehandCounter;a++)if(this.selPointColl[a]){this.selPoints=sf.base.extend([],this.selPointColl[a].points,[]),this.pointCounter=0;for(r=this.selPoints.length,n=0;n<r;n++)""===o||"vertical"===o?this.selPoints[n].x+=e:this.selPoints[n].x-=e,""===o||"horizontal"===o?this.selPoints[n].y+=t:this.selPoints[n].y-=t}this.freehandRedraw(this.lowerContext,null)},e.prototype.freeHandDraw=function(e){var t=this.parent;if(e){if(t.points=[],t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),t.togglePen=!0,t.upperCanvas.style.cursor=t.cursor="crosshair",t.upperCanvas.style.display="block",sf.base.isNullOrUndefined(t.activeObj.strokeSettings)){var o={strokeSettings:{}};t.notify("shape",{prop:"getStrokeSettings",onPropertyChange:!1,value:{obj:o}}),t.activeObj.strokeSettings=o.strokeSettings}sf.base.isNullOrUndefined(t.activeObj.strokeSettings.strokeWidth)&&(t.activeObj.strokeSettings.strokeWidth=4),sf.base.isBlazor()?t.updateToolbar(t.element,"pen"):t.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"pen",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}})}else t.upperCanvas.style.cursor=t.cursor="default",t.notify("shape",{prop:"apply",onPropertyChange:!1,value:{shape:null,obj:null,canvas:null}}),sf.base.isBlazor()?t.updateToolbar(t.element,"imageLoaded"):(t.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1}),t.notify("toolbar",{prop:"setCurrentToolbar",value:{type:"main"}})),t.notify("selection",{prop:"setFreehandDrawCustomized",value:{isFreehandDrawCustomized:!1}})},e.prototype.isFHDIdx=function(e,t){for(var o=!1,i=0;i<this.parent.freehandCounter;i++)if(this.parent.pointColl[i].id&&parseInt(this.parent.pointColl[i].id.split("_")[1],10)-1===e){o=!0;break}return t&&(t.isIndex=o),o},e.prototype.updateCropPtsForSel=function(){for(var e=this.parent,t=0;t<e.freehandCounter;t++){var o={selPointColl:sf.base.extend([],this.selPointColl)};if(o.selPointColl[t]){this.selPoints=sf.base.extend([],o.selPointColl[t].points,[]),this.pointCounter=0;for(var i=this.selPoints.length,a=0;a<i;a++)this.selPoints[a].ratioX=(this.selPoints[a].x-e.activeObj.activePoint.startX)/e.activeObj.activePoint.width,this.selPoints[a].ratioY=(this.selPoints[a].y-e.activeObj.activePoint.startY)/e.activeObj.activePoint.height}}},e}(),b=function(){function e(e){this.diffPoint={x:0,y:0},this.oldPoint={},this.isTouch=!1,this.isObjSelected=!1,this.isFhdPoint=!1,this.dragPoint={startX:0,startY:0,endX:0,endY:0},this.isShapeInserted=!1,this.tempActiveObj={activePoint:{startX:0,startY:0,endX:0,endY:0,width:0,height:0},flipObjColl:[],triangle:[],triangleRatio:[]},this.isFirstMove=!1,this.startTouches=[],this.tempTouches=[],this.currMousePoint={x:0,y:0},this.cursorTargetId="",this.isPreventDragging=!1,this.dragElement="",this.textRow=1,this.mouseDownPoint={x:0,y:0},this.previousPoint={x:0,y:0},this.zoomType="Toolbar",this.isInitialTextEdited=!1,this.dragCanvas=!1,this.isFhdCustomized=!1,this.touchEndPoint={},this.isFhdEditing=!1,this.currentDrawingShape="",this.initialPrevObj={},this.touchTime=0,this.resizedElement="",this.parent=e,this.addEventListener()}return e.prototype.destroy=function(){this.parent.isDestroyed||this.removeEventListener()},e.prototype.addEventListener=function(){this.parent.on("selection",this.selection,this),this.parent.on("destroyed",this.destroy,this)},e.prototype.removeEventListener=function(){this.parent.off("selection",this.selection),this.parent.off("destroyed",this.destroy)},e.prototype.selection=function(e){var t=this;switch(this.updatePrivateVariables(),e.prop){case"mouse-up":this.selMouseUpEvent();break;case"setCursor":this.setCursor(e.value.x,e.value.y);break;case"updateActivePoint":this.updateActivePoint(e.value.x,e.value.y,e.value.isCropSelection);break;case"updateCursorStyles":this.updateCursorStyles(e.value.x,e.value.y,e.value.type);break;case"setTextSelection":this.setTextSelection(e.value.width,e.value.height);break;case"setActivePoint":this.setActivePoint(e.value.startX,e.value.startY);break;case"clearSelection":this.clearSelection();break;case"calcShapeRatio":this.calcShapeRatio(e.value.x,e.value.y,e.value.imgWidth,e.value.imgHeight);break;case"applyCurrShape":this.applyCurrShape(e.value.isShapeClick);break;case"tab":this.performTabAction();break;case"setDragDirection":this.setDragDirection(e.value.width,e.value.height);break;case"clearUpperCanvas":this.isTouch&&setTimeout((function(){t.parent.upperCanvas.getContext("2d").clearRect(0,0,t.parent.upperCanvas.width,t.parent.upperCanvas.height)}),550);break;case"resetFreehandDrawVariables":this.isFhdEditing=this.isFhdPoint=!1;break;case"isShapeInserted":this.isShapeInserted=e.value.bool;break;case"redrawShape":this.redrawShape(e.value.obj);break;case"setTextBoxStylesToActObj":this.setTextBoxStylesToActObj();break;case"mouseDownEventHandler":this.mouseDownEventHandler(e.value.e);break;case"mouseMoveEventHandler":this.mouseMoveEventHandler(e.value.e);break;case"mouseUpEventHandler":this.mouseUpEventHandler(e.value.e);break;case"canvasMouseDownHandler":this.canvasMouseDownHandler(e.value.e);break;case"canvasMouseMoveHandler":this.canvasMouseMoveHandler(e.value.e);break;case"canvasMouseUpHandler":this.canvasMouseUpHandler(e.value.e);break;case"touchStartHandler":this.touchStartHandler(e.value.e);break;case"keyDownEventHandler":this.keyDownEventHandler(e.value.e);break;case"handleScroll":this.handleScroll(e.value.e);break;case"textKeyDown":setTimeout(this.textKeyDown.bind(this),1,e.value.e);break;case"deleteItem":this.deleteItem();break;case"updatePrevShapeSettings":this.updatePrevShapeSettings(e.value.obj);break;case"getZoomType":e.value.obj.zoomType=this.zoomType;break;case"setZoomType":this.zoomType=e.value.zoomType;break;case"setInitialTextEdit":this.isInitialTextEdited=e.value.bool;break;case"setDragCanvas":this.dragCanvas=e.value.bool;break;case"setFreehandDrawCustomized":this.isFhdCustomized=e.value.isFreehandDrawCustomized;break;case"setTouchEndPoint":this.touchEndPoint.x=e.value.x,this.touchEndPoint.y=e.value.y;break;case"getPanDown":e.value.obj.panDown=this.panDown;break;case"setPanDown":this.panDown=e.value.panDown;break;case"getFreehandDrawEditing":e.value.obj.bool=this.isFhdEditing;break;case"setFreehandDrawEditing":this.isFhdEditing=e.value.bool;break;case"getTempActObj":e.value.obj.tempObj=this.tempActiveObj;break;case"setTempActObj":this.tempActiveObj=e.value.obj;break;case"isInside":this.isInside(e.value.x,e.value.y,e.value.z1,e.value.z2,e.value.z3,e.value.z4);break;case"setDragElement":this.dragElement=e.value.value;break;case"setObjSelected":this.isObjSelected=e.value.bool;break;case"adjustActObjForLineArrow":this.adjustActObjForLineArrow(e.value.obj);break;case"findTarget":this.findTarget(e.value.x,e.value.y,e.value.type);break;case"getCurrentFlipState":this.getCurrentFlipState();break;case"setDragWidth":this.setDragWidth(e.value.width);break;case"setDragHeight":this.setDragHeight(e.value.setDragHeight);break;case"annotate":this.currentDrawingShape=e.value.shape,"text"===e.value.shape?(this.parent.activeObj.textSettings.fontSize=100,this.parent.activeObj.keyHistory="Enter Text",this.parent.notify("shape",{prop:"initializeTextShape",onPropertyChange:!1,value:{text:null,fontFamily:null,fontSize:null,bold:null,italic:null,strokeColor:null}})):"path"===e.value.shape&&(this.parent.activeObj.pointColl=[]);break;case"getCurrentDrawingShape":e.value.obj.shape=this.currentDrawingShape;break;case"setCurrentDrawingShape":this.currentDrawingShape=e.value.value;break;case"getTransRotationPoint":this.getTransRotationPoint(e.value.obj,e.value.object);break;case"reset":this.reset()}},e.prototype.getModuleName=function(){return"selection"},e.prototype.updatePrivateVariables=function(){var e=this.parent;e.lowerCanvas&&(this.lowerContext=e.lowerCanvas.getContext("2d")),e.upperCanvas&&(this.upperContext=e.upperCanvas.getContext("2d"))},e.prototype.reset=function(){this.diffPoint={x:0,y:0},this.oldPoint={},this.isTouch=this.isObjSelected=this.isFhdPoint=this.isShapeInserted=!1,this.dragPoint={startX:0,startY:0,endX:0,endY:0},this.tempActiveObj={activePoint:{startX:0,startY:0,endX:0,endY:0,width:0,height:0},flipObjColl:[],triangle:[],triangleRatio:[]},this.isFirstMove=!1,this.cursorTargetId=this.dragElement="",this.startTouches=[],this.tempTouches=[],this.currMousePoint={x:0,y:0},this.isPreventDragging=!1,this.timer=void 0,this.tempObjColl=void 0,this.textRow=1,this.mouseDownPoint={x:0,y:0},this.previousPoint={x:0,y:0},this.zoomType="Toolbar",this.isInitialTextEdited=!1,this.dragCanvas=!1,this.isFhdCustomized=!1,this.touchEndPoint={},this.panDown=null,this.isFhdEditing=!1,this.pathAdjustedIndex=null,this.touchTime=0,this.currentDrawingShape="",this.initialPrevObj={},this.resizedElement=""},e.prototype.performTabAction=function(){if("block"===this.parent.textArea.style.display){var e=this.applyCurrShape(!1);this.parent.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),e&&this.parent.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}})}},e.prototype.selMouseUpEvent=function(){this.oldPoint.x=void 0,this.oldPoint.y=void 0},e.prototype.getMouseCursor=function(e,t,o,i,a){var r=this.getTransRotationPoint(e),n=a?0:2*e.topLeftCircle.radius;return t>=e.topLeftCircle.startX-n&&t<=e.topLeftCircle.startX+n&&o>=e.topLeftCircle.startY-n&&o<=e.topLeftCircle.startY+n?"nw-resize":t>=e.topLeftCircle.startX-n&&t<=e.topRightCircle.startX-n&&o>=e.topCenterCircle.startY-n&&o<=e.topCenterCircle.startY+n?"n-resize":t>=e.topRightCircle.startX-n&&t<=e.topRightCircle.startX+n&&o>=e.topRightCircle.startY-n&&o<=e.topRightCircle.startY+n?"ne-resize":t>=e.centerLeftCircle.startX-n&&t<=e.centerLeftCircle.startX+n&&o>=e.topLeftCircle.startY-n&&o<=e.bottomLeftCircle.startY-n?"w-resize":t>=e.centerRightCircle.startX-n&&t<=e.centerRightCircle.startX+n&&o>=e.topRightCircle.startY-n&&o<=e.bottomRightCircle.startY-n?"e-resize":t>=e.bottomLeftCircle.startX-n&&t<=e.bottomLeftCircle.startX+n&&o>=e.bottomLeftCircle.startY-n&&o<=e.bottomLeftCircle.startY+n?"sw-resize":t>=e.bottomLeftCircle.startX-n&&t<=e.bottomRightCircle.startX-n&&o>=e.bottomCenterCircle.startY-n&&o<=e.bottomCenterCircle.startY+n?"s-resize":t>=e.bottomRightCircle.startX-n&&t<=e.bottomRightCircle.startX+n&&o>=e.bottomRightCircle.startY-n&&o<=e.bottomRightCircle.startY+n?"se-resize":t>=e.activePoint.startX&&t<=e.activePoint.endX&&o>=e.activePoint.startY&&o<=e.activePoint.endY?i?"grab":"move":r&&!a&&t>=r.x-(e.bottomCenterCircle.radius+2)&&t<=r.x+(e.bottomCenterCircle.radius+2)&&o>=r.y-(e.bottomCenterCircle.radius+2)&&o<=r.y+(e.bottomCenterCircle.radius+2)?"grabbing":"default"},e.prototype.setCursor=function(e,t){var o,i=this.parent,a=document.querySelector("#"+i.element.id+"_lowerCanvas"),r=document.querySelector("#"+i.element.id+"_upperCanvas"),n=!1;if(""===this.currentDrawingShape)if(i.currObjType.isDragging)""===this.dragElement?r.style.cursor=i.cursor="move":r.style.cursor=i.cursor=this.dragElement;else{if(void 0!==i.activeObj.horTopLine){void 0!==i.activeObj.shape&&(o=i.activeObj.shape.split("-")),(void 0===o&&i.currObjType.isCustomCrop||void 0!==o&&"crop"===o[0])&&(n=!0),!n&&i.togglePan&&(a.style.cursor=r.style.cursor=i.cursor="grab");var s=r.style.cursor,l=sf.base.extend({},i.activeObj,{},!0);this.cursorTargetId=l.currIndex;var p=void 0;(p=0===l.shapeDegree?i.transform.degree:i.transform.degree-l.shapeDegree)<0&&(p=360+p),"line"===l.shape||"arrow"===l.shape?this.setCursorForLineArrow(l,e,t,r):"path"===l.shape?this.setCursorForPath(l,e,t,r):sf.base.isNullOrUndefined(l.rotatedAngle)||0===l.rotatedAngle?(r.style.cursor=i.cursor=this.getMouseCursor(l,e,t,n,!1),"text"!==l.shape||"n-resize"!==i.cursor&&"s-resize"!==i.cursor&&"e-resize"!==i.cursor&&"w-resize"!==i.cursor||(r.style.cursor=i.cursor="move")):this.setCursorForRotatedObject(l,e,t,r),"default"===s&&"default"===i.cursor&&n&&(r.style.cursor=i.cursor="grab"),"grab"===s&&"default"===i.cursor&&(r.style.cursor=i.cursor="grab")}else i.togglePan&&!i.togglePen?a.style.cursor=r.style.cursor=i.cursor="grab":i.currObjType.isCustomCrop||i.togglePen?r.style.cursor=i.cursor="crosshair":r.style.cursor=i.cursor="default";if("default"===i.cursor||"grab"===i.cursor){s=r.style.cursor;i.objColl.length>0&&("grab"!==i.cursor||!n)&&this.setCursorFromObj(e,t,i.objColl,r,n),"grab"===s&&"default"===i.cursor&&(r.style.cursor=i.cursor="grab")}"default"!==i.cursor&&"grab"!==i.cursor||!i.pointColl[0]||"grab"===i.cursor&&n||i.currObjType.isDragging||i.currObjType.isResize||this.setCursorForFreehandDrawing(e,t,r)}else r.style.cursor=i.cursor="crosshair"},e.prototype.setCursorForPath=function(e,t,o,i){this.setCursorForLineArrow(e,t,o,i);var a=this.parent;if("default"===a.cursor)for(var r=sf.base.extend({},e,null,!0),n=!1,s=1;s<e.pointColl.length&&!n;s++){r.activePoint.startX=e.pointColl[s-1].x,r.activePoint.startY=e.pointColl[s-1].y,r.activePoint.endX=e.pointColl[s].x,r.activePoint.endY=e.pointColl[s].y,a.notify("shape",{prop:"setPointCollForLineArrow",onPropertyChange:!1,value:{obj:r}});for(var l=0;l<r.pointColl.length;l++){var p=r.pointColl[l];if(!sf.base.isNullOrUndefined(p.x-2*e.topLeftCircle.radius)&&!sf.base.isNullOrUndefined(p.x+2*e.topLeftCircle.radius)&&!sf.base.isNullOrUndefined(p.y-2*e.topLeftCircle.radius)&&!sf.base.isNullOrUndefined(p.y+2*e.topLeftCircle.radius)&&t>=p.x-2*e.topLeftCircle.radius&&t<=p.x+2*e.topLeftCircle.radius&&o>=p.y-2*e.topLeftCircle.radius&&o<=p.y+2*e.topLeftCircle.radius){i.style.cursor=a.cursor="move",n=!0;break}i.style.cursor=a.cursor="default"}}return a.cursor},e.prototype.setCursorForLineArrow=function(e,t,o,i){for(var a,r=0;r<e.pointColl.length;r++){var n=e.pointColl[r];if(t>=n.x-2*e.topLeftCircle.radius&&t<=n.x+2*e.topLeftCircle.radius&&o>=n.y-2*e.topLeftCircle.radius&&o<=n.y+2*e.topLeftCircle.radius){i.style.cursor=this.parent.cursor="move",a=r;break}i.style.cursor=this.parent.cursor="default"}return a},e.prototype.setCursorForRotatedObject=function(e,t,o,i){this.resizedElement="";var a=this.parent;if(t>=e.horTopLinePointColl[0].x-(e.bottomCenterCircle.radius+2)&&t<=e.horTopLinePointColl[0].x+(e.bottomCenterCircle.radius+2)&&o>=e.horTopLinePointColl[0].y-(e.bottomCenterCircle.radius+2)&&o<=e.horTopLinePointColl[0].y+(e.bottomCenterCircle.radius+2))i.style.cursor=a.cursor="nw-resize";else if(t>=e.horTopLinePointColl[Math.round(e.horTopLinePointColl.length/2)].x-5&&t<=e.horTopLinePointColl[Math.round(e.horTopLinePointColl.length/2)].x+5&&o>=e.horTopLinePointColl[Math.round(e.horTopLinePointColl.length/2)].y-5&&o<=e.horTopLinePointColl[Math.round(e.horTopLinePointColl.length/2)].y+5)i.style.cursor=a.cursor=this.resizedElement="n-resize";else if(t>=e.horTopLinePointColl[Math.round(e.horTopLinePointColl.length-1)].x-(e.bottomCenterCircle.radius+2)&&t<=e.horTopLinePointColl[Math.round(e.horTopLinePointColl.length-1)].x+(e.bottomCenterCircle.radius+2)&&o>=e.horTopLinePointColl[Math.round(e.horTopLinePointColl.length-1)].y-(e.bottomCenterCircle.radius+2)&&o<=e.horTopLinePointColl[Math.round(e.horTopLinePointColl.length-1)].y+(e.bottomCenterCircle.radius+2))i.style.cursor=a.cursor="ne-resize";else if(t>=e.verLeftLinePointColl[Math.round(e.verLeftLinePointColl.length/2)].x-5&&t<=e.verLeftLinePointColl[Math.round(e.verLeftLinePointColl.length/2)].x+5&&o>=e.verLeftLinePointColl[Math.round(e.verLeftLinePointColl.length/2)].y-5&&o<=e.verLeftLinePointColl[Math.round(e.verLeftLinePointColl.length/2)].y+5)i.style.cursor=a.cursor=this.resizedElement="w-resize";else if(t>=e.verRightLinePointColl[Math.round(e.verRightLinePointColl.length/2)].x-5&&t<=e.verRightLinePointColl[Math.round(e.verRightLinePointColl.length/2)].x+5&&o>=e.verRightLinePointColl[Math.round(e.verRightLinePointColl.length/2)].y-5&&o<=e.verRightLinePointColl[Math.round(e.verRightLinePointColl.length/2)].y+5)i.style.cursor=a.cursor=this.resizedElement="e-resize";else if(t>=e.horBottomLinePointColl[0].x-(e.bottomCenterCircle.radius+2)&&t<=e.horBottomLinePointColl[0].x+(e.bottomCenterCircle.radius+2)&&o>=e.horBottomLinePointColl[0].y-(e.bottomCenterCircle.radius+2)&&o<=e.horBottomLinePointColl[0].y+(e.bottomCenterCircle.radius+2))i.style.cursor=a.cursor="sw-resize";else if(t>=e.horBottomLinePointColl[Math.round(e.horBottomLinePointColl.length/2)].x-5&&t<=e.horBottomLinePointColl[Math.round(e.horBottomLinePointColl.length/2)].x+5&&o>=e.horBottomLinePointColl[Math.round(e.horBottomLinePointColl.length/2)].y-5&&o<=e.horBottomLinePointColl[Math.round(e.horBottomLinePointColl.length/2)].y+5)i.style.cursor=a.cursor=this.resizedElement="s-resize";else if(t>=e.horBottomLinePointColl[Math.round(e.horBottomLinePointColl.length-1)].x-(e.bottomCenterCircle.radius+2)&&t<=e.horBottomLinePointColl[Math.round(e.horBottomLinePointColl.length-1)].x+(e.bottomCenterCircle.radius+2)&&o>=e.horBottomLinePointColl[Math.round(e.horBottomLinePointColl.length-1)].y-(e.bottomCenterCircle.radius+2)&&o<=e.horBottomLinePointColl[Math.round(e.horBottomLinePointColl.length-1)].y+(e.bottomCenterCircle.radius+2))i.style.cursor=a.cursor="se-resize";else if(e.rotationCirclePointColl&&t>=e.rotationCirclePointColl.x-(e.bottomCenterCircle.radius+2)&&t<=e.rotationCirclePointColl.x+(e.bottomCenterCircle.radius+2)&&o>=e.rotationCirclePointColl.y-(e.bottomCenterCircle.radius+2)&&o<=e.rotationCirclePointColl.y+(e.bottomCenterCircle.radius+2))i.style.cursor=a.cursor="grabbing";else{i.style.cursor=a.cursor="default",this.getRectanglePoints(e.activePoint.startX,e.activePoint.startY,e.activePoint.width,e.activePoint.height,e.rotatedAngle*(180/Math.PI),t,o)&&(i.style.cursor=a.cursor="move")}if("default"===a.cursor)for(var r=0,n=e.horTopLinePointColl.length;r<n;r++)if(t>=e.horTopLinePointColl[r].x-5&&t<=e.horTopLinePointColl[r].x+5&&o>=e.horTopLinePointColl[r].y-5&&o<=e.horTopLinePointColl[r].y+5){i.style.cursor=a.cursor=this.resizedElement="n-resize";break}if("default"===a.cursor)for(r=0,n=e.horBottomLinePointColl.length;r<n;r++)if(t>=e.horBottomLinePointColl[r].x-5&&t<=e.horBottomLinePointColl[r].x+5&&o>=e.horBottomLinePointColl[r].y-5&&o<=e.horBottomLinePointColl[r].y+5){i.style.cursor=a.cursor=this.resizedElement="s-resize";break}if("default"===a.cursor)for(r=0,n=e.verLeftLinePointColl.length;r<n;r++)if(t>=e.verLeftLinePointColl[r].x-5&&t<=e.verLeftLinePointColl[r].x+5&&o>=e.verLeftLinePointColl[r].y-5&&o<=e.verLeftLinePointColl[r].y+5){i.style.cursor=a.cursor=this.resizedElement="w-resize";break}if("default"===a.cursor)for(r=0,n=e.verRightLinePointColl.length;r<n;r++)if(t>=e.verRightLinePointColl[r].x-5&&t<=e.verRightLinePointColl[r].x+5&&o>=e.verRightLinePointColl[r].y-5&&o<=e.verRightLinePointColl[r].y+5){i.style.cursor=a.cursor=this.resizedElement="e-resize";break}return this.adjustCursorStylesForRotatedState(e),a.cursor},e.prototype.adjustCursorStylesForRotatedState=function(e){var t=this.parent,o=e.rotatedAngle*(180/Math.PI);if((o=o>0?Math.floor(o):Math.ceil(o))>=92&&o<=182||o>=-178&&o<=-88){var i={"nw-resize":"ne-resize","n-resize":"s-resize","ne-resize":"nw-resize","w-resize":"e-resize","e-resize":"w-resize","sw-resize":"se-resize","s-resize":"n-resize","se-resize":"sw-resize"};t.cursor in i&&(t.cursor=i[t.cursor])}return t.upperCanvas.style.cursor=this.getResizeElement(e.rotatedAngle*(180/Math.PI),t.cursor),t.cursor},e.prototype.getResizeElement=function(e,t){var o=[];"nw-resize"===t?o=[[337.5,22.5,"nw-resize"],[22.5,67.5,"n-resize"],[67.5,112.5,"ne-resize"],[112.5,157.5,"e-resize"],[157.5,202.5,"se-resize"],[202.5,247.5,"s-resize"],[247.5,292.5,"sw-resize"],[292.5,337.5,"w-resize"]]:"n-resize"===t?o=[[337.5,22.5,"n-resize"],[22.5,67.5,"ne-resize"],[67.5,112.5,"e-resize"],[112.5,157.5,"se-resize"],[157.5,202.5,"s-resize"],[202.5,247.5,"sw-resize"],[247.5,292.5,"w-resize"],[292.5,337.5,"nw-resize"]]:"ne-resize"===t?o=[[337.5,22.5,"ne-resize"],[22.5,67.5,"e-resize"],[67.5,112.5,"se-resize"],[112.5,157.5,"s-resize"],[157.5,202.5,"sw-resize"],[202.5,247.5,"w-resize"],[247.5,292.5,"nw-resize"],[292.5,337.5,"n-resize"]]:"e-resize"===t?o=[[337.5,22.5,"e-resize"],[22.5,67.5,"se-resize"],[67.5,112.5,"s-resize"],[112.5,157.5,"sw-resize"],[157.5,202.5,"w-resize"],[202.5,247.5,"nw-resize"],[247.5,292.5,"n-resize"],[292.5,337.5,"ne-resize"]]:"se-resize"===t?o=[[337.5,22.5,"se-resize"],[22.5,67.5,"s-resize"],[67.5,112.5,"sw-resize"],[112.5,157.5,"w-resize"],[157.5,202.5,"nw-resize"],[202.5,247.5,"n-resize"],[247.5,292.5,"ne-resize"],[292.5,337.5,"e-resize"]]:"s-resize"===t?o=[[337.5,22.5,"s-resize"],[22.5,67.5,"sw-resize"],[67.5,112.5,"w-resize"],[112.5,157.5,"nw-resize"],[157.5,202.5,"n-resize"],[202.5,247.5,"ne-resize"],[247.5,292.5,"e-resize"],[292.5,337.5,"se-resize"]]:"sw-resize"===t?o=[[337.5,22.5,"sw-resize"],[22.5,67.5,"w-resize"],[67.5,112.5,"nw-resize"],[112.5,157.5,"n-resize"],[157.5,202.5,"ne-resize"],[202.5,247.5,"e-resize"],[247.5,292.5,"se-resize"],[292.5,337.5,"s-resize"]]:"w-resize"===t&&(o=[[337.5,22.5,"w-resize"],[22.5,67.5,"nw-resize"],[67.5,112.5,"n-resize"],[112.5,157.5,"ne-resize"],[157.5,202.5,"e-resize"],[202.5,247.5,"se-resize"],[247.5,292.5,"s-resize"],[292.5,337.5,"sw-resize"]]);for(var i=e<0?360-Math.abs(e):e,a=0,r=o;a<r.length;a++){var n=r[a],s=n[0],l=n[1],p=n[2];if(i>s&&i<=l||i+360>s&&i+360<=l)return p}return t},e.prototype.setCursorForFreehandDrawing=function(e,t,o){var i,a=o.getContext("2d"),r=this.parent,n=document.querySelector("#"+r.element.id+"_textArea"),s=!1;r.notify("freehand-draw",{prop:"setFreehandDrawHoveredIndex",onPropertyChange:!1,value:{index:-1}});for(var l=0;l<r.freehandCounter;l++){var p={selPointColl:{}};r.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:p}}),i=sf.base.extend([],p.selPointColl[l].points,[]),r.points=sf.base.extend([],r.pointColl[l].points,[]),r.notify("freehand-draw",{prop:"setPointCounter",onPropertyChange:!1,value:{value:0}});for(var h=i.length,c=0;c<h;c++)if(0!==c){var d=!1;if(i[c-1]&&i[c]&&(d=this.isInside(e,t,i[c-1].x,i[c-1].y,i[c].x,i[c].y)),d){this.isFhdPoint=!0,r.notify("freehand-draw",{prop:"setFreehandDrawHoveredIndex",onPropertyChange:!1,value:{index:l}}),r.notify("freehand-draw",{prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:null,strokeWidth:null}}),o.style.cursor=r.cursor="pointer",s=!0;break}if(!this.isFhdEditing||r.pointColl[l].isSelected){if((this.isFhdPoint||this.isFhdEditing)&&(a.clearRect(0,0,o.width,o.height),r.activeObj.shape&&"none"===n.style.display&&r.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:r.activeObj}})),this.isFhdEditing){var v=r.pointColl[l].strokeColor;r.notify("freehand-draw",{prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:v,strokeWidth:r.pointColl[l].strokeWidth}})}else r.notify("freehand-draw",{prop:"setFreehandDrawHoveredIndex",onPropertyChange:!1,value:{index:null}});this.isFhdPoint=!1}}else{if(e>r.points[c].x-r.pointColl[l].strokeWidth&&e<r.points[c].x+r.pointColl[l].strokeWidth&&t>r.points[c].y-r.pointColl[l].strokeWidth&&t<r.points[c].y+r.pointColl[l].strokeWidth){this.isFhdPoint=!0,r.notify("freehand-draw",{prop:"setFreehandDrawHoveredIndex",onPropertyChange:!1,value:{index:l}}),r.notify("freehand-draw",{prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:null,strokeWidth:null}}),o.style.cursor=r.cursor="pointer",s=!0;break}if(!this.isFhdEditing||r.pointColl[l].isSelected){if((this.isFhdPoint||this.isFhdEditing)&&(a.clearRect(0,0,o.width,o.height),r.activeObj.shape&&"none"===n.style.display&&r.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:r.activeObj}})),this.isFhdEditing){v=r.pointColl[l].strokeColor;r.notify("freehand-draw",{prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:v,strokeWidth:r.pointColl[l].strokeWidth}})}this.isFhdPoint=!1}}if(s)break}},e.prototype.setCursorFromObj=function(e,t,o,i,a){for(var r=this.parent,n=0,s=o.length;n<s;n++){if("move"===r.cursor)return;var l=sf.base.extend({},o[n],{},!0);this.cursorTargetId=l.currIndex,"line"===l.shape||"arrow"===l.shape?this.setCursorForLineArrow(l,e,t,i):"path"===l.shape?this.setCursorForPath(l,e,t,i):sf.base.isNullOrUndefined(l.rotatedAngle)||0===l.rotatedAngle?i.style.cursor=r.cursor=this.getMouseCursor(l,e,t,a,!0):this.setCursorForRotatedObject(l,e,t,i)}},e.prototype.isInside=function(e,t,o,i,a,r){var n=Math.min(o,a),s=Math.max(o,a),l=Math.min(i,r),p=Math.max(i,r);return n<=e&&e<=s&&l<=t&&t<=p},e.prototype.updateActivePoint=function(e,t,o){var i=this.parent,a={width:0,height:0};i.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:i.activeObj.activePoint.width,height:i.activeObj.activePoint.height,obj:a}});var r,n=a,s=this.updatePrevShapeSettings(),l={action:"resize",previousShapeSettings:s},p={action:"move",previousShapeSettings:s};sf.base.isNullOrUndefined(this.shapeResizingArgs)&&(this.shapeResizingArgs=l),sf.base.isNullOrUndefined(this.shapeMovingArgs)&&(this.shapeMovingArgs=p),"text"===i.activeObj.shape&&""!==this.dragElement&&i.notify("shape",{prop:"updateFontRatio",onPropertyChange:!1,value:{obj:i.activeObj,isTextArea:null}}),""===this.currentDrawingShape||""!==this.dragElement&&"move"!==this.dragElement||("line"===i.activeObj.shape||"arrow"===i.activeObj.shape||"path"===i.activeObj.shape?this.dragElement="e-resize":e>i.activeObj.activePoint.startX&&t>i.activeObj.activePoint.startY?this.dragElement="se-resize":e<i.activeObj.activePoint.startX&&t>i.activeObj.activePoint.startY?this.dragElement="sw-resize":e>i.activeObj.activePoint.startX&&t<i.activeObj.activePoint.startY?this.dragElement="ne-resize":e<i.activeObj.activePoint.startX&&t<i.activeObj.activePoint.startY&&(this.dragElement="nw-resize")),"arrow"===i.activeObj.shape&&(Math.atan2(e-i.lowerCanvas.width/2,t-i.lowerCanvas.height/2)>0?i.activeObj.rotatedAngle=-Math.atan2(e-i.lowerCanvas.width/2,t-i.lowerCanvas.height/2):i.activeObj.rotatedAngle=Math.abs(Math.atan2(e-i.lowerCanvas.width/2,t-i.lowerCanvas.height/2)));var h=!1,c=!1;switch(this.dragElement.toLowerCase()){case"nw-resize":this.updateNWPoints(e,t,n),i.notify("shape",{prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:i.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(l,p,"resize");break;case"n-resize":this.updateNPoints(e,t),i.notify("shape",{prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:i.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(l,p,"resize");break;case"ne-resize":this.updateNEPoints(e,t,n),i.notify("shape",{prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:i.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(l,p,"resize");break;case"w-resize":this.updateWPoints(e,t),i.notify("shape",{prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:i.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(l,p,"resize");break;case"e-resize":this.updateEPoints(e,t),i.notify("shape",{prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:i.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(l,p,"resize");break;case"sw-resize":this.updateSWPoints(e,t,n),i.notify("shape",{prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:i.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(l,p,"resize");break;case"s-resize":this.updateSPoints(e,t),i.notify("shape",{prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:i.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(l,p,"resize");break;case"se-resize":this.updateSEPoints(e,t,n),i.notify("shape",{prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:i.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(l,p,"resize");break;case"grabbing":Math.atan2(e-(i.activeObj.activePoint.startX+i.activeObj.activePoint.width/2),t-(i.activeObj.activePoint.startY+i.activeObj.activePoint.height/2))>0?i.activeObj.rotatedAngle=-Math.atan2(e-(i.activeObj.activePoint.startX+i.activeObj.activePoint.width/2),t-(i.activeObj.activePoint.startY+i.activeObj.activePoint.height/2)):i.activeObj.rotatedAngle=Math.abs(Math.atan2(e-(i.activeObj.activePoint.startX+i.activeObj.activePoint.width/2),t-(i.activeObj.activePoint.startY+i.activeObj.activePoint.height/2))),(r=0===i.activeObj.shapeDegree?i.transform.degree:i.transform.degree-i.activeObj.shapeDegree)<0&&(r=360+r);for(var d=0,v=i.activeObj.flipObjColl.length;d<v;d++)"horizontal"===i.activeObj.flipObjColl[d].toLowerCase()?h=!0:"vertical"===i.activeObj.flipObjColl[d].toLowerCase()&&(c=!0);i.activeObj.rotatedAngle-=r*(Math.PI/180),0===r||360===r?c&&(i.activeObj.rotatedAngle-=Math.PI/180*180):90===r||-270===r?h&&(i.activeObj.rotatedAngle-=Math.PI/180*180):180===r||-180===r?c&&(i.activeObj.rotatedAngle-=Math.PI/180*180):270!==r&&-90!==r||h&&(i.activeObj.rotatedAngle-=Math.PI/180*180);break;case"pathdrag":sf.base.isNullOrUndefined(this.pathAdjustedIndex)||(i.activeObj.pointColl[this.pathAdjustedIndex].x=e,i.activeObj.pointColl[this.pathAdjustedIndex].y=t);break;default:if(!o&&!i.currObjType.isCustomCrop){if(this.dragPoint.startX){var u=this.dragPoint.endX-this.previousPoint.x,b=this.dragPoint.endY-this.previousPoint.y;if(i.activeObj.activePoint.startX+=u,i.activeObj.activePoint.endX+=u,i.activeObj.activePoint.startY+=b,i.activeObj.activePoint.endY+=b,"line"!==i.activeObj.shape&&"arrow"!==i.activeObj.shape&&i.activeObj.rotationCirclePointColl&&(i.activeObj.rotationCirclePointColl.x+=u,i.activeObj.rotationCirclePointColl.y+=b,i.activeObj.rotationCirclePoint.x+=u,i.activeObj.rotationCirclePoint.y+=b),"path"===i.activeObj.shape)for(d=0,v=i.activeObj.pointColl.length;d<v;d++)i.activeObj.pointColl[d].x+=u,i.activeObj.pointColl[d].y+=b;!this.isPreventDragging&&(i.activeObj.activePoint.startX<i.img.destLeft||i.activeObj.activePoint.startY<i.img.destTop||i.activeObj.activePoint.endX>i.img.destLeft+i.img.destWidth||i.activeObj.activePoint.endY>i.img.destTop+i.img.destHeight)&&(i.activeObj.activePoint.startX-=u,i.activeObj.activePoint.endX-=u,i.activeObj.activePoint.startY-=b,i.activeObj.activePoint.endY-=b,"line"!==i.activeObj.shape&&"arrow"!==i.activeObj.shape&&i.activeObj.rotationCirclePointColl&&(i.activeObj.rotationCirclePointColl.x-=u,i.activeObj.rotationCirclePointColl.y-=b,i.activeObj.rotationCirclePoint.x-=u,i.activeObj.rotationCirclePoint.y-=b),this.setDragWidth(u),this.setDragHeight(b))}else i.activeObj.activePoint.startX=e<this.mouseDownPoint.x?e:this.mouseDownPoint.x,i.activeObj.activePoint.startY=t<this.mouseDownPoint.y?t:this.mouseDownPoint.y,e=e<this.mouseDownPoint.x?this.mouseDownPoint.x:e,t=t<this.mouseDownPoint.y?this.mouseDownPoint.y:t,i.activeObj.activePoint.endX=e,i.activeObj.activePoint.endY=t;this.triggerShapeChange(l,p,"move")}}},e.prototype.triggerShapeChange=function(e,t,o){var i=this.parent;i.activeObj.activePoint.width=i.activeObj.activePoint.endX-i.activeObj.activePoint.startX,i.activeObj.activePoint.height=i.activeObj.activePoint.endY-i.activeObj.activePoint.startY;var a=this.updatePrevShapeSettings();if(e.currentShapeSettings=a,t.currentShapeSettings=a,"resize"===o){this.isCropSelection=!1;var r=void 0;if(void 0!==i.activeObj.shape&&(r=i.activeObj.shape.split("-")),void 0!==r&&"crop"===r[0]&&(this.isCropSelection=!0),!this.isCropSelection&&"resize"!==this.parent.eventType&&sf.base.isBlazor()&&i.events&&!0===this.parent.events.onShapeResizeStart.hasDelegate)e.action="resize-start",i.dotNetRef.invokeMethodAsync("ShapeEventAsync","OnShapeResizeStart",e).then((function(e){i.notify("shape",{prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:e.currentShapeSettings}})}));else if(this.isCropSelection){var n={action:e.action,previousSelectionSettings:{type:i.getSelectionType(i.activeObj.shape),startX:e.previousShapeSettings.startX,startY:e.previousShapeSettings.startY,width:e.previousShapeSettings.width,height:e.previousShapeSettings.height},currentSelectionSettings:{type:i.getSelectionType(i.activeObj.shape),startX:e.currentShapeSettings.startX,startY:e.currentShapeSettings.startY,width:e.currentShapeSettings.width,height:e.currentShapeSettings.height}};sf.base.isNullOrUndefined(this.selectionResizingArgs)&&(this.selectionResizingArgs=n),sf.base.isBlazor()&&sf.base.isNullOrUndefined(this.parent.eventType)&&i.events&&!0===i.events.onSelectionResizeStart.hasDelegate?(n.action="resize-start",i.dotNetRef.invokeMethodAsync("SelectionEventAsync","OnSelectionResizeStart",n).then((function(e){i.notify("shape",{prop:"updSelChangeEventArgs",onPropertyChange:!1,value:{selectionSettings:e.currentSelectionSettings}})}))):(i.trigger("selectionChanging",n),i.notify("shape",{prop:"updSelChangeEventArgs",onPropertyChange:!1,value:{selectionSettings:n.currentSelectionSettings}}))}else i.trigger("shapeChanging",e),i.notify("shape",{prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:e.currentShapeSettings}})}else sf.base.isBlazor()&&sf.base.isNullOrUndefined(this.parent.eventType)&&i.events&&!0===i.events.onShapeDragStart.hasDelegate?(t.action="drag-start",i.dotNetRef.invokeMethodAsync("ShapeEventAsync","OnShapeDragStart",t).then((function(e){i.notify("shape",{prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:e.currentShapeSettings}})}))):(i.trigger("shapeChanging",t),i.notify("shape",{prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:t.currentShapeSettings}}));this.parent.eventType=o},e.prototype.setDragWidth=function(e){var t=this.parent,o=e;if(o>=0)for(var i=0;i<o&&(e=o-i,t.activeObj.activePoint.startX+=e,t.activeObj.activePoint.endX+=e,!(t.activeObj.activePoint.startX>=t.img.destLeft&&t.activeObj.activePoint.endX<=t.img.destLeft+t.img.destWidth));i++)t.activeObj.activePoint.startX-=e,t.activeObj.activePoint.endX-=e;else for(i=1;i<Math.abs(o)&&(e=o+i,t.activeObj.activePoint.startX+=e,t.activeObj.activePoint.endX+=e,!(t.activeObj.activePoint.startX>=t.img.destLeft&&t.activeObj.activePoint.endX<=t.img.destLeft+t.img.destWidth));i++)t.activeObj.activePoint.startX-=e,t.activeObj.activePoint.endX-=e},e.prototype.setDragHeight=function(e){var t=this.parent,o=e;if(o>=0)for(var i=1;i<o&&(e=o-i,t.activeObj.activePoint.startY+=e,t.activeObj.activePoint.endY+=e,!(t.activeObj.activePoint.startY>=t.img.destTop&&t.activeObj.activePoint.endY<=t.img.destTop+t.img.destHeight));i++)t.activeObj.activePoint.startY-=e,t.activeObj.activePoint.endY-=e;else for(i=0;i<Math.abs(o)&&(e=o+i,t.activeObj.activePoint.startY+=e,t.activeObj.activePoint.endY+=e,!(t.activeObj.activePoint.startY>=t.img.destTop&&t.activeObj.activePoint.endY<=t.img.destTop+t.img.destHeight));i++)t.activeObj.activePoint.startY-=e,t.activeObj.activePoint.endY-=e},e.prototype.limitDrag=function(e){var t=this.parent,o=e?t.activeObj.activePoint.startX:t.activeObj.activePoint.endX,i=e?t.activeObj.activePoint.startY:t.activeObj.activePoint.endY,a=e?t.activeObj.activePoint.endX:t.activeObj.activePoint.startX,r=e?t.activeObj.activePoint.endY:t.activeObj.activePoint.startY;o<t.img.destLeft&&(o=t.img.destLeft),i<t.img.destTop&&(i=t.img.destTop),a>t.img.destLeft+t.img.destWidth&&(a=t.img.destLeft+t.img.destWidth),r>t.img.destTop+t.img.destHeight&&(r=t.img.destTop+t.img.destHeight),e?(t.activeObj.activePoint.startX=o,t.activeObj.activePoint.startY=i,t.activeObj.activePoint.endX=a,t.activeObj.activePoint.endY=r):(t.activeObj.activePoint.startX=a,t.activeObj.activePoint.startY=r,t.activeObj.activePoint.endX=o,t.activeObj.activePoint.endY=i)},e.prototype.preventDraggingInvertly=function(){var e=this.parent;this.isPreventDragging||0!==e.activeObj.rotatedAngle||(this.limitDrag(!0),"line"!==e.activeObj.shape&&"arrow"!==e.activeObj.shape&&"path"!==e.activeObj.shape||this.limitDrag(!1))},e.prototype.preventTextDraggingInvertly=function(){var e=this.parent,t=!1;return this.isPreventDragging||(e.activeObj.activePoint.startX<e.img.destLeft||e.activeObj.activePoint.startY<e.img.destTop||e.activeObj.activePoint.endX>e.img.destLeft+e.img.destWidth||e.activeObj.activePoint.endY>e.img.destTop+e.img.destHeight)&&(t=!0),t},e.prototype.preventInverseResize=function(e){var t=this.parent;t.activeObj.activePoint.width<0&&(t.activeObj.activePoint.width=0,t.activeObj.activePoint.startX=e.activePoint.startX,t.activeObj.activePoint.endX=e.activePoint.endX),t.activeObj.activePoint.height<0&&(t.activeObj.activePoint.height=0,t.activeObj.activePoint.startY=e.activePoint.startY,t.activeObj.activePoint.endY=e.activePoint.endY)},e.prototype.getScaleRatio=function(e){var t=this.parent,o={x:e,y:e};if(t.activeObj.shape&&"crop-custom"!==t.activeObj.shape&&"crop-circle"!==t.activeObj.shape&&"crop-square"!==t.activeObj.shape){var i=t.activeObj.shape.split("-");if(i.length>1){i=i[1].split(":");var a=e/parseInt(i[1],10);o.x=a*parseInt(i[0],10),o.y=a*parseInt(i[1],10)}}return o},e.prototype.updateNWPoints=function(e,t,o){var i,a,r,n,s=this.parent,l=this.diffPoint.x,p=this.diffPoint.y,h=sf.base.extend({},s.activeObj,null,!0);if("text"===s.activeObj.shape)void 0===this.oldPoint.x&&void 0===this.oldPoint.y?(this.diffPoint.x=s.activeObj.activePoint.startX-e,this.diffPoint.y=s.activeObj.activePoint.startY-t):(this.diffPoint.x=this.oldPoint.x-e,this.diffPoint.y=this.oldPoint.y-t),this.oldPoint.x=e,this.oldPoint.y=t,n=(this.diffPoint.x<=l&&this.diffPoint.y>=p?Math.min(this.diffPoint.x,this.diffPoint.y):Math.max(this.diffPoint.x,this.diffPoint.y))/10,s.activeObj.activePoint.startX-=o.width/100*n,s.activeObj.activePoint.startY-=o.height/100*n,this.preventTextDraggingInvertly()&&(s.activeObj.activePoint.startX+=o.width/100*n,s.activeObj.activePoint.startY+=o.height/100*n),s.activeObj.activePoint.width=s.activeObj.activePoint.endX-s.activeObj.activePoint.startX,s.activeObj.activePoint.height=s.activeObj.activePoint.endY-s.activeObj.activePoint.startY,s.notify("shape",{prop:"updateFontSize",onPropertyChange:!1,value:{obj:s.activeObj}});else{var c=void 0;if(void 0!==s.activeObj.shape&&(c=s.activeObj.shape.split("-")),"crop-custom"===s.activeObj.shape||void 0!==s.activeObj.shape&&"crop"!==c[0]){if(this.adjustNWPoints(s.activeObj.activePoint,e,t,s.activeObj.rotatedAngle),s.activeObj.activePoint.startX>s.activeObj.activePoint.endX){var d=s.activeObj.activePoint.startX;s.activeObj.activePoint.startX=s.activeObj.activePoint.endX,s.activeObj.activePoint.endX=d,this.dragElement=s.upperCanvas.style.cursor=s.cursor="ne-resize"}if(s.activeObj.activePoint.startY>s.activeObj.activePoint.endY){d=s.activeObj.activePoint.startY;s.activeObj.activePoint.startY=s.activeObj.activePoint.endY,s.activeObj.activePoint.endY=d,this.dragElement=s.upperCanvas.style.cursor=s.cursor="sw-resize"}this.preventDraggingInvertly()}else if(s.activeObj.activePoint.startX<e&&s.activeObj.activePoint.startY<t){i=e-s.activeObj.activePoint.startX,a=t-s.activeObj.activePoint.startY,r=Math.min(i,a);var v=this.getScaleRatio(r);s.activeObj.activePoint.startX+=v.x,s.activeObj.activePoint.startY+=v.y;var u=s.img.destLeft>0?s.img.destLeft:0,b=s.img.destTop>0?s.img.destTop:0;(s.activeObj.activePoint.startX<u||s.activeObj.activePoint.startY<b)&&(s.activeObj.activePoint.startX-=v.x,s.activeObj.activePoint.startY-=v.y)}else{i=s.activeObj.activePoint.startX-e,a=t-s.activeObj.activePoint.endY,r=Math.max(i,a);v=this.getScaleRatio(r);s.activeObj.activePoint.startX-=v.x,s.activeObj.activePoint.startY-=v.y;u=s.img.destLeft>0?s.img.destLeft:0;var g=s.img.destTop>0?s.img.destTop:0;(s.activeObj.activePoint.startX<u||s.activeObj.activePoint.startY<g)&&(s.activeObj.activePoint.startX+=v.x,s.activeObj.activePoint.startY+=v.y)}s.activeObj.activePoint.width=s.activeObj.activePoint.endX-s.activeObj.activePoint.startX,s.activeObj.activePoint.height=s.activeObj.activePoint.endY-s.activeObj.activePoint.startY,this.preventInverseResize(h)}},e.prototype.updateNPoints=function(e,t){var o,i,a,r=this.parent;if("text"!==r.activeObj.shape){var n=void 0;if(r.activeObj.shape&&(n=r.activeObj.shape.split("-")),"crop-custom"===r.activeObj.shape||r.activeObj.shape&&"crop"!==n[0]){if("line"!==r.activeObj.shape&&"arrow"!==r.activeObj.shape&&"path"!==r.activeObj.shape&&0!==r.activeObj.rotatedAngle&&this.dragPoint.startX?(this.dragPoint.startX&&this.dragPoint.startY&&(this.previousPoint.x=this.dragPoint.endX,this.previousPoint.y=this.dragPoint.endY,this.dragPoint.endX=e,this.dragPoint.endY=t),o=this.dragPoint.endX-this.previousPoint.x,i=this.dragPoint.endY-this.previousPoint.y,this.adjustRotationPoints(r.activeObj.activePoint,o,i,r.activeObj.rotatedAngle)):(r.activeObj.activePoint.startY=t,r.activeObj.activePoint.height=r.activeObj.activePoint.endY-r.activeObj.activePoint.startY),r.activeObj.activePoint.startY>r.activeObj.activePoint.endY){var s=r.activeObj.activePoint.startY;r.activeObj.activePoint.startY=r.activeObj.activePoint.endY,r.activeObj.activePoint.endY=s,this.dragElement=this.resizedElement="s-resize"}this.preventDraggingInvertly()}else{if(r.activeObj.activePoint.endX>e&&r.activeObj.activePoint.startY<t){o=r.activeObj.activePoint.endX-e,i=t-r.activeObj.activePoint.startY,a=Math.min(o,i);var l=this.getScaleRatio(a);r.activeObj.activePoint.endX-=l.x,r.activeObj.activePoint.startY+=l.y,(r.activeObj.activePoint.endX>r.img.destLeft+r.img.destWidth||r.activeObj.activePoint.startY<r.img.destTop)&&(r.activeObj.activePoint.endX+=l.x,r.activeObj.activePoint.startY-=l.y)}else{o=e-r.activeObj.activePoint.endX,i=r.activeObj.activePoint.startY-t,a=Math.max(o,i);l=this.getScaleRatio(a);r.activeObj.activePoint.endX+=l.x,r.activeObj.activePoint.startY-=l.y,(r.activeObj.activePoint.endX>r.img.destLeft+r.img.destWidth||r.activeObj.activePoint.startY<r.img.destTop)&&(r.activeObj.activePoint.endX-=l.x,r.activeObj.activePoint.startY+=l.y)}r.activeObj.activePoint.width=r.activeObj.activePoint.endX-r.activeObj.activePoint.startX,r.activeObj.activePoint.height=r.activeObj.activePoint.endY-r.activeObj.activePoint.startY}}},e.prototype.updateNEPoints=function(e,t,o){var i,a,r,n,s=this.parent,l=this.diffPoint.x,p=this.diffPoint.y,h=sf.base.extend({},s.activeObj,null,!0);if("text"===s.activeObj.shape)void 0===this.oldPoint.x&&void 0===this.oldPoint.y?(this.diffPoint.x=e-s.activeObj.activePoint.endX,this.diffPoint.y=s.activeObj.activePoint.startY-t):(this.diffPoint.x=e-this.oldPoint.x,this.diffPoint.y=this.oldPoint.y-t),this.oldPoint.x=e,this.oldPoint.y=t,n=(this.diffPoint.x<=l&&this.diffPoint.y>=p?Math.min(this.diffPoint.x,this.diffPoint.y):Math.max(this.diffPoint.x,this.diffPoint.y))/10,s.activeObj.activePoint.endX+=o.width/100*n,s.activeObj.activePoint.startY-=o.height/100*n,this.preventTextDraggingInvertly()&&(s.activeObj.activePoint.endX-=o.width/100*n,s.activeObj.activePoint.startY+=o.height/100*n),s.activeObj.activePoint.width=s.activeObj.activePoint.endX-s.activeObj.activePoint.startX,s.activeObj.activePoint.height=s.activeObj.activePoint.endY-s.activeObj.activePoint.startY,s.notify("shape",{prop:"updateFontSize",onPropertyChange:!1,value:{obj:s.activeObj}});else{var c=void 0;if(s.activeObj.shape&&(c=s.activeObj.shape.split("-")),"crop-custom"===s.activeObj.shape||void 0!==s.activeObj.shape&&"crop"!==c[0]){if(this.adjustNEPoints(s.activeObj.activePoint,e,t,s.activeObj.rotatedAngle),s.activeObj.activePoint.endX<s.activeObj.activePoint.startX){var d=s.activeObj.activePoint.endX;s.activeObj.activePoint.endX=s.activeObj.activePoint.startX,s.activeObj.activePoint.startX=d,this.dragElement=s.upperCanvas.style.cursor=s.cursor="nw-resize"}if(s.activeObj.activePoint.startY>s.activeObj.activePoint.endY){d=s.activeObj.activePoint.startY;s.activeObj.activePoint.startY=s.activeObj.activePoint.endY,s.activeObj.activePoint.endY=d,this.dragElement=s.upperCanvas.style.cursor=s.cursor="se-resize"}this.preventDraggingInvertly()}else if(s.activeObj.activePoint.endX>e&&s.activeObj.activePoint.startY<t){i=s.activeObj.activePoint.endX-e,a=t-s.activeObj.activePoint.startY,r=Math.min(i,a);var v=this.getScaleRatio(r);s.activeObj.activePoint.endX-=v.x,s.activeObj.activePoint.startY+=v.y;var u=s.img.destLeft+s.img.destWidth<s.lowerCanvas.width?s.img.destLeft+s.img.destWidth:s.lowerCanvas.width,b=s.img.destTop>0?s.img.destTop:0;(s.activeObj.activePoint.endX>u||s.activeObj.activePoint.startY<b)&&(s.activeObj.activePoint.endX+=v.x,s.activeObj.activePoint.startY-=v.y)}else{i=e-s.activeObj.activePoint.endX,a=s.activeObj.activePoint.startY-t,r=Math.max(i,a);v=this.getScaleRatio(r);s.activeObj.activePoint.endX+=v.x,s.activeObj.activePoint.startY-=v.y;u=s.img.destLeft+s.img.destWidth<s.lowerCanvas.width?s.img.destLeft+s.img.destWidth:s.lowerCanvas.width,b=s.img.destTop>0?s.img.destTop:0;(s.activeObj.activePoint.endX>u||s.activeObj.activePoint.startY<b)&&(s.activeObj.activePoint.endX-=v.x,s.activeObj.activePoint.startY+=v.y)}s.activeObj.activePoint.width=s.activeObj.activePoint.endX-s.activeObj.activePoint.startX,s.activeObj.activePoint.height=s.activeObj.activePoint.endY-s.activeObj.activePoint.startY,this.preventInverseResize(h)}},e.prototype.updateWPoints=function(e,t){var o,i,a,r=this.parent;if("text"!==r.activeObj.shape){var n=void 0;if(r.activeObj.shape&&(n=r.activeObj.shape.split("-")),"crop-custom"===r.activeObj.shape||r.activeObj.shape&&"crop"!==n[0]){if("line"!==r.activeObj.shape&&"arrow"!==r.activeObj.shape&&"path"!==r.activeObj.shape&&0!==r.activeObj.rotatedAngle&&this.dragPoint.startX?(this.dragPoint.startX&&this.dragPoint.startY&&(this.previousPoint.x=this.dragPoint.endX,this.previousPoint.y=this.dragPoint.endY,this.dragPoint.endX=e,this.dragPoint.endY=t),o=this.dragPoint.endX-this.previousPoint.x,i=this.dragPoint.endY-this.previousPoint.y,this.adjustRotationPoints(r.activeObj.activePoint,o,i,r.activeObj.rotatedAngle)):(r.activeObj.activePoint.startX=e,r.activeObj.activePoint.width=r.activeObj.activePoint.endX-r.activeObj.activePoint.startX),"line"===r.activeObj.shape||"arrow"===r.activeObj.shape||"path"===r.activeObj.shape)r.activeObj.activePoint.startY=t,r.activeObj.activePoint.height=r.activeObj.activePoint.endY-r.activeObj.activePoint.startY,this.adjustActObjForLineArrow()&&(this.dragElement="e-resize","right"===r.activeObj.triangleDirection?r.activeObj.triangleDirection="left":"left"===r.activeObj.triangleDirection&&(r.activeObj.triangleDirection="right"));else if(r.activeObj.activePoint.startX>r.activeObj.activePoint.endX){var s=r.activeObj.activePoint.startX;r.activeObj.activePoint.startX=r.activeObj.activePoint.endX,r.activeObj.activePoint.endX=s,this.dragElement=this.resizedElement="e-resize"}this.preventDraggingInvertly()}else{if(r.activeObj.activePoint.startX<e&&r.activeObj.activePoint.endY>t){o=e-r.activeObj.activePoint.startX,i=r.activeObj.activePoint.endY-t,a=Math.min(o,i);var l=this.getScaleRatio(a);r.activeObj.activePoint.startX+=l.x,r.activeObj.activePoint.endY-=l.y,(r.activeObj.activePoint.startX<r.img.destLeft||r.activeObj.activePoint.endY>r.img.destTop+r.img.destHeight)&&(r.activeObj.activePoint.startX-=l.x,r.activeObj.activePoint.endY+=l.y)}else{o=r.activeObj.activePoint.startX-e,i=t-r.activeObj.activePoint.endY,a=Math.max(o,i);l=this.getScaleRatio(a);r.activeObj.activePoint.startX-=l.x,r.activeObj.activePoint.endY+=l.y,(r.activeObj.activePoint.startX<r.img.destLeft||r.activeObj.activePoint.endY>r.img.destTop+r.img.destHeight)&&(r.activeObj.activePoint.startX+=l.x,r.activeObj.activePoint.endY-=l.y)}r.activeObj.activePoint.width=r.activeObj.activePoint.endX-r.activeObj.activePoint.startX,r.activeObj.activePoint.height=r.activeObj.activePoint.endY-r.activeObj.activePoint.startY}}},e.prototype.updateEPoints=function(e,t){var o,i,a,r=this.parent;if("text"!==r.activeObj.shape){var n=void 0;if(r.activeObj.shape&&(n=r.activeObj.shape.split("-")),"crop-custom"===r.activeObj.shape||r.activeObj.shape&&"crop"!==n[0]){if("line"!==r.activeObj.shape&&"arrow"!==r.activeObj.shape&&"path"!==r.activeObj.shape&&0!==r.activeObj.rotatedAngle&&this.dragPoint.startX?(this.dragPoint.startX&&this.dragPoint.startY&&(this.previousPoint.x=this.dragPoint.endX,this.previousPoint.y=this.dragPoint.endY,this.dragPoint.endX=e,this.dragPoint.endY=t),o=this.dragPoint.endX-this.previousPoint.x,i=this.dragPoint.endY-this.previousPoint.y,this.adjustRotationPoints(r.activeObj.activePoint,o,i,r.activeObj.rotatedAngle)):(r.activeObj.activePoint.endX=e,r.activeObj.activePoint.width=r.activeObj.activePoint.endX-r.activeObj.activePoint.startX),"line"===r.activeObj.shape||"arrow"===r.activeObj.shape||"path"===r.activeObj.shape)r.activeObj.activePoint.endY=t,r.activeObj.activePoint.height=r.activeObj.activePoint.endY-r.activeObj.activePoint.startY,this.adjustActObjForLineArrow()&&(this.dragElement="w-resize","right"===r.activeObj.triangleDirection?r.activeObj.triangleDirection="left":"left"===r.activeObj.triangleDirection&&(r.activeObj.triangleDirection="right"));else if(r.activeObj.activePoint.endX<r.activeObj.activePoint.startX){var s=r.activeObj.activePoint.endX;r.activeObj.activePoint.endX=r.activeObj.activePoint.startX,r.activeObj.activePoint.startX=s,this.dragElement=this.resizedElement="w-resize"}this.preventDraggingInvertly()}else{if(r.activeObj.activePoint.endX>e&&r.activeObj.activePoint.endY>t){o=r.activeObj.activePoint.endX-e,i=r.activeObj.activePoint.endY-t,a=Math.min(o,i);var l=this.getScaleRatio(a);r.activeObj.activePoint.endX-=l.x,r.activeObj.activePoint.endY-=l.y,(r.activeObj.activePoint.endX>r.img.destLeft+r.img.destWidth||r.activeObj.activePoint.endY>r.img.destTop+r.img.destHeight)&&(r.activeObj.activePoint.endX+=l.x,r.activeObj.activePoint.endY+=l.y)}else{o=e-r.activeObj.activePoint.endX,i=t-r.activeObj.activePoint.endY,a=Math.max(o,i);l=this.getScaleRatio(a);r.activeObj.activePoint.endX+=l.x,r.activeObj.activePoint.endY+=l.y,(r.activeObj.activePoint.endX>r.img.destLeft+r.img.destWidth||r.activeObj.activePoint.endY>r.img.destTop+r.img.destHeight)&&(r.activeObj.activePoint.endX-=l.x,r.activeObj.activePoint.endY-=l.y)}r.activeObj.activePoint.width=r.activeObj.activePoint.endX-r.activeObj.activePoint.startX,r.activeObj.activePoint.height=r.activeObj.activePoint.endY-r.activeObj.activePoint.startY}}},e.prototype.updateSWPoints=function(e,t,o){var i,a,r,n,s=this.parent,l=this.diffPoint.x,p=this.diffPoint.y,h=sf.base.extend({},s.activeObj,null,!0);if("text"===s.activeObj.shape)sf.base.isNullOrUndefined(this.oldPoint.x)&&sf.base.isNullOrUndefined(this.oldPoint.y)?(this.diffPoint.x=s.activeObj.activePoint.startX-e,this.diffPoint.y=t-s.activeObj.activePoint.endY):(this.diffPoint.x=this.oldPoint.x-e,this.diffPoint.y=t-this.oldPoint.y),this.oldPoint.x=e,this.oldPoint.y=t,n=(this.diffPoint.x<=l&&this.diffPoint.y>=p?Math.min(this.diffPoint.x,this.diffPoint.y):Math.max(this.diffPoint.x,this.diffPoint.y))/10,s.activeObj.activePoint.startX-=o.width/100*n,s.activeObj.activePoint.endY+=o.height/100*n,this.preventTextDraggingInvertly()&&(s.activeObj.activePoint.startX+=o.width/100*n,s.activeObj.activePoint.endY-=o.height/100*n),s.activeObj.activePoint.width=s.activeObj.activePoint.endX-s.activeObj.activePoint.startX,s.activeObj.activePoint.height=s.activeObj.activePoint.endY-s.activeObj.activePoint.startY,s.notify("shape",{prop:"updateFontSize",onPropertyChange:!1,value:{obj:s.activeObj}});else{var c=void 0;if(void 0!==s.activeObj.shape&&(c=s.activeObj.shape.split("-")),"crop-custom"===s.activeObj.shape||void 0!==s.activeObj.shape&&"crop"!==c[0]){if(this.adjustSWPoints(s.activeObj.activePoint,e,t,s.activeObj.rotatedAngle),s.activeObj.activePoint.startX>s.activeObj.activePoint.endX){var d=s.activeObj.activePoint.startX;s.activeObj.activePoint.startX=s.activeObj.activePoint.endX,s.activeObj.activePoint.endX=d,this.dragElement=s.upperCanvas.style.cursor=s.cursor="se-resize"}if(s.activeObj.activePoint.endY<s.activeObj.activePoint.startY){d=s.activeObj.activePoint.endY;s.activeObj.activePoint.endY=s.activeObj.activePoint.startY,s.activeObj.activePoint.startY=d,this.dragElement=s.upperCanvas.style.cursor=s.cursor="nw-resize"}this.preventDraggingInvertly()}else if(s.activeObj.activePoint.startX<e&&s.activeObj.activePoint.endY>t){i=e-s.activeObj.activePoint.startX,a=s.activeObj.activePoint.endY-t,r=Math.min(i,a);var v=this.getScaleRatio(r);s.activeObj.activePoint.startX+=v.x,s.activeObj.activePoint.endY-=v.y;var u=s.img.destLeft>0?s.img.destLeft:0,b=s.img.destTop+s.img.destHeight<s.lowerCanvas.height?s.img.destTop+s.img.destHeight:s.lowerCanvas.height;(s.activeObj.activePoint.startX<u||s.activeObj.activePoint.endY>b)&&(s.activeObj.activePoint.startX-=v.x,s.activeObj.activePoint.endY+=v.y)}else{i=s.activeObj.activePoint.startX-e,a=t-s.activeObj.activePoint.endY,r=Math.max(i,a);v=this.getScaleRatio(r);s.activeObj.activePoint.startX-=v.x,s.activeObj.activePoint.endY+=v.y;u=s.img.destLeft>0?s.img.destLeft:0,b=s.img.destTop+s.img.destHeight<s.lowerCanvas.height?s.img.destTop+s.img.destHeight:s.lowerCanvas.height;(s.activeObj.activePoint.startX<u||s.activeObj.activePoint.endY>b)&&(s.activeObj.activePoint.startX+=v.x,s.activeObj.activePoint.endY-=v.y)}s.activeObj.activePoint.width=s.activeObj.activePoint.endX-s.activeObj.activePoint.startX,s.activeObj.activePoint.height=s.activeObj.activePoint.endY-s.activeObj.activePoint.startY,this.preventInverseResize(h)}},e.prototype.updateSPoints=function(e,t){var o,i,a,r=this.parent;if("text"!==r.activeObj.shape){var n=void 0;if(r.activeObj.shape&&(n=r.activeObj.shape.split("-")),"crop-custom"===r.activeObj.shape||r.activeObj.shape&&"crop"!==n[0]){if("line"!==r.activeObj.shape&&"arrow"!==r.activeObj.shape&&"path"!==r.activeObj.shape&&0!==r.activeObj.rotatedAngle&&this.dragPoint.startX?(this.dragPoint.startX&&this.dragPoint.startY&&(this.previousPoint.x=this.dragPoint.endX,this.previousPoint.y=this.dragPoint.endY,this.dragPoint.endX=e,this.dragPoint.endY=t),o=this.dragPoint.endX-this.previousPoint.x,i=this.dragPoint.endY-this.previousPoint.y,this.adjustRotationPoints(r.activeObj.activePoint,o,i,r.activeObj.rotatedAngle)):(r.activeObj.activePoint.endY=t,r.activeObj.activePoint.height=r.activeObj.activePoint.endY-r.activeObj.activePoint.startY),r.activeObj.activePoint.endY<r.activeObj.activePoint.startY){var s=r.activeObj.activePoint.endY;r.activeObj.activePoint.endY=r.activeObj.activePoint.startY,r.activeObj.activePoint.startY=s,this.dragElement=this.resizedElement="n-resize"}this.preventDraggingInvertly()}else{if(r.activeObj.activePoint.endX>e&&r.activeObj.activePoint.endY>t){o=r.activeObj.activePoint.endX-e,i=r.activeObj.activePoint.endY-t,a=Math.min(o,i);var l=this.getScaleRatio(a);r.activeObj.activePoint.endX-=l.x,r.activeObj.activePoint.endY-=l.y,(r.activeObj.activePoint.endX>r.img.destLeft+r.img.destWidth||r.activeObj.activePoint.endY>r.img.destTop+r.img.destHeight)&&(r.activeObj.activePoint.endX+=l.x,r.activeObj.activePoint.endY+=l.y)}else{o=e-r.activeObj.activePoint.endX,i=t-r.activeObj.activePoint.endY,a=Math.max(o,i);l=this.getScaleRatio(a);r.activeObj.activePoint.endX+=l.x,r.activeObj.activePoint.endY+=l.x,(r.activeObj.activePoint.endX>r.img.destLeft+r.img.destWidth||r.activeObj.activePoint.endY>r.img.destTop+r.img.destHeight)&&(r.activeObj.activePoint.endX-=l.x,r.activeObj.activePoint.endY-=l.y)}r.activeObj.activePoint.width=r.activeObj.activePoint.endX-r.activeObj.activePoint.startX,r.activeObj.activePoint.height=r.activeObj.activePoint.endY-r.activeObj.activePoint.startY}}},e.prototype.updateSEPoints=function(e,t,o){var i,a,r,n,s=this.parent,l=this.diffPoint.x,p=this.diffPoint.y,h=sf.base.extend({},s.activeObj,null,!0);if("text"===s.activeObj.shape)void 0===this.oldPoint.x&&void 0===this.oldPoint.y?(this.diffPoint.x=e-s.activeObj.activePoint.endX,this.diffPoint.y=t-s.activeObj.activePoint.endY):(this.diffPoint.x=e-this.oldPoint.x,this.diffPoint.y=t-this.oldPoint.y),this.oldPoint.x=e,this.oldPoint.y=t,n=(this.diffPoint.x>=l&&this.diffPoint.y>=p?Math.max(this.diffPoint.x,this.diffPoint.y):Math.min(this.diffPoint.x,this.diffPoint.y))/10,s.activeObj.activePoint.endX+=o.width/50*n,s.activeObj.activePoint.endY+=o.height/50*n,this.preventTextDraggingInvertly()&&(s.activeObj.activePoint.endX-=o.width/50*n,s.activeObj.activePoint.endY-=o.height/50*n),s.activeObj.activePoint.width=s.activeObj.activePoint.endX-s.activeObj.activePoint.startX,s.activeObj.activePoint.height=s.activeObj.activePoint.endY-s.activeObj.activePoint.startY,s.notify("shape",{prop:"updateFontSize",onPropertyChange:!1,value:{obj:s.activeObj}});else{var c=void 0;if(void 0!==s.activeObj.shape&&(c=s.activeObj.shape.split("-")),"crop-custom"===s.activeObj.shape||void 0!==s.activeObj.shape&&"crop"!==c[0]){if(this.adjustSEPoints(s.activeObj.activePoint,e,t,s.activeObj.rotatedAngle),s.activeObj.activePoint.endX<s.activeObj.activePoint.startX){var d=s.activeObj.activePoint.endX;s.activeObj.activePoint.endX=s.activeObj.activePoint.startX,s.activeObj.activePoint.startX=d,this.dragElement=s.upperCanvas.style.cursor=s.cursor="sw-resize"}if(s.activeObj.activePoint.endY<s.activeObj.activePoint.startY){d=s.activeObj.activePoint.endY;s.activeObj.activePoint.endY=s.activeObj.activePoint.startY,s.activeObj.activePoint.startY=d,this.dragElement=s.upperCanvas.style.cursor=s.cursor="ne-resize"}this.preventDraggingInvertly()}else if(s.activeObj.activePoint.endX>e&&s.activeObj.activePoint.endY>t){i=s.activeObj.activePoint.endX-e,a=s.activeObj.activePoint.endY-t,r=Math.min(i,a);var v=this.getScaleRatio(r);s.activeObj.activePoint.endX-=v.x,s.activeObj.activePoint.endY-=v.y;var u=s.img.destLeft+s.img.destWidth<s.lowerCanvas.width?s.img.destLeft+s.img.destWidth:s.lowerCanvas.width,b=s.img.destTop+s.img.destHeight<s.lowerCanvas.height?s.img.destTop+s.img.destHeight:s.lowerCanvas.height;(s.activeObj.activePoint.endX>u||s.activeObj.activePoint.endY>b)&&(s.activeObj.activePoint.endX+=v.x,s.activeObj.activePoint.endY+=v.y)}else{i=e-s.activeObj.activePoint.endX,a=t-s.activeObj.activePoint.endY,r=Math.max(i,a);v=this.getScaleRatio(r);s.activeObj.activePoint.endX+=v.x,s.activeObj.activePoint.endY+=v.y;u=s.img.destLeft+s.img.destWidth<s.lowerCanvas.width?s.img.destLeft+s.img.destWidth:s.lowerCanvas.width,b=s.img.destTop+s.img.destHeight<s.lowerCanvas.height?s.img.destTop+s.img.destHeight:s.lowerCanvas.height;(s.activeObj.activePoint.endX>u||s.activeObj.activePoint.endY>b)&&(s.activeObj.activePoint.endX-=v.x,s.activeObj.activePoint.endY-=v.y)}s.activeObj.activePoint.width=s.activeObj.activePoint.endX-s.activeObj.activePoint.startX,s.activeObj.activePoint.height=s.activeObj.activePoint.endY-s.activeObj.activePoint.startY,this.preventInverseResize(h)}},e.prototype.adjustNWPoints=function(e,t,o,i){var a=e.startX+e.width/2,r=e.startY+e.height/2,n=this.rotatePoints(e.endX,e.endY,a,r,i),s=[(n[0]+t)/2,(n[1]+o)/2],l=this.rotatePoints(n[0],n[1],s[0],s[1],-i),p=this.rotatePoints(t,o,s[0],s[1],-i);return e.endX=l[0],e.endY=l[1],e.startY=p[1],e.startX=p[0],e.width=e.endX-e.startX,e.height=e.endY-e.startY,e},e.prototype.adjustNEPoints=function(e,t,o,i){var a=e.startX+e.width/2,r=e.startY+e.height/2,n=this.rotatePoints(e.startX,e.endY,a,r,i),s=[(n[0]+t)/2,(n[1]+o)/2],l=this.rotatePoints(n[0],n[1],s[0],s[1],-i),p=this.rotatePoints(t,o,s[0],s[1],-i);return e.startX=l[0],e.endY=l[1],e.width=p[0]-l[0],e.height=l[1]-p[1],e.endX=e.startX+e.width,e.startY=e.endY-e.height,e},e.prototype.adjustSWPoints=function(e,t,o,i){var a=e.startX+e.width/2,r=e.startY+e.height/2,n=this.rotatePoints(e.endX,e.startY,a,r,i),s=[(n[0]+t)/2,(n[1]+o)/2],l=this.rotatePoints(n[0],n[1],s[0],s[1],-i),p=this.rotatePoints(t,o,s[0],s[1],-i);return e.endX=l[0],e.startY=l[1],e.startX=p[0],e.endY=p[1],e.width=e.endX-e.startX,e.height=e.endY-e.startY,e},e.prototype.adjustSEPoints=function(e,t,o,i){var a=e.startX+e.width/2,r=e.startY+e.height/2,n=this.rotatePoints(e.startX,e.startY,a,r,i),s=[(n[0]+t)/2,(n[1]+o)/2],l=this.rotatePoints(n[0],n[1],s[0],s[1],-i),p=this.rotatePoints(t,o,s[0],s[1],-i);return e.startX=l[0],e.startY=l[1],e.width=p[0]-l[0],e.height=p[1]-l[1],e.endX=e.startX+e.width,e.endY=e.startY+e.height,e},e.prototype.adjustRotationPoints=function(e,t,o,i){var a=e.startX+e.width/2,r=e.startY+e.height/2;this.getResizeDirection(e,t,o,i);var n=this.rotatePoints(e.startX,e.startY,a,r,i),s=this.rotatePoints(e.endX,e.startY,a,r,i),l=this.rotatePoints(e.endX,e.endY,a,r,i),p=this.rotatePoints(e.startX,e.endY,a,r,i),h=[(n[0]+l[0])/2,(n[1]+l[1])/2],c=this.rotatePoints(n[0],n[1],h[0],h[1],-i),d=this.rotatePoints(p[0],p[1],h[0],h[1],-i),v=this.rotatePoints(s[0],s[1],h[0],h[1],-i);return e.startX=c[0],e.startY=c[1],e.endX=v[0],e.endY=d[1],e.width=e.endX-e.startX,e.height=e.endY-e.startY,e},e.prototype.rotatePoints=function(e,t,o,i,a){return[(e-o)*Math.cos(a)-(t-i)*Math.sin(a)+o,(e-o)*Math.sin(a)+(t-i)*Math.cos(a)+i]},e.prototype.setResizedValue=function(e,t,o,i){switch(e){case"x":t+=o;break;case"y":t+=i;break;case"abs-x":t+=o>0?-o:Math.abs(o);break;case"abs-y":t+=i>0?-i:Math.abs(i);break;case"y-abs-x":t+=i+(o>0?-o:Math.abs(o))/2;break;case"abs-x-abs-y":t+=(o>0?-o:Math.abs(o))+(i>0?-i:Math.abs(i))/2;break;case"abs-y-x":t+=(i>0?-i:Math.abs(i))+o/2;break;case"x-y":t+=o+i/2}return t},e.prototype.getResizeDirection=function(e,t,o,i){var a=i*(180/Math.PI),r=this.getResizedElement(a,this.resizedElement);"e-resize"===this.resizedElement?(e.width=this.setResizedValue(r,e.width,t,o),e.endX=e.width+e.startX):"n-resize"===this.resizedElement?(e.startY=this.setResizedValue(r,e.startY,t,o),e.height=e.endY-e.startY):"w-resize"===this.resizedElement?(e.startX=this.setResizedValue(r,e.startX,t,o),e.width=e.startX+e.endX):"s-resize"===this.resizedElement&&(e.height=this.setResizedValue(r,e.height,t,o),e.endY=e.height+e.startY)},e.prototype.getResizedElement=function(e,t){var o=[];"n-resize"===t?o=[[337.5,360,"y"],[0,22.5,"y"],[22.5,67.5,"y-abs-x"],[67.5,112.5,"abs-x"],[112.5,157.5,"abs-x-abs-y"],[157.5,202.5,"abs-y"],[202.5,247.5,"abs-y-x"],[247.5,292.5,"x"],[292.5,337.5,"x-y"]]:"e-resize"===t?o=[[337.5,360,"x"],[0,22.5,"x"],[22.5,67.5,"x-y"],[67.5,112.5,"y"],[112.5,157.5,"y-abs-x"],[157.5,202.5,"abs-x"],[202.5,247.5,"abs-x-abs-y"],[247.5,292.5,"abs-y"],[292.5,337.5,"abs-y-x"]]:"s-resize"===t?o=[[337.5,360,"y"],[0,22.5,"y"],[22.5,67.5,"y-abs-x"],[67.5,112.5,"abs-x"],[112.5,157.5,"abs-x-abs-y"],[157.5,202.5,"abs-y"],[202.5,247.5,"abs-y-x"],[247.5,292.5,"x"],[292.5,337.5,"x-y"]]:"w-resize"===t&&(o=[[337.5,360,"x"],[0,22.5,"x"],[22.5,67.5,"x-y"],[67.5,112.5,"y"],[112.5,157.5,"y-abs-x"],[157.5,202.5,"abs-x"],[202.5,247.5,"abs-x-abs-y"],[247.5,292.5,"abs-y"],[292.5,337.5,"abs-y-x"]]);for(var i=e<0?360-Math.abs(e):e,a=0,r=o;a<r.length;a++){var n=r[a],s=n[0],l=n[1],p=n[2];if(i>s&&i<=l||i+360>s&&i+360<=l)return p}return t},e.prototype.updateCursorStyles=function(e,t,o){var i=this.parent,a=!1;""===i.activeObj.keyHistory||void 0!==i.activeObj.shape||i.currObjType.isCustomCrop||i.currObjType.isLine||!i.currObjType.isText||(i.activeObj.shape="text");var r=sf.base.extend({},i.activeObj,{},!0);if(!sf.base.isNullOrUndefined(r.topLeftCircle)){var n;if((n=0===r.shapeDegree?i.transform.degree:i.transform.degree-r.shapeDegree)<0&&(n=360+n),this.isObjSelected)if("line"===r.shape||"arrow"===r.shape)a=this.updateCursorStylesForLineArrow(e,t,r);else if("path"===r.shape)a=this.updateCursorStylesForPath(e,t,r);else if(r.rotatedAngle)this.setCursorForRotatedObject(r,e,t,i.upperCanvas),"grabbing"===i.cursor?(i.upperCanvas.style.cursor=this.parent.cursor="grabbing",this.dragElement=i.cursor):"move"===i.cursor?(this.dragPoint.startX=this.previousPoint.x=this.dragPoint.endX=e,this.dragPoint.startY=this.previousPoint.y=this.dragPoint.endY=t):"default"!==i.cursor&&(a=!0,this.dragElement=i.cursor,i.currObjType.isResize=!0);else{var s=this.getTransRotationPoint(r);e>=r.topLeftCircle.startX-2*r.topLeftCircle.radius&&e<=r.topLeftCircle.startX+2*r.topLeftCircle.radius&&t>=r.topLeftCircle.startY-2*r.topLeftCircle.radius&&t<=r.topLeftCircle.startY+2*r.topLeftCircle.radius&&"nw-resize"!==this.dragElement?(r.topLeftCircle.startX=r.topLeftCircle.startY=0,i.upperCanvas.style.cursor=i.cursor="nw-resize",a=!0,this.dragElement=i.upperCanvas.style.cursor):e>=r.topLeftCircle.startX-2*r.topLeftCircle.radius&&e<=r.topRightCircle.startX-2*r.topLeftCircle.radius&&t>=r.topCenterCircle.startY-2*r.topLeftCircle.radius&&t<=r.topCenterCircle.startY+2*r.topLeftCircle.radius&&"n-resize"!==this.dragElement?(r.topCenterCircle.startX=r.topCenterCircle.startY=0,i.upperCanvas.style.cursor=i.cursor="n-resize",a=!0,this.dragElement=i.upperCanvas.style.cursor):e>=r.topRightCircle.startX-2*r.topLeftCircle.radius&&e<=r.topRightCircle.startX+2*r.topLeftCircle.radius&&t>=r.topRightCircle.startY-2*r.topLeftCircle.radius&&t<=r.topRightCircle.startY+2*r.topLeftCircle.radius&&"ne-resize"!==this.dragElement?(r.topRightCircle.startX=r.topRightCircle.startY=0,i.upperCanvas.style.cursor=i.cursor="ne-resize",a=!0,this.dragElement=i.upperCanvas.style.cursor):e>=r.centerLeftCircle.startX-2*r.topLeftCircle.radius&&e<=r.centerLeftCircle.startX+2*r.topLeftCircle.radius&&t>=r.topLeftCircle.startY-2*r.topLeftCircle.radius&&t<=r.bottomLeftCircle.startY-2*r.topLeftCircle.radius&&"w-resize"!==this.dragElement?(r.centerLeftCircle.startX=r.centerLeftCircle.startY=0,i.upperCanvas.style.cursor=i.cursor="w-resize",a=!0,this.dragElement=i.upperCanvas.style.cursor):e>=r.centerRightCircle.startX-2*r.topLeftCircle.radius&&e<=r.centerRightCircle.startX+2*r.topLeftCircle.radius&&t>=r.topRightCircle.startY-2*r.topLeftCircle.radius&&t<=r.bottomRightCircle.startY-2*r.topLeftCircle.radius&&"e-resize"!==this.dragElement?(r.centerRightCircle.startX=r.centerRightCircle.startY=0,i.upperCanvas.style.cursor=i.cursor="e-resize",a=!0,this.dragElement=i.upperCanvas.style.cursor):e>=r.bottomLeftCircle.startX-2*r.topLeftCircle.radius&&e<=r.bottomLeftCircle.startX+2*r.topLeftCircle.radius&&t>=r.bottomLeftCircle.startY-2*r.topLeftCircle.radius&&t<=r.bottomLeftCircle.startY+2*r.topLeftCircle.radius&&"sw-resize"!==this.dragElement?(r.bottomLeftCircle.startX=r.bottomLeftCircle.startY=0,i.upperCanvas.style.cursor=i.cursor="sw-resize",a=!0,this.dragElement=i.upperCanvas.style.cursor):e>=r.bottomLeftCircle.startX-2*r.topLeftCircle.radius&&e<=r.bottomRightCircle.startX-2*r.topLeftCircle.radius&&t>=r.bottomCenterCircle.startY-2*r.topLeftCircle.radius&&t<=r.bottomCenterCircle.startY+2*r.topLeftCircle.radius&&"s-resize"!==this.dragElement?(r.bottomCenterCircle.startX=r.bottomCenterCircle.startY=0,i.upperCanvas.style.cursor=i.cursor="s-resize",a=!0,this.dragElement=i.upperCanvas.style.cursor):e>=r.bottomRightCircle.startX-2*r.topLeftCircle.radius&&e<=r.bottomRightCircle.startX+2*r.topLeftCircle.radius&&t>=r.bottomRightCircle.startY-2*r.topLeftCircle.radius&&t<=r.bottomRightCircle.startY+2*r.topLeftCircle.radius&&"se-resize"!==this.dragElement?(r.bottomRightCircle.startX=r.bottomRightCircle.startY=0,i.upperCanvas.style.cursor=i.cursor="se-resize",a=!0,this.dragElement=i.upperCanvas.style.cursor):s&&e>=s.x-2*r.topLeftCircle.radius&&e<=s.x+2*r.topLeftCircle.radius&&t>=s.y-2*r.topLeftCircle.radius&&t<=s.y+2*r.topLeftCircle.radius&&"grabbing"!==this.dragElement?(i.upperCanvas.style.cursor=i.cursor="grabbing",this.dragElement=i.upperCanvas.style.cursor):(this.dragPoint.startX=this.previousPoint.x=this.dragPoint.endX=e,this.dragPoint.startY=this.previousPoint.y=this.dragPoint.endY=t),"text"!==r.shape||"n-resize"!==i.cursor&&"s-resize"!==i.cursor&&"e-resize"!==i.cursor&&"w-resize"!==i.cursor||(i.upperCanvas.style.cursor=i.cursor="move",this.dragElement="",this.dragPoint.startX=this.previousPoint.x=this.dragPoint.endX=e,this.dragPoint.startY=this.previousPoint.y=this.dragPoint.endY=t)}else this.dragPoint.startX=this.previousPoint.x=this.dragPoint.endX=e,this.dragPoint.startY=this.previousPoint.y=this.dragPoint.endY=t;this.previousPoint.x=this.previousPoint.y=this.diffPoint.x=this.diffPoint.y=0,"touchstart"===o?a||e>=r.activePoint.startX&&e<=r.activePoint.endX&&t>=r.activePoint.startY&&t<=r.activePoint.endY||"grabbing"===this.dragElement?i.currObjType.isDragging=!0:"line"===r.shape||"arrow"===r.shape?(this.setCursorForLineArrow(r,e,t,i.upperCanvas),"move"===i.cursor&&(i.currObjType.isDragging=!0)):"path"===r.shape&&(this.setCursorForPath(r,e,t,i.upperCanvas),"move"===i.cursor&&(i.currObjType.isDragging=!0)):i.currObjType.isDragging=!0,0===r.rotatedAngle||"e-resize"!==this.dragElement&&"w-resize"!==this.dragElement&&"n-resize"!==this.dragElement&&"s-resize"!==this.dragElement||(this.dragPoint.startX=this.previousPoint.x=this.dragPoint.endX=e,this.dragPoint.startY=this.previousPoint.y=this.dragPoint.endY=t)}},e.prototype.updateCursorStylesForLineArrow=function(e,t,o){for(var i,a=!1,r=this.parent,n=0;n<5;n++)if(e>=(i=o.pointColl[n]).x-2*o.topLeftCircle.radius&&e<=i.x+2*o.topLeftCircle.radius&&t>=i.y-2*o.topLeftCircle.radius&&t<=i.y+2*o.topLeftCircle.radius){o.centerLeftCircle.startX=o.centerLeftCircle.startY=0,this.dragElement="w-resize",a=!0;break}if(!a)for(n=1;n<6;n++)if(e>=(i=o.pointColl[o.pointColl.length-n]).x-2*o.topLeftCircle.radius&&e<=i.x+2*o.topLeftCircle.radius&&t>=i.y-2*o.topLeftCircle.radius&&t<=i.y+2*o.topLeftCircle.radius){o.centerRightCircle.startX=o.centerRightCircle.startY=0,this.dragElement="e-resize",a=!0;break}if(!a)for(n=0;n<o.pointColl.length;n++){if(e>=(i=o.pointColl[n]).x-2*o.topLeftCircle.radius&&e<=i.x+2*o.topLeftCircle.radius&&t>=i.y-2*o.topLeftCircle.radius&&t<=i.y+2*o.topLeftCircle.radius){r.upperCanvas.style.cursor=r.cursor="move",this.dragPoint.startX=this.previousPoint.x=this.dragPoint.endX=e,this.dragPoint.startY=this.previousPoint.y=this.dragPoint.endY=t;break}r.upperCanvas.style.cursor=r.cursor="default"}return a},e.prototype.updateCursorStylesForPath=function(e,t,o){var i=!1;return this.pathAdjustedIndex=this.setCursorForLineArrow(o,e,t,this.parent.upperCanvas),"move"===this.parent.cursor&&(i=!0,this.dragElement="pathDrag"),i||(this.parent.upperCanvas.style.cursor=this.parent.cursor="move",this.dragPoint.startX=this.previousPoint.x=this.dragPoint.endX=e,this.dragPoint.startY=this.previousPoint.y=this.dragPoint.endY=t),i},e.prototype.setTextSelection=function(e,t){var o=this.parent,i=o.transform.degree;(i=0===o.activeObj.shapeDegree?o.transform.degree:o.transform.degree-o.activeObj.shapeDegree)<0&&(i=360+i);for(var a=0,r=o.activeObj.flipObjColl.length;a<r;a++){var n=o.activeObj.flipObjColl[a].toLowerCase();switch(i){case 0:switch(n){case"horizontal":o.activeObj.activePoint={startX:o.activeObj.activePoint.endX-e,startY:o.activeObj.activePoint.startY,endX:o.activeObj.activePoint.endX,endY:o.activeObj.activePoint.startY+(t||0)};break;case"vertical":o.activeObj.activePoint.startY=o.activeObj.activePoint.endY-t,o.activeObj.activePoint={startX:o.activeObj.activePoint.startX,startY:o.activeObj.activePoint.startY,endX:o.activeObj.activePoint.startX+(e||0),endY:o.activeObj.activePoint.endY};break;default:o.activeObj.activePoint={startX:o.activeObj.activePoint.startX,startY:o.activeObj.activePoint.startY,endX:o.activeObj.activePoint.startX+(e||0),endY:o.activeObj.activePoint.startY+(t||0)}}break;case 90:switch(n){case"horizontal":o.activeObj.activePoint.endX=o.activeObj.activePoint.startX+t,o.activeObj.activePoint={startX:o.activeObj.activePoint.startX,startY:o.activeObj.activePoint.startY,endX:o.activeObj.activePoint.endX,endY:o.activeObj.activePoint.startY+(e||0)};break;case"vertical":o.activeObj.activePoint.startX=o.activeObj.activePoint.endX-t,o.activeObj.activePoint={startX:o.activeObj.activePoint.startX,startY:o.activeObj.activePoint.endY-e,endX:o.activeObj.activePoint.endX,endY:o.activeObj.activePoint.endY};break;default:o.activeObj.activePoint.startX=o.activeObj.activePoint.endX-t,o.activeObj.activePoint={startX:o.activeObj.activePoint.startX,startY:o.activeObj.activePoint.startY,endX:o.activeObj.activePoint.endX,endY:o.activeObj.activePoint.startY+(e||0)}}break;case 180:switch(n){case"horizontal":o.activeObj.activePoint.startY=o.activeObj.activePoint.endY-t,o.activeObj.activePoint={startX:o.activeObj.activePoint.startX,startY:o.activeObj.activePoint.startY,endX:o.activeObj.activePoint.startX+e,endY:o.activeObj.activePoint.endY};break;case"vertical":o.activeObj.activePoint.endY=o.activeObj.activePoint.startY+t,o.activeObj.activePoint={endX:o.activeObj.activePoint.endX,endY:o.activeObj.activePoint.endY,startX:o.activeObj.activePoint.endX-(e||0),startY:o.activeObj.activePoint.startY};break;default:o.activeObj.activePoint={endX:o.activeObj.activePoint.endX,endY:o.activeObj.activePoint.endY,startX:o.activeObj.activePoint.endX-(e||0),startY:o.activeObj.activePoint.endY-(t||0)}}break;case 270:switch(n){case"horizontal":o.activeObj.activePoint.startX=o.activeObj.activePoint.endX-t,o.activeObj.activePoint={startX:o.activeObj.activePoint.startX,startY:o.activeObj.activePoint.endY-(e||0),endX:o.activeObj.activePoint.endX,endY:o.activeObj.activePoint.endY};break;case"vertical":o.activeObj.activePoint={startX:o.activeObj.activePoint.startX,startY:o.activeObj.activePoint.startY,endX:o.activeObj.activePoint.startX+t,endY:o.activeObj.activePoint.startY+(e||0)};break;default:o.activeObj.activePoint.endX=o.activeObj.activePoint.startX+t,o.activeObj.activePoint={startX:o.activeObj.activePoint.startX,startY:o.activeObj.activePoint.endY-(e||0),endX:o.activeObj.activePoint.endX,endY:o.activeObj.activePoint.endY}}}}if(0===o.activeObj.flipObjColl.length)switch(i){case 0:o.activeObj.activePoint={startX:o.activeObj.activePoint.startX,startY:o.activeObj.activePoint.startY,endX:o.activeObj.activePoint.startX+(e||0),endY:o.activeObj.activePoint.startY+(t||0)};break;case 90:o.activeObj.activePoint.startX=o.activeObj.activePoint.endX-t,o.activeObj.activePoint={startX:o.activeObj.activePoint.startX,startY:o.activeObj.activePoint.startY,endX:o.activeObj.activePoint.endX,endY:o.activeObj.activePoint.startY+(e||0)};break;case 180:o.activeObj.activePoint={endX:o.activeObj.activePoint.endX,endY:o.activeObj.activePoint.endY,startX:o.activeObj.activePoint.endX-(e||0),startY:o.activeObj.activePoint.endY-(t||0)};break;case 270:o.activeObj.activePoint.endX=o.activeObj.activePoint.startX+t,o.activeObj.activePoint={startX:o.activeObj.activePoint.startX,startY:o.activeObj.activePoint.endY-(e||0),endX:o.activeObj.activePoint.endX,endY:o.activeObj.activePoint.endY}}o.activeObj.activePoint.width=o.activeObj.activePoint.endX-o.activeObj.activePoint.startX,o.activeObj.activePoint.height=o.activeObj.activePoint.endY-o.activeObj.activePoint.startY,360!==o.transform.degree&&-360!==o.transform.degree||(o.transform.degree=0)},e.prototype.setActivePoint=function(e,t){var o=this.parent;if(!sf.base.isNullOrUndefined(o.activeObj.activePoint))if(o.currObjType.isText){var i=e||0,a=t||o.activeObj.textSettings.fontSize;void 0===o.activeObj.textSettings.fontSize&&(o.activeObj.textSettings.fontSize=.1*Math.abs(o.baseImg.width-o.baseImg.height)),this.setTextSelection(i,a),this.mouseDownPoint.x=o.activeObj.activePoint.endX,this.mouseDownPoint.y=o.activeObj.activePoint.endY,void 0!==o.activeObj.horTopLine&&(o.activeObj.activePoint=sf.base.extend({},o.activeObj.activePoint,{},!0)),o.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}})}else if(e&&t)o.activeObj.activePoint.startX=this.mouseDownPoint.x=e,o.activeObj.activePoint.startY=this.mouseDownPoint.y=t,o.currObjType.isDragging=!0;else{var r=o.activeObj;o.activeObj.activePoint={startX:r.horTopLine.startX,startY:r.horTopLine.startY,endX:r.horTopLine.endX,endY:r.horTopLine.endY},o.activeObj.activePoint.width=o.activeObj.activePoint.endX-o.activeObj.activePoint.startX,o.activeObj.activePoint.height=o.activeObj.activePoint.endY-o.activeObj.activePoint.startY}},e.prototype.mouseDownEventHandler=function(e){var t=this,o=this.parent;if("touchstart"===e.type?this.isTouch=!0:this.isTouch=!1,"touchstart"!==e.type||e.currentTarget!==o.lowerCanvas||o.isImageLoaded){var i;this.isCropSelection=!1,this.isPan=!0,void 0!==o.activeObj.shape&&(i=o.activeObj.shape.split("-")),void 0!==i&&"crop"===i[0]&&(this.isCropSelection=!0),this.isCropSelection&&(this.dragCanvas=o.togglePan=!0);var a={point:this.setXYPoints(e)};sf.base.isBlazor()&&o.events&&!0===o.events.clicked.hasDelegate?o.dotNetRef.invokeMethodAsync("ClickEventAsync","click",a).then((function(o){t.clickEvent(o,e)})):(o.trigger("click",a),this.clickEvent(a,e))}},e.prototype.getImagePoints=function(e,t){var o=this.parent;return e<o.img.destLeft?e=o.img.destLeft:e>o.img.destLeft+o.img.destWidth&&(e=o.img.destLeft+o.img.destWidth),t<o.img.destTop?t=o.img.destTop:t>o.img.destTop+o.img.destHeight&&(t=o.img.destTop+o.img.destHeight),{x:e,y:t}},e.prototype.clickEvent=function(e,t){var o=this.parent,i=e.point.x,a=e.point.y,r=o.activeObj.shape&&"text"===o.activeObj.shape?o.cursor:"default";if(""!==this.currentDrawingShape){var n={currObj:{}};o.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:n}}),this.initialPrevObj=n.currObj,this.initialPrevObj.objColl=sf.base.extend([],o.objColl,[],!0),this.initialPrevObj.pointColl=sf.base.extend([],o.pointColl,[],!0),this.initialPrevObj.afterCropActions=sf.base.extend([],o.afterCropActions,[],!0);var s={selPointColl:null};if(o.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:s}}),this.initialPrevObj.selPointColl=sf.base.extend([],s.selPointColl,[],!0),this.setActivePoint(i,a),"path"===this.currentDrawingShape){var l=this.getImagePoints(i,a);o.activeObj.pointColl.push({x:l.x,y:l.y}),0!==o.activeObj.activePoint.width&&0!==o.activeObj.activePoint.height&&(o.activeObj.activePoint.width=0,o.activeObj.activePoint.height=0,o.activeObj.activePoint.startX=o.activeObj.pointColl[o.activeObj.pointColl.length-1].x,o.activeObj.activePoint.startY=o.activeObj.pointColl[o.activeObj.pointColl.length-1].y)}return o.activeObj.activePoint.endX=o.activeObj.activePoint.startX,o.activeObj.activePoint.endY=o.activeObj.activePoint.startY,void(o.currObjType.isDragging=!0)}this.isCropSelection&&this.dragCanvas&&(this.setCursor(i,a),"move"!==o.cursor&&"crosshair"!==o.cursor&&"default"!==o.cursor&&"grab"!==o.cursor&&(this.isPan=!1)),o.activeObj.shape?this.isObjSelected=!0:this.isObjSelected=!1;var p={currObj:{}};o.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:p}});var h=p.currObj,c=sf.base.extend({},o.activeObj,null,!0),d=this.isShapeTouch(t,this.isCropSelection),v=this.isFreehandDrawTouch(t,this.isCropSelection),u=d||this.isShapeClick(t,this.isCropSelection),b=this.applyCurrShape(u);if(this.isTouch&&!d&&c.shape&&!this.isCropSelection){this.applyObj(i,a)&&(o.okBtn(!0),o.notify("draw",{prop:"setPrevActObj",onPropertyChange:!1,value:{prevActObj:null}}));var g=sf.base.extend({},o.cropObj,{},!0);o.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:h,previousObjColl:h.objColl,previousPointColl:h.pointColl,previousSelPointColl:h.selPointColl,previousCropObj:g,previousText:null,currentText:null,previousFilter:null,isCircleCrop:o.isCircleCrop}}),b&&o.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}})}if(d||o.togglePen||this.isCropSelection||(sf.base.isBlazor()?o.isImageLoaded&&o.updateToolbar(o.element,"imageLoaded","okBtnClick"):(o.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1}),o.notify("toolbar",{prop:"close-contextual-toolbar",onPropertyChange:!1}))),!this.dragCanvas||!this.isPan||"grab"!==o.cursor&&!this.isTouch||d||v||o.togglePen){var f=!1;!o.activeObj.shape||"line"!==o.activeObj.shape&&"arrow"!==o.activeObj.shape||(f=!0);var C=this.setXYPoints(t),m=C.x,y=C.y;this.applyObj(m,y)&&(o.okBtn(!0),b&&o.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),o.notify("draw",{prop:"setPrevActObj",onPropertyChange:!1,value:{prevActObj:null}})),o.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:m,y:y,isMouseDown:!0}});var P={index:null};o.notify("freehand-draw",{prop:"getFreehandDrawHoveredIndex",onPropertyChange:!1,value:{obj:P}});var j={freehandSelectedIndex:null};if(o.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:j}}),this.isFhdPoint||this.isFhdCustomized&&!o.togglePen){if(!sf.base.isNullOrUndefined(j.freehandSelectedIndex)&&j.freehandSelectedIndex!==P.index){var O=P.index;if(o.okBtn(),this.isFhdCustomized=!1,o.notify("freehand-draw",{prop:"setFreehandDrawHoveredIndex",onPropertyChange:!1,value:{index:O}}),P.index>-1){var x=o.pointColl[P.index].strokeColor;o.notify("freehand-draw",{prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:x,strokeWidth:o.pointColl[P.index].strokeWidth}})}}if(j.freehandSelectedIndex=null,o.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:j}}),!sf.base.isNullOrUndefined(P.index)&&P.index>-1)o.notify("freehand-draw",{prop:"selectFhd",value:{type:"ok"}}),sf.base.isBlazor()?(o.updateToolbar(o.element,"pen"),o.updateToolbar(o.element,"quickAccessToolbar","pen")):o.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:!0}});else if(j.freehandSelectedIndex){o.okBtn();x=o.pointColl[j.freehandSelectedIndex].strokeColor;o.notify("freehand-draw",{prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:x,strokeWidth:o.pointColl[j.freehandSelectedIndex].strokeWidth}})}}else{if(this.isFhdEditing&&(o.notify("freehand-draw",{prop:"cancelFhd",value:{type:"ok"}}),document.getElementById(o.element.id+"_quickAccessToolbarArea")&&(document.getElementById(o.element.id+"_quickAccessToolbarArea").style.display="none")),sf.base.isBlazor()||o.notify("toolbar",{prop:"close-contextual-toolbar",onPropertyChange:!1}),this.isFhdEditing=!1,f?this.setCursor(m,y):"default"!==r&&(o.upperCanvas.style.cursor=o.cursor=r),"crosshair"===o.cursor||sf.base.Browser.isDevice&&o.togglePen){if(o.togglePen){if(sf.base.isNullOrUndefined(o.activeObj.strokeSettings)){var w={strokeSettings:{}};o.notify("shape",{prop:"getStrokeSettings",onPropertyChange:!1,value:{obj:w}}),o.activeObj.strokeSettings=w.strokeSettings}var S={penStrokeWidth:null};o.notify("freehand-draw",{prop:"getPenStrokeWidth",onPropertyChange:!1,value:{obj:S}}),sf.base.isNullOrUndefined(S.penStrokeWidth)&&o.notify("freehand-draw",{prop:"setPenStrokeWidth",onPropertyChange:!1,value:{value:2}}),this.upperContext.strokeStyle=o.activeObj.strokeSettings.strokeColor,this.upperContext.fillStyle=o.activeObj.strokeSettings.strokeColor,o.notify("freehand-draw",{prop:"freehandDownHandler",onPropertyChange:!1,value:{e:t,canvas:o.upperCanvas}})}else o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height);o.currObjType.isActiveObj=!1,this.dragElement="",this.dragPoint.startX=this.dragPoint.startY=this.dragPoint.endX=this.dragPoint.endY=0}"crosshair"!==o.cursor&&"touchstart"===t.type.toLowerCase()||o.currObjType.isActiveObj&&"default"!==o.cursor&&!o.togglePen?(o.currObjType.isUndoAction&&o.notify("undo-redo",{prop:"refreshUrc",value:{bool:null}}),this.findTarget(m,y,t.type)):""!==o.currObjType.shape&&!o.currObjType.isCustomCrop||o.togglePen||"default"===o.cursor||this.setActivePoint(m,y)}}else this.applyObj(i,a)&&(o.okBtn(!0),b&&o.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),o.notify("draw",{prop:"setPrevActObj",onPropertyChange:!1,value:{prevActObj:null}})),this.isFhdEditing&&(o.notify("freehand-draw",{prop:"applyFhd",onPropertyChange:!1}),this.isFhdCustomized=!1,sf.base.isBlazor()||o.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1})),!o.activeObj.shape||"rectangle"!==o.activeObj.shape&&"ellipse"!==o.activeObj.shape&&"line"!==o.activeObj.shape&&"arrow"!==o.activeObj.shape&&"path"!==o.activeObj.shape&&"text"!==o.activeObj.shape||(o.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),sf.base.isBlazor()?o.updateToolbar(o.element,"imageLoaded"):(o.notify("toolbar",{prop:"setCurrentToolbar",value:{type:"main"}}),o.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1}))),this.canvasMouseDownHandler(t);this.isShapeInserted=!1,this.tempActiveObj=sf.base.extend({},o.activeObj,{},!0)},e.prototype.mouseMoveEventHandler=function(e){var t=this.parent,o=t.cursor,i=t.upperCanvas.style.cursor;e.preventDefault();var r=t.lowerCanvas.getBoundingClientRect();if("touchmove"!==e.type||2!==e.touches.length){var n,s;"mousemove"===e.type?(n=e.clientX,s=e.clientY):(this.touchEndPoint.x=n=e.touches[0].clientX,this.touchEndPoint.y=s=e.touches[0].clientY),n-=r.left,s-=r.top,this.canvasMouseMoveHandler(e);var l,p=!1;void 0!==t.activeObj.shape&&(l=t.activeObj.shape.split("-")),void 0!==l&&"crop"===l[0]&&(p=!0),p&&t.notify("transform",{prop:"disableZoomOutBtn",value:{isZoomOut:!0}}),t.upperCanvas.style.cursor=i,t.cursor=o,(t.currObjType.isActiveObj&&(void 0!==t.activeObj.activePoint||t.objColl.length>0)&&!this.dragCanvas||void 0!==t.activeObj.activePoint)&&""===this.dragElement&&(this.setCursor(n,s),t.activeObj.activePoint&&(0===t.activeObj.activePoint.width||!sf.base.isNullOrUndefined(t.activeObj.currIndex)&&this.cursorTargetId!==t.activeObj.currIndex)&&"default"!==t.cursor&&"move"!==t.cursor&&"crosshair"!==t.cursor&&"grab"!==t.cursor&&"pointer"!==t.cursor&&(t.upperCanvas.style.cursor=t.cursor="move"),this.findTarget(n,s,e.type)),t.currObjType.isDragging&&(this.upperContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),this.updateActivePoint(n,s,p),t.notify("shape",{prop:"updateTrianglePoints",onPropertyChange:!1,value:{obj:t.activeObj}}),this.isPreventDragging?(t.activeObj.activePoint.startX>t.img.destLeft&&t.activeObj.activePoint.endX<t.img.destLeft+t.img.destWidth&&t.activeObj.activePoint.startY>t.img.destTop&&t.activeObj.activePoint.endY<t.img.destTop+t.img.destHeight&&(this.isPreventDragging=!1),t.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:null,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:null}})):t.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:null,isCropRatio:null,points:null,isPreventDrag:null,saveContext:null,isPreventSelection:null}}),p&&(this.dragCanvas=t.togglePan=!0))}else{if(this.isFirstMove)this.startTouches=this.targetTouches(e.touches),this.tempTouches=[],this.tempTouches.push({x:e.touches[0].clientX||e.touches[0].pageX-t.lowerCanvas.offsetLeft-r.left,y:(e.touches[0].clientY||e.touches[0].pageY-t.lowerCanvas.offsetTop)-r.top}),this.tempTouches.push({x:(e.touches[1].clientX||e.touches[1].pageX-t.lowerCanvas.offsetLeft)-r.left,y:(e.touches[1].clientY||e.touches[1].pageY-t.lowerCanvas.offsetTop)-r.top});else{var h=(e.touches[0].clientX||e.touches[0].pageX-t.lowerCanvas.offsetLeft)-r.left,c=(e.touches[0].clientY||e.touches[0].pageY-t.lowerCanvas.offsetTop)-r.top,d=(e.touches[1].clientX||e.touches[1].pageX-t.lowerCanvas.offsetLeft)-r.left,v=(e.touches[1].clientY||e.touches[1].pageY-t.lowerCanvas.offsetTop)-r.top,u={x:h<d?d-(d-h)/2:h-(h-d)/2,y:c<v?v-(v-c)/2:c-(c-v)/2};if(this.currMousePoint.x!==u.x&&this.currMousePoint.y!==u.y){var b="";if("touchmove"===e.type&&(t.zoomSettings.zoomTrigger&a.Pinch)===a.Pinch){this.zoomType="Pinch";var g=this.calculateScale(this.startTouches,this.targetTouches(e.touches));this.startTouches=this.targetTouches(e.touches),g>1?b="zoomIn":g<1&&(b="zoomOut")}""!==b&&t.notify("draw",{prop:"performPointZoom",onPropertyChange:!1,value:{x:u.x,y:u.y,type:b}}),this.tempTouches=[],this.tempTouches.push({x:e.touches[0].clientX||e.touches[0].pageX-t.lowerCanvas.offsetLeft,y:e.touches[0].clientY||e.touches[0].pageY-t.lowerCanvas.offsetTop}),this.tempTouches.push({x:e.touches[1].clientX||e.touches[1].pageX-t.lowerCanvas.offsetLeft,y:e.touches[1].clientY||e.touches[1].pageY-t.lowerCanvas.offsetTop}),this.currMousePoint.x=u.x,this.currMousePoint.y=u.y}}this.isFirstMove=!1}},e.prototype.mouseUpEventHandler=function(e){var t,o,i=this,a=this.parent;"touchstart"===e.type?this.isTouch=!1:"touchend"===e.type&&e.stopImmediatePropagation(),e.preventDefault(),a.togglePan&&this.canvasMouseUpHandler(e),"mouseup"===e.type?(t=e.clientX,o=e.clientY):(t=this.touchEndPoint.x,o=this.touchEndPoint.y);var r=a.lowerCanvas.getBoundingClientRect();t-=r.left,o-=r.top,"touchend"===e.type&&(this.startTouches=this.tempTouches=[],this.isFirstMove=!1,"none"===a.textArea.style.display&&(this.timer=0));var n,s=!1;if(void 0!==a.activeObj.shape&&(n=a.activeObj.shape.split("-")),void 0!==n&&"crop"===n[0]&&(s=!0),sf.base.isBlazor()&&this.parent.eventType){if("pan"===this.parent.eventType)a.events&&!0===a.events.onPanEnd.hasDelegate&&a.dotNetRef.invokeMethodAsync("PanEventAsync","OnPanEnd",this.parent.panEventArgs);else if("resize"===this.parent.eventType){if(!this.isCropSelection&&this.parent.events&&!0===this.parent.events.onShapeResizeEnd.hasDelegate)this.shapeResizingArgs.currentShapeSettings=this.updatePrevShapeSettings(),this.shapeResizingArgs.action="resize-end",this.parent.dotNetRef.invokeMethodAsync("ShapeEventAsync","OnShapeResizeEnd",this.shapeResizingArgs).then((function(e){i.parent.notify("shape",{prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:e.currentShapeSettings}})}));else if(this.shapeResizingArgs&&this.selectionResizingArgs&&this.parent.events&&!0===this.parent.events.onSelectionResizeEnd.hasDelegate){var l={type:this.parent.activeObj.shape,startX:this.shapeResizingArgs.currentShapeSettings.startX,startY:this.shapeResizingArgs.currentShapeSettings.startY,width:this.shapeResizingArgs.currentShapeSettings.width,height:this.shapeResizingArgs.currentShapeSettings.height};this.selectionResizingArgs.currentSelectionSettings=l,this.selectionResizingArgs.action="resize-end",this.parent.dotNetRef.invokeMethodAsync("SelectionEventAsync","OnSelectionResizeEnd",this.selectionResizingArgs).then((function(e){i.parent.notify("shape",{prop:"updateSelectionChangeEventArgs",onPropertyChange:!1,value:{selectionSettings:e.currentSelectionSettings}})}))}}else this.shapeMovingArgs&&this.parent.events&&!0===this.parent.events.onShapeDragEnd.hasDelegate&&(this.shapeMovingArgs.currentShapeSettings=this.updatePrevShapeSettings(),this.shapeMovingArgs.action="drag-end",this.parent.dotNetRef.invokeMethodAsync("ShapeEventAsync","OnShapeDragEnd",this.shapeMovingArgs).then((function(e){i.parent.notify("shape",{prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:e.currentShapeSettings}})})));this.shapeResizingArgs=null,this.shapeMovingArgs=null,this.parent.panEventArgs=null,this.parent.eventType=null}if("path"!==this.currentDrawingShape){if(e.currentTarget===a.upperCanvas){if(this.pathAdjustedIndex=null,""!==this.currentDrawingShape){if("text"===this.currentDrawingShape){var p=sf.base.extend({},a.cropObj,{},!0);a.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:this.initialPrevObj,previousObjColl:this.initialPrevObj.objColl,previousPointColl:this.initialPrevObj.pointColl,previousSelPointColl:this.initialPrevObj.selPointColl,previousCropObj:p,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}})}else a.notify("undo-redo",{prop:"updateUrObj",onPropertyChange:!1,value:{objColl:this.initialPrevObj.objColl}});this.isShapeInserted=!0,this.currentDrawingShape="",0===a.activeObj.activePoint.width&&0===a.activeObj.activePoint.height&&a.notify("draw",{prop:"performCancel",value:{isContextualToolbar:null}})}this.adjustActObjForLineArrow(),this.updPtCollForShpRot(),a.currObjType.shape=a.currObjType.shape.toLowerCase();var h=sf.base.extend({},a.cropObj,{},!0),c={currObj:{}};a.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:c}});var d=c.currObj;d.objColl=sf.base.extend([],a.objColl,[],!0),d.pointColl=sf.base.extend([],a.pointColl,[],!0),d.afterCropActions=sf.base.extend([],a.afterCropActions,[],!0);var v={selPointColl:null};if(a.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:v}}),d.selPointColl=sf.base.extend([],v.selPointColl,[],!0),a.togglePen||s||(this.tempObjColl&&0!==a.activeObj.activePoint.width&&(a.objColl.push(a.activeObj),JSON.stringify(a.activeObj.activePoint)!==JSON.stringify(this.tempActiveObj.activePoint)&&a.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:d,previousObjColl:this.tempObjColl,previousPointColl:d.pointColl,previousSelPointColl:d.selPointColl,previousCropObj:h,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.redrawShape(a.objColl[a.objColl.length-1],!0),this.tempObjColl=void 0),this.isFhdEditing||(this.applyCurrActObj(t,o),a.currObjType.isResize=!1)),a.activeObj){var u,b=!1;if(void 0!==a.activeObj.shape&&(u=a.activeObj.shape.split("-")),(void 0===u&&(a.currObjType.isCustomCrop||a.togglePen)||void 0!==u&&"crop"===u[0])&&(b=!0),sf.base.isBlazor())"rectangle"===a.activeObj.shape||"ellipse"===a.activeObj.shape||"line"===a.activeObj.shape||"arrow"===a.activeObj.shape||"path"===a.activeObj.shape?a.updateToolbar(a.element,a.activeObj.shape):"text"===a.activeObj.shape&&a.updateToolbar(a.element,"text");else{if("rectangle"===a.activeObj.shape||"ellipse"===a.activeObj.shape||"line"===a.activeObj.shape||"arrow"===a.activeObj.shape||"path"===a.activeObj.shape)a.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"shapes",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}});else if("text"===a.activeObj.shape)a.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"text",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}});else if(this.isFhdEditing)a.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"pen",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}});else if(!b){a.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:null,isCropping:!1,isZooming:null}})}a.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1})}}}void 0!==a.activeObj.shape&&(n=a.activeObj.shape.split("-")),void 0!==n&&"crop"===n[0]&&(s=!0),a.activeObj.shape&&!s&&e.currentTarget===a.upperCanvas&&"none"===a.textArea.style.display&&("text"===a.activeObj.shape?sf.base.isBlazor()||a.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"text",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}):sf.base.isBlazor()||a.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"shapes",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}),sf.base.isBlazor()?a.updateToolbar(a.element,"quickAccessToolbar",a.activeObj.shape):(a.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1}),a.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}}))),a.togglePen&&e.currentTarget===a.upperCanvas?a.notify("freehand-draw",{prop:"freehandUpHandler",onPropertyChange:!1,value:{e:e,canvas:a.upperCanvas,context:this.upperContext}}):a.currObjType.shape="",this.dragElement="",a.currObjType.isInitialLine=a.currObjType.isDragging=!1,this.selMouseUpEvent()}},e.prototype.adjustActObjForLineArrow=function(e){var t=!1,o=this.parent;if((e=e||o.activeObj).shape&&("line"===e.shape||"arrow"===o.activeObj.shape)){var i=void 0;if(("e-resize"===this.dragElement&&e.activePoint.endX<e.activePoint.startX||"w-resize"===this.dragElement&&e.activePoint.startX>e.activePoint.endX)&&(t=!0,i=e.activePoint.startX,e.activePoint.startX=e.activePoint.endX,e.activePoint.endX=i,i=e.activePoint.startY,e.activePoint.startY=e.activePoint.endY,e.activePoint.endY=i),e.activePoint.width=Math.abs(e.activePoint.endX-e.activePoint.startX),e.activePoint.height=Math.abs(e.activePoint.endY-e.activePoint.startY),"path"!==o.activeObj.shape){o.notify("shape",{prop:"setPointCollForLineArrow",onPropertyChange:!1,value:{obj:e}});for(var a=0;a<e.pointColl.length;a++)e.pointColl[a].ratioX=(e.pointColl[a].x-o.img.destLeft)/o.img.destWidth,e.pointColl[a].ratioY=(e.pointColl[a].y-o.img.destTop)/o.img.destHeight}}return t},e.prototype.updPtCollForShpRot=function(e){var t=this.parent;if((e=e||t.activeObj).shape&&0!==e.rotatedAngle){t.notify("shape",{prop:"setPointCollForShapeRotation",onPropertyChange:!1,value:{obj:e}});for(var o=0;o<e.horTopLinePointColl.length;o++)e.horTopLinePointColl[o].ratioX=(e.horTopLinePointColl[o].x-t.img.destLeft)/t.img.destWidth,e.horTopLinePointColl[o].ratioY=(e.horTopLinePointColl[o].y-t.img.destTop)/t.img.destHeight;for(o=0;o<e.horBottomLinePointColl.length;o++)e.horBottomLinePointColl[o].ratioX=(e.horBottomLinePointColl[o].x-t.img.destLeft)/t.img.destWidth,e.horBottomLinePointColl[o].ratioY=(e.horBottomLinePointColl[o].y-t.img.destTop)/t.img.destHeight;for(o=0;o<e.verLeftLinePointColl.length;o++)e.verLeftLinePointColl[o].ratioX=(e.verLeftLinePointColl[o].x-t.img.destLeft)/t.img.destWidth,e.verLeftLinePointColl[o].ratioY=(e.verLeftLinePointColl[o].y-t.img.destTop)/t.img.destHeight;for(o=0;o<e.verRightLinePointColl.length;o++)e.verRightLinePointColl[o].ratioX=(e.verRightLinePointColl[o].x-t.img.destLeft)/t.img.destWidth,e.verRightLinePointColl[o].ratioY=(e.verRightLinePointColl[o].y-t.img.destTop)/t.img.destHeight}},e.prototype.setXYPoints=function(e){var t,o;e.preventDefault(),"mousedown"===e.type?(t=e.clientX,o=e.clientY):(this.touchEndPoint.x=t=e.touches[0].clientX,this.touchEndPoint.y=o=e.touches[0].clientY);var i=this.parent.lowerCanvas.getBoundingClientRect();return{x:t-=i.left,y:o-=i.top}},e.prototype.getCurrentIndex=function(){for(var e,t=this.parent,o=0;o<t.objColl.length;o++)if(t.activeObj.currIndex===t.objColl[o].currIndex){e=o;break}return e},e.prototype.isShapeClick=function(e,t){var o=this.parent,i=!1;if(o.togglePen)return i;if(o.activeObj.shape&&"text"===o.activeObj.shape&&this.isShapeInserted){var a="block"===o.textArea.style.display,r=sf.base.extend({},o.activeObj,null,!0);o.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:!0}});var n=this.setXYPoints(e),s=n.x,l=n.y;if(i=this.findTargetObj(s,l,t),t||this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),a){o.textArea.value=o.objColl[o.objColl.length-1].keyHistory,o.textArea.style.display="block",o.activeObj=r;var p=this.getCurrentIndex();sf.base.isNullOrUndefined(p)?o.objColl.pop():o.objColl.splice(p,1)}else if(!i&&r.shape){o.activeObj=r;p=this.getCurrentIndex();sf.base.isNullOrUndefined(p)||JSON.stringify(o.activeObj.activePoint)!==JSON.stringify(o.objColl[p].activePoint)?sf.base.isNullOrUndefined(o.activeObj.currIndex)&&o.objColl.pop():o.objColl.splice(p,1)}}return i},e.prototype.isShapeTouch=function(e,t){var o=this.parent,i=!1;if("touchstart"===e.type&&!o.togglePen){o.activeObj&&"text"===o.activeObj.shape&&(this.timer=setTimeout(this.setTimer.bind(this),1e3,e));var a="block"===o.textArea.style.display,r=sf.base.extend({},o.activeObj,null,!0);o.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:!0}});var n=this.setXYPoints(e),s=n.x,l=n.y;if(i=this.findTargetObj(s,l,t),t||this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),a){o.textArea.value=o.objColl[o.objColl.length-1].keyHistory,o.textArea.style.display="block",o.activeObj=r;var p=this.getCurrentIndex();sf.base.isNullOrUndefined(p)?o.objColl.pop():o.objColl.splice(p,1)}else if(!i&&r.shape){o.activeObj=r;p=this.getCurrentIndex();t||(sf.base.isNullOrUndefined(p)||JSON.stringify(o.activeObj.activePoint)!==JSON.stringify(o.objColl[p].activePoint)?sf.base.isNullOrUndefined(o.activeObj.currIndex)&&o.objColl.pop():o.objColl.splice(p,1))}}return i},e.prototype.isFreehandDrawTouch=function(e,t){var o=this.parent,i=!1;if("touchstart"===e.type&&!t&&!o.togglePen){var a="block"===o.textArea.style.display,r=sf.base.extend({},o.activeObj,null,!0);o.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:!0}});var n=this.setXYPoints(e),s=n.x,l=n.y;if(this.setCursor(s,l),this.isFhdPoint&&(i=!0),a){o.textArea.value=o.objColl[o.objColl.length-1].keyHistory,o.textArea.style.display="block",o.activeObj=r;var p=this.getCurrentIndex();sf.base.isNullOrUndefined(p)?o.objColl.pop():o.objColl.splice(p,1)}else if(r.shape){o.activeObj=r;p=this.getCurrentIndex();t||(sf.base.isNullOrUndefined(p)||JSON.stringify(o.activeObj.activePoint)!==JSON.stringify(o.objColl[p].activePoint)?sf.base.isNullOrUndefined(o.activeObj.currIndex)&&o.objColl.pop():o.objColl.splice(p,1))}}return i},e.prototype.applyObj=function(e,t){var o=this.parent,i=!1;return!o.activeObj.shape||"rectangle"!==o.activeObj.shape&&"ellipse"!==o.activeObj.shape&&"text"!==o.activeObj.shape&&"line"!==o.activeObj.shape&&"arrow"!==o.activeObj.shape&&"path"!==o.activeObj.shape||(i=!(e>=o.activeObj.activePoint.startX-2*o.activeObj.topLeftCircle.radius&&e<=o.activeObj.activePoint.endX+2*o.activeObj.topLeftCircle.radius&&t>=o.activeObj.activePoint.startY-2*o.activeObj.topLeftCircle.radius&&t<=o.activeObj.activePoint.endY+2*o.activeObj.topLeftCircle.radius)&&("default"===o.upperCanvas.style.cursor||"grab"===o.upperCanvas.style.cursor||"crosshair"===o.upperCanvas.style.cursor||"pointer"===o.upperCanvas.style.cursor)),i},e.prototype.applyCurrShape=function(e){var t=this.parent,o=!1;if(t.togglePen)return o;var i=sf.base.extend({},t.activeObj,null,!0);if(this.isShapeInserted&&"text"===t.activeObj.shape&&e&&(this.isInitialTextEdited=!0,t.notify("draw",{prop:"setShapeTextInsert",onPropertyChange:!1,value:{bool:!0}})),"block"===t.textArea.style.display){var a=sf.base.extend({},t.activeObj,null,!0);t.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),i=sf.base.extend({},t.objColl[t.objColl.length-1],null,!0),t.objColl.pop(),t.activeObj=sf.base.extend({},a,null,!0),t.textArea.value=i.keyHistory,t.textArea.style.display="block";var r="rgb"===i.strokeSettings.strokeColor.split("(")[0]?this.rgbToHex(parseFloat(i.strokeSettings.strokeColor.split("(")[1].split(",")[0]),parseFloat(i.strokeSettings.strokeColor.split("(")[1].split(",")[1]),parseFloat(i.strokeSettings.strokeColor.split("(")[1].split(",")[2])):i.strokeSettings.strokeColor;"#ffffff"===r&&(r="#fff"),"#ffffff"===this.tempActiveObj.strokeSettings.strokeColor&&(this.tempActiveObj.strokeSettings.strokeColor="#fff"),i.keyHistory===this.tempActiveObj.keyHistory&&r===this.tempActiveObj.strokeSettings.strokeColor&&i.textSettings.fontFamily===this.tempActiveObj.textSettings.fontFamily&&Math.round(i.textSettings.fontSize)===Math.round(this.tempActiveObj.textSettings.fontSize)&&Math.round(i.textSettings.fontRatio)===Math.round(this.tempActiveObj.textSettings.fontRatio)&&i.textSettings.bold===this.tempActiveObj.textSettings.bold&&i.textSettings.italic===this.tempActiveObj.textSettings.italic&&i.textSettings.underline===this.tempActiveObj.textSettings.underline||(o=!0),this.isInitialTextEdited&&!o&&(o=!0,this.isInitialTextEdited=!1)}else this.tempActiveObj.activePoint.height=Math.abs(this.tempActiveObj.activePoint.height),o=JSON.stringify(i)!==JSON.stringify(this.tempActiveObj);return o},e.prototype.canvasMouseDownHandler=function(e){var t,o,i=this.parent;e.preventDefault(),"mousedown"===e.type?(t=e.offsetX||e.pageX-i.lowerCanvas.offsetLeft,o=e.offsetY||e.pageY-i.lowerCanvas.offsetTop):(t=e.touches[0].clientX||e.touches[0].pageX-i.lowerCanvas.offsetLeft,o=e.touches[0].clientY||e.touches[0].pageY-i.lowerCanvas.offsetTop);var a=i.lowerCanvas.getBoundingClientRect();t-=a.left,o-=a.top,this.panDown={x:t,y:o};var r={tempPanMove:null};i.notify("transform",{prop:"getTempPanMove",onPropertyChange:!1,value:{obj:r}}),sf.base.isNullOrUndefined(r.tempPanMove)&&i.notify("transform",{prop:"setTempPanMove",onPropertyChange:!1,value:{point:{x:t,y:o}}})},e.prototype.canvasMouseMoveHandler=function(e){var t,o,i=this.parent;this.dragCanvas?i.lowerCanvas.style.cursor="grab":(this.dragCanvas=i.togglePan=!1,i.lowerCanvas.style.cursor=i.upperCanvas.style.cursor=i.cursor="default"),"mousemove"===e.type?(t=e.offsetX,o=e.offsetY):(t=e.touches[0].clientX||e.touches[0].pageX-i.lowerCanvas.offsetLeft,o=e.touches[0].clientY||e.touches[0].pageY-i.lowerCanvas.offsetTop);var a=i.lowerCanvas.getBoundingClientRect(),r={x:t-=a.left,y:o-=a.top};i.notify("transform",{prop:"setPanMove",onPropertyChange:!1,value:{point:{x:t,y:o}}}),this.panDown&&r&&i.togglePan&&this.dragCanvas&&i.notify("transform",{prop:"drawPannedImage",onPropertyChange:!1,value:{xDiff:null,yDiff:null}})},e.prototype.canvasMouseUpHandler=function(e){var t=this.parent;e.preventDefault();var o={panMove:null};t.notify("transform",{prop:"getPanMove",onPropertyChange:!1,value:{obj:o}}),t.togglePan&&this.panDown&&o.panMove&&t.togglePan&&this.dragCanvas&&(this.panDown=null,t.notify("transform",{prop:"setPanMove",onPropertyChange:!1,value:{point:null}}),t.notify("transform",{prop:"setTempPanMove",onPropertyChange:!1,value:{point:null}})),"path"!==this.currentDrawingShape&&(t.currObjType.isDragging=!1)},e.prototype.touchStartHandler=function(e){e.preventDefault(),0===this.touchTime?this.touchTime=(new Date).getTime():(new Date).getTime()-this.touchTime<400?(this.parent.notify("shape",{prop:"stopPathDrawing",onPropertyChange:!1,value:{e:e}}),this.touchTime=0):this.touchTime=(new Date).getTime(),2===e.touches.length?this.isFirstMove=!0:this.mouseDownEventHandler(e),sf.base.EventHandler.add(this.parent.lowerCanvas,"touchend",this.mouseUpEventHandler,this),sf.base.EventHandler.add(this.parent.lowerCanvas,"touchmove",this.mouseMoveEventHandler,this),sf.base.EventHandler.add(this.parent.upperCanvas,"touchend",this.mouseUpEventHandler,this),sf.base.EventHandler.add(this.parent.upperCanvas,"touchmove",this.mouseMoveEventHandler,this)},e.prototype.keyDownEventHandler=function(e){var t=this,o=this.parent;!e.ctrlKey||"+"!==e.key&&"-"!==e.key||e.preventDefault();var i={fileName:"",fileType:null};o.notify("draw",{prop:"getFileName",onPropertyChange:!1,value:{obj:i}});var r,n={fileName:i.fileName,fileType:i.fileType,cancel:!1};switch(e.key){case e.ctrlKey&&"s":sf.base.isBlazor()&&o.events&&!0===o.events.saving.hasDelegate?o.dotNetRef.invokeMethodAsync("BeforeSaveEventAsync","BeforeSave",n).then((function(o){t.beforeSaveEvent(o,e)})):(o.trigger("beforeSave",n),this.beforeSaveEvent(n,e));break;case e.ctrlKey&&"z":o.allowUndoRedo&&o.notify("undo-redo",{prop:"call-undo"});break;case e.ctrlKey&&"y":o.allowUndoRedo&&o.notify("undo-redo",{prop:"call-redo"});break;case e.ctrlKey&&"+":(o.zoomSettings.zoomTrigger&a.Commands)===a.Commands&&(this.zoomType="Commands",o.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:.1,zoomPoint:null}}));break;case e.ctrlKey&&"-":(o.zoomSettings.zoomTrigger&a.Commands)===a.Commands&&(this.zoomType="Commands",o.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.1,zoomPoint:null}}));break;case"Delete":this.deleteItem();break;case"Escape":o.notify("draw",{prop:"performCancel",value:{isContextualToolbar:null}});break;case"Enter":o.activeObj.shape&&(r=o.activeObj.shape.split("-")),this.isKeyBoardCrop(e)&&o.activeObj.horTopLine&&o.activeObj.shape&&"crop"===r[0]&&o.crop();break;case"Tab":this.performTabAction();break;default:sf.base.Browser.isDevice&&"block"===o.textArea.style.display&&setTimeout(this.textKeyDown.bind(this),1,e)}},e.prototype.isKeyBoardCrop=function(e){var t=!1,o=e.target;return o.id!==this.parent.element.id+"_ok"&&""!==o.id||sf.base.isBlazor()||(t=!0),t},e.prototype.beforeSaveEvent=function(e,t){var o=this.parent;e.cancel||o.notify("export",{prop:"export",onPropertyChange:!1,value:{type:e.fileType,fileName:e.fileName}}),t.preventDefault(),t.stopImmediatePropagation()},e.prototype.handleScroll=function(e){var t,o,i=this.parent,r=!1;"mousewheel"===e.type&&(t=e.clientX,o=e.clientY);var n=i.lowerCanvas.getBoundingClientRect();if(t-=n.left,o-=n.top,t>i.img.destLeft&&t<i.img.destLeft+i.img.destWidth&&o>i.img.destTop&&o<i.img.destTop+i.img.destHeight&&(r=!0),e.stopPropagation(),!0===e.ctrlKey&&r){e.preventDefault(),!i.isCropTab&&i.activeObj.shape&&"crop"!==i.activeObj.shape.split("-")[0]&&(i.okBtn(),sf.base.isBlazor()||i.notify("toolbar",{prop:"close-contextual-toolbar",onPropertyChange:!1}));var s="";"mousewheel"===e.type&&(i.zoomSettings.zoomTrigger&a.MouseWheel)===a.MouseWheel&&(this.zoomType="MouseWheel",s=e.wheelDelta>0?"zoomIn":"zoomOut"),""!==s&&i.notify("draw",{prop:"performPointZoom",onPropertyChange:!1,value:{x:t,y:o,type:s}})}},e.prototype.textKeyDown=function(e){var t=this.parent;"\r"===String.fromCharCode(e.which)&&(this.textRow+=1),t.textArea.setAttribute("rows",this.textRow.toString()),t.textArea.style.height="auto",t.textArea.style.height=t.textArea.scrollHeight+"px",t.notify("shape",{prop:"setTextBoxWidth",onPropertyChange:!1,value:{e:e}}),sf.base.Browser.isDevice&&(t.textArea.style.width=parseFloat(t.textArea.style.width)+t.textArea.style.fontSize+"px");var o=t.textArea.value.split("\n");this.textRow=o.length,t.textArea.setAttribute("rows",this.textRow.toString()),this.isInitialTextEdited=!1},e.prototype.clearSelection=function(){var e=this.parent;!e.disabled&&e.isImageLoaded&&(e.togglePen=!1,e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.dragElement="",this.dragPoint.startX=this.dragPoint.startY=this.dragPoint.endX=this.dragPoint.endY=0,e.currObjType.shape="",this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.currObjType.isActiveObj=!0,e.currObjType.isCustomCrop=!1,e.upperCanvas.style.cursor=e.cursor="default")},e.prototype.setDragDirection=function(e,t){var o=this.parent;o.img.destWidth>o.img.destHeight?(o.activeObj.activePoint.startX=this.dragPoint.startX=e/2-t/2+7.5,o.activeObj.activePoint.startY=this.dragPoint.startY=t/2-t/2+7.5,o.activeObj.activePoint.endX=e/2+t/2-7.5,o.activeObj.activePoint.endY=t/2+t/2-7.5):(o.activeObj.activePoint.startY=this.dragPoint.startX=t/2-e/2+7.5,o.activeObj.activePoint.endY=t/2+e/2-7.5,o.activeObj.activePoint.startX=this.dragPoint.startX=7.5,o.activeObj.activePoint.endX=e-7.5)},e.prototype.calcShapeRatio=function(e,t,o,i){for(var a=this.parent,r=o,n=i,s=r>=n?r:n,l=s*(e/t),p=s,h=this.getScale(l,r),c=[],d=0;d<2;d++)0===d?c.push(l*h):c.push(p*h);l=c[0],p=c[1];var v=this.getScale(p,n),u=[];for(d=0;d<2;d++)0===d?u.push(l*v):u.push(p*v);l=u[0],p=u[1],a.activeObj.activePoint.width=l,a.activeObj.activePoint.height=p,a.activeObj.activePoint.startX=7.5+(this.dragPoint.startX=(r-l)/2),a.activeObj.activePoint.startY=7.5+(this.dragPoint.startY=(n-p)/2),a.activeObj.activePoint.endX=(r-l)/2+l-7.5,a.activeObj.activePoint.endY=(n-p)/2+p-7.5,a.activeObj.activePoint.startX<a.img.destLeft&&a.img.destLeft+a.img.destWidth>a.lowerCanvas.clientWidth&&(a.activeObj.activePoint.startX=a.img.destLeft,a.activeObj.activePoint.endX=a.activeObj.activePoint.startX+l-7.5),a.activeObj.activePoint.startY<a.img.destTop&&a.img.destTop+a.img.destHeight>a.lowerCanvas.clientHeight&&(a.activeObj.activePoint.startY=a.img.destTop,a.activeObj.activePoint.endY=a.activeObj.activePoint.startY+p-7.5),a.activeObj.activePoint.width=a.activeObj.activePoint.endX-a.activeObj.activePoint.startX,a.activeObj.activePoint.height=a.activeObj.activePoint.endY-a.activeObj.activePoint.startY},e.prototype.getScale=function(e,t){return e>t?t/e:1},e.prototype.findTarget=function(e,t,o){var i=this.parent;if("mousedown"===o.toLowerCase()||"touchstart"===o.toLowerCase()){var a=!1;i.activeObj.shape&&"crop"===i.activeObj.shape.split("-")[0]&&(a=!0),this.findTargetObj(e,t,a),this.updateCursorStyles(e,t,o)}else switch(this.dragElement.toLowerCase()){case"nw-resize":i.activeObj.topLeftCircle.startX=e,i.activeObj.topLeftCircle.startY=t;break;case"n-resize":i.activeObj.topCenterCircle.startX=e,i.activeObj.topCenterCircle.startY=t;break;case"ne-resize":i.activeObj.topRightCircle.startX=e,i.activeObj.topRightCircle.startY=t;break;case"w-resize":i.activeObj.centerLeftCircle.startX=e,i.activeObj.centerLeftCircle.startY=t;break;case"e-resize":i.activeObj.centerRightCircle.startX=e,i.activeObj.centerRightCircle.startY=t;break;case"sw-resize":i.activeObj.bottomLeftCircle.startX=e,i.activeObj.bottomLeftCircle.startY=t;break;case"s-resize":i.activeObj.bottomCenterCircle.startX=e,i.activeObj.bottomCenterCircle.startY=t;break;case"se-resize":i.activeObj.bottomRightCircle.startX=e,i.activeObj.bottomRightCircle.startY=t;break;default:this.dragPoint.startX&&this.dragPoint.startY&&(this.previousPoint.x=this.dragPoint.endX,this.previousPoint.y=this.dragPoint.endY,this.dragPoint.endX=e,this.dragPoint.endY=t)}},e.prototype.findTargetObj=function(e,t,o){var i=this,a=this.parent,r=!1;if(0!==a.objColl.length&&!a.currObjType.isCustomCrop&&!o){for(var n=0,s=void 0,l=0;l<a.objColl.length;l++){var p=a.upperCanvas.style.cursor;this.setCursor(e,t);var h=sf.base.extend({},a.objColl[l],{},!0);if("line"===h.shape||"arrow"===h.shape){for(var c=0;c<h.pointColl.length;c++)if(e>=h.pointColl[c].x-2*h.topLeftCircle.radius&&e<=h.pointColl[c].x+2*h.topLeftCircle.radius&&t>=h.pointColl[c].y-2*h.topLeftCircle.radius&&t<=h.pointColl[c].y+2*h.topLeftCircle.radius){this.isTouch||"move"===a.cursor||"grab"===a.cursor||this.isShapeInserted?(0===n||n>e-h.activePoint.startX)&&(n=e-a.objColl[l].activePoint.startX,s=l):a.objColl[l].currIndex===this.tempActiveObj.currIndex&&(s=l);break}}else if("path"===h.shape){var d=this.setCursorForPath(h,e,t,a.upperCanvas);"default"!==d&&"grab"!==d&&(this.isTouch||"move"===a.cursor||"grab"===a.cursor||this.isShapeInserted?(0===n||n>e-h.activePoint.startX)&&(n=e-a.objColl[l].activePoint.startX,s=l):a.objColl[l].currIndex===this.tempActiveObj.currIndex&&(s=l))}else if(0!==h.rotatedAngle){var v=this.setCursorForRotatedObject(h,e,t,a.upperCanvas);"default"!==v&&"grab"!==v&&(this.isTouch||"move"===a.cursor||"grab"===a.cursor||this.isShapeInserted?(0===n||n>e-h.activePoint.startX)&&(n=e-a.objColl[l].activePoint.startX,s=l):a.objColl[l].currIndex===this.tempActiveObj.currIndex&&(s=l))}else{var u=this.getTransRotationPoint(h);(e>=h.activePoint.startX-2*h.topLeftCircle.radius&&e<=h.activePoint.endX+2*h.topLeftCircle.radius&&t>=h.activePoint.startY-2*h.topLeftCircle.radius&&t<=h.activePoint.endY+2*h.topLeftCircle.radius||u&&e>=u.x-2*h.topLeftCircle.radius&&e<=u.x+2*h.topLeftCircle.radius&&t>=u.y-2*h.topLeftCircle.radius&&t<=u.y+2*h.topLeftCircle.radius)&&(this.isTouch||"move"===p||"grabbing"===p||this.isShapeInserted||"move"===a.cursor||"grabbing"===a.cursor?(0===n||n>e-h.activePoint.startX)&&(n=e-a.objColl[l].activePoint.startX,s=l):a.objColl[l].currIndex===this.tempActiveObj.currIndex&&(s=l))}}if(sf.base.isNullOrUndefined(s))a.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),r=!1;else{this.tempObjColl=sf.base.extend([],a.objColl,[],!0),a.currObjType.isCustomCrop=!1,a.activeObj=sf.base.extend({},a.objColl[s],{},!0);var b=sf.base.extend({},a.objColl[s],{},!0);if(a.objColl.splice(s,1),0===a.transform.degree){var g=this.lowerContext.filter;this.lowerContext.clearRect(0,0,a.lowerCanvas.width,a.lowerCanvas.height),a.notify("filter",{prop:"updateBrightFilter",onPropertyChange:!1}),this.lowerContext.drawImage(a.baseImg,a.img.srcLeft,a.img.srcTop,a.img.srcWidth,a.img.srcHeight,a.img.destLeft,a.img.destTop,a.img.destWidth,a.img.destHeight),this.lowerContext.filter="none",a.notify("shape",{prop:"iterateObjColl",onPropertyChange:!1}),a.activeObj=sf.base.extend({},g,{},!0),a.notify("freehand-draw",{prop:"freehandRedraw",onPropertyChange:!1,value:{context:this.lowerContext,points:null}}),this.lowerContext.filter=g,this.getCurrentFlipState()}else a.notify("draw",{prop:"callUpdateCurrTransState",onPropertyChange:!1}),a.notify("freehand-draw",{prop:"freehandRedraw",onPropertyChange:!1,value:{context:this.lowerContext,points:null}});a.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),(a.currSelectionPoint&&"crop-circle"===a.currSelectionPoint.shape||a.isCircleCrop)&&a.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),this.setActivePoint(),a.activeObj=sf.base.extend({},b,{},!0);var f=sf.base.extend({},a.activeObj.strokeSettings,{},!0);a.notify("draw",{prop:"setTempStrokeSettings",onPropertyChange:!1,value:{tempStrokeSettings:f}});var C=sf.base.extend({},a.activeObj.textSettings,{},!0);a.notify("draw",{prop:"setTempTextSettings",onPropertyChange:!1,value:{tempTextSettings:C}});var m=this.updatePrevShapeSettings(),y={action:"select",previousShapeSettings:m,currentShapeSettings:m};"line"!==a.activeObj.shape&&"arrow"!==a.activeObj.shape||(y.currentShapeSettings.width=a.activeObj.activePoint.endX-a.activeObj.activePoint.startX,y.currentShapeSettings.height=a.activeObj.activePoint.endY-a.activeObj.activePoint.startY),this.isCropSelection=!1;var P=void 0;if(void 0!==a.activeObj.shape&&(P=a.activeObj.shape.split("-")),void 0!==P&&"crop"===P[0]&&(this.isCropSelection=!0),!this.isCropSelection&&sf.base.isBlazor()&&sf.base.isNullOrUndefined(this.parent.eventType)&&a.events&&!0===a.events.shapeChanging.hasDelegate)a.dotNetRef.invokeMethodAsync("ShapeEventAsync","OnShape",y).then((function(e){i.shapeEvent(e)}));else if(this.isCropSelection){var j={action:y.action,previousSelectionSettings:{type:a.getSelectionType(a.activeObj.shape),startX:y.previousShapeSettings.startX,startY:y.previousShapeSettings.startY,width:y.previousShapeSettings.width,height:y.previousShapeSettings.height},currentSelectionSettings:{type:a.getSelectionType(a.activeObj.shape),startX:y.currentShapeSettings.startX,startY:y.currentShapeSettings.startY,width:y.currentShapeSettings.width,height:y.currentShapeSettings.height}};sf.base.isBlazor()&&a.events&&!0===a.events.onSelectionResizeStart.hasDelegate?a.dotNetRef.invokeMethodAsync("SelectionEventAsync","OnSelectionResizeStart",j).then((function(e){y.currentShapeSettings.startX=e.currentSelectionSettings.startX,y.currentShapeSettings.startY=e.currentSelectionSettings.startY,y.currentShapeSettings.width=e.currentSelectionSettings.width,y.currentShapeSettings.height=e.currentSelectionSettings.height,i.shapeEvent(y)})):(a.trigger("selectionChanging",j),y.currentShapeSettings.startX=j.currentSelectionSettings.startX,y.currentShapeSettings.startY=j.currentSelectionSettings.startY,y.currentShapeSettings.width=j.currentSelectionSettings.width,y.currentShapeSettings.height=j.currentSelectionSettings.height,this.shapeEvent(y))}else a.trigger("shapeChanging",y),this.shapeEvent(y);r=!0}}return r},e.prototype.shapeEvent=function(e){var t=this.parent;if(t.notify("shape",{prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:e.currentShapeSettings}}),t.activeObj.activePoint){var o={prevActObj:null};t.notify("draw",{prop:"getPrevActObj",onPropertyChange:!1,value:{obj:o}}),sf.base.isNullOrUndefined(o.prevActObj)&&t.notify("draw",{prop:"setPrevActObj",onPropertyChange:!1,value:{prevActObj:sf.base.extend({},t.activeObj,{},!0)}}),t.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:t.activeObj,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:!0}}),this.isShapeInserted||(t.activeObj.activePoint.startX<t.img.destLeft||t.activeObj.activePoint.endX>t.img.destLeft+t.img.destWidth||t.activeObj.activePoint.startY<t.img.destTop||t.activeObj.activePoint.endY>t.img.destTop+t.img.destHeight)&&(this.isPreventDragging=!0)}},e.prototype.targetTouches=function(e){var t=this.parent.lowerCanvas.getBoundingClientRect();return[{x:e[0].pageX-t.left,y:e[0].pageY-t.top},{x:e[1].pageX-t.left,y:e[1].pageY-t.top}]},e.prototype.calculateScale=function(e,t){var o=this.getDistance(e[0],e[1]);return this.getDistance(t[0],t[1])/o},e.prototype.getDistance=function(e,t){var o=0,i=0;return e&&t&&(o=e.x-t.x,i=e.y-t.y),Math.sqrt(o*o+i*i)},e.prototype.redrawShape=function(e,t){for(var o=this.parent,i=0,a=o.objColl.length;i<a;i++)if(JSON.stringify(e)===JSON.stringify(o.objColl[i])){o.objColl.splice(i,1);break}this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),this.isPreventDragging?(o.activeObj.activePoint.startX>o.img.destLeft&&(this.isPreventDragging=!1),t&&o.activeObj.rotatedAngle,o.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:null,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:null}})):(t&&o.activeObj.rotatedAngle,o.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:null,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:null}}))},e.prototype.setTimer=function(e){this.timer>10&&(clearTimeout(this.timer),this.timer=0,this.parent.notify("shape",{prop:"findTextTarget",onPropertyChange:!1,value:{e:e}}),sf.base.Browser.isDevice&&this.upperContext.clearRect(0,0,this.parent.upperCanvas.width,this.parent.upperCanvas.height))},e.prototype.applyCurrActObj=function(e,t){var o=this.parent,i=!1,a=sf.base.extend({},o.activeObj,{},!0);if(!sf.base.isNullOrUndefined(a.activePoint)){if(e>=Math.floor(a.activePoint.startX)&&e<=Math.ceil(a.activePoint.endX)&&t>=Math.floor(a.activePoint.startY)&&t<=Math.ceil(a.activePoint.endY))i=!0;else if("text"===a.shape&&""!==this.dragElement)i=!0;else if("line"===a.shape||"arrow"===a.shape){var r={x:a.activePoint.startX<a.activePoint.endX?a.activePoint.startX:a.activePoint.endX,y:a.activePoint.startY<a.activePoint.endY?a.activePoint.startY:a.activePoint.endY},n={x:a.activePoint.startX>a.activePoint.endX?a.activePoint.startX:a.activePoint.endX,y:a.activePoint.startY>a.activePoint.endY?a.activePoint.startY:a.activePoint.endY};e>=Math.floor(r.x)-5&&e<=Math.ceil(n.x)+5&&t>=Math.floor(r.y)-5&&t<=Math.ceil(n.y)+5&&(i=!0)}else if("path"===a.shape){"move"===(s=this.setCursorForPath(a,e,t,o.upperCanvas))&&(i=!0)}else if("grabbing"===this.dragElement)i=!0;else if(0!==a.rotatedAngle){var s;("default"!==(s=this.setCursorForRotatedObject(a,e,t,o.upperCanvas))&&"grab"!==s||"n-resize"===this.dragElement||"e-resize"===this.dragElement||"s-resize"===this.dragElement||"w-resize"===this.dragElement)&&(i=!0)}if(!i){if(sf.base.isNullOrUndefined(o.activeObj.currIndex)&&(o.activeObj.currIndex="shape_"+(o.objColl.length+1)),o.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),void 0===o.activeObj.horTopLine||0===o.activeObj.horTopLine.startX||0===o.activeObj.horTopLine.endX||o.currObjType.isCustomCrop||""===o.currObjType.shape||o.objColl.push(sf.base.extend({},o.activeObj,{},!0)),"text"===o.activeObj.shape||"ellipse"===o.currObjType.shape||"rectangle"===o.currObjType.shape||"line"===o.currObjType.shape||"arrow"===o.activeObj.shape||"path"===o.activeObj.shape){var l=this.lowerContext.filter;this.lowerContext.filter="brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)";for(var p=0;p<o.objColl.length;p++){var h={isInside:!1};o.notify("crop",{prop:"isObjInImage",onPropertyChange:!1,value:{obj:o.objColl[p],object:h}}),h.isInside&&(o.notify("shape",{prop:"apply",onPropertyChange:!1,value:{shape:o.objColl[p].shape,obj:o.objColl[p],canvas:null}}),o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}))}o.notify("freehand-draw",{prop:"zoomFHDColl",onPropertyChange:!1,value:{isPreventApply:null}}),this.lowerContext.filter=l,o.activeObj.shape&&o.notify("shape",{prop:"apply",onPropertyChange:!1,value:{shape:null,obj:null,canvas:null}}),o.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),o.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),o.isCircleCrop&&o.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}})}sf.base.isBlazor()||o.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1})}}},e.prototype.getCurrentFlipState=function(){var e=this.parent;if(0!==e.rotateFlipColl.length){var t=sf.base.extend({},e.panPoint.totalPannedInternalPoint,{},!0);e.notify("draw",{prop:"callUpdateCurrTransState",onPropertyChange:!1}),e.panPoint.totalPannedInternalPoint=t}else e.notify("draw",{prop:"callUpdateCurrTransState",onPropertyChange:!1})},e.prototype.setTextBoxStylesToActObj=function(){var e=this.parent;e.activeObj.textSettings.fontFamily=e.textArea.style.fontFamily,e.activeObj.strokeSettings.strokeColor=""!==e.textArea.style.color?this.rgbToHex(parseFloat(e.textArea.style.color.split("(")[1].split(",")[0]),parseFloat(e.textArea.style.color.split("(")[1].split(",")[1]),parseFloat(e.textArea.style.color.split("(")[1].split(",")[2])):e.textArea.style.color,"bold"===e.textArea.style.fontWeight?e.activeObj.textSettings.bold=!0:e.activeObj.textSettings.bold=!1,"italic"===e.textArea.style.fontStyle?e.activeObj.textSettings.italic=!0:e.activeObj.textSettings.italic=!1,e.activeObj.textSettings.fontSize=parseFloat(e.textArea.style.fontSize)},e.prototype.rgbToHex=function(e,t,o){return"#"+this.componentToHex(e)+this.componentToHex(t)+this.componentToHex(o)},e.prototype.componentToHex=function(e){var t=e.toString(16);return 1===t.length?"0"+t:t},e.prototype.deleteItem=function(){var e=this.parent,t={};if(this.isFhdEditing){this.updateFreehandDrawColorChange();var o=sf.base.extend({},e.cropObj,{},!0),i={currObj:{}};e.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:i}}),(l=i.currObj).objColl=sf.base.extend([],e.objColl,[],!0),l.pointColl=sf.base.extend([],e.pointColl,[],!0),l.afterCropActions=sf.base.extend([],e.afterCropActions,[],!0);var a={selPointColl:null};e.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:a}}),l.selPointColl=sf.base.extend([],a.selPointColl,[],!0);var r={freehandDrawSelectedId:null};e.notify("freehand-draw",{prop:"getFreehandDrawSelectedId",onPropertyChange:!1,value:{obj:r}}),e.notify("freehand-draw",{prop:"deleteFhd",value:{id:r.freehandDrawSelectedId}}),e.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"deleteFreehandDrawing",previousObj:l,previousObjColl:this.tempObjColl,previousPointColl:l.pointColl,previousSelPointColl:l.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),e.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),e.notify("freehand-draw",{prop:"resetFreehandDrawSelectedId"})}else if("none"===e.textArea.style.display){r={prevActObj:null};if(e.notify("draw",{prop:"getPrevActObj",onPropertyChange:!1,value:{obj:r}}),r.prevActObj&&(r.prevActObj.activePoint.width=Math.abs(r.prevActObj.activePoint.width),r.prevActObj.activePoint.height=Math.abs(r.prevActObj.activePoint.height)),r.prevActObj&&JSON.stringify(r.prevActObj)!==JSON.stringify(e.activeObj)){var n=e.activeObj.currIndex;e.notify("draw",{prop:"performCancel",value:{isContextualToolbar:null}});for(var s=0;s<e.objColl.length;s++)if(e.objColl[s].currIndex===n){e.objColl.splice(s,1),e.notify("draw",{prop:"render-image",value:{isMouseWheel:null}});break}}i={isNewPath:null};if(e.notify("draw",{prop:"getNewPath",value:{obj:i}}),i.isNewPath)e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.notify("draw",{prop:"render-image",value:{isMouseWheel:null}}),sf.base.isBlazor()?e.updateToolbar(e.element,"imageLoaded"):e.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1});else if(e.activeObj.shape){e.objColl.push(e.activeObj);o=sf.base.extend({},e.cropObj,{},!0);var l,p={currObj:{}};e.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:p}}),(l=p.currObj).objColl=sf.base.extend([],e.objColl,[],!0),l.pointColl=sf.base.extend([],e.pointColl,[],!0),l.afterCropActions=sf.base.extend([],e.afterCropActions,[],!0);a={selPointColl:null};e.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:a}}),l.selPointColl=sf.base.extend([],a.selPointColl,[],!0),e.objColl.pop(),t={action:"delete",previousShapeSettings:this.updatePrevShapeSettings(),currentShapeSettings:null},e.notify("shape",{prop:"setKeyHistory",onPropertyChange:!1,value:{keyHistory:""}}),e.clearSelection(),sf.base.isBlazor()&&e.events&&!0===e.events.shapeChanging.hasDelegate?e.dotNetRef.invokeMethodAsync("ShapeEventAsync","OnShape",t):(e.trigger("shapeChanging",t),sf.base.isBlazor()||e.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1})),sf.base.isNullOrUndefined(l.objColl[l.objColl.length-1].currIndex)||(e.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"deleteObj",previousObj:l,previousObjColl:this.tempObjColl,previousPointColl:l.pointColl,previousSelPointColl:l.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),e.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}))}e.notify("draw",{prop:"setPrevActObj",onPropertyChange:!1,value:{prevActObj:null}})}document.getElementById(e.element.id+"_quickAccessToolbarArea")&&(document.getElementById(e.element.id+"_quickAccessToolbarArea").style.display="none")},e.prototype.updateFreehandDrawColorChange=function(){var e=this.parent,t={freehandSelectedIndex:null};if(e.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:t}}),!sf.base.isNullOrUndefined(t.freehandSelectedIndex)&&!sf.base.isNullOrUndefined(e.pointColl[t.freehandSelectedIndex])&&"#42a5f5"===e.pointColl[t.freehandSelectedIndex].strokeColor){var o={tempFreeHandDrawEditingStyles:null};e.notify("freehand-draw",{prop:"getTempFreeHandDrawEditingStyles",value:{obj:o}}),e.pointColl[t.freehandSelectedIndex].strokeColor=o.tempFreeHandDrawEditingStyles.strokeColor}},e.prototype.updatePrevShapeSettings=function(e){var t=this.parent,o=[];"text"===t.activeObj.shape&&t.activeObj.textSettings&&(t.activeObj.textSettings.bold&&o.push("bold"),t.activeObj.textSettings.italic&&o.push("italic"),t.activeObj.textSettings.underline&&o.push("underline"));var i={id:sf.base.isNullOrUndefined(t.activeObj.currIndex)?null:t.activeObj.currIndex,type:t.toPascalCase(t.activeObj.shape),startX:t.activeObj.activePoint.startX,startY:t.activeObj.activePoint.startY,width:t.activeObj.activePoint.width,height:t.activeObj.activePoint.height,strokeColor:t.activeObj.strokeSettings?t.activeObj.strokeSettings.strokeColor:null,strokeWidth:t.activeObj.strokeSettings?t.activeObj.strokeSettings.strokeWidth:null,fillColor:t.activeObj.strokeSettings?t.activeObj.strokeSettings.fillColor:null,radius:"ellipse"===t.activeObj.shape?t.activeObj.activePoint.width/2:null,length:"line"===t.activeObj.shape||"arrow"===t.activeObj.shape?t.activeObj.activePoint.width:null,text:"text"===t.activeObj.shape&&t.activeObj.keyHistory?t.activeObj.keyHistory:null,fontSize:"text"===t.activeObj.shape&&t.activeObj.textSettings?t.activeObj.textSettings.fontSize:null,fontStyle:"text"===t.activeObj.shape?o:null,color:"text"===t.activeObj.shape&&t.activeObj.strokeSettings?t.activeObj.strokeSettings.strokeColor:null};return e&&(e.shapeSettingsObj=i),i},e.prototype.getRectanglePoints=function(e,t,o,i,a,r,n){var s=e+o/2,l=t+i/2,p=a*(Math.PI/180),h=Math.cos(p),c=Math.sin(p),d=r-s,v=n-l,u=d*h+v*c,b=-d*c+v*h,g=o/2,f=i/2;return u>=-g&&u<=g&&b>=-f&&b<=f},e.prototype.getTransRotationPoint=function(e,t){var o,i,a=!1,r=!1;(i=0===e.shapeDegree?this.parent.transform.degree:this.parent.transform.degree-e.shapeDegree)<0&&(i=360+i);for(var n=0;n<e.flipObjColl.length;n++)"horizontal"===e.flipObjColl[n].toLowerCase()?a=!0:"vertical"===e.flipObjColl[n].toLowerCase()&&(r=!0);return 0===i||360===i?o=r?{x:e.topCenterCircle.startX,y:e.topCenterCircle.startY-e.rotationCircleLine}:{x:e.bottomCenterCircle.startX,y:e.bottomCenterCircle.startY+e.rotationCircleLine}:90===i||-270===i?o=a?{x:e.centerRightCircle.startX+e.rotationCircleLine,y:e.centerLeftCircle.startY}:{x:e.centerLeftCircle.startX-e.rotationCircleLine,y:e.centerLeftCircle.startY}:180===i||-180===i?o=r?{x:e.bottomCenterCircle.startX,y:e.bottomCenterCircle.startY+e.rotationCircleLine}:{x:e.topCenterCircle.startX,y:e.topCenterCircle.startY-e.rotationCircleLine}:270!==i&&-90!==i||(o=a?{x:e.centerLeftCircle.startX-e.rotationCircleLine,y:e.centerLeftCircle.startY}:{x:e.centerRightCircle.startX+e.rotationCircleLine,y:e.centerLeftCircle.startY}),t&&(t.rotationCirclePoint=o),o},e}(),g=function(){function e(e){this.textSettings={text:"Enter Text",fontFamily:"Arial",fontSize:null,fontRatio:null,bold:!1,italic:!1,underline:!1},this.strokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null},this.keyHistory="",this.parent=e,this.addEventListener()}return e.prototype.destroy=function(){this.parent.isDestroyed||this.removeEventListener()},e.prototype.addEventListener=function(){this.parent.on("shape",this.shape,this),this.parent.on("destroyed",this.destroy,this)},e.prototype.removeEventListener=function(){this.parent.off("shape",this.shape),this.parent.off("destroyed",this.destroy)},e.prototype.shape=function(e){switch(this.initShapePvtProps(),e.prop){case"drawEllipse":this.drawEllipse(e.value.x,e.value.y,e.value.radiusX,e.value.radiusY,e.value.strokeWidth,e.value.strokeColor,e.value.fillColor);break;case"drawLine":this.drawLine(e.value.startX,e.value.startY,e.value.endX,e.value.endY,e.value.strokeWidth,e.value.strokeColor);break;case"drawArrow":this.drawArrow(e.value.startX,e.value.startY,e.value.endX,e.value.endY,e.value.strokeWidth,e.value.strokeColor,e.value.arrowStart,e.value.arrowEnd);break;case"drawPath":this.drawPath(e.value.pointColl,e.value.strokeWidth,e.value.strokeColor);break;case"drawRectangle":this.drawRectangle(e.value.x,e.value.y,e.value.width,e.value.height,e.value.strokeWidt,e.value.strokeColor,e.value.fillColor);break;case"drawText":this.drawText(e.value.x,e.value.y,e.value.text,e.value.fontFamily,e.value.fontSize,e.value.bold,e.value.italic,e.value.color);break;case"redrawActObj":this.redrawActObj(e.value.x,e.value.y,e.value.isMouseDown);break;case"apply":this.apply(e.value.shape,e.value.obj,e.value.canvas);break;case"updateShapeChangeEventArgs":this.updateShapeChangeEventArgs(e.value.shapeSettings);break;case"updSelChangeEventArgs":this.updSelChangeEventArgs(e.value.selectionSettings);break;case"iterateObjColl":this.iterateObjColl();break;case"updImgRatioForActObj":this.updImgRatioForActObj();break;case"zoomObjColl":this.zoomObjColl(e.value.isPreventApply);break;case"redrawObj":this.redrawObj(e.value.degree);break;case"rotateObjColl":this.rotateObjColl();break;case"draw-shape-text":this.drawShapeText();break;case"redraw-text":this.redrawText();break;case"draw-shape":this.drawShape(e.value.obj,e.value.strokeWidth,e.value.strokeColor,e.value.fillColor,e.value.start,e.value.width,e.value.height);break;case"renderTextArea":this.renderTextArea(e.value.x,e.value.y,e.value.actObj);break;case"setTextBoxWidth":this.setTextBoxWidth(e.value.e);break;case"findTextTarget":this.findTextTarget(e.value.e);break;case"panObjColl":this.panObjColl(e.value.xDiff,e.value.yDiff,e.value.panRegion);break;case"updateFontStyles":this.updateFontStyles(e.value.isTextBox);break;case"applyFontStyle":this.applyFontStyle(e.value.item);break;case"updateFontRatio":this.updateFontRatio(e.value.obj,e.value.isTextArea);break;case"updateFontSize":this.updateFontSize(e.value.obj);break;case"updateObjColl":this.updateObjColl(e.value.item,e.value.objColl);break;case"pushActItemIntoObj":this.pushActItemIntoObj();break;case"clearActObj":this.clearActObj();break;case"refreshActiveObj":this.refreshActiveObj();break;case"applyActObj":this.applyActObj(e.value.isMouseDown);break;case"wireEvent":sf.base.EventHandler.add(this.parent.upperCanvas,"dblclick",this.findTextTarget,this),sf.base.EventHandler.add(this.parent.textArea,"mousedown",this.findTextTarget,this);break;case"unWireEvent":sf.base.EventHandler.remove(this.parent.upperCanvas,"dblclick",this.findTextTarget),sf.base.EventHandler.remove(this.parent.textArea,"mousedown",this.findTextTarget);break;case"getShapeSetting":this.getShapeSetting(e.value.id,e.value.obj);break;case"getShapeSettings":this.getShapeSettings(e.value.obj);break;case"isPointsInRange":this.isPointsInRange(e.value.x,e.value.y,e.value.obj);break;case"alignRotateFlipColl":this.alignRotateFlipColl(e.value.collection,e.value.isRotateFlipCollection,e.value.obj);break;case"selectShape":this.selectShape(e.value.id,e.value.obj);break;case"deleteShape":this.deleteShape(e.value.id);break;case"getMaxText":this.getMaxText(e.value.isTextBox,e.value.text,e.value.obj);break;case"setPointCollForLineArrow":e.value.obj.pointColl=this.getLinePoints(e.value.obj.activePoint.startX,e.value.obj.activePoint.startY,e.value.obj.activePoint.endX,e.value.obj.activePoint.endY);break;case"setPointCollForShapeRotation":this.setPointCollForShapeRotation(e.value.obj);break;case"setTextSettings":e.value.textSettings?this.textSettings=e.value.textSettings:e.value.fontFamily?this.textSettings.fontFamily=e.value.fontFamily:e.value.fontSize&&(this.textSettings.fontSize=e.value.fontSize);break;case"setStrokeSettings":e.value.strokeSettings?this.strokeSettings=e.value.strokeSettings:e.value.strokeColor?this.strokeSettings.strokeColor=e.value.strokeColor:e.value.fillColor?this.strokeSettings.fillColor=e.value.fillColor:e.value.strokeWidth&&(this.strokeSettings.strokeWidth=e.value.strokeWidth);break;case"getStrokeSettings":e.value.obj.strokeSettings=this.strokeSettings;break;case"setKeyHistory":this.keyHistory=e.value.keyHistory;break;case"getKeyHistory":e.value.obj.keyHistory=this.keyHistory;break;case"setTextBoxPos":this.setTextBoxPos(e.value.actObj,e.value.degree,e.value.flip,e.value.x,e.value.y);break;case"setTextBoxPoints":this.setTextBoxPoints(e.value.actObj,e.value.degree,e.value.flip,e.value.x,e.value.y);break;case"alignTextAreaIntoCanvas":this.alignTextAreaIntoCanvas();break;case"initializeTextShape":this.initializeTextShape(e.value.text,e.value.fontFamily,e.value.fontSize,e.value.bold,e.value.italic,e.value.strokeColor);break;case"stopPathDrawing":this.stopPathDrawing(e.value.e);break;case"updateArrowRatio":this.updateArrowRatio(e.value.obj);break;case"getSquarePointForRotatedShape":this.getSquarePointForRotatedShape(e.value.obj,e.value.object);break;case"reset":this.reset()}},e.prototype.getModuleName=function(){return"shape"},e.prototype.initShapePvtProps=function(){this.parent.lowerCanvas&&(this.lowerContext=this.parent.lowerCanvas.getContext("2d")),this.parent.upperCanvas&&(this.upperContext=this.parent.upperCanvas.getContext("2d"))},e.prototype.reset=function(){this.textSettings={text:"Enter Text",fontFamily:"Arial",fontSize:null,fontRatio:null,bold:!1,italic:!1,underline:!1},this.strokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null}},e.prototype.drawEllipse=function(e,t,o,i,a,r,n){this.initializeShape("ellipse");var s={x:e,y:t};this.drawShape("ellipse",a,r,n,s,o,i)},e.prototype.drawLine=function(e,t,o,i,a,r){this.initializeShape("line");var n={x:e,y:t},s=o-e,l=i-t;this.drawShape("line",a,r,null,n,s,l)},e.prototype.drawPath=function(e,t,o){this.initializeShape("path"),this.drawShape("path",t,o,null,null,null,null,e)},e.prototype.drawArrow=function(e,t,o,i,a,r,n,s){this.initializeShape("arrow");var l={x:e,y:t},p=o-e,h=i-t;this.drawShape("arrow",a,r,null,l,p,h,null,n,s)},e.prototype.drawRectangle=function(e,t,o,i,a,r,n){this.initializeShape("rectangle");var s={x:e,y:t};this.drawShape("rectangle",a,r,n,s,o,i)},e.prototype.drawText=function(e,t,o,i,a,r,n,s){this.drawShapeText(o,i,a,r,n,s,e,t)},e.prototype.initializeShape=function(e){this.redrawActObj(),this.parent.activeObj.shape=e,"freehanddraw"===this.parent.currObjType.shape&&(this.apply(),this.parent.upperCanvas.style.cursor=this.parent.cursor="default",this.parent.currObjType.shape=""),this.parent.currObjType.isCustomCrop=!1},e.prototype.updateWidthHeight=function(e){return e.activePoint.width=e.activePoint.endX-e.activePoint.startX,e.activePoint.height=e.activePoint.endY-e.activePoint.startY,e},e.prototype.setDimension=function(e,t){e&&t&&(this.parent.activeObj.activePoint.width=e,this.parent.activeObj.activePoint.height=t,"ellipse"===this.parent.currObjType.shape.toLowerCase()&&(this.parent.activeObj.activePoint.width=2*e,this.parent.activeObj.activePoint.height=2*t))},e.prototype.getArrowType=function(e){var t=e;if(e){t={None:"none",Arrow:"arrow",SolidArrow:"arrowSolid",Circle:"circle",SolidCircle:"circleSolid",Square:"square",SolidSquare:"squareSolid",Bar:"bar"}[""+e]}return t},e.prototype.drawShape=function(e,t,o,i,a,r,n,s,l,p){var h=this,c=this.parent;if(!c.disabled&&c.isImageLoaded){c.notify("draw",{prop:"setImageEdited",onPropertyChange:!1}),this.redrawActObj();var d=sf.base.extend([],c.objColl,[],!0);if(c.togglePen=!1,this.keyHistory="",this.parent.upperCanvas.style.display="block",this.refreshActiveObj(),c.currObjType.shape=e,"path"===c.currObjType.shape.toLowerCase()&&sf.base.isNullOrUndefined(s))c.activeObj.shape=c.currObjType.shape.toLowerCase(),c.activeObj.pointColl=[],c.upperCanvas.style.cursor=this.parent.cursor="crosshair",c.notify("selection",{prop:"setCurrentDrawingShape",onPropertyChange:!1,value:{value:"path"}}),sf.base.isBlazor()||(c.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"shapes",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}),c.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1}));else if("freehanddraw"!==c.currObjType.shape.toLowerCase()&&""!==c.currObjType.shape.toLowerCase()){c.activeObj.shape=c.currObjType.shape.toLowerCase(),this.upperContext.clearRect(0,0,c.upperCanvas.width,c.upperCanvas.height),sf.base.isNullOrUndefined(c.activeObj.strokeSettings)&&(c.activeObj.strokeSettings=this.strokeSettings),"path"===c.currObjType.shape.toLowerCase()&&s&&(c.activeObj.pointColl=s),c.activeObj.strokeSettings.strokeWidth=t||c.activeObj.strokeSettings.strokeWidth,c.activeObj.strokeSettings.strokeColor=o||c.activeObj.strokeSettings.strokeColor,c.activeObj.strokeSettings.fillColor=i||c.activeObj.strokeSettings.fillColor;var v=c.img.destWidth>100?100:c.img.destWidth/2,u=c.img.destHeight>100?100:c.img.destHeight/2;c.activeObj.activePoint.width=v,c.activeObj.activePoint.height=u,"line"===c.currObjType.shape.toLowerCase()||"arrow"===c.currObjType.shape.toLowerCase()?(c.activeObj.lineDraw="horizontal",c.activeObj.activePoint.height=0,"arrow"===c.currObjType.shape.toLowerCase()&&(c.activeObj.activePoint.width+=50,c.activeObj.start=this.getArrowType(l),c.activeObj.end=this.getArrowType(p))):"rectangle"===c.currObjType.shape.toLowerCase()&&(c.activeObj.activePoint.width+=c.activeObj.activePoint.width/2),this.setDimension(r,n),a?(c.activeObj.activePoint.startX=a.x,c.activeObj.activePoint.startY=a.y,c.activeObj.activePoint.endX=c.activeObj.activePoint.startX+c.activeObj.activePoint.width,c.activeObj.activePoint.endY=c.activeObj.activePoint.startY+c.activeObj.activePoint.height):this.setCenterPoints(),this.setPointCollForLineAndArrow(),"arrow"===c.currObjType.shape.toLowerCase()&&(c.activeObj.triangleDirection="right"),c.currObjType.isDragging=c.currObjType.isCustomCrop=!1,c.activeObj.shapeDegree=c.transform.degree,c.activeObj.shapeFlip=c.transform.currFlipState,c.activeObj.textFlip=c.transform.currFlipState,c.activeObj.flipObjColl=[];var b={shapeSettingsObj:{}};c.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:b}});var g=b.shapeSettingsObj,f={action:"insert",previousShapeSettings:g,currentShapeSettings:g};sf.base.isBlazor()&&c.events&&!0===c.events.shapeChanging.hasDelegate?this.parent.dotNetRef.invokeMethodAsync("ShapeEventAsync","OnShape",f).then((function(e){h.updateShapeChangeEventArgs(e.currentShapeSettings),h.setDimension(r,n),c.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),c.updateToolbar(c.element,"quickAccessToolbar","shape"),c.notify("selection",{prop:"isShapeInserted",onPropertyChange:!1,value:{bool:!0}}),c.notify("undo-redo",{prop:"updateUrObj",onPropertyChange:!1,value:{objColl:d}}),c.isPublicMethod&&c.notify("undo-redo",{prop:"updateUndoRedo",onPropertyChange:!1}),c.isPublicMethod=!1})):(c.trigger("shapeChanging",f),this.updateShapeChangeEventArgs(f.currentShapeSettings),this.setDimension(r,n),c.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),sf.base.isBlazor()?c.updateToolbar(c.element,"quickAccessToolbar","shape"):c.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}}),c.notify("selection",{prop:"isShapeInserted",onPropertyChange:!1,value:{bool:!0}}),c.notify("undo-redo",{prop:"updateUrObj",onPropertyChange:!1,value:{objColl:d}}),c.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"shapes",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}),c.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1}),c.isPublicMethod&&c.notify("undo-redo",{prop:"updateUndoRedo",onPropertyChange:!1}),c.isPublicMethod=!1)}}},e.prototype.setPointCollForLineAndArrow=function(){var e=this.parent;if(("line"===e.activeObj.shape||"arrow"===e.activeObj.shape)&&(e.activeObj.pointColl=this.getLinePoints(e.activeObj.activePoint.startX,e.activeObj.activePoint.startY,e.activeObj.activePoint.endX,e.activeObj.activePoint.endY),e.activeObj.pointColl))for(var t=0,o=e.activeObj.pointColl.length;t<o;t++)e.activeObj.pointColl[t].ratioX=(e.activeObj.pointColl[t].x-e.img.destLeft)/e.img.destWidth,e.activeObj.pointColl[t].ratioY=(e.activeObj.pointColl[t].y-e.img.destTop)/e.img.destHeight},e.prototype.drawShapeText=function(e,t,o,i,a,r,n,s){var l=this,p=this.parent;if(!p.disabled&&p.isImageLoaded){"freehanddraw"===p.currObjType.shape&&(this.apply(),p.upperCanvas.style.cursor=p.cursor="default",p.currObjType.shape=""),p.notify("draw",{prop:"setImageEdited",onPropertyChange:!1}),p.togglePen=!1,this.redrawActObj();var h={currObj:{}};p.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:h}}),this.prevObj=h.currObj,this.prevObj.objColl=sf.base.extend([],p.objColl,[],!0),this.prevObj.pointColl=sf.base.extend([],p.pointColl,[],!0),this.prevObj.afterCropActions=sf.base.extend([],p.afterCropActions,[],!0);var c={selPointColl:null};p.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:c}}),this.prevObj.selPointColl=sf.base.extend([],c.selPointColl,[],!0),this.refreshActiveObj(),p.activeObj.shape=p.currObjType.shape="text",p.currObjType.isCustomCrop=!1,this.initializeTextShape(e,t,o,i,a,r),p.currObjType.isText=p.currObjType.isInitialText=!0,sf.base.isNullOrUndefined(p.activeObj.textSettings.fontSize)&&(p.img.destWidth>p.img.destHeight?p.activeObj.textSettings.fontSize=p.img.destWidth/15:p.activeObj.textSettings.fontSize=p.img.destHeight/15,p.activeObj.textSettings.fontSize<20&&(p.activeObj.textSettings.fontSize=20)),p.img.destWidth<100?p.activeObj.textSettings.fontSize=Math.floor(p.img.destWidth/20):p.img.destHeight<100&&(p.activeObj.textSettings.fontSize=Math.floor(p.img.destHeight/20)),p.activeObj.shapeDegree=p.transform.degree,p.activeObj.shapeFlip=p.transform.currFlipState,p.activeObj.flipObjColl=[],this.updateFontStyles();var d=this.upperContext.measureText(p.activeObj.textSettings.text).width+.5*p.activeObj.textSettings.fontSize,v=p.activeObj.textSettings.fontSize+.25*p.activeObj.textSettings.fontSize;sf.base.isNullOrUndefined(n)||sf.base.isNullOrUndefined(s)?this.setCenterPoints(!0,d,v):(p.activeObj.activePoint.startX=n,p.activeObj.activePoint.startY=s,p.activeObj.activePoint.endX=p.activeObj.activePoint.startX+d,p.activeObj.activePoint.endY=p.activeObj.activePoint.startY+v);var u={shapeSettingsObj:{}};p.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:u}});var b=u.shapeSettingsObj,g={action:"insert",previousShapeSettings:b,currentShapeSettings:b};sf.base.isBlazor()&&p.events&&!0===p.events.shapeChanging.hasDelegate?p.dotNetRef.invokeMethodAsync("ShapeEventAsync","OnShape",g).then((function(e){l.drawShapeTextEvent(e),p.isPublicMethod&&p.notify("undo-redo",{prop:"updateUndoRedo",onPropertyChange:!1}),p.isPublicMethod=!1})):(p.trigger("shapeChanging",g),this.drawShapeTextEvent(g),p.isPublicMethod&&p.notify("undo-redo",{prop:"updateUndoRedo",onPropertyChange:!1}),p.isPublicMethod=!1)}},e.prototype.drawShapeTextEvent=function(e){var t=this.parent;this.updateShapeChangeEventArgs(e.currentShapeSettings),this.addLetter(t.activeObj.textSettings.text),t.activeObj.textFlip=t.transform.currFlipState,this.updateFontRatio(t.activeObj),t.objColl.push(t.activeObj);var o=sf.base.extend({},t.cropObj,{},!0);t.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:this.prevObj,previousObjColl:this.prevObj.objColl,previousPointColl:this.prevObj.pointColl,previousSelPointColl:this.prevObj.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),t.notify("selection",{prop:"redrawShape",onPropertyChange:!1,value:{obj:t.objColl[t.objColl.length-1]}}),sf.base.isBlazor()?t.updateToolbar(t.element,"quickAccessToolbar","text"):t.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}}),t.notify("selection",{prop:"isShapeInserted",onPropertyChange:!1,value:{bool:!0}}),sf.base.isBlazor()||(t.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"text",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}),t.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1}))},e.prototype.initializeTextShape=function(e,t,o,i,a,r){var n=this.parent;this.keyHistory="",n.upperCanvas.style.display="block",sf.base.isNullOrUndefined(n.activeObj.textSettings)&&(n.activeObj.textSettings=this.textSettings),sf.base.isNullOrUndefined(n.activeObj.strokeSettings)&&(n.activeObj.strokeSettings=this.strokeSettings),n.activeObj.strokeSettings.strokeColor=r||n.activeObj.strokeSettings.strokeColor,n.activeObj.textSettings.text=e||n.activeObj.textSettings.text,n.activeObj.textSettings.fontFamily=t||n.activeObj.textSettings.fontFamily,n.activeObj.textSettings.fontSize=o||n.activeObj.textSettings.fontSize,n.activeObj.textSettings.bold=i||n.activeObj.textSettings.bold,n.activeObj.textSettings.italic=a||n.activeObj.textSettings.italic},e.prototype.redrawActObj=function(e,t,o){var i,a=this.parent;a.activeObj.shape&&(i=a.activeObj.shape.split("-")),a.activeObj.horTopLine&&a.activeObj.shape&&"crop"!==i[0]&&("block"===a.textArea.style.display?(a.notify("selection",{prop:"setTextBoxStylesToActObj",onPropertyChange:!1}),this.updateFontRatio(a.activeObj,!0),e&&t?e!==a.activeObj.activePoint.startX&&t!==a.activeObj.activePoint.startY&&(this.updateTextFromTextArea(),this.applyActObj()):(this.updateTextFromTextArea(),this.apply(a.activeObj.shape,a.activeObj),a.objColl.push(a.activeObj),this.refreshActiveObj(),a.textArea.style.transform="",a.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1}))):this.applyActObj(o))},e.prototype.apply=function(e,t,o){var i=this.parent;if(!i.disabled)if(i.togglePen&&!i.currObjType.isCustomCrop){var a=i.img.destLeft,r=i.img.destTop,n=i.img.destWidth,s=i.img.destHeight;i.notify("draw",{prop:"callUpdateCurrTransState",onPropertyChange:!1});var l=this.lowerContext.filter;this.lowerContext.filter="none",i.togglePen=!1,this.iterateObjColl(),i.notify("freehandDraw",{prop:"freehandRedraw",onPropertyChange:!1,value:{context:this.lowerContext,points:null}}),i.togglePen=!1,(i.isCircleCrop||i.currSelectionPoint&&"crop-circle"===i.currSelectionPoint.shape)&&i.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),i.img.destLeft=a,i.img.destTop=r,i.img.destWidth=n,i.img.destHeight=s,this.lowerContext.filter=l}else o=o||"original",sf.base.isNullOrUndefined(i.activeObj.shape)&&sf.base.isNullOrUndefined(e)?i.currObjType.shape="":i.currObjType.shape=e||i.currObjType.shape,""!==i.currObjType.shape&&(this.upperContext.clearRect(0,0,i.upperCanvas.width,i.upperCanvas.height),"text"===i.activeObj.shape?(i.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:o,obj:t,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:null}}),i.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}})):i.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:o,obj:t}}),i.activeObj.shape=i.currObjType.shape.toLowerCase(),e||""===i.currObjType.shape||i.currObjType.isCustomCrop||i.objColl.push(sf.base.extend({},i.activeObj,{},!0)),this.keyHistory="")},e.prototype.setCenterPoints=function(e,t,o){var i,a,r=this.parent;e&&t&&o?(i=t,a=o):(i=r.activeObj.activePoint.width,a=r.activeObj.activePoint.height),r.activeObj.activePoint.startX=r.lowerCanvas.width/2-i/2,r.activeObj.activePoint.startY=r.lowerCanvas.height/2-a/2,r.activeObj.activePoint.endX=r.lowerCanvas.width/2+i/2,r.activeObj.activePoint.endY=r.lowerCanvas.height/2+a/2},e.prototype.updSelChangeEventArgs=function(e){var t=this.parent;t.activeObj.activePoint.startX=e.startX,t.activeObj.activePoint.startY=e.startY,t.activeObj.activePoint.width=e.width,t.activeObj.activePoint.height=e.height,t.activeObj.activePoint.endX=t.activeObj.activePoint.startX+t.activeObj.activePoint.width,t.activeObj.activePoint.endY=t.activeObj.activePoint.startY+t.activeObj.activePoint.height},e.prototype.updateShapeChangeEventArgs=function(e){var t=this.parent;switch(t.activeObj.currIndex=e.id,t.activeObj.activePoint.startX=e.startX,t.activeObj.activePoint.startY=e.startY,t.activeObj.activePoint.width=e.width,t.activeObj.activePoint.height=e.height,t.activeObj.activePoint.endX=t.activeObj.activePoint.startX+t.activeObj.activePoint.width,t.activeObj.activePoint.endY=t.activeObj.activePoint.startY+t.activeObj.activePoint.height,t.activeObj.strokeSettings.strokeColor=e.strokeColor,t.activeObj.strokeSettings.fillColor=e.fillColor,t.activeObj.shape){case"ellipse":t.activeObj.activePoint.width=e.radius/2;break;case"line":case"arrow":t.activeObj.activePoint.width=e.length;break;case"text":t.activeObj.keyHistory=e.text,t.activeObj.textSettings.fontSize=e.fontSize,t.activeObj.strokeSettings.strokeColor=e.color}if("text"===t.activeObj.shape&&t.activeObj.textSettings)for(var o=0;o<e.fontStyle.length;o++)switch(e.fontStyle[o]){case"bold":t.activeObj.textSettings.bold=!0;break;case"italic":t.activeObj.textSettings.italic=!0;break;case"underline":t.activeObj.textSettings.underline=!0}},e.prototype.addLetter=function(e){var t=this.parent;if("none"===t.textArea.style.display&&(t.currObjType.isText||"text"===t.activeObj.shape)){"Backspace"===e?this.keyHistory=this.keyHistory.slice(0,-1):this.keyHistory+=e,this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),this.updateFontStyles();var o=this.upperContext.measureText(this.keyHistory).width+.5*t.activeObj.textSettings.fontSize,i=t.activeObj.textSettings.fontSize+.25*t.activeObj.textSettings.fontSize;this.upperContext.fillText(this.keyHistory,t.activeObj.activePoint.startX,t.activeObj.activePoint.startY+t.activeObj.textSettings.fontSize),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.currObjType.isText=!0,t.notify("selection",{prop:"setActivePoint",onPropertyChange:!1,value:{startX:o,startY:i}})}},e.prototype.redrawText=function(){var e=this.parent,t="";e.activeObj.textSettings.bold&&(t+="bold "),e.activeObj.textSettings.italic&&(t+="italic "),this.upperContext.font=t+e.activeObj.textSettings.fontSize+"px "+e.activeObj.textSettings.fontFamily;var o=e.activeObj.keyHistory.split("\n"),i="block"===e.textArea.style.display?this.getMaxText(!0):this.getMaxText(),a=this.upperContext.measureText(i).width+.5*e.activeObj.textSettings.fontSize,r=o.length*(e.activeObj.textSettings.fontSize+.25*e.activeObj.textSettings.fontSize);e.notify("selection",{prop:"setTextSelection",onPropertyChange:!1,value:{width:a,height:r}}),e.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:e.activeObj.activePoint,obj:e.activeObj,isMouseMove:null,x:null,y:null}}),e.notify("selection",{prop:"redrawShape",onPropertyChange:!1,value:{obj:e.activeObj}})},e.prototype.updateTextFromTextArea=function(){var e=this.parent;if(e.activeObj.keyHistory!==e.textArea.value){var t=sf.base.extend({},e.cropObj,{},!0),o={currObj:{}};e.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:o}});var i=o.currObj;i.objColl=sf.base.extend([],e.objColl,[],!0),i.pointColl=sf.base.extend([],e.pointColl,[],!0),i.afterCropActions=sf.base.extend([],this.parent.afterCropActions,[],!0);var a={selPointColl:null};e.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:a}}),i.selPointColl=sf.base.extend([],a.selPointColl,[],!0),e.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"text",previousObj:i,previousObjColl:i.objColl,previousPointColl:i.pointColl,previousSelPointColl:i.selPointColl,previousCropObj:t,previousText:e.activeObj.keyHistory,currentText:e.textArea.value,previousFilter:null,isCircleCrop:null}})}e.activeObj.keyHistory=e.textArea.value,e.textArea.style.display="none",e.textArea.value="",this.updateFontStyles();var r=this.upperContext.measureText(e.activeObj.keyHistory).width+.5*e.activeObj.textSettings.fontSize,n=e.activeObj.textSettings.fontSize+.25*this.parent.activeObj.textSettings.fontSize,s=e.activeObj.keyHistory.split("\n");if(s.length>1){n*=s.length;for(var l=[],p=0,h=s.length;p<h;p++)l.push(this.upperContext.measureText(s[p]).width+.5*e.activeObj.textSettings.fontSize);r=Math.max.apply(Math,l)}e.notify("selection",{prop:"setTextSelection",onPropertyChange:!1,value:{width:r,height:n}}),e.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:e.activeObj.activePoint,obj:e.activeObj,isMouseMove:null,x:null,y:null}}),this.updImgRatioForActObj()},e.prototype.iterateObjColl=function(){for(var e=this.parent,t=0,o=e.objColl.length;t<o;t++)this.apply(e.objColl[t].shape,e.objColl[t]),this.refreshActiveObj()},e.prototype.updImgRatioForActObj=function(){var e=this.parent;e.activeObj.imageRatio={startX:(e.activeObj.activePoint.startX-e.img.destLeft)/e.img.destWidth,startY:(e.activeObj.activePoint.startY-e.img.destTop)/e.img.destHeight,endX:(e.activeObj.activePoint.endX-e.img.destLeft)/e.img.destWidth,endY:(e.activeObj.activePoint.endY-e.img.destTop)/e.img.destHeight,width:e.img.destWidth/e.activeObj.activePoint.width,height:e.img.destHeight/e.activeObj.activePoint.height},e.activeObj.rotationCirclePointColl&&(e.activeObj.rotationCirclePointColl.ratioX=(e.activeObj.rotationCirclePointColl.x-e.img.destLeft)/e.img.destWidth,e.activeObj.rotationCirclePointColl.ratioY=(e.activeObj.rotationCirclePointColl.y-e.img.destTop)/e.img.destHeight),"path"===e.activeObj.shape?this.updatePathRatio(e.activeObj):"arrow"===e.activeObj.shape&&this.updateArrowRatio(e.activeObj)},e.prototype.zoomObjColl=function(e){for(var t=this.parent,o=0,i=t.objColl.length;o<i;o++){var a=t.objColl[o];if(a.activePoint.startX=a.imageRatio.startX*t.img.destWidth+t.img.destLeft,a.activePoint.startY=a.imageRatio.startY*t.img.destHeight+t.img.destTop,a.activePoint.endX=a.imageRatio.endX*t.img.destWidth+t.img.destLeft,a.activePoint.endY=a.imageRatio.endY*t.img.destHeight+t.img.destTop,"text"===(a=this.updateWidthHeight(a)).shape)this.updateFontSize(a);else if("line"===a.shape||"arrow"===a.shape){a.pointColl=this.getLinePoints(a.activePoint.startX,a.activePoint.startY,a.activePoint.endX,a.activePoint.endY);for(var r=0,n=a.pointColl.length;r<n;r++)a.pointColl[r].ratioX=(a.pointColl[r].x-t.img.destLeft)/t.img.destWidth,a.pointColl[r].ratioY=(a.pointColl[r].y-t.img.destTop)/t.img.destHeight;"arrow"===a.shape&&this.updateArrowSize(a)}else if("path"===a.shape){for(var s=0,l=a.pointColl.length;s<l;s++)a.pointColl[s].x=a.pointColl[s].ratioX*t.img.destWidth+t.img.destLeft,a.pointColl[s].y=a.pointColl[s].ratioY*t.img.destHeight+t.img.destTop;this.updatePathRatio(a)}if(t.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:a.activePoint,obj:a}}),sf.base.isNullOrUndefined(e)){var p=this.lowerContext.filter;this.lowerContext.filter="none",this.apply(a.shape,a),this.refreshActiveObj(),this.lowerContext.filter=p}"line"!==a.shape&&"arrow"!==a.shape&&"path"!==a.shape&&0!==a.rotatedAngle&&(this.setPointCollForShapeRotation(a),a.rotationCirclePoint.x=a.rotationCirclePoint.ratioX*t.img.destWidth+t.img.destLeft,a.rotationCirclePoint.y=a.rotationCirclePoint.ratioY*t.img.destHeight+t.img.destTop,a.rotationCirclePointColl.x=a.rotationCirclePointColl.ratioX*t.img.destWidth+t.img.destLeft,a.rotationCirclePointColl.y=a.rotationCirclePointColl.ratioY*t.img.destHeight+t.img.destTop)}},e.prototype.redrawObj=function(e){var t=this.parent;if(this.parent.objColl.length>0)if("horizontal"===e||"vertical"===e||"Horizontal"===e||"Vertical"===e||"horizontalVertical"===e||"verticalHorizontal"===e)this.updateCurrentActiveObjPoint(e.toLowerCase());else if("number"==typeof e){this.updateCurrentActiveObjPoint(e);var o=this.lowerContext.filter;this.lowerContext.filter="brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)";for(var i=0,a=t.objColl.length;i<a;i++){"crop"!==t.objColl[i].shape.split("-")[0]&&this.apply(t.objColl[i].shape,t.objColl[i])}this.lowerContext.filter=o}},e.prototype.updateCurrentActiveObjPoint=function(e){for(var t,o=this.parent,i=0,a=o.objColl.length;i<a;i++){var r=o.objColl[i];if(o.activeObj.shape===r.shape&&o.activeObj.activePoint.startX===r.activePoint.startX&&o.activeObj.activePoint.startY===r.activePoint.startY&&o.activeObj.activePoint.endX===r.activePoint.endX&&o.activeObj.activePoint.endY===r.activePoint.endY&&o.activeObj.currIndex===r.currIndex){t=i;break}}if("horizontal"===e||"vertical"===e||"Horizontal"===e||"Vertical"===e||"horizontalvertical"===e||"verticalhorizontal"===e){if("horizontal"===e||"Horizontal"===e){var n=0;for(a=o.objColl.length;n<a;n++){(r=o.objColl[n]).shapeFlip!==o.transform.currFlipState&&(r.activePoint.startX<=o.img.destLeft+o.img.destWidth/2?(r.activePoint.endX=o.img.destLeft+o.img.destWidth-(r.activePoint.startX-o.img.destLeft),r.activePoint.startX=r.activePoint.endX-r.activePoint.width,o.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:r.activePoint,obj:r}})):r.activePoint.startX>=o.img.destLeft+o.img.destWidth/2&&(r.activePoint.startX=o.img.destLeft+(o.img.destLeft+o.img.destWidth-r.activePoint.endX),r.activePoint.endX=r.activePoint.startX+r.activePoint.width,o.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:r.activePoint,obj:r}})),"line"===r.shape||"arrow"===r.shape||"path"===r.shape?this.flipLineArrowObj(r,"horizontal"):0!==r.rotatedAngle&&(r.rotatedAngle=r.rotatedAngle+2*(Math.PI-r.rotatedAngle),r.rotationCirclePointColl.x<=o.img.destLeft+o.img.destWidth/2?r.rotationCirclePointColl.x=o.img.destLeft+o.img.destWidth-(r.rotationCirclePointColl.x-o.img.destLeft):r.rotationCirclePointColl.x>=o.img.destLeft+o.img.destWidth/2&&(r.rotationCirclePointColl.x=o.img.destLeft+(o.img.destLeft+o.img.destWidth-r.rotationCirclePointColl.x)),r.rotationCirclePointColl.ratioX=(r.rotationCirclePointColl.x-o.img.destLeft)/o.img.destWidth),r.shapeFlip=o.transform.currFlipState,r.imageRatio={startX:(r.activePoint.startX-o.img.destLeft)/o.img.destWidth,startY:(r.activePoint.startY-o.img.destTop)/o.img.destHeight,endX:(r.activePoint.endX-o.img.destLeft)/o.img.destWidth,endY:(r.activePoint.endY-o.img.destTop)/o.img.destHeight,width:o.img.destWidth/r.activePoint.width,height:o.img.destHeight/r.activePoint.height})}}else if("vertical"===e||"Vertical"===e)for(n=0;n<o.objColl.length;n++){(r=o.objColl[n]).shapeFlip!==o.transform.currFlipState&&(r.activePoint.startY<=o.img.destTop+o.img.destHeight/2?(r.activePoint.endY=o.img.destTop+o.img.destHeight-(r.activePoint.startY-o.img.destTop),r.activePoint.startY=r.activePoint.endY-r.activePoint.height,o.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:r.activePoint,obj:r}})):r.activePoint.startY>=this.parent.lowerCanvas.height/2&&(r.activePoint.startY=o.img.destTop+(o.img.destTop+o.img.destHeight-r.activePoint.endY),r.activePoint.endY=r.activePoint.startY+r.activePoint.height,o.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:r.activePoint,obj:r}})),"line"===r.shape||"arrow"===r.shape||"path"===r.shape?this.flipLineArrowObj(r,"vertical"):0!==r.rotatedAngle&&(r.rotatedAngle=-r.rotatedAngle,r.rotationCirclePointColl.y<=o.img.destTop+o.img.destHeight/2?r.rotationCirclePointColl.y=o.img.destTop+o.img.destHeight-(r.rotationCirclePointColl.y-o.img.destTop):r.rotationCirclePointColl.y>=o.img.destTop+o.img.destHeight/2&&(r.rotationCirclePointColl.y=o.img.destTop+(o.img.destTop+o.img.destHeight-r.rotationCirclePointColl.y)),r.rotationCirclePointColl.ratioY=(r.rotationCirclePointColl.y-o.img.destTop)/o.img.destHeight),r.shapeFlip=o.transform.currFlipState,r.imageRatio={startX:(r.activePoint.startX-o.img.destLeft)/o.img.destWidth,startY:(r.activePoint.startY-o.img.destTop)/o.img.destHeight,endX:(r.activePoint.endX-o.img.destLeft)/o.img.destWidth,endY:(r.activePoint.endY-o.img.destTop)/o.img.destHeight,width:o.img.destWidth/r.activePoint.width,height:o.img.destHeight/r.activePoint.height})}else if("verticalhorizontal"===e||"horizontalvertical"===e)for(n=0,a=o.objColl.length;n<a;n++){(r=o.objColl[n]).shapeFlip!==o.transform.currFlipState&&(r.activePoint.startX<=o.img.destLeft+o.img.destWidth/2?(r.activePoint.endX=o.img.destLeft+o.img.destWidth-(r.activePoint.startX-o.img.destLeft),r.activePoint.startX=r.activePoint.endX-r.activePoint.width,o.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:r.activePoint,obj:r}})):r.activePoint.startX>=o.img.destLeft+o.img.destWidth/2&&(r.activePoint.startX=o.img.destLeft+(o.img.destLeft+o.img.destWidth-r.activePoint.endX),r.activePoint.endX=r.activePoint.startX+r.activePoint.width,o.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:r.activePoint,obj:r}})),r.activePoint.startY<=o.img.destTop+o.img.destHeight/2?(r.activePoint.endY=o.img.destTop+o.img.destHeight-(r.activePoint.startY-o.img.destTop),r.activePoint.startY=r.activePoint.endY-r.activePoint.height,o.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:r.activePoint,obj:r}})):r.activePoint.startY>=this.parent.lowerCanvas.height/2&&(r.activePoint.startY=o.img.destTop+(o.img.destTop+o.img.destHeight-r.activePoint.endY),r.activePoint.endY=r.activePoint.startY+r.activePoint.height,o.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:r.activePoint,obj:r}})),"line"!==r.shape&&"arrow"!==r.shape&&"path"!==r.shape||this.flipLineArrowObj(r,e),r.shapeFlip=o.transform.currFlipState,r.imageRatio={startX:(r.activePoint.startX-o.img.destLeft)/o.img.destWidth,startY:(r.activePoint.startY-o.img.destTop)/o.img.destHeight,endX:(r.activePoint.endX-o.img.destLeft)/o.img.destWidth,endY:(r.activePoint.endY-o.img.destTop)/o.img.destHeight,width:o.img.destWidth/r.activePoint.width,height:o.img.destHeight/r.activePoint.height})}void 0!==t&&(o.activeObj=sf.base.extend({},o.objColl[t],{},!0))}else if(90===e)this.rotateObjColl();else if(-90===e)for(n=0;n<3;n++)this.rotateObjColl();else if("number"==typeof e)if(e>0)this.rotateObjColl();else for(n=0;n<3;n++)this.rotateObjColl()},e.prototype.rotateObjColl=function(){for(var e=this.parent,t=0,o=e.objColl.length;t<o;t++){(i=e.objColl[t]).activePoint.startY=e.img.destTop+e.img.destHeight*i.imageRatio.startX,i.activePoint.endY=e.img.destTop+e.img.destHeight*i.imageRatio.endX,i.activePoint.startX=e.img.destLeft+e.img.destWidth-e.img.destWidth*i.imageRatio.endY,i.activePoint.endX=e.img.destLeft+e.img.destWidth-e.img.destWidth*i.imageRatio.startY,i=this.updateWidthHeight(e.objColl[t]),this.updateFontSize(i),"line"===i.shape||"arrow"===i.shape||"path"===i.shape?(this.rotateLineArrowObj(i),"arrow"===i.shape&&this.updateArrowSize(i)):0!==i.rotatedAngle&&(i.rotationCirclePointColl.y=e.img.destTop+e.img.destHeight*i.rotationCirclePointColl.ratioX,i.rotationCirclePointColl.x=e.img.destLeft+e.img.destWidth-e.img.destWidth*i.rotationCirclePointColl.ratioY,i.rotationCirclePointColl.ratioX=(i.rotationCirclePointColl.x-e.img.destLeft)/e.img.destWidth,i.rotationCirclePointColl.ratioY=(i.rotationCirclePointColl.y-e.img.destTop)/e.img.destHeight)}for(t=0,o=e.objColl.length;t<o;t++)e.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:e.objColl[t].activePoint,obj:e.objColl[t]}});for(t=0,o=e.objColl.length;t<o;t++){var i;(i=e.objColl[t]).imageRatio={startX:(i.activePoint.startX-e.img.destLeft)/e.img.destWidth,startY:(i.activePoint.startY-e.img.destTop)/e.img.destHeight,endX:(i.activePoint.endX-e.img.destLeft)/e.img.destWidth,endY:(i.activePoint.endY-e.img.destTop)/e.img.destHeight,width:e.img.destWidth/i.activePoint.width,height:e.img.destHeight/i.activePoint.height}}},e.prototype.rotateLineArrowObj=function(e){if(!sf.base.isNullOrUndefined(e.pointColl)){var t=this.parent;if(e.pointColl.length>0){for(var o=0;o<e.pointColl.length;o++)e.pointColl[o].y=t.img.destTop+t.img.destHeight*e.pointColl[o].ratioX,e.pointColl[o].x=t.img.destLeft+t.img.destWidth-t.img.destWidth*e.pointColl[o].ratioY;for(o=0;o<e.pointColl.length;o++)e.pointColl[o].ratioX=(e.pointColl[o].x-t.img.destLeft)/t.img.destWidth,e.pointColl[o].ratioY=(e.pointColl[o].y-t.img.destTop)/t.img.destHeight;var i=void 0;i=sf.base.isNullOrUndefined(e.pointColl[e.pointColl.length-2])?{x:0,y:0}:{x:e.pointColl[e.pointColl.length-2].x,y:e.pointColl[e.pointColl.length-2].y};var a=e.pointColl[e.pointColl.length-1].x-i.x,r=e.pointColl[e.pointColl.length-1].y-i.y;e.activePoint.startX=e.pointColl[0].x,e.activePoint.startY=e.pointColl[0].y,e.activePoint.endX=e.pointColl[e.pointColl.length-1].x+a/2,e.activePoint.endY=e.pointColl[e.pointColl.length-1].y+r/2,e=this.updateWidthHeight(e)}}},e.prototype.flipLineArrowObj=function(e,t){if(!sf.base.isNullOrUndefined(e.pointColl)&&("horizontal"===t.toLowerCase()?this.lineArrowHorizontalFlip(e):("vertical"===t.toLowerCase()||(this.lineArrowHorizontalFlip(e),e.shapeFlip=""),this.lineArrowVerticalFlip(e)),e.activePoint.startX=e.pointColl[0].x,e.activePoint.startY=e.pointColl[0].y,e.activePoint.endX=e.pointColl[e.pointColl.length-1].x,e.activePoint.endY=e.pointColl[e.pointColl.length-1].y,e.activePoint.startX>e.activePoint.endX)){var o=e.activePoint.startX;e.activePoint.startX=e.activePoint.endX,e.activePoint.endX=o,o=e.activePoint.startY,e.activePoint.startY=e.activePoint.endY,e.activePoint.endY=o}},e.prototype.lineArrowHorizontalFlip=function(e){var t=this.parent;if(e.shapeFlip!==t.transform.currFlipState){for(var o=0,i=e.pointColl.length;o<i;o++){var a=e.pointColl[o];a.x<=t.img.destLeft+t.img.destWidth/2?a.x=t.img.destLeft+t.img.destWidth-(a.x-t.img.destLeft):a.x>=t.img.destLeft+t.img.destWidth/2&&(a.x=t.img.destLeft+(t.img.destLeft+t.img.destWidth-a.x)),a.ratioX=(a.x-t.img.destLeft)/t.img.destWidth,a.ratioY=(a.y-t.img.destTop)/t.img.destHeight}if("arrow"===e.shape){var r=e.start;e.start=e.end,e.end=r}e.shapeFlip=t.transform.currFlipState}},e.prototype.lineArrowVerticalFlip=function(e){var t=this.parent;if(e.shapeFlip!==t.transform.currFlipState){for(var o=0,i=e.pointColl.length;o<i;o++){var a=e.pointColl[o];a.y<=t.img.destTop+t.img.destHeight/2?a.y=t.img.destTop+t.img.destHeight-(a.y-t.img.destTop):a.y>=t.img.destTop+t.img.destHeight/2&&(a.y=t.img.destTop+(t.img.destTop+t.img.destHeight-a.y)),a.ratioX=(a.x-t.img.destLeft)/t.img.destWidth,a.ratioY=(a.y-t.img.destTop)/t.img.destHeight}e.shapeFlip=t.transform.currFlipState}},e.prototype.getRotDegOfShape=function(e){var t;return(t=0===e.shapeDegree?this.parent.transform.degree:this.parent.transform.degree-e.shapeDegree)<0&&(t=360+t),t},e.prototype.renderTextArea=function(e,t,o){var i=this.parent,a=this.getRotDegOfShape(i.activeObj);this.transformTextArea(),sf.base.isBlazor()?i.updateToolbar(i.element,"destroyQuickAccessToolbar"):i.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1}),i.element.querySelector("#"+i.element.id+"_duplicate")&&i.element.querySelector("#"+i.element.id+"_duplicate").classList.add("e-disabled"),i.element.querySelector("#"+i.element.id+"_remove")&&i.element.querySelector("#"+i.element.id+"_remove").classList.add("e-disabled"),i.element.querySelector("#"+i.element.id+"_editText")&&i.element.querySelector("#"+i.element.id+"_editText").classList.add("e-disabled"),i.textArea.style.display="block",i.textArea.style.left=e+"px",i.textArea.style.top=t+"px",i.textArea.style.fontFamily=o.textSettings.fontFamily,i.textArea.style.fontSize=o.textSettings.fontSize+"px",i.textArea.style.color=o.strokeSettings.strokeColor,i.textArea.style.fontWeight=o.textSettings.bold?"bold":"normal",i.textArea.style.fontStyle=o.textSettings.italic?"italic":"normal",i.textArea.style.border="2px solid "+i.themeColl[i.theme].primaryColor,i.textArea.value=o.keyHistory,i.textArea.style.overflow="hidden",i.textArea.style.width="auto",i.textArea.style.height="auto",i.textArea.focus();i.transform.zoomFactor;var r=o.activePoint,n=r.width,s=r.height;a%90==0&&a%180!=0&&0!==a?(i.textArea.style.width=s+"px",i.textArea.style.height=n+"px"):(i.textArea.style.width=n+"px",i.textArea.style.height=s+"px"),this.setTextBoxWidth();var l={flipColl:null};i.notify("transform",{prop:"getFlipColl",onPropertyChange:!1,value:{obj:l}}),l.flipColl.length<=1&&this.setTextBoxHeight(),a%90==0&&a%180!=0?parseFloat(i.textArea.style.left)+parseFloat(i.textArea.style.width)>i.img.destTop+i.img.destHeight&&this.alignTextAreaIntoCanvas():parseFloat(i.textArea.style.left)+parseFloat(i.textArea.style.width)>i.img.destLeft+i.img.destWidth&&this.alignTextAreaIntoCanvas(),i.notify("selection",{prop:"clearUpperCanvas",onPropertyChange:!1})},e.prototype.setTextBoxWidth=function(e){var t=this.parent,o=this.getMaxText(!0);"block"===t.textArea.style.display?this.updateFontStyles(!0):this.updateFontStyles();var i=this.upperContext.measureText(o).width+parseFloat(t.textArea.style.fontSize)/2,a=e?this.upperContext.measureText(String.fromCharCode(e.which)).width:0,r=sf.base.extend({},t.activeObj,{},!0),n="",s=this.getRotDegOfShape(r);if(n=r.shapeFlip!==t.transform.currFlipState?"":t.transform.currFlipState,e&&parseFloat(t.textArea.style.width)<i+a||sf.base.isNullOrUndefined(e))if(0===s)"horizontal"===n.toLowerCase()?parseFloat(t.textArea.style.left)-t.img.destLeft-i-a>0&&(t.textArea.style.width=i+a+"px"):t.img.destWidth-(parseFloat(t.textArea.style.left)-t.img.destLeft)>i+a&&(t.textArea.style.width=i+a+"px");else if(90===s)"vertical"===n.toLowerCase()?parseFloat(t.textArea.style.top)-t.img.destTop-i-a>0&&(t.textArea.style.width=i+a+"px"):t.img.destHeight-(parseFloat(t.textArea.style.top)-t.img.destTop)>i+a&&(t.textArea.style.width=i+a+"px");else if(180===s){var l=parseFloat(t.textArea.style.left),p=t.img.destLeft;if("horizontal"===n.toLowerCase())t.img.destWidth-(l-p)>i+a&&(t.textArea.style.width=i+a+"px");else l-p-i-a>0&&(t.textArea.style.width=i+a+"px")}else if(270===s){var h=parseFloat(t.textArea.style.top),c=t.img.destTop;if("vertical"===n.toLowerCase())t.img.destHeight-(h-c)>i+a&&(t.textArea.style.width=i+a+"px");else h-c-i-a>0&&(t.textArea.style.width=i+a+"px")}},e.prototype.setTextBoxHeight=function(){var e,t=this.parent,o=sf.base.extend({},t.activeObj,{},!0),i="",a=this.getRotDegOfShape(o);switch(i=o.textFlip===t.transform.currFlipState?"":""===o.textFlip?t.transform.currFlipState:o.textFlip,a){case 0:"vertical"===i.toLowerCase()?t.textArea.style.maxHeight=t.img.destHeight-(t.img.destHeight-parseFloat(t.textArea.style.top))+"px":(e=parseFloat(t.textArea.style.top)-t.img.destTop,t.textArea.style.maxHeight=t.img.destHeight-e+"px");break;case 90:"horizontal"===i.toLowerCase()?t.textArea.style.maxHeight=t.img.destWidth-(parseFloat(t.textArea.style.left)-t.img.destLeft)+"px":t.textArea.style.maxHeight=parseFloat(t.textArea.style.left)-t.img.destLeft+"px";break;case 180:"vertical"===i.toLowerCase()?(e=parseFloat(t.textArea.style.top)-t.img.destTop,t.textArea.style.maxHeight=t.img.destHeight-e+"px"):t.textArea.style.maxHeight=parseFloat(t.textArea.style.top)-t.img.destTop+"px";break;case 270:"horizontal"===i.toLowerCase()?t.textArea.style.maxHeight=parseFloat(t.textArea.style.left)-t.img.destLeft+"px":t.textArea.style.maxHeight=t.img.destWidth-(parseFloat(t.textArea.style.left)-t.img.destLeft)+"px"}},e.prototype.updatePathRatio=function(e){for(var t=this.parent,o=0,i=e.pointColl.length;o<i;o++){var a=e.pointColl[o];a.ratioX=(a.x-t.img.destLeft)/t.img.destWidth,a.ratioY=(a.y-t.img.destTop)/t.img.destHeight}},e.prototype.stopPathDrawing=function(e){var t=this.parent;if("path"===t.activeObj.shape){var o={shape:null};if(t.notify("selection",{prop:"getCurrentDrawingShape",value:{obj:o}}),"path"===o.shape){var i=sf.base.extend({},this.parent.cropObj,{},!0),a={currObj:{}};this.parent.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:a}});var r=a.currObj;r.objColl=sf.base.extend([],this.parent.objColl,[],!0),r.pointColl=sf.base.extend([],this.parent.pointColl,[],!0),r.afterCropActions=sf.base.extend([],this.parent.afterCropActions,[],!0);var n={selPointColl:null};this.parent.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:n}}),r.selPointColl=sf.base.extend([],n.selPointColl,[],!0),t.notify("selection",{prop:"setCurrentDrawingShape",value:{value:""}}),t.currObjType.isDragging=!1,"touchstart"!==e.type&&t.activeObj.pointColl.pop(),this.updatePathRatio(t.activeObj),t.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:r,previousObjColl:r.objColl,previousPointColl:r.pointColl,previousSelPointColl:r.selPointColl,previousCropObj:i,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),t.notify("selection",{prop:"mouseUpEventHandler",value:{e:e}}),t.notify("draw",{prop:"setNewPath",value:{bool:!0}}),t.objColl[t.objColl.length-1]&&t.selectShape(t.objColl[t.objColl.length-1].currIndex),sf.base.isBlazor()?t.updateToolbar(t.element,"quickAccessToolbar",t.activeObj.shape):t.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}})}}},e.prototype.findTextTarget=function(e){var t,o,i=this.parent;if("text"===i.activeObj.shape)if("dblclick"===e.type?(t=e.clientX,o=e.clientY):"touchstart"===e.type&&(t=e.touches[0].clientX,o=e.touches[0].clientY,i.notify("selection",{prop:"setTouchEndPoint",onPropertyChange:!1,value:{x:e.touches[0].clientX,y:e.touches[0].clientY}})),i.notify("toolbar",{prop:"setPreventZoomBtn",onPropertyChange:!1,value:{isPrevent:!0}}),i.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"text",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}),i.notify("toolbar",{prop:"setPreventZoomBtn",onPropertyChange:!1,value:{isPrevent:!1}}),i.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1}),sf.base.isNullOrUndefined(t)||sf.base.isNullOrUndefined(o))if("block"===i.textArea.style.display&&""!==this.selectedText()&&"mousedown"===e.type){s=i.textArea.value;i.textArea.value+="a",i.textArea.value=s}else"none"===i.textArea.style.display&&(i.textArea.style.display="block");else{var a=this.parent.lowerCanvas.getBoundingClientRect();t-=a.left,o-=a.top;var r="",n=this.getRotDegOfShape(i.activeObj);r=""===i.activeObj.textFlip?i.activeObj.textFlip===i.transform.currFlipState?"":i.transform.currFlipState:i.activeObj.textFlip===i.transform.currFlipState?"":""===i.transform.currFlipState?i.activeObj.textFlip:i.transform.currFlipState;var s=void 0;if("none"===i.textArea.style.display){s=sf.base.extend({},i.activeObj,{},!0);for(var l=0;l<i.objColl.length;l++)JSON.stringify(i.activeObj)===JSON.stringify(i.objColl[l])&&i.objColl.splice(l,1);this.refreshActiveObj(),this.upperContext.clearRect(0,0,this.parent.upperCanvas.width,this.parent.upperCanvas.height),this.lowerContext.clearRect(0,0,this.parent.upperCanvas.width,this.parent.upperCanvas.height),i.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1}),(i.currSelectionPoint&&"crop-circle"===i.currSelectionPoint.shape||i.isCircleCrop)&&i.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),i.activeObj=s,this.updateFontStyles();var p=sf.base.extend({},i.activeObj,{},!0);if(t>=p.activePoint.startX-2*p.topLeftCircle.radius&&t<=p.activePoint.endX+2*p.topLeftCircle.radius&&o>=p.activePoint.startY-2*p.topLeftCircle.radius&&o<=p.activePoint.endY+2*p.topLeftCircle.radius){var h;if(this.upperContext.clearRect(0,0,this.parent.upperCanvas.width,this.parent.upperCanvas.height),4===p.flipObjColl.length&&(p.flipObjColl=[],r=""),""===r&&p.flipObjColl.length>1&&(r=p.flipObjColl[p.flipObjColl.length-1]),p.flipObjColl.length<=1)t=(h=this.setTextBoxPos(p,n,r,t,o)).x,o=h.y;else t=(h=this.setTextBoxPoints(p,n,r,t,o)).x,o=h.y;0!==i.activeObj.rotatedAngle&&(t=i.activeObj.horTopLinePointColl[0].x,o=i.activeObj.horTopLinePointColl[0].y),this.renderTextArea(t,o,p)}else this.applyActObj()}}else this.stopPathDrawing(e)},e.prototype.setTextBoxPos=function(e,t,o,i,a){var r={x:i,y:a};switch(t){case 0:"horizontal"===o.toLowerCase()?(r.x=e.activePoint.endX,r.y=e.activePoint.startY):"vertical"===o.toLowerCase()?(r.x=e.activePoint.startX,r.y=e.activePoint.endY):(r.x=e.activePoint.startX,r.y=e.activePoint.startY);break;case 90:"horizontal"===o.toLowerCase()?(r.x=e.activePoint.startX,r.y=e.activePoint.startY):"vertical"===o.toLowerCase()?(r.x=e.activePoint.endX,r.y=e.activePoint.endY):(r.x=e.activePoint.endX,r.y=e.activePoint.startY);break;case 180:"horizontal"===o.toLowerCase()?(r.x=e.activePoint.startX,r.y=e.activePoint.endY):"vertical"===o.toLowerCase()?(r.x=e.activePoint.endX,r.y=e.activePoint.startY):(r.x=e.activePoint.endX,r.y=e.activePoint.endY);break;case 270:"horizontal"===o.toLowerCase()?(r.x=e.activePoint.endX,r.y=e.activePoint.endY):"vertical"===o.toLowerCase()?(r.x=e.activePoint.startX,r.y=e.activePoint.startY):(r.x=e.activePoint.startX,r.y=e.activePoint.endY)}return r},e.prototype.setTextBoxPoints=function(e,t,o,i,a){var r={x:i,y:a};switch(t){case 0:e.flipObjColl[0]&&"horizontal"===e.flipObjColl[0].toLowerCase()?"horizontal"===o.toLowerCase()?(r.x=e.activePoint.startX,r.y=e.activePoint.startY):"vertical"===o.toLowerCase()&&(r.x=e.activePoint.endX,r.y=e.activePoint.endY):"horizontal"===o.toLowerCase()?(r.x=e.activePoint.endX,r.y=e.activePoint.endY):"vertical"===o.toLowerCase()&&(r.x=e.activePoint.endX,r.y=e.activePoint.startY);break;case 90:e.flipObjColl[0]&&"horizontal"===e.flipObjColl[0].toLowerCase()?"horizontal"===o.toLowerCase()?(r.x=e.activePoint.endX,r.y=e.activePoint.endY):"vertical"===o.toLowerCase()&&(r.x=e.activePoint.startX,r.y=e.activePoint.endY):"horizontal"===o.toLowerCase()?(r.x=e.activePoint.startX,r.y=e.activePoint.endY):"vertical"===o.toLowerCase()&&(r.x=e.activePoint.startX,r.y=e.activePoint.startY);break;case 180:e.flipObjColl[0]&&"horizontal"===e.flipObjColl[0].toLowerCase()?("horizontal"===o.toLowerCase()||"vertical"===o.toLowerCase())&&(r.x=e.activePoint.startX,r.y=e.activePoint.startY):"horizontal"===o.toLowerCase()?(r.x=e.activePoint.startX,r.y=e.activePoint.startY):"vertical"===o.toLowerCase()&&(r.x=e.activePoint.startX,r.y=e.activePoint.endY);break;case 270:e.flipObjColl[0]&&"horizontal"===e.flipObjColl[0].toLowerCase()?"horizontal"===o.toLowerCase()?(r.x=e.activePoint.startX,r.y=e.activePoint.startY):"vertical"===o.toLowerCase()&&(r.x=e.activePoint.endX,r.y=e.activePoint.startY):"horizontal"===o.toLowerCase()?(r.x=e.activePoint.endX,r.y=e.activePoint.startY):"vertical"===o.toLowerCase()&&(r.x=e.activePoint.endX,r.y=e.activePoint.endY)}return r},e.prototype.selectedText=function(){var e=this.parent.textArea.selectionStart,t=this.parent.textArea.selectionEnd;return this.parent.textArea.value.substring(e,t)},e.prototype.panObjColl=function(e,t,o){for(var i=this.parent,a=0,r=i.objColl.length;a<r;a++){var n=i.objColl[a];if(""===o||"vertical"===o){if(n.activePoint.startX+=e,n.activePoint.endX+=e,n.rotationCirclePointColl&&(n.rotationCirclePointColl.x+=e),"path"===n.shape)for(var s=0,l=n.pointColl.length;s<l;s++)n.pointColl[s].x+=e}else if(n.activePoint.startX-=e,n.activePoint.endX-=e,n.rotationCirclePointColl&&(n.rotationCirclePointColl.x-=e),"path"===n.shape){s=0;for(var p=n.pointColl.length;s<p;s++)n.pointColl[s].x-=e}if(""===o||"horizontal"===o){if(n.activePoint.startY+=t,n.activePoint.endY+=t,n.rotationCirclePointColl&&(n.rotationCirclePointColl.y+=t),"path"===n.shape)for(s=0;s<n.pointColl.length;s++)n.pointColl[s].y+=t}else if(n.activePoint.startY-=t,n.activePoint.endY-=t,n.rotationCirclePointColl&&(n.rotationCirclePointColl.y-=t),"path"===n.shape)for(s=0;s<n.pointColl.length;s++)n.pointColl[s].y-=t;if(n=this.updateWidthHeight(n),i.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:n.activePoint,obj:n}}),"line"===n.shape||"arrow"===n.shape){n.pointColl=this.getLinePoints(n.activePoint.startX,n.activePoint.startY,n.activePoint.endX,n.activePoint.endY);for(var h=0,c=n.pointColl.length;h<c;h++)n.pointColl[h].ratioX=(n.pointColl[h].x-i.img.destLeft)/i.img.destWidth,n.pointColl[h].ratioY=(n.pointColl[h].y-i.img.destTop)/i.img.destHeight}var d=this.lowerContext.filter;this.lowerContext.filter="none",this.apply(n.shape,n),this.lowerContext.filter=d,this.refreshActiveObj()}},e.prototype.updateFontStyles=function(e){var t=this.parent;this.upperContext.strokeStyle=t.activeObj.strokeSettings.strokeColor,this.upperContext.fillStyle=t.activeObj.strokeSettings.strokeColor;var o="";t.activeObj.textSettings.bold&&(o="bold "),t.activeObj.textSettings.italic&&(o="italic "),t.activeObj.textSettings.bold&&t.activeObj.textSettings.italic&&(o="italic bold ");var i=e?parseFloat(t.textArea.style.fontSize):t.activeObj.textSettings.fontSize,a="block"===t.textArea.style.display?t.textArea.style.fontFamily:t.activeObj.textSettings.fontFamily;this.upperContext.font=o+i+"px "+a},e.prototype.applyFontStyle=function(e){var t=this.parent;this.pushActItemIntoObj();var o=sf.base.extend([],t.objColl,[],!0);switch(t.objColl.pop(),"none"===t.textArea.style.display?this.updateFontRatio(t.activeObj):this.updateFontRatio(t.activeObj,!0),e){case"default":this.updateFontStyle(e,o,"normal","normal");break;case"bold":this.updateFontStyle(e,o,"bold","normal");break;case"italic":this.updateFontStyle(e,o,"normal","italic");break;case"bolditalic":this.updateFontStyle(e,o,"bold","italic")}},e.prototype.updateFontStyle=function(e,t,o,i){var a=this.parent;if("block"===a.textArea.style.display){var r=this.getTextAreaWidth(e);a.textArea.style.width=r+"px",a.textArea.style.fontWeight=o,a.textArea.style.fontStyle=i,this.updateObjColl(e,t)}else this.textSettings.bold=a.activeObj.textSettings.bold="normal"!==o,this.textSettings.italic=a.activeObj.textSettings.italic="normal"!==i,this.redrawText(),a.notify("undo-redo",{prop:"updateUrObj",onPropertyChange:!1,value:{objColl:t}})},e.prototype.updateArrowRatio=function(e){var t,o={arrowDimension:null};this.parent.notify("draw",{prop:"getArrowDimension",onPropertyChange:!1,value:{obj:o}});var i,a=this.getRotDegOfShape(e);t=0===a||180===a||-180===a?Math.abs(e.activePoint.width):Math.abs(e.activePoint.height);for(var r=0,n=["bar","arrow","arrowSolid","circle","square"];r<n.length;r++){i=n[r];var s=t/o.arrowDimension[i].width,l=t/o.arrowDimension[i].height;o.arrowDimension[i].ratioX=s,o.arrowDimension[i].ratioY=l}},e.prototype.updateArrowSize=function(e){var t,o={arrowDimension:null};this.parent.notify("draw",{prop:"getArrowDimension",onPropertyChange:!1,value:{obj:o}});var i,a=this.getRotDegOfShape(e);t=0===a||180===a||-180===a?Math.abs(e.activePoint.width):Math.abs(e.activePoint.height);for(var r=0,n=["bar","arrow","arrowSolid","circle","square"];r<n.length;r++){i=n[r];var s=o.arrowDimension[i].ratioX,l=o.arrowDimension[i].ratioY;o.arrowDimension[i].width=t/s,o.arrowDimension[i].height=t/l}},e.prototype.updateFontRatio=function(e,t){var o=this.parent,i=this.getMaxText(t),a=this.upperContext.measureText(i).width+.5*o.activeObj.textSettings.fontSize,r=o.activeObj.textSettings.fontSize+.25*o.activeObj.textSettings.fontSize,n=this.getRotDegOfShape(e);sf.base.isNullOrUndefined(t)?0===n||180===Math.abs(n)?e.textSettings.fontRatio=a/e.textSettings.fontSize:e.textSettings.fontRatio=r/e.textSettings.fontSize:t&&(e.textSettings.fontRatio=a/parseFloat(o.textArea.style.fontSize))},e.prototype.updateFontSize=function(e){var t=this.getRotDegOfShape(e);0===t||180===Math.abs(t)?e.textSettings.fontSize=e.activePoint.width/e.textSettings.fontRatio:e.textSettings.fontSize=e.activePoint.height/e.textSettings.fontRatio},e.prototype.updateObjColl=function(e,t){var o=this.parent,i=sf.base.extend({},o.cropObj,{},!0),a={currObj:{}};o.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:a}});var r=a.currObj;r.objColl=t,r.pointColl=sf.base.extend([],o.pointColl,[],!0),r.afterCropActions=sf.base.extend([],o.afterCropActions,[],!0);var n={selPointColl:null};o.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:n}}),r.selPointColl=sf.base.extend([],n.selPointColl,[],!0);var s=o.activeObj.textSettings.bold,l=o.activeObj.textSettings.italic;switch(e){case"default":o.activeObj.textSettings.bold=!1,o.activeObj.textSettings.italic=!1;break;case"bold":o.activeObj.textSettings.bold=!0,o.activeObj.textSettings.italic=!1;break;case"italic":o.activeObj.textSettings.bold=!1,o.activeObj.textSettings.italic=!0;break;case"bolditalic":o.activeObj.textSettings.bold=!0,o.activeObj.textSettings.italic=!0}o.objColl.push(o.activeObj),o.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"textAreaCustomization",previousObj:r,previousObjColl:r.objColl,previousPointColl:r.pointColl,previousSelPointColl:r.selPointColl,previousCropObj:i,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),o.objColl.pop(),o.activeObj.textSettings.bold=s,o.activeObj.textSettings.italic=l},e.prototype.pushActItemIntoObj=function(){if("none"===this.parent.textArea.style.display)this.parent.objColl.push(this.parent.activeObj);else{var e=sf.base.extend({},this.parent.activeObj,{},!0);this.parent.notify("selection",{prop:"setTextBoxStylesToActObj",onPropertyChange:!1}),this.parent.objColl.push(this.parent.activeObj),this.parent.activeObj=e}},e.prototype.clearActObj=function(){"none"===this.parent.textArea.style.display&&(this.refreshActiveObj(),this.applyActObj(),this.refreshActiveObj(),this.parent.currObjType.isCustomCrop=!1)},e.prototype.refreshActiveObj=function(){this.parent.activeObj={},this.parent.activeObj.activePoint={startX:0,startY:0,endX:0,endY:0,width:0,height:0},this.parent.activeObj.triangle=[],this.parent.activeObj.triangleRatio=[],this.parent.activeObj.flipObjColl=[],this.parent.activeObj.strokeSettings=this.strokeSettings,this.parent.activeObj.textSettings=this.textSettings,this.parent.activeObj.rotatedAngle=0},e.prototype.applyActObj=function(e){var t=!1;if(void 0!==this.parent.activeObj.shape&&"text"===this.parent.activeObj.shape&&""===this.parent.activeObj.keyHistory)this.refreshActiveObj(),this.upperContext.clearRect(0,0,this.parent.upperCanvas.width,this.parent.upperCanvas.height);else{var o=void 0,i=!1;if(void 0!==this.parent.activeObj.shape&&(o=this.parent.activeObj.shape.split("-")),(void 0===o&&this.parent.currObjType.isCustomCrop||void 0!==o&&"crop"===o[0])&&(i=!0),this.parent.activeObj.shape&&!i&&"shape"!==this.parent.activeObj.shape){for(var a=0;a<this.parent.objColl.length;a++)if(JSON.stringify(this.parent.activeObj)===JSON.stringify(this.parent.objColl[a])){t=!0;break}if(!t){sf.base.isNullOrUndefined(this.parent.activeObj.currIndex)&&(this.parent.activeObj.currIndex="shape_"+(this.parent.objColl.length+1)),this.updImgRatioForActObj();var r=this.parent.activeObj.currIndex.split("_"),n=this.parent.objColl.splice(0,parseInt(r[1],10)-1);n.push(sf.base.extend({},this.parent.activeObj,{},!0));for(a=0;a<this.parent.objColl.length;a++)n.push(this.parent.objColl[a]);this.parent.objColl=n,n=[],this.refreshActiveObj(),this.lowerContext.clearRect(0,0,this.parent.lowerCanvas.width,this.parent.lowerCanvas.height),this.parent.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1}),this.parent.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),this.parent.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),this.parent.currObjType.shape="",this.refreshActiveObj(),this.parent.isCircleCrop&&this.parent.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),sf.base.isBlazor()?this.parent.updateToolbar(this.parent.element,"destroyQuickAccessToolbar"):this.parent.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1}),sf.base.isNullOrUndefined(e)&&(this.parent.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),this.parent.notify("draw",{prop:"setPrevActObj",onPropertyChange:!1,value:{prevActObj:null}}))}}}},e.prototype.alignTextAreaIntoCanvas=function(){var e=this.parent,t=e.textArea.value;e.textArea.value="";for(var o=0,i=t.length;o<i;o++)e.textArea.value+=t[o],e.textArea.style.height="auto",e.textArea.style.height=e.textArea.scrollHeight+"px",this.setTextBoxWidth()},e.prototype.transformTextArea=function(){var e=this.parent;if("text"===e.activeObj.shape){e.textArea.style.transformOrigin="0 0";var t=e.activeObj.rotatedAngle*(180/Math.PI),o="",i=this.getRotDegOfShape(e.activeObj);if(e.activeObj.flipObjColl.length>0)for(var a=0;a<e.activeObj.flipObjColl.length;a++)o+=0!==i&&i%90==0&&180!==i?"horizontal"===e.activeObj.flipObjColl[a].toLowerCase()?"scale(1, -1)":"scale(-1, 1)":"horizontal"===e.activeObj.flipObjColl[a].toLowerCase()?"scale(-1, 1)":"scale(1, -1)",i+=t,("horizontal"===e.activeObj.flipObjColl[a].toLowerCase()||"vertical"===e.activeObj.flipObjColl[a].toLowerCase())&&(e.textArea.style.transform="rotate("+i+"deg)"+o);else i+=t,e.textArea.style.transform="rotate("+i+"deg)"}},e.prototype.getTextAreaWidth=function(e){var t,o=this.parent,i=o.activeObj.textSettings.bold,a=o.activeObj.textSettings.italic;switch(e){case"default":o.activeObj.textSettings.bold=!1,o.activeObj.textSettings.italic=!1;break;case"bold":o.activeObj.textSettings.bold=!0,o.activeObj.textSettings.italic=!1;break;case"italic":o.activeObj.textSettings.bold=!1,o.activeObj.textSettings.italic=!0;break;case"bolditalic":o.activeObj.textSettings.bold=!0,o.activeObj.textSettings.italic=!0}return this.updateFontStyles(),t="none"===o.textArea.style.display?this.upperContext.measureText(o.activeObj.keyHistory).width+.5*o.activeObj.textSettings.fontSize:this.upperContext.measureText(o.textArea.value).width+.5*o.activeObj.textSettings.fontSize,o.activeObj.textSettings.bold=i,o.activeObj.textSettings.italic=a,t},e.prototype.getObjDetails=function(e){var t=this.parent,o={};switch(o.id=e.currIndex,o.type=t.toPascalCase(e.shape),o.startX=e.activePoint.startX,o.startY=e.activePoint.startY,e.shape){case"rectangle":o.width=e.activePoint.width,o.height=e.activePoint.height,o.strokeColor=e.strokeSettings.strokeColor,o.fillColor=e.strokeSettings.fillColor,o.strokeWidth=e.strokeSettings.strokeWidth;break;case"ellipse":o.radius=e.activePoint.width/2,o.strokeColor=e.strokeSettings.strokeColor,o.fillColor=e.strokeSettings.fillColor,o.strokeWidth=e.strokeSettings.strokeWidth;break;case"line":case"arrow":o.length=e.activePoint.width,o.strokeColor=e.strokeSettings.strokeColor,o.strokeWidth=e.strokeSettings.strokeWidth;break;case"text":o.text=e.keyHistory,o.fontSize=e.textSettings.fontSize,o.color=e.strokeSettings.strokeColor,o.fontStyle=[],e.textSettings.bold&&o.fontStyle.push("bold"),e.textSettings.italic&&o.fontStyle.push("italic")}return o},e.prototype.getFreehandDrawDetails=function(e){var t=this.parent,o={};return o.id=t.pointColl[e].id,o.type=i.FreehandDraw,o.points=sf.base.extend([],t.pointColl[e].points),o.strokeColor=t.pointColl[e].strokeColor,o.strokeWidth=t.pointColl[e].strokeWidth,o},e.prototype.getShapeSetting=function(e,t){var o,i=this.parent;if(!i.disabled&&i.isImageLoaded)if(this.applyActObj(),"shape"===e.split("_")[0]){for(var a,r=0,n=i.objColl.length;r<n;r++)if(i.objColl[r].currIndex===e){a=sf.base.extend({},i.objColl[r],{},!0);break}o=this.getObjDetails(a)}else"pen"===e.split("_")[0]&&(o=this.getFreehandDrawDetails(parseInt(e.split("_")[1],10)-1));t.shapeDetails=o},e.prototype.getShapeSettings=function(e){var t=this.parent,o=[];if(!t.disabled&&t.isImageLoaded){this.applyActObj();for(var i=0,a=t.objColl.length;i<a;i++){var r=this.getObjDetails(t.objColl[i]);o.push(r)}for(i=0;i<t.freehandCounter;i++){r=this.getFreehandDrawDetails(i);o.push(r)}}e.shapeDetailsColl=o},e.prototype.isPointsInRange=function(e,t,o){var i=!1;!sf.base.isNullOrUndefined(e)&&!sf.base.isNullOrUndefined(t)&&e>=this.parent.img.destLeft&&t>=this.parent.img.destTop&&e<=this.parent.img.destLeft+this.parent.img.destWidth&&t<=this.parent.img.destTop+this.parent.img.destHeight&&(i=!0),o.inRange=i},e.prototype.alignRotateFlipColl=function(e,t,o){return e=this.popForDefaultTransformedState(e),e=this.popForDefaultFlipState(e),0===(e=this.popForDefaultRotateState(e)).length&&t&&(this.parent.transform.degree=0,this.parent.transform.currFlipState=""),o.collection=e,e},e.prototype.popForDefaultTransformedState=function(e){for(var t=0,o=0,i=0,a=0,r=0;r<e.length;r++)90===e[r]||"rotateRight"===e[r]?(o=0,i=0,a=0,4===++t&&(e.pop(),e.pop(),e.pop(),e.pop())):-90===e[r]||"rotateLeft"===e[r]?(t=0,i=0,a=0,4===++o&&(e.pop(),e.pop(),e.pop(),e.pop())):"horizontal"===e[r]||"Horizontal"===e[r]||"horizontalflip"===e[r]?(o=0,t=0,a=0,2===++i&&(e.pop(),e.pop())):"vertical"!==e[r]&&"Vertical"!==e[r]&&"verticalflip"!==e[r]||(i=0,o=0,t=0,2===++a&&(e.pop(),e.pop()));return e},e.prototype.popForDefaultFlipState=function(e){for(var t=0;t<e.length;t++)sf.base.isNullOrUndefined(e[t+3])||("horizontal"!==e[t]&&"Horizontal"!==e[t]&&"horizontalFlip"!==e[t]||"vertical"!==e[t+1]&&"Vertical"!==e[t+1]&&"verticalFlip"!==e[t]||"horizontal"!==e[t+2]&&"Horizontal"!==e[t+2]&&"horizontalFlip"!==e[t]||"vertical"!==e[t+3]&&"Vertical"!==e[t+3]&&"verticalFlip"!==e[t])&&("vertical"!==e[t]&&"Vertical"!==e[t]&&"verticalFlip"!==e[t]||"horizontal"!==e[t+1]&&"Horizontal"!==e[t+1]&&"horizontalFlip"!==e[t+1]||"vertical"!==e[t+2]&&"Vertical"!==e[t+2]&&"verticalFlip"!==e[t]||"horizontal"!==e[t+3]&&"Horizontal"!==e[t+3]&&"horizontalFlip"!==e[t])||(e.pop(),e.pop(),e.pop(),e.pop());return e},e.prototype.popForDefaultRotateState=function(e){for(var t=0;t<e.length;t++)sf.base.isNullOrUndefined(e[t+1])||(90!==e[t]&&"rotateRight"!==e[t]||-90!==e[t+1]&&"rotateLeft"!==e[t])&&(-90!==e[t]&&"rotateLeft"!==e[t]||90!==e[t+1]&&"rotateRight"!==e[t])||(e.pop(),e.pop());return e},e.prototype.selectShape=function(e,t){var o=this.parent,i=!1;if(!o.disabled&&o.isImageLoaded)if(this.applyActObj(),"shape"===e.split("_")[0]){for(var a,r=0,n=o.objColl.length;r<n;r++)if(o.objColl[r].currIndex===e){a=sf.base.extend({},o.objColl[r],{},!0);break}if(sf.base.isNullOrUndefined(a))i=!1;else{i=!0,o.activeObj=a;var s={canvasFilter:null};o.notify("toolbar",{prop:"getCanvasFilter",onPropertyChange:!1,value:{obj:s}}),this.lowerContext.filter=s.canvasFilter,o.notify("selection",{prop:"redrawShape",onPropertyChange:!1,value:{obj:o.activeObj}}),sf.base.isBlazor()?(o.updateToolbar(o.element,o.activeObj.shape),"path"===o.activeObj.shape?o.updateToolbar(this.parent.element,"path","pathQuickAccessToolbar"):o.updateToolbar(o.element,"quickAccessToolbar",o.activeObj.shape)):("text"===o.activeObj.shape?o.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"text",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}):"pen"===o.activeObj.shape?o.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"pen",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}):o.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"shapes",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}),o.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1}),o.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}}))}}else if("pen"===e.split("_")[0]){s={bool:!1};o.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:s}}),s.bool&&o.okBtn();var l={isIndex:!1};o.notify("freehand-draw",{prop:"isFHDIdx",value:{index:parseInt(e.split("_")[1],10)-1,obj:l}}),l.isIndex?(i=!0,o.notify("freehand-draw",{prop:"selectFhd",value:{id:e}}),sf.base.isBlazor()?(o.updateToolbar(o.element,"pen"),o.updateToolbar(o.element,"quickAccessToolbar","pen")):(o.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:!0}}),o.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1}))):i=!1}t.isSelected=i},e.prototype.deleteShape=function(e){var t=this.parent;if(!t.disabled&&t.isImageLoaded){if(this.applyActObj(),"shape"===e.split("_")[0]){for(var o=0,i=t.objColl.length;o<i;o++)if(t.objColl[o].currIndex===e){t.objColl.splice(o,1);break}}else"pen"===e.split("_")[0]&&t.notify("freehand-draw",{prop:"handle-freehand-draw",value:{id:e}});var a={canvasFilter:null};t.notify("toolbar",{prop:"getCanvasFilter",onPropertyChange:!1,value:{obj:a}}),this.lowerContext.filter=a.canvasFilter,this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),t.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1}),t.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1})}},e.prototype.getMaxText=function(e,t,o){var i;sf.base.isNullOrUndefined(t)&&(t=e?this.parent.textArea.value:this.parent.activeObj.keyHistory);for(var a=t.split("\n"),r=a[0].length,n=a[0],s=1;s<a.length;s++)(i=a[s].length)>r&&(n=a[s],r=i);return o&&(o.maxText=n),n},e.prototype.getLinePoints=function(e,t,o,i){var a,r,n=[];if(e===o){t<i?(a=[e,t],r=[o,i]):(r=[e,t],a=[o,i]);for(var s=this.getSlope(a,r,!0),l=this.getIntercept(a,s),p=a[1];p<=r[1];p++){var h=s*p+l;n.push({x:h,y:p})}}else{e<o?(a=[e,t],r=[o,i]):(r=[e,t],a=[o,i]);for(s=this.getSlope(a,r,!1),l=this.getIntercept(a,s),h=a[0];h<=r[0];h++){p=s*h+l;n.push({x:h,y:p})}}if(Math.floor(e)===Math.floor(o)||n.length<10&&(i-t>10||t-i>10)){n=[];for(var c=Math.min(t,i),d=0;d<Math.abs(Math.floor(i)-Math.floor(t));d++)n.push({x:e,y:c+d});if(n.length>1){var v=void 0;v=sf.base.isNullOrUndefined(n[n.length-2])?{x:0,y:0}:n[n.length-2];var u=n[n.length-1].x-v.x,b=n[n.length-1].y-v.y;n.push({x:n[n.length-1].x+u/2,y:n[n.length-1].y+b/2})}}else if(Math.floor(t)===Math.floor(i)||n.length<10&&(o-e>10||e-o>10)){n=[];for(var g=Math.min(e,o),f=0;f<Math.abs(Math.floor(o)-Math.floor(e));f++)n.push({x:g+f,y:t});if(n.length>1){v=void 0;v=sf.base.isNullOrUndefined(n[n.length-2])?{x:0,y:0}:n[n.length-2];u=n[n.length-1].x-v.x,b=n[n.length-1].y-v.y;n.push({x:n[n.length-1].x+u/2,y:n[n.length-1].y+b/2})}}return n},e.prototype.getSlope=function(e,t,o){var i;if(o){if(e[1]===t[1])return null;i=(t[0]-e[0])/(t[1]-e[1])}else{if(e[0]===t[0])return null;i=(t[1]-e[1])/(t[0]-e[0])}return i},e.prototype.getIntercept=function(e,t){return null===t?e[0]:e[1]-t*e[0]},e.prototype.setPointCollForShapeRotation=function(e){var t=e.activePoint.startX+e.activePoint.width/2,o=e.activePoint.startY+e.activePoint.height/2,i={x:Math.cos(e.rotatedAngle)*(e.activePoint.startX-t)-Math.sin(e.rotatedAngle)*(e.activePoint.startY-o)+t,y:Math.sin(e.rotatedAngle)*(e.activePoint.startX-t)+Math.cos(e.rotatedAngle)*(e.activePoint.startY-o)+o},a={x:Math.cos(e.rotatedAngle)*(e.activePoint.endX-t)-Math.sin(e.rotatedAngle)*(e.activePoint.startY-o)+t,y:Math.sin(e.rotatedAngle)*(e.activePoint.endX-t)+Math.cos(e.rotatedAngle)*(e.activePoint.startY-o)+o},r={x:Math.cos(e.rotatedAngle)*(e.activePoint.startX-t)-Math.sin(e.rotatedAngle)*(e.activePoint.endY-o)+t,y:Math.sin(e.rotatedAngle)*(e.activePoint.startX-t)+Math.cos(e.rotatedAngle)*(e.activePoint.endY-o)+o},n={x:Math.cos(e.rotatedAngle)*(e.activePoint.endX-t)-Math.sin(e.rotatedAngle)*(e.activePoint.endY-o)+t,y:Math.sin(e.rotatedAngle)*(e.activePoint.endX-t)+Math.cos(e.rotatedAngle)*(e.activePoint.endY-o)+o};e.horTopLinePointColl=this.getLinePoints(i.x,i.y,a.x,a.y),e.horBottomLinePointColl=this.getLinePoints(r.x,r.y,n.x,n.y),e.verLeftLinePointColl=this.getLinePoints(i.x,i.y,r.x,r.y),e.verRightLinePointColl=this.getLinePoints(a.x,a.y,n.x,n.y),e.verLeftLinePointColl.reverse(),e.verRightLinePointColl.reverse();for(var s=0;s<e.horTopLinePointColl.length;s++)e.horTopLinePointColl[s].ratioX=(e.horTopLinePointColl[s].x-this.parent.img.destLeft)/this.parent.img.destWidth,e.horTopLinePointColl[s].ratioY=(e.horTopLinePointColl[s].y-this.parent.img.destTop)/this.parent.img.destHeight;for(s=0;s<e.horBottomLinePointColl.length;s++)e.horBottomLinePointColl[s].ratioX=(e.horBottomLinePointColl[s].x-this.parent.img.destLeft)/this.parent.img.destWidth,e.horBottomLinePointColl[s].ratioY=(e.horBottomLinePointColl[s].y-this.parent.img.destTop)/this.parent.img.destHeight;for(s=0;s<e.verLeftLinePointColl.length;s++)e.verLeftLinePointColl[s].ratioX=(e.verLeftLinePointColl[s].x-this.parent.img.destLeft)/this.parent.img.destWidth,e.verLeftLinePointColl[s].ratioY=(e.verLeftLinePointColl[s].y-this.parent.img.destTop)/this.parent.img.destHeight;for(s=0;s<e.verRightLinePointColl.length;s++)e.verRightLinePointColl[s].ratioX=(e.verRightLinePointColl[s].x-this.parent.img.destLeft)/this.parent.img.destWidth,e.verRightLinePointColl[s].ratioY=(e.verRightLinePointColl[s].y-this.parent.img.destTop)/this.parent.img.destHeight;if("move"!==this.parent.upperCanvas.style.cursor){var l={rotationCirclePoint:null};this.parent.notify("selection",{prop:"getTransRotationPoint",value:{obj:e,object:l}});var p=l.rotationCirclePoint;p&&(e.rotationCirclePointColl={x:Math.cos(e.rotatedAngle)*(p.x-t)-Math.sin(e.rotatedAngle)*(p.y-o)+t,y:Math.sin(e.rotatedAngle)*(p.x-t)+Math.cos(e.rotatedAngle)*(p.y-o)+o},e.rotationCirclePointColl.ratioX=(e.rotationCirclePointColl.x-this.parent.img.destLeft)/this.parent.img.destWidth,e.rotationCirclePointColl.ratioY=(e.rotationCirclePointColl.y-this.parent.img.destTop)/this.parent.img.destHeight)}},e.prototype.getSquarePointForRotatedShape=function(e,t){var o={startX:0,startY:0,endX:0,endY:0,width:0,height:0},i=e.activePoint.startX+e.activePoint.width/2,a=e.activePoint.startY+e.activePoint.height/2,r={x:Math.cos(e.rotatedAngle)*(e.activePoint.startX-i)-Math.sin(e.rotatedAngle)*(e.activePoint.startY-a)+i,y:Math.sin(e.rotatedAngle)*(e.activePoint.startX-i)+Math.cos(e.rotatedAngle)*(e.activePoint.startY-a)+a},n={x:Math.cos(e.rotatedAngle)*(e.activePoint.endX-i)-Math.sin(e.rotatedAngle)*(e.activePoint.startY-a)+i,y:Math.sin(e.rotatedAngle)*(e.activePoint.endX-i)+Math.cos(e.rotatedAngle)*(e.activePoint.startY-a)+a},s={x:Math.cos(e.rotatedAngle)*(e.activePoint.startX-i)-Math.sin(e.rotatedAngle)*(e.activePoint.endY-a)+i,y:Math.sin(e.rotatedAngle)*(e.activePoint.startX-i)+Math.cos(e.rotatedAngle)*(e.activePoint.endY-a)+a},l={x:Math.cos(e.rotatedAngle)*(e.activePoint.endX-i)-Math.sin(e.rotatedAngle)*(e.activePoint.endY-a)+i,y:Math.sin(e.rotatedAngle)*(e.activePoint.endX-i)+Math.cos(e.rotatedAngle)*(e.activePoint.endY-a)+a};return o.startX=r.x,o.startY=r.y,o.endX=r.x,o.endY=r.y,o.startX>n.x&&(o.startX=n.x),o.startX>s.x&&(o.startX=s.x),o.startX>l.x&&(o.startX=l.x),o.startY>n.y&&(o.startY=n.y),o.startY>s.y&&(o.startY=s.y),o.startY>l.y&&(o.startY=l.y),o.endX<n.x&&(o.endX=n.x),o.endX<s.x&&(o.endX=s.x),o.endX<l.x&&(o.endX=l.x),o.endY<n.y&&(o.endY=n.y),o.endY<s.y&&(o.endY=s.y),o.endY<l.y&&(o.endY=l.y),o.width=o.endX-o.startX,o.height=o.endY-o.startY,t&&(t.activePoint=o),o},e}(),f=function(){function e(e){this.isReverseFlip=!1,this.disablePan=!1,this.isReverseRotate=!1,this.flipColl=[],this.prevZoomValue=1,this.cropDimension={width:0,height:0},this.isPreventSelect=!1,this.parent=e,this.addEventListener()}return e.prototype.destroy=function(){this.parent.isDestroyed||this.removeEventListener()},e.prototype.addEventListener=function(){this.parent.on("transform",this.transform,this),this.parent.on("destroyed",this.destroy,this)},e.prototype.removeEventListener=function(){this.parent.off("transform",this.transform),this.parent.off("destroyed",this.destroy)},e.prototype.transform=function(e){switch(this.initTransformPvtVar(),e.prop){case"rotateImage":this.rotateImage(e.value.degree);break;case"flipImage":this.flipImage(e.value.direction);break;case"setDestPointsForFlipState":this.setDestPointsForFlipState();break;case"zoomAction":this.zoomAction(e.value.zoomFactor,e.value.zoomPoint);break;case"disableZoomOutBtn":this.disableZoomOutBtn(e.value.isZoomOut);break;case"rotatedFlip":this.rotatedFlip();break;case"drawPannedImage":this.drawPannedImage(e.value.xDiff,e.value.yDiff);break;case"drawPannImage":this.drawPannImage(e.value.point);break;case"performTransformation":this.performTransformation(e.value.text);break;case"updateTransform":this.updateTransform(e.value.text);break;case"rotatePan":this.rotatePan(e.value.isCropSelection,e.value.isDefaultZoom);break;case"drawRotatedImage":this.drawRotatedImage(e.value.degree);break;case"limitPan":this.limitPan();break;case"updateFlipActiveObj":this.updateFlipActiveObj(e.value.panRegion);break;case"resetZoom":this.resetZoom();break;case"pan":this.pan(e.value.value);break;case"zoom":this.zoom(e.value.zoomFactor,e.value.zoomPoint);break;case"setCurrPanRegion":this.setCurrPanRegion(e.value.region,e.value.type,e.value.obj);break;case"rotate":this.rotate(e.value.degree,e.value.obj);break;case"flip":this.flip(e.value.direction);break;case"update":this.update();break;case"calcMaxDimension":this.calcMaxDimension(e.value.width,e.value.height,e.value.obj);break;case"updatePanPoints":this.updatePanPoints(e.value.panRegion,e.value.obj);break;case"getPanMove":e.value.obj.panMove=this.panMove;break;case"setPanMove":this.panMove=e.value.point;break;case"getTempPanMove":e.value.obj.tempPanMove=this.tempPanMove;break;case"setTempPanMove":this.tempPanMove=e.value.point;break;case"setReverseFlip":this.isReverseFlip=e.value.isReverseFlip;break;case"setDisablePan":this.disablePan=e.value.bool;break;case"setCurrDestinationPoint":this.currDestPoint=e.value.point,this.currDestPoint.startX-=this.parent.cropObj.totalPannedPoint.x,this.currDestPoint.startY-=this.parent.cropObj.totalPannedPoint.y;break;case"setReverseRotate":this.isReverseRotate=e.value.bool;break;case"getFlipColl":e.value.obj.flipColl=this.flipColl;break;case"setFlipColl":this.flipColl=e.value.flipColl;break;case"getPreviousZoomValue":e.value.obj.previousZoomValue=this.prevZoomValue;break;case"setPreviousZoomValue":this.prevZoomValue=e.value.previousZoomValue;break;case"getCropDimension":e.value.obj.cropDimension=this.cropDimension;break;case"setCropDimension":this.cropDimension.width=e.value.width,this.cropDimension.height=e.value.height;break;case"reset":this.reset()}},e.prototype.getModuleName=function(){return"transform"},e.prototype.initTransformPvtVar=function(){this.parent.lowerCanvas&&(this.lowerContext=this.parent.lowerCanvas.getContext("2d")),this.parent.upperCanvas&&(this.upperContext=this.parent.upperCanvas.getContext("2d"))},e.prototype.reset=function(){this.zoomBtnHold=null,this.tempPanMove=null,this.panMove=null,this.disablePan=!1,this.currDestPoint=null,this.isReverseRotate=!1,this.flipColl=[],this.transCurrObj=null,this.prevZoomValue=1,this.isPreventSelect=!1},e.prototype.rotateImage=function(e){var t=this,o=this.parent,i={cancel:!1,previousDegree:o.transform.degree,currentDegree:360===Math.abs(o.transform.degree+e)?0:o.transform.degree+e};!this.isPreventSelect&&sf.base.isBlazor()&&o.events&&!0===o.events.rotating.hasDelegate?o.dotNetRef.invokeMethodAsync("RotateEventAsync","OnRotate",i).then((function(o){t.rotateEvent(o,e)})):(this.isPreventSelect||o.trigger("rotating",i),this.rotateEvent(i,e))},e.prototype.rotateEvent=function(e,t){var o=this.parent;if(!e.cancel){var i=void 0;if(sf.base.isNullOrUndefined(this.transCurrObj)){var a={currObj:{}};o.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:a}}),(i=a.currObj).objColl=sf.base.extend([],o.objColl,null,!0),i.pointColl=sf.base.extend({},o.pointColl,null,!0),i.afterCropActions=sf.base.extend([],o.afterCropActions,[],!0);var r={selPointColl:null};o.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:r}}),i.selPointColl=sf.base.extend([],r.selPointColl,[],!0)}o.afterCropActions.push(90===t?"rotateRight":"rotateLeft");var n=[],s=void 0;o.activeObj.activePoint&&o.activeObj.shape&&(void 0!==o.activeObj.shape&&(n=o.activeObj.shape.split("-")),(o.currObjType.isCustomCrop||"crop"===n[0])&&(s=o.currObjType.isCustomCrop?"custom":n[1],o.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),o.objColl.push(o.activeObj),o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}))),o.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:!0}}),this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),this.drawRotatedImage(t),o.notify("draw",{prop:"setImageEdited",onPropertyChange:!1}),o.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),o.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),o.isCircleCrop&&o.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),s&&(this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),o.activeObj=sf.base.extend({},o.objColl[o.objColl.length-1],{},!0),o.objColl.pop(),o.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:o.activeObj}})),o.isUndoRedo=!1;var l={collection:o.rotateFlipColl};o.notify("shape",{prop:"alignRotateFlipColl",onPropertyChange:!1,value:{collection:o.rotateFlipColl,isRotateFlipCollection:!0,obj:l}}),o.rotateFlipColl=l.collection,o.cropObj.activeObj.shape&&!this.isPreventSelect&&(this.isPreventSelect=!0,o.select("custom"),this.isPreventSelect=!1,o.setProperties({zoomSettings:{zoomFactor:1}},!0),this.prevZoomValue=o.zoomSettings.zoomFactor)}},e.prototype.drawRotatedImage=function(e){var t=this.parent;0===e?t.transform.degree=0:t.transform.degree+=e,360===Math.abs(t.transform.degree)&&(t.transform.degree=0),t.notify("draw",{prop:"setDestPoints",onPropertyChange:!1});var o=sf.base.extend([],t.objColl,[],!0),i=sf.base.extend({},t.activeObj,{},!0);if(t.objColl=[],t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.isReverseRotate||t.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,isRotatePan:null}}),this.rotateDegree(e),this.isReverseRotate||(t.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,isRotatePan:null}}),t.rotateFlipColl.push(e)),t.objColl=sf.base.extend([],o,[],!0),t.activeObj=sf.base.extend({},i,{},!0),t.isCircleCrop&&t.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),t.notify("shape",{prop:"redrawObj",onPropertyChange:!1,value:{degree:e}}),t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),e>0)t.notify("freehand-draw",{prop:"rotateFhdColl",onPropertyChange:!1});else for(var a=0;a<3;a++)t.notify("freehand-draw",{prop:"rotateFhdColl",onPropertyChange:!1});t.notify("freehand-draw",{prop:"freehandRedraw",onPropertyChange:!1,value:{context:this.lowerContext,points:null}}),this.updateCurrSelectionPoint(e)},e.prototype.rotateDegree=function(e){var t=this.parent;this.lowerContext.save(),this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),this.lowerContext.translate(t.lowerCanvas.width/2,t.lowerCanvas.height/2),this.lowerContext.rotate(Math.PI/180*e),this.lowerContext.translate(-t.lowerCanvas.width/2,-t.lowerCanvas.height/2);var o=this.lowerContext.filter;this.parent.notify("filter",{prop:"updateBrightFilter",onPropertyChange:!1}),this.lowerContext.drawImage(this.parent.baseImg,this.parent.img.srcLeft,this.parent.img.srcTop,this.parent.img.srcWidth,this.parent.img.srcHeight,this.parent.img.destLeft,this.parent.img.destTop,this.parent.img.destWidth,this.parent.img.destHeight),this.lowerContext.filter=o,this.lowerContext.translate(t.lowerCanvas.width/2,t.lowerCanvas.height/2),this.lowerContext.rotate(Math.PI/180*-e),this.lowerContext.translate(-t.lowerCanvas.width/2,-t.lowerCanvas.height/2),this.lowerContext.restore()},e.prototype.updateCurrSelectionPoint=function(e){var t=this.parent;if(t.currSelectionPoint&&this.currDestPoint){var o=sf.base.extend({},t.activeObj,{},!0),i=sf.base.extend([],t.objColl,[],!0),a={startX:t.img.srcLeft,startY:t.img.srcTop,width:t.img.srcWidth,height:t.img.srcHeight},r={startX:t.img.destLeft,startY:t.img.destTop,width:t.img.destWidth,height:t.img.destHeight};t.objColl=[],t.objColl.push(sf.base.extend({},t.currSelectionPoint,{},!0)),sf.base.isNullOrUndefined(t.objColl[0].imageRatio)&&(t.activeObj=t.objColl[0],t.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),t.objColl[0]=t.activeObj),t.img.srcLeft=0,t.img.srcTop=0,t.img.srcWidth=t.baseImg.width,t.img.srcHeight=t.baseImg.height,t.img.destLeft=this.currDestPoint.startX,t.img.destTop=this.currDestPoint.startY,t.img.destWidth=this.currDestPoint.width,t.img.destHeight=this.currDestPoint.height,"number"==typeof e&&(t.notify("draw",{prop:"setDestPoints",onPropertyChange:!1}),t.notify("draw",{prop:"setClientTransDim",onPropertyChange:!1,value:{isPreventDimension:null}})),t.notify("shape",{prop:"redrawObj",onPropertyChange:!1,value:{degree:e}}),t.currSelectionPoint=sf.base.extend({},t.objColl[0],{},!0),this.currDestPoint={startX:t.img.destLeft,startY:t.img.destTop,width:t.img.destWidth,height:t.img.destHeight},t.objColl=i,t.activeObj=o,t.img.srcLeft=a.startX,t.img.srcTop=a.startY,t.img.srcWidth=a.width,t.img.srcHeight=a.height,t.img.destLeft=r.startX,t.img.destTop=r.startY,t.img.destWidth=r.width,t.img.destHeight=r.height}},e.prototype.flipImage=function(e){var t=this,o=this.parent,i={direction:e,cancel:!1,previousDirection:o.toPascalCase(o.transform.currFlipState)};!this.isPreventSelect&&sf.base.isBlazor()&&o.events&&!0===o.events.flipping.hasDelegate?o.dotNetRef.invokeMethodAsync("FlipEventAsync","OnFlip",i).then((function(o){t.flipEvent(o,e)})):(this.isPreventSelect||o.trigger("flipping",i),this.flipEvent(i,e))},e.prototype.flipEvent=function(e,t){var o=this.parent;if(!e.cancel){var i;if(sf.base.isNullOrUndefined(this.transCurrObj)){var a={currObj:{}};o.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:a}}),(i=a.currObj).objColl=sf.base.extend([],o.objColl,null,!0),i.pointColl=sf.base.extend({},o.pointColl,null,!0),i.afterCropActions=sf.base.extend([],o.afterCropActions,[],!0);var r={selPointColl:null};o.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:r}}),i.selPointColl=sf.base.extend([],r.selPointColl,[],!0)}o.afterCropActions.push("horizontal"===t.toLowerCase()?"horizontalflip":"verticalflip");var n,s=[];o.activeObj.activePoint&&(void 0!==o.activeObj.shape&&(s=o.activeObj.shape.split("-")),(o.currObjType.isCustomCrop||"crop"===s[0])&&(n=o.currObjType.isCustomCrop?"custom":s[1],o.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),o.objColl.push(o.activeObj),o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}))),o.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:!0}}),o.clearContext(this.lowerContext),o.clearContext(this.upperContext);var l=sf.base.extend([],o.objColl,[],!0),p=sf.base.extend({},o.activeObj,{},!0);o.objColl=[],o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.isReverseFlip||o.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,isRotatePan:null}});var h=t.toLowerCase();this.updateFlipState(h),o.transform.currFlipState="horizontal"===h?"horizontal"===o.transform.currFlipState.toLowerCase()?"":"horizontal":"vertical"===o.transform.currFlipState.toLowerCase()?"":"vertical";var c={isSelected:null};o.notify("draw",{prop:"getRotatedFlipCropSelection",onPropertyChange:!1,value:{bool:c}}),c.isSelected&&(o.img.destLeft+=o.panPoint.totalPannedInternalPoint.x,o.img.destTop+=o.panPoint.totalPannedInternalPoint.y);var d=this.lowerContext.filter;if(o.notify("filter",{prop:"updateBrightFilter",onPropertyChange:!1}),this.lowerContext.drawImage(o.baseImg,o.img.srcLeft,o.img.srcTop,o.img.srcWidth,o.img.srcHeight,o.img.destLeft,o.img.destTop,o.img.destWidth,o.img.destHeight),this.lowerContext.filter=d,o.notify("draw",{prop:"setImageEdited",onPropertyChange:!1}),this.updateFlipState(t.toLowerCase()),this.isReverseFlip||(o.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,isRotatePan:null}}),this.updateFlipColl(t.toLocaleLowerCase()),o.rotateFlipColl.push(t.toLowerCase())),1===o.rotateFlipColl.length){var v={panRegion:""};o.notify("crop",{prop:"getCurrFlipState",onPropertyChange:!1,value:{panObj:v}}),""===v.panRegion?o.notify("draw",{prop:"setClientTransDim",onPropertyChange:!1,value:{isPreventDimension:null}}):this.setDestPointsForFlipState()}o.isCircleCrop&&o.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),o.objColl=sf.base.extend([],l,[],!0),o.activeObj=sf.base.extend({},p,{},!0);for(var u=0,b=o.objColl.length;u<b;u++){var g=o.objColl[u].flipObjColl;0===g.length?g.push(t):g[g.length-1]===t?g.pop():g.push(t)}o.notify("shape",{prop:"redrawObj",onPropertyChange:!1,value:{degree:t.toLowerCase()}});var f=this.lowerContext.filter;this.lowerContext.filter="brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)",o.notify("shape",{prop:"iterateObjColl",onPropertyChange:!1}),"horizontal"===t.toLowerCase()||"vertical"===t.toLowerCase()?(o.notify("freehand-draw",{prop:"flipFHDColl",onPropertyChange:!1,value:{value:t.toLowerCase()}}),o.notify("freehand-draw",{prop:"freehandRedraw",onPropertyChange:!1,value:{context:this.lowerContext,points:null}})):o.notify("freehand-draw",{prop:"freehandRedraw",onPropertyChange:!1,value:{context:this.lowerContext,points:null}}),this.lowerContext.filter=f,o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.updateCurrSelectionPoint(t.toLowerCase()),o.isUndoRedo=!1,o.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),o.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),o.isCircleCrop&&o.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),n&&(this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),o.activeObj=sf.base.extend({},o.objColl[o.objColl.length-1],{},!0),o.objColl.pop(),o.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:o.activeObj}}));var C={collection:o.rotateFlipColl};o.notify("shape",{prop:"alignRotateFlipColl",onPropertyChange:!1,value:{collection:o.rotateFlipColl,isRotateFlipCollection:!0,obj:C}}),o.rotateFlipColl=C.collection,o.cropObj.activeObj.shape&&!this.isPreventSelect&&(this.isPreventSelect=!0,o.select("custom"),this.isPreventSelect=!1,o.setProperties({zoomSettings:{zoomFactor:1}},!0),this.prevZoomValue=o.zoomSettings.zoomFactor)}},e.prototype.updateFlipState=function(e){var t=this.parent.transform.degree;"horizontal"===e?t%90==0&&t%180!=0?this.verticalFlip():this.horizontalFlip():"vertical"===e&&(t%90==0&&t%180!=0?this.horizontalFlip():this.verticalFlip())},e.prototype.horizontalFlip=function(){this.lowerContext.translate(this.lowerContext.canvas.width,0),this.lowerContext.scale(-1,1),this.upperContext.translate(this.upperContext.canvas.width,0),this.upperContext.scale(-1,1)},e.prototype.verticalFlip=function(){this.lowerContext.translate(0,this.lowerContext.canvas.height),this.lowerContext.scale(1,-1),this.upperContext.translate(0,this.upperContext.canvas.height),this.upperContext.scale(1,-1)},e.prototype.updateFlipColl=function(e){if(!this.isPreventSelect&&(0===this.flipColl.length||this.flipColl[this.flipColl.length-1]!==e?this.flipColl.push(e):this.flipColl.pop(),this.flipColl.length>=4)){var t=this.flipColl.slice(-4);("horizontal"===t[0]&&"vertical"===t[1]&&"horizontal"===t[2]&&"vertical"===t[3]||"vertical"===t[0]&&"horizontal"===t[1]&&"vertical"===t[2]&&"horizontal"===t[3])&&this.flipColl.splice(-4)}},e.prototype.setDestPointsForFlipState=function(){var e=this.parent,t={panRegion:""};e.notify("crop",{prop:"getCurrFlipState",onPropertyChange:!1,value:{panObj:t}}),""!==t.panRegion&&("horizontal"===t.panRegion?e.img.destLeft=e.lowerCanvas.clientWidth-(e.img.destWidth+e.img.destLeft):("vertical"===t.panRegion||(e.img.destLeft=e.lowerCanvas.clientWidth-(e.img.destWidth+e.img.destLeft)),e.img.destTop=e.lowerCanvas.clientHeight-(e.img.destHeight+e.img.destTop)))},e.prototype.zoomAction=function(e,t){var o=this,i=this.parent;if(!i.disabled&&i.isImageLoaded){if(i.zoomSettings.zoomFactor>=i.zoomSettings.maxZoomFactor&&e>0||i.zoomSettings.zoomFactor>i.zoomSettings.minZoomFactor&&e<0&&this.disableZoomOutBtn(!0)||i.zoomSettings.zoomFactor<=i.zoomSettings.minZoomFactor&&e<0)return void(sf.base.isBlazor()||i.notify("toolbar",{prop:"zoom-up-handler",onPropertyChange:!1}));i.notify("draw",{prop:"setImageEdited",onPropertyChange:!1});var a=e;e=a>0?.1:-.1;for(var r=0;r<Math.abs(a/.1);r++)if(1===this.prevZoomValue)this.prevZoomValue+=e>0?10*e:10*e/10;else if(this.prevZoomValue>1)this.prevZoomValue+=10*e;else if(this.prevZoomValue<1){this.prevZoomValue+=10*e/10;var n=Math.pow(10,1);this.prevZoomValue=Math.round(this.prevZoomValue*n)/n}e=a,i.setProperties({zoomSettings:{zoomFactor:this.prevZoomValue}},!0);var s=void 0;this.tempActiveObj=null,this.isShape=!1,void 0!==i.activeObj.shape&&("shape"===i.activeObj.shape?i.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}):s=i.activeObj.shape.split("-")),void 0!==s&&"crop"===s[0]?(this.tempActiveObj=sf.base.extend({},i.activeObj,{},!0),i.isCropTab=!0):i.activeObj.shape&&"crop"!==s[0]&&(this.isShape=!0);var l={zoomType:null};i.notify("selection",{prop:"getZoomType",onPropertyChange:!1,value:{obj:l}}),sf.base.isNullOrUndefined(t)&&(t=i.isCropTab&&this.tempActiveObj?{x:i.activeObj.activePoint.startX+i.activeObj.activePoint.width/2,y:i.activeObj.activePoint.startY+i.activeObj.activePoint.height/2}:{x:i.lowerCanvas.clientWidth/2,y:i.lowerCanvas.clientHeight/2},"MouseWheel"!==l.zoomType&&"Pinch"!==l.zoomType||(t={x:i.zoomSettings.zoomPoint.x,y:i.zoomSettings.zoomPoint.y}));var p={zoomPoint:t,cancel:!1,previousZoomFactor:i.zoomSettings.zoomFactor-10*e,currentZoomFactor:i.zoomSettings.zoomFactor,zoomTrigger:l.zoomType};!i.isCropToolbar&&sf.base.isBlazor()&&i.events&&!0===i.events.zooming.hasDelegate?i.dotNetRef.invokeMethodAsync("ZoomEventAsync","OnZoom",p).then((function(t){o.zoomEvent(t,e)})):(i.isCropToolbar||i.trigger("zooming",p),this.zoomEvent(p,e))}},e.prototype.zoomEvent=function(e,t){var o=this.parent;if(!e.cancel){sf.base.isBlazor()?o.element.querySelector(".e-contextual-toolbar-wrapper")&&!o.element.querySelector(".e-contextual-toolbar-wrapper").classList.contains("e-hidden")&&o.updateToolbar(o.element,"closeContextualToolbar"):o.notify("toolbar",{prop:"close-contextual-toolbar",onPropertyChange:!1}),o.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:!0}}),o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,o.lowerCanvas.width,o.lowerCanvas.height);var i={canvasFilter:this.parent.canvasFilter};this.lowerContext.filter=i.canvasFilter,o.upperCanvas.style.cursor=o.cursor="default";var a=sf.base.extend([],o.objColl,[],!0);if(o.isCropTab||(0!==o.transform.degree?(o.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),o.panPoint.currentPannedPoint={x:0,y:0},this.rotatePan(!0,!0)):""!==o.transform.currFlipState&&(o.panPoint.totalPannedPoint={x:0,y:0}),o.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1})),0===o.transform.degree){this.drawZoomImgToCanvas(t,this.tempActiveObj);var r={panRegion:""};if(o.notify("crop",{prop:"getCurrFlipState",onPropertyChange:!1,value:{panObj:r}}),""!==r.panRegion){o.notify("crop",{prop:"setTempFlipPanPoint",onPropertyChange:!1,value:{point:o.panPoint.totalPannedPoint,isAdd:!0}}),a=sf.base.extend([],o.objColl,[],!0),o.objColl=[];var n=o.img.destLeft,s=o.img.destTop;this.setDestPointsForFlipState(),this.rotatedFlip(),o.img.destLeft=n,o.img.destTop=s,o.objColl=a,o.notify("shape",{prop:"zoomObjColl",onPropertyChange:!1,value:{isPreventApply:null}}),o.notify("freehand-draw",{prop:"zoomFHDColl",onPropertyChange:!1,value:{isPreventApply:null}}),o.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1})}o.zoomSettings.zoomFactor<=o.zoomSettings.minZoomFactor&&!o.isCropTab&&(o.panPoint.totalPannedPoint={x:0,y:0})}else{o.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1}),o.panPoint.totalPannedClientPoint={x:0,y:0},o.panPoint.totalPannedInternalPoint={x:0,y:0},this.rotateZoom(t);var l={panRegion:""};if(o.notify("crop",{prop:"getCurrFlipState",onPropertyChange:!1,value:{panObj:l}}),""!==l.panRegion){var p=this.lowerContext.filter;this.lowerContext.filter="none",o.notify("shape",{prop:"zoomObjColl",onPropertyChange:!1,value:{isPreventApply:null}}),o.notify("freehand-draw",{prop:"zoomFHDColl",onPropertyChange:!1,value:{isPreventApply:null}}),this.lowerContext.filter=p}}var h=Math.pow(10,1);(o.zoomSettings.zoomFactor<=o.zoomSettings.minZoomFactor||Math.round(o.transform.zoomFactor*h)/h==2)&&(clearInterval(this.zoomBtnHold),this.zoomBtnHold=0);var c,d={panRegion:""};if(o.notify("crop",{prop:"getCurrFlipState",onPropertyChange:!1,value:{panObj:d}}),""===d.panRegion){p=this.lowerContext.filter;this.lowerContext.filter="none",o.notify("shape",{prop:"zoomObjColl",onPropertyChange:!1,value:{isPreventApply:null}}),o.notify("freehand-draw",{prop:"zoomFHDColl",onPropertyChange:!1,value:{isPreventApply:null}}),this.lowerContext.filter=p}(o.currSelectionPoint&&"crop-circle"===o.currSelectionPoint.shape||o.isCircleCrop)&&o.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),o.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.tempActiveObj&&(o.activeObj=sf.base.extend({},this.tempActiveObj,{},!0),o.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:o.activeObj}}),o.zoomSettings.zoomFactor<=o.zoomSettings.minZoomFactor&&(o.currSelectionPoint=null)),o.isUndoRedo=!1,sf.base.isBlazor()?(c=o.element.querySelector("#zoomout"))&&o.zoomSettings.zoomFactor<=o.zoomSettings.minZoomFactor?c.classList.add("e-overlay"):c&&c.classList.remove("e-overlay"):(c=document.querySelector("#"+o.element.id+"_zoomOut"))&&o.zoomSettings.zoomFactor<=o.zoomSettings.minZoomFactor?(c.classList.add("e-disabled"),c.parentElement.classList.add("e-overlay")):c&&(c.classList.remove("e-disabled"),c.parentElement.classList.remove("e-overlay")),this.autoEnablePan(),this.tempActiveObj&&(o.activeObj=sf.base.extend({},this.tempActiveObj,{},!0)),"crop-custom"===o.activeObj.shape&&(o.currObjType.isCustomCrop=!0);var v=o.element.querySelector(".e-img-pan .e-btn");v&&o.togglePan?v.classList.add("e-selected-btn"):v&&v.classList.remove("e-selected-btn"),this.isShape&&(o.activeObj=sf.base.extend({},o.objColl[o.objColl.length-1],{},!0),o.objColl.pop(),o.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:o.activeObj,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:null}}),sf.base.isBlazor()||(o.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1}),o.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}}))),sf.base.isBlazor()?o.updateToolbar(o.element,"enableDisableToolbarBtn"):o.notify("toolbar",{prop:"enable-disable-btns",onPropertyChange:!1}),o.notify("selection",{prop:"setZoomType",onPropertyChange:!1,value:{zoomType:"Toolbar"}})}},e.prototype.disableZoomOutBtn=function(e){var t,o=this.parent,i=!1;sf.base.isNullOrUndefined(e)||(o.transform.zoomFactor-=.1),t=sf.base.isBlazor()?this.parent.element.querySelector("#zoomout"):document.querySelector("#"+o.element.id+"_zoomOut");var a=o.img.destLeft,r=o.img.destTop,n=o.img.destWidth,s=o.img.destHeight;return o.activeObj.shape?(this.setZoomDimension(-.1,o.activeObj),sf.base.isNullOrUndefined(t)||(o.img.destLeft>o.activeObj.activePoint.startX||o.img.destTop>o.activeObj.activePoint.startY||o.img.destLeft+o.img.destWidth<o.activeObj.activePoint.endX||o.img.destTop+o.img.destHeight<o.activeObj.activePoint.endY||o.zoomSettings.zoomFactor===o.zoomSettings.minZoomFactor?(sf.base.isBlazor()?t.classList.add("e-overlay"):(t.classList.add("e-disabled"),t.parentElement.classList.add("e-overlay")),i=!0):(sf.base.isBlazor()?t.classList.remove("e-overlay"):(t.classList.remove("e-disabled"),t.parentElement.classList.remove("e-overlay")),i=!1))):this.setZoomDimension(-.1,null),sf.base.isNullOrUndefined(e)||(o.transform.zoomFactor+=.1),o.img.destLeft=a,o.img.destTop=r,o.img.destWidth=n,o.img.destHeight=s,i},e.prototype.drawZoomImgToCanvas=function(e,t){var o=this.parent,i=Math.pow(10,1);Math.round(o.transform.zoomFactor*i)/i==.1&&-.1===e?o.transform.zoomFactor=0:o.transform.zoomFactor+=e,o.transform[o.isCropTab?"cropZoomFactor":"defaultZoomFactor"]=o.transform.zoomFactor;var a={width:0,height:0};o.isCropTab?a=this.cropZoom(e,t):((a=this.calcMaxDimension(o.img.srcWidth,o.img.srcHeight)).width+=a.width*o.transform.zoomFactor,a.height+=a.height*o.transform.zoomFactor,o.img.destLeft=(o.lowerCanvas.clientWidth-a.width)/2,o.img.destTop=(o.lowerCanvas.clientHeight-a.height)/2),o.notify("draw",{prop:"draw-image-to-canvas",value:{dimension:a}}),a.width=this.cropDimension.width,a.height=this.cropDimension.height,a.width+=a.width*o.transform.zoomFactor,a.height+=a.height*o.transform.zoomFactor,o.notify("draw",{prop:"setZoomCropWidth",value:{width:a.width,height:a.height}})},e.prototype.rotatedFlip=function(){var e=this.parent;this.isReverseFlip=!0;var t=e.transform.currFlipState,o=this.flipColl,i=sf.base.extend([],e.objColl,[],!0),a=sf.base.extend({},e.activeObj,{},!0);this.flipColl=[],e.objColl=[],e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),e.notify("draw",{prop:"currTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,context:null,isPreventCircleCrop:null}});var r=this.lowerContext.filter;e.notify("filter",{prop:"updateBrightFilter",onPropertyChange:!1}),this.lowerContext.drawImage(e.baseImg,e.img.srcLeft,e.img.srcTop,e.img.srcWidth,e.img.srcHeight,e.img.destLeft,e.img.destTop,e.img.destWidth,e.img.destHeight),this.lowerContext.filter=r,e.notify("draw",{prop:"currTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:!0,context:null,isPreventCircleCrop:null}}),""===t&&""!==e.transform.currFlipState&&(t=e.transform.currFlipState),e.transform.currFlipState=t,this.flipColl=o,e.objColl=sf.base.extend([],i,[],!0),this.lowerContext.filter="none",e.notify("shape",{prop:"iterateObjColl",onPropertyChange:!1}),this.lowerContext.filter=r,0!==a.activePoint.width&&(e.activeObj=sf.base.extend({},a,{},!0)),this.isReverseFlip=!1},e.prototype.rotateZoom=function(e){var t=this.parent,o=Math.pow(10,1);Math.round(t.transform.zoomFactor*o)/o==.1&&-.1===e?t.transform.zoomFactor=0:t.transform.zoomFactor+=e,t.isCropTab?t.transform.cropZoomFactor=t.transform.zoomFactor:t.transform.defaultZoomFactor=t.transform.zoomFactor;var i=sf.base.extend([],t.objColl,[],!0),a=sf.base.extend({},t.activeObj,{},!0);t.objColl=[],t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),t.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,isRotatePan:null}}),t.notify("draw",{prop:"setRotateZoom",onPropertyChange:!1,value:{isRotateZoom:!0}}),t.notify("draw",{prop:"setDestPoints",onPropertyChange:!1});var r=this.lowerContext.filter;t.notify("filter",{prop:"updateBrightFilter",onPropertyChange:!1}),this.lowerContext.drawImage(t.baseImg,t.img.srcLeft,t.img.srcTop,t.img.srcWidth,t.img.srcHeight,t.img.destLeft,t.img.destTop,t.img.destWidth,t.img.destHeight),this.lowerContext.filter=r,t.notify("draw",{prop:"setRotateZoom",onPropertyChange:!1,value:{isRotateZoom:!1}}),t.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,isRotatePan:null}}),t.objColl=i,t.activeObj=a;var n={width:this.cropDimension.width,height:this.cropDimension.height};n.width+=n.width*t.transform.zoomFactor,n.height+=n.height*t.transform.zoomFactor,t.notify("draw",{prop:"setZoomCropWidth",value:{width:n.width,height:n.height}})},e.prototype.autoEnablePan=function(){this.parent.transform.zoomFactor<=0?(this.parent.togglePan=!1,this.parent.notify("selection",{prop:"setDragCanvas",value:{bool:!1}}),this.parent.pan(!1),this.disablePan=!1):this.parent.pan(!this.disablePan)},e.prototype.cropZoom=function(e,t){var o=this.parent,i=o.img.destLeft,a=o.img.destTop,r={width:0,height:0};return 0===o.img.srcLeft||0===o.img.srcTop?r=sf.base.isNullOrUndefined(t)?this.setZoomDimension(e,null):this.setZoomDimension(e,t):((r=o.transform.degree%90==0&&o.transform.degree%180!=0?this.calcMaxDimension(o.img.srcHeight,o.img.srcWidth):this.calcMaxDimension(o.img.srcWidth,o.img.srcHeight)).width+=r.width*o.transform.zoomFactor,r.height+=r.height*o.transform.zoomFactor),o.img.destLeft=i-(r.width-o.img.destWidth)/2,o.img.destTop=a-(r.height-o.img.destHeight)/2,i=o.img.destLeft,a=o.img.destTop,t&&(o.img.destLeft>t.activePoint.startX&&(o.img.destLeft=t.activePoint.startX,0===o.transform.degree&&(o.panPoint.totalPannedPoint.x-=i-o.img.destLeft)),o.img.destTop>t.activePoint.startY&&(o.img.destTop=t.activePoint.startY,0===o.transform.degree&&(o.panPoint.totalPannedPoint.y-=a-o.img.destTop)),o.img.destLeft+r.width<t.activePoint.endX&&(o.img.destLeft=t.activePoint.endX-r.width,0===o.transform.degree&&(o.panPoint.totalPannedPoint.x-=i-o.img.destLeft)),o.img.destTop+r.height<t.activePoint.endY&&(o.img.destTop=t.activePoint.endY-r.height,0===o.transform.degree&&(o.panPoint.totalPannedPoint.y-=a-o.img.destTop))),r},e.prototype.setZoomDimension=function(e,t){var o=this.parent,i={width:0,height:0};if((i=o.transform.degree%90==0&&o.transform.degree%180!=0?this.calcMaxDimension(o.img.srcHeight,o.img.srcWidth):this.calcMaxDimension(o.img.srcWidth,o.img.srcHeight)).width+=i.width*o.transform.zoomFactor,i.height+=i.height*o.transform.zoomFactor,o.img.destLeft+=(o.img.destWidth-i.width)/2,o.img.destTop+=(o.img.destHeight-i.height)/2,e<0&&t){var a=t.activePoint.startX,r=t.activePoint.startY,n=t.activePoint.width,s=t.activePoint.height,l=o.img.destLeft+i.width,p=o.img.destTop+i.height;o.img.destLeft>a&&(o.img.destLeft=a),o.img.destTop>r&&(o.img.destTop=r),l<a+n&&(o.img.destLeft=a+n-i.width),p<r+s&&(o.img.destTop=r+s-i.height)}else e<0&&sf.base.isNullOrUndefined(t)&&(o.img.destLeft>0&&(o.img.destLeft=0),o.img.destTop>0&&(o.img.destTop=0),o.img.destLeft+i.width<o.lowerCanvas.width&&(o.img.destLeft=o.lowerCanvas.width-o.img.destWidth),o.img.destTop+i.height<o.lowerCanvas.height&&(o.img.destTop=o.lowerCanvas.height-o.img.destHeight));return i},e.prototype.drawPannedImage=function(e,t){var o=this,i=this.parent,a={panDown:null};i.notify("selection",{prop:"getPanDown",onPropertyChange:!1,value:{obj:a}});var r={startPoint:a.panDown,endPoint:this.panMove,cancel:!1};sf.base.isBlazor()&&sf.base.isNullOrUndefined(this.parent.eventType)&&i.events&&!0===i.events.onPanStart.hasDelegate?(this.parent.eventType="pan",this.parent.panEventArgs=r,i.dotNetRef.invokeMethodAsync("PanEventAsync","OnPanStart",r).then((function(i){o.panEvent(i,e,t)}))):(i.trigger("panning",r),this.panEvent(r,e,t))},e.prototype.panEvent=function(e,t,o){if(!e.cancel){var i=this.parent,a=!1;if(i.activeObj.shape&&"shape"===i.activeObj.shape&&i.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),sf.base.isNullOrUndefined(i.activeObj.shape)){a=!0,i.activeObj.activePoint={startX:i.img.destLeft,startY:i.img.destTop,endX:i.img.destLeft+i.img.destWidth,endY:i.img.destTop+i.img.destHeight};var r=i.activeObj.activePoint.startX,n=i.activeObj.activePoint.startY,s=i.activeObj.activePoint.endX,l=i.activeObj.activePoint.endY;r<0&&(i.activeObj.activePoint.startX=0),n<0&&(i.activeObj.activePoint.startY=0),s>i.lowerCanvas.width&&(i.activeObj.activePoint.endX=i.lowerCanvas.width),l>i.lowerCanvas.height&&(i.activeObj.activePoint.endY=i.lowerCanvas.height),i.activeObj.activePoint.width=i.activeObj.activePoint.endX-i.activeObj.activePoint.startX,i.activeObj.activePoint.height=i.activeObj.activePoint.endY-i.activeObj.activePoint.startY,i.activeObj.shape="crop-custom";var p={strokeSettings:{}};i.notify("shape",{prop:"getStrokeSettings",onPropertyChange:!1,value:{obj:p}}),i.activeObj.strokeSettings=p.strokeSettings,i.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:i.activeObj.activePoint,obj:i.activeObj,isMouseMove:null,x:null,y:null}}),i.isCropTab=!0}if(0===i.transform.degree){var h=void 0;h=sf.base.isNullOrUndefined(t)&&sf.base.isNullOrUndefined(o)?this.updatePanPoints(""):{x:t,y:o},i.panPoint.totalPannedPoint.x+=h.x,i.panPoint.totalPannedPoint.y+=h.y;var c=sf.base.extend({},i.activeObj,{},!0),d=this.lowerContext.filter;this.drawPannImage(h),this.lowerContext.filter=d,this.tempPanMove=sf.base.extend({},this.panMove,{},!0),i.activeObj=sf.base.extend({},c,{},!0),this.upperContext.clearRect(0,0,i.upperCanvas.width,i.upperCanvas.height),i.activeObj.shape&&i.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:i.activeObj}})}else{var v=i.transform.currFlipState;i.isCropTab=!0,sf.base.isNullOrUndefined(t)&&sf.base.isNullOrUndefined(o)?i.panPoint.currentPannedPoint=this.updatePanPoints(""):i.panPoint.currentPannedPoint={x:t,y:o},i.transform.currFlipState=v,this.rotatePan(),i.isCropTab=!1,this.tempPanMove=sf.base.extend({},this.panMove,{},!0)}a&&(i.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),i.isCropTab=!1,this.upperContext.clearRect(0,0,i.upperCanvas.width,i.upperCanvas.height))}},e.prototype.drawPannImage=function(e){var t=this.parent,o={startX:t.img.destLeft,startY:t.img.destTop,width:t.img.destWidth,height:t.img.destHeight};this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),t.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,isRotatePan:null}}),t.img.destLeft=o.startX,t.img.destTop=o.startY,t.img.destWidth=o.width,t.img.destHeight=o.height,this.setDestPointsForFlipState(),t.notify("filter",{prop:"updateBrightFilter",onPropertyChange:!1}),this.lowerContext.drawImage(t.baseImg,t.img.srcLeft,t.img.srcTop,t.img.srcWidth,t.img.srcHeight,t.img.destLeft,t.img.destTop,t.img.destWidth,t.img.destHeight),(t.currSelectionPoint&&"crop-circle"===t.currSelectionPoint.shape||t.isCircleCrop)&&t.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:!0}}),t.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,isRotatePan:null}}),t.img.destLeft=o.startX,t.img.destTop=o.startY,t.img.destWidth=o.width,t.img.destHeight=o.height;var i=this.lowerContext.filter;this.lowerContext.filter="none",t.notify("shape",{prop:"panObjColl",onPropertyChange:!1,value:{xDiff:e.x,yDiff:e.y,panRegion:""}}),t.notify("freehand-draw",{prop:"panFHDColl",onPropertyChange:!1,value:{xDiff:e.x,yDiff:e.y,panRegion:""}}),this.lowerContext.filter=i,t.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),t.isCircleCrop&&t.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:!0}})},e.prototype.resetZoom=function(){var e=this.parent;if(0!==e.transform.defaultZoomFactor){var t=e.isUndoRedo,o={currObj:{}};e.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:o}}),this.transCurrObj=o.currObj,this.transCurrObj.objColl=sf.base.extend([],e.objColl,null,!0),this.transCurrObj.pointColl=sf.base.extend({},e.pointColl,null,!0),this.transCurrObj.afterCropActions=sf.base.extend([],e.afterCropActions,[],!0);var i={selPointColl:null};e.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:i}}),this.transCurrObj.selPointColl=sf.base.extend([],i.selPointColl,[],!0),e.isUndoRedo=e.isCropToolbar=!0,e.transform.defaultZoomFactor>0?this.zoomAction(-e.transform.defaultZoomFactor):this.zoomAction(Math.abs(e.transform.defaultZoomFactor)),e.isCropToolbar=!1,e.isUndoRedo=t}},e.prototype.performTransformation=function(e){var t=this.parent,o=t.transform.defaultZoomFactor,i=t.isUndoRedo,a=sf.base.extend({},t.cropObj,{},!0);this.resetZoom(),this.updateTransform(e);for(var r=0,n=t.objColl.length;r<n;r++)if(t.objColl[r].flipObjColl.length>0){var s={collection:t.objColl[r].flipObjColl};t.notify("shape",{prop:"alignRotateFlipColl",onPropertyChange:!1,value:{collection:t.objColl[r].flipObjColl,isRotateFlipCollection:null,obj:s}}),t.objColl[r].flipObjColl=s.collection}if(0!==o){t.isUndoRedo=!0,this.zoomAction(o),t.isUndoRedo=i;var l="";"rotateleft"===e||"rotateright"===e?l="rotate":"horizontalflip"!==e&&"verticalflip"!==e||(l="flip"),t.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:l,previousObj:this.transCurrObj,previousObjColl:this.transCurrObj.objColl,previousPointColl:this.transCurrObj.pointColl,previousSelPointColl:this.transCurrObj.selPointColl,previousCropObj:a,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.transCurrObj=null}},e.prototype.updateTransform=function(e){switch(e.toLowerCase()){case"rotateleft":this.rotateImage(-90);break;case"rotateright":this.rotateImage(90);break;case"horizontalflip":this.flipImage(t.Horizontal);break;case"verticalflip":this.flipImage(t.Vertical)}},e.prototype.rotatePan=function(e,t){var o=this.parent;this.isReverseRotate=!0;var i,a=o.transform.degree,r={selPointColl:null};o.activeObj.activePoint&&o.activeObj.shape&&(i=sf.base.extend({},o.activeObj,{},!0));var n=sf.base.extend([],o.objColl,[],!0),s=sf.base.extend([],o.pointColl,[],!0);o.objColl=[],o.pointColl=[],o.freehandCounter=0,o.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:r}});var l=r.selPointColl;o.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),o.notify("draw",{prop:"setRotateZoom",onPropertyChange:!1,value:{isRotateZoom:!0}}),o.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,isRotatePan:null}});var p=o.img.destLeft,h=o.img.destTop;o.isCropTab&&(o.img.destLeft+=o.panPoint.totalPannedInternalPoint.x,o.img.destTop+=o.panPoint.totalPannedInternalPoint.y),o.notify("crop",{prop:"updateRotatePan",onPropertyChange:!1}),o.isCropTab&&(o.panPoint.totalPannedInternalPoint.x=o.img.destLeft-p,o.panPoint.totalPannedInternalPoint.y=o.img.destTop-h);var c=this.lowerContext.filter;o.notify("filter",{prop:"updateBrightFilter",onPropertyChange:!1}),this.lowerContext.drawImage(o.baseImg,o.img.srcLeft,o.img.srcTop,o.img.srcWidth,o.img.srcHeight,o.img.destLeft,o.img.destTop,o.img.destWidth,o.img.destHeight),o.notify("draw",{prop:"setRotateZoom",onPropertyChange:!1,value:{isRotateZoom:!1}}),o.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:!0,isRotatePan:!0}});var d=o.img.destLeft,v=o.img.destTop;o.img.destLeft+=o.panPoint.totalPannedClientPoint.x,o.img.destTop+=o.panPoint.totalPannedClientPoint.y,o.img.destLeft+=o.panPoint.currentPannedPoint.x,o.img.destTop+=o.panPoint.currentPannedPoint.y,o.panPoint.totalPannedClientPoint.x=o.img.destLeft-d,o.panPoint.totalPannedClientPoint.y=o.img.destTop-v,o.objColl=n,o.pointColl=s,o.freehandCounter=o.pointColl.length,o.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:l}}}),o.transform.degree=a,this.lowerContext.filter="none",e&&(t?(o.panPoint.totalPannedClientPoint.x=-o.panPoint.totalPannedClientPoint.x,o.panPoint.totalPannedClientPoint.y=-o.panPoint.totalPannedClientPoint.y,o.panPoint.currentPannedPoint=sf.base.extend({},o.panPoint.totalPannedClientPoint,{},!0),o.panPoint.totalPannedClientPoint={x:0,y:0},o.img.destLeft+=o.panPoint.currentPannedPoint.x,o.img.destTop+=o.panPoint.currentPannedPoint.y):o.panPoint.currentPannedPoint=sf.base.extend({},o.panPoint.totalPannedClientPoint,{},!0)),o.notify("shape",{prop:"panObjColl",onPropertyChange:!1,value:{xDiff:o.panPoint.currentPannedPoint.x,yDiff:o.panPoint.currentPannedPoint.y,panRegion:""}}),o.notify("freehand-draw",{prop:"panFHDColl",onPropertyChange:!1,value:{xDiff:o.panPoint.currentPannedPoint.x,yDiff:o.panPoint.currentPannedPoint.y,panRegion:""}}),this.lowerContext.filter=c,o.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),o.activeObj=sf.base.extend({},i,{},!0),o.activeObj.activePoint&&o.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:o.activeObj,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:null}}),this.isReverseRotate=!1},e.prototype.limitPan=function(){var e=this.parent;e.activeObj.activePoint&&(e.img.destLeft>e.activeObj.activePoint.startX&&(e.img.destLeft=e.activeObj.activePoint.startX),e.img.destTop>e.activeObj.activePoint.startY&&(e.img.destTop=e.activeObj.activePoint.startY),e.img.destLeft+e.img.destWidth<e.activeObj.activePoint.endX&&(e.img.destLeft=e.activeObj.activePoint.endX-e.img.destWidth),e.img.destTop+e.img.destHeight<e.activeObj.activePoint.endY&&(e.img.destTop=e.activeObj.activePoint.endY-e.img.destHeight))},e.prototype.updateFlipActiveObj=function(e){var t=this.parent;"horizontal"===e?(t.activeObj.activePoint.startX>t.lowerCanvas.width/2?t.activeObj.activePoint.endX=t.lowerCanvas.width/2-(t.activeObj.activePoint.startX-t.lowerCanvas.width/2):t.activeObj.activePoint.endX=t.lowerCanvas.width/2+(t.lowerCanvas.width/2-t.activeObj.activePoint.startX),t.activeObj.activePoint.startX=t.activeObj.activePoint.endX-t.activeObj.activePoint.width):"vertical"===e?(t.activeObj.activePoint.startX>t.lowerCanvas.width/2?t.activeObj.activePoint.endY=t.lowerCanvas.height/2-(t.activeObj.activePoint.startY-t.lowerCanvas.height/2):t.activeObj.activePoint.endY=t.lowerCanvas.height/2+(t.lowerCanvas.height/2-t.activeObj.activePoint.startY),t.activeObj.activePoint.startY=t.activeObj.activePoint.endY-t.activeObj.activePoint.height):"verticalHorizontal"!==e&&"horizontalVertical"!==e||(t.activeObj.activePoint.startX>t.lowerCanvas.width/2?(t.activeObj.activePoint.endX=t.lowerCanvas.width/2-(t.activeObj.activePoint.startX-t.lowerCanvas.width/2),t.activeObj.activePoint.endY=t.lowerCanvas.height/2-(t.activeObj.activePoint.startY-t.lowerCanvas.height/2)):(t.activeObj.activePoint.endX=t.lowerCanvas.width/2+(t.lowerCanvas.width/2-t.activeObj.activePoint.startX),t.activeObj.activePoint.endY=t.lowerCanvas.height/2+(t.lowerCanvas.height/2-t.activeObj.activePoint.startY)),t.activeObj.activePoint.startX=t.activeObj.activePoint.endX-t.activeObj.activePoint.width,t.activeObj.activePoint.startY=t.activeObj.activePoint.endY-t.activeObj.activePoint.height),t.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:t.activeObj.activePoint,obj:t.activeObj,isMouseMove:null,x:null,y:null}})},e.prototype.pan=function(e){var t=this.parent;!t.disabled&&t.isImageLoaded&&(e?(t.togglePan=!0,t.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),t.notify("selection",{prop:"setDragCanvas",value:{bool:!0}}),t.lowerCanvas.style.cursor=t.upperCanvas.style.cursor=t.cursor="grab",t.notify("selection",{prop:"setPanDown",onPropertyChange:!1,value:{panDown:null}})):(t.togglePan=t.currObjType.isCustomCrop=!1,t.notify("selection",{prop:"setDragCanvas",value:{bool:!1}}),t.lowerCanvas.style.cursor=t.upperCanvas.style.cursor=t.cursor="default"))},e.prototype.zoom=function(e,t){var o=this.parent;if(!o.disabled&&o.isImageLoaded){var i=this.getCurrentZoomFactor(e);if(sf.base.isNullOrUndefined(t))this.zoomAction(i,t);else for(var a=i>0?"zoomIn":"zoomOut",r=0;r<10*Math.abs(i);r++)o.notify("draw",{prop:"performPointZoom",onPropertyChange:!1,value:{x:t.x,y:t.y,type:a}})}},e.prototype.getCurrentZoomFactor=function(e){return.1*(e-this.prevZoomValue)},e.prototype.setCurrPanRegion=function(e,t,o){var i=e;""===e?"horizontal"===t?i="horizontal":"vertical"===t&&(i="vertical"):"horizontal"===e?"horizontal"===t?i="horizontalVertical":"vertical"===t?i="verticalHorizontal":90===t?i="vertical":-90===t&&(i="horizontal"):"vertical"===e?"horizontal"===t?i="horizontalVertical":"vertical"===t?i="verticalHorizontal":90===t?i="horizontal":-90===t&&(i="vertical"):"horizontal"===t?i="vertical":"vertical"===t&&(i="horizontal"),o.panRegion=i},e.prototype.rotate=function(e,t){var o=this.parent;!o.disabled&&o.isImageLoaded&&e%90==0&&this.rotateImage(e),t.isRotate=!1},e.prototype.flip=function(e){var t=this.parent;!t.disabled&&t.isImageLoaded&&this.flipImage(e)},e.prototype.update=function(){var e=this.parent,t=0,o=!1,i={bool:!1};e.isImageLoaded&&((e.element.querySelector("#"+e.element.id+"_contextualToolbar")&&!e.element.querySelector("#"+e.element.id+"_contextualToolbar").parentElement.classList.contains("e-hide")||e.element.querySelector("#"+e.element.id+"_headWrapper")&&!e.element.querySelector("#"+e.element.id+"_headWrapper").parentElement.classList.contains("e-hide"))&&(e.element.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hide"),e.okBtn(),sf.base.isBlazor()?e.updateToolbar(e.element,"imageLoaded"):(e.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1}),e.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1}))),e.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:i}}),i.bool&&(sf.base.isBlazor()?e.updateToolbar(e.element,"destroyQuickAccessToolbar"):e.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1})),void 0!==e.activeObj.shape&&(o=!0,"block"===e.textArea.style.display?(e.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),sf.base.isBlazor()?e.updateToolbar(e.element,"destroyQuickAccessToolbar"):e.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1})):(e.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),e.objColl.push(e.activeObj)),e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1})));var a=this.lowerContext.filter,r=document.querySelector("#"+e.element.id+"_canvasWrapper");if(r&&(r.style.width=e.element.offsetWidth-2+"px"),e.lowerCanvas.width=e.upperCanvas.width=e.element.offsetWidth-2,e.toolbarTemplate?t=e.element.querySelector("#"+e.element.id+"_toolbarArea").clientHeight:e.element.querySelector("#"+e.element.id+"_toolbar")&&(t=e.element.querySelector("#"+e.element.id+"_toolbar").clientHeight),e.notify("toolbar",{prop:"setToolbarHeight",value:{height:t}}),sf.base.Browser.isDevice?(r&&(r.style.height=e.element.offsetHeight-2*t-5+"px"),e.lowerCanvas.height=e.upperCanvas.height=e.element.offsetHeight-2*t-5):(r&&(r.style.height=e.element.offsetHeight-t-3+"px"),e.lowerCanvas.height=e.upperCanvas.height=e.element.offsetHeight-t-3),this.lowerContext.filter="brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)",e.notify("filter",{prop:"setAdjustmentValue",onPropertyChange:!1,value:{adjustmentValue:this.lowerContext.filter}}),e.canvasFilter=this.lowerContext.filter,this.parent.initialAdjustmentValue=this.lowerContext.filter,e.clearContext(this.lowerContext),this.parent.clearContext(this.upperContext),e.isImageLoaded){if(e.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:null}}),e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.lowerContext.filter=a,e.initialAdjustmentValue=a,e.isImageLoaded&&(sf.popups.showSpinner(e.element),e.element.style.opacity="0.5"),this.lowerContext.clearRect(0,0,e.lowerCanvas.width,e.lowerCanvas.height),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),r){r.style.width=e.element.offsetWidth-2+"px",r.style.height=e.element.offsetHeight+"px";var n={toolbarHeight:sf.base.isBlazor()?e.toolbarHeight:0};sf.base.isBlazor()||e.notify("toolbar",{prop:"getToolbarHeight",value:{obj:n}}),sf.base.Browser.isDevice?r.style.height=parseFloat(r.style.height)-2*n.toolbarHeight-3+"px":r.style.height=parseFloat(r.style.height)-n.toolbarHeight-3+"px"}var s={width:0,height:0};e.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:e.img.srcWidth,height:e.img.srcHeight,obj:s}});var l=s;if(e.transform.defaultZoomFactor>0&&(l.width+=l.width*e.transform.defaultZoomFactor,l.height+=l.height*e.transform.defaultZoomFactor),e.img.destLeft=(e.lowerCanvas.clientWidth-l.width)/2,e.img.destTop=(e.lowerCanvas.clientHeight-l.height)/2,0===e.transform.degree&&""===e.transform.currFlipState)e.transform.defaultZoomFactor>0&&(e.img.destLeft+=e.panPoint.totalPannedPoint.x,e.img.destTop+=e.panPoint.totalPannedPoint.y),e.notify("draw",{prop:"draw-image-to-canvas",value:{dimension:l}});else{e.notify("draw",{prop:"draw-image-to-canvas",value:{dimension:l}}),e.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,isRotatePan:null}});var p=this.lowerContext.filter;e.notify("filter",{prop:"updateBrightFilter",onPropertyChange:!1}),this.lowerContext.drawImage(e.baseImg,e.img.srcLeft,e.img.srcTop,e.img.srcWidth,e.img.srcHeight,e.img.destLeft,e.img.destTop,e.img.destWidth,e.img.destHeight),this.lowerContext.filter=p,e.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,isRotatePan:null}})}e.notify("shape",{prop:"zoomObjColl",onPropertyChange:!1,value:{isPreventApply:null}}),e.notify("freehand-draw",{prop:"zoomFHDColl",onPropertyChange:!1,value:{isPreventApply:null}}),e.isCircleCrop&&e.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),sf.popups.hideSpinner(e.element),e.element.style.opacity="1";var h={defToolbarItems:null};if(!sf.base.isBlazor())if(e.notify("toolbar",{prop:"getDefToolbarItems",value:{obj:h}}),h.defToolbarItems&&h.defToolbarItems.length>0&&document.getElementById(e.element.id+"_toolbar"))sf.base.getComponent(e.element.id+"_toolbar","toolbar").refreshOverflow(),e.element.querySelector(".e-contextual-toolbar-wrapper")&&e.element.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hide");if(e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),o&&(e.activeObj=sf.base.extend({},e.objColl[e.objColl.length-1],null,!0),e.objColl.pop(),e.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:e.activeObj}}),"rectangle"!==e.activeObj.shape&&"ellipse"!==e.activeObj.shape&&"text"!==e.activeObj.shape&&"line"!==e.activeObj.shape&&"arrow"!==e.activeObj.shape&&"path"!==e.activeObj.shape||(sf.base.isBlazor()?e.updateToolbar(e.element,"quickAccessToolbar",e.activeObj.shape):e.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}}))),i.bool&&(sf.base.isBlazor()?e.updateToolbar(e.element,"quickAccessToolbar","pen"):e.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:!0}})),(0!==e.transform.degree||""!==e.transform.currFlipState)&&e.transform.defaultZoomFactor>0){var c=sf.base.extend({},e.panPoint.totalPannedPoint,null,!0),d=sf.base.extend({},e.panPoint.totalPannedInternalPoint,null,!0),v=sf.base.extend({},e.panPoint.totalPannedClientPoint,null,!0);e.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:.1,zoomPoint:null}}),e.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.1,zoomPoint:null}}),0===e.transform.degree?(e.img.destLeft+=c.x,e.img.destTop+=c.y,e.panPoint.totalPannedPoint=c,e.notify("draw",{prop:"updateFlipPan",value:{tempSelectionObj:null}})):(e.panPoint.totalPannedInternalPoint=d,e.panPoint.totalPannedClientPoint=v,e.panPoint.currentPannedPoint={x:0,y:0},e.isCropTab=!0,e.notify("transform",{prop:"rotatePan",onPropertyChange:!1,value:{isCropSelection:null,isDefaultZoom:null}}),e.isCropTab=!1)}else 0!==e.transform.degree&&e.transform.cropZoomFactor>0&&(e.transform.zoomFactor=0,e.transform.cropZoomFactor=null,sf.base.isBlazor()?e.updateToolbar(e.element,"enableDisableToolbarBtn"):e.notify("toolbar",{prop:"enable-disable-btns",onPropertyChange:!1}))}},e.prototype.calcMaxDimension=function(e,t,o){var i={toolbarHeight:0};sf.base.isBlazor()?i.toolbarHeight=this.parent.toolbarHeight:this.parent.notify("toolbar",{prop:"getToolbarHeight",value:{obj:i}});var a=this.parent.element.clientWidth,r=this.parent.element.clientHeight-i.toolbarHeight;a>30&&(a-=30),(r=sf.base.Browser.isDevice?r-i.toolbarHeight:r)>30&&(r-=30);var n=a/e,s=r/t,l=Math.min(e,a),p=Math.min(t,r);n<1&&n<s?(l=e*n,p=t*n):s<1&&s<n&&(l=e*s,p=t*s);var h={bool:null};return this.parent.notify("crop",{prop:"getPreventScaling",onPropertyChange:!1,value:{obj:h}}),h.bool&&this.parent.cropObj.activeObj.activePoint&&0!==this.parent.cropObj.activeObj.activePoint.width&&0!==this.parent.cropObj.activeObj.activePoint.height&&(l=this.parent.cropObj.activeObj.activePoint.width,p=this.parent.cropObj.activeObj.activePoint.height),o&&(o.width=l,o.height=p),{width:l,height:p}},e.prototype.updatePanPoints=function(e,t){var o=this.parent,i=sf.base.extend({},o.activeObj,{},!0),a=o.img.destLeft,r=o.img.destTop;sf.base.isNullOrUndefined(this.tempPanMove)&&(this.tempPanMove={x:this.panMove.x,y:this.panMove.y});var n=this.panMove.x-this.tempPanMove.x,s=this.panMove.y-this.tempPanMove.y;switch(e){case"":o.img.destLeft+=n,o.img.destTop+=s;break;case"horizontal":this.updateFlipActiveObj(e),n=this.tempPanMove.x-this.panMove.x,o.img.destLeft+=n,o.img.destTop+=s;break;case"vertical":this.updateFlipActiveObj(e),s=this.tempPanMove.y-this.panMove.y,o.img.destLeft+=n,o.img.destTop+=s;break;case"horizontalVertical":this.updateFlipActiveObj(e),n=this.tempPanMove.x-this.panMove.x,o.img.destLeft+=n,o.img.destTop-=s;break;case"verticalHorizontal":this.updateFlipActiveObj(e),s=this.tempPanMove.y-this.panMove.y,o.img.destLeft-=n,o.img.destTop+=s}return this.limitPan(),o.activeObj=i,t&&(t.x=o.img.destLeft-a,t.y=o.img.destTop-r),{x:o.img.destLeft-a,y:o.img.destTop-r}},e}(),C=function(){function e(e){this.undoRedoStep=0,this.undoRedoColl=[],this.appliedUndoRedoColl=[],this.tempUndoRedoColl=[],this.tempUndoRedoStep=0,this.parent=e,this.addEventListener()}return e.prototype.destroy=function(){this.parent.isDestroyed||this.removeEventListener()},e.prototype.addEventListener=function(){this.parent.on("undo-redo",this.undoRedo,this),this.parent.on("destroyed",this.destroy,this)},e.prototype.removeEventListener=function(){this.parent.off("undo-redo",this.undoRedo),this.parent.off("destroyed",this.destroy)},e.prototype.initializeUrPvtProp=function(){this.parent.lowerCanvas&&(this.lowerContext=this.parent.lowerCanvas.getContext("2d")),this.parent.upperCanvas&&(this.upperContext=this.parent.upperCanvas.getContext("2d"))},e.prototype.undoRedo=function(e){switch(this.initializeUrPvtProp(),e.prop){case"updateUndoRedoColl":this.updateUrc(e.value.operation,e.value.previousObj,e.value.previousObjColl,e.value.previousPointColl,e.value.previousSelPointColl,e.value.previousCropObj,e.value.previousText,e.value.currentText,e.value.previousFilter,e.value.isCircleCrop);break;case"refreshUrc":this.refreshUrc(e.value.bool);break;case"updateCurrUrc":this.updateCurrUrc(e.value.type);break;case"call-undo":this.callUndo();break;case"call-redo":this.callRedo();break;case"undo":this.undo();break;case"redo":this.redo();break;case"updateUrObj":this.updateUrObj(e.value.objColl);break;case"updateUndoRedo":this.updateUndoRedo();break;case"getAppliedUndoRedoColl":e.value.obj.appliedUndoRedoColl=this.appliedUndoRedoColl;break;case"getUndoRedoStep":e.value.obj.undoRedoStep=this.undoRedoStep;break;case"setUndoRedoStep":this.undoRedoStep=e.value.step;break;case"undoDefault":this.undoDefault(e.value.obj);break;case"reset":this.reset()}},e.prototype.getModuleName=function(){return"undo-redo"},e.prototype.reset=function(){this.tempCurrSelPoint=null,this.undoRedoStep=0,this.undoRedoColl=[],this.appliedUndoRedoColl=[],this.tempActObj=null,this.tempUndoRedoColl=[],this.tempUndoRedoStep=0},e.prototype.refreshUrc=function(e){var t=this.parent;(e=e||!1)?(sf.base.isBlazor()||t.notify("toolbar",{prop:"setEnableDisableUndoRedo",value:{isPrevent:!0}}),this.tempUndoRedoColl=sf.base.extend([],this.appliedUndoRedoColl,[],!0),this.tempUndoRedoStep=this.undoRedoStep):sf.base.isBlazor()||t.notify("toolbar",{prop:"setEnableDisableUndoRedo",value:{isPrevent:!1}}),this.undoRedoColl=this.undoRedoColl.slice(0,this.undoRedoStep),this.appliedUndoRedoColl=this.appliedUndoRedoColl.slice(0,this.undoRedoStep),t.isUndoRedo=t.currObjType.isUndoAction=!1,sf.base.isBlazor()?t.updateToolbar(t.element,"enableDisableToolbarBtn"):t.notify("toolbar",{prop:"enable-disable-btns"})},e.prototype.updateCurrUrc=function(e){var t=this.parent;if(sf.base.isBlazor()||t.notify("toolbar",{prop:"setEnableDisableUndoRedo",value:{isPrevent:!1}}),"ok"===e){t.notify("draw",{prop:"setShapeTextInsert",onPropertyChange:!1,value:{bool:!1}});var o=this.tempUndoRedoColl.length>0?sf.base.extend([],this.tempUndoRedoColl,[],!0):sf.base.extend([],this.undoRedoColl,[],!0),i=this.undoRedoColl[this.undoRedoColl.length-1];if(sf.base.isNullOrUndefined(this.appliedUndoRedoColl[this.appliedUndoRedoColl.length-1])?this.undoRedoColl[0]&&(i.previousCropObj=o[0].previousCropObj,i.previousObj=o[0].previousObj,i.previousObjColl=o[0].previousObjColl,i.previousPointColl=o[0].previousPointColl,i.previousText=o[0].previousText):(i.previousCropObj=this.appliedUndoRedoColl[this.appliedUndoRedoColl.length-1].currentCropObj,i.previousObj=this.appliedUndoRedoColl[this.appliedUndoRedoColl.length-1].currentObj,i.previousObjColl=this.appliedUndoRedoColl[this.appliedUndoRedoColl.length-1].currentObjColl,i.previousPointColl=this.appliedUndoRedoColl[this.appliedUndoRedoColl.length-1].currentPointColl,i.previousText=this.appliedUndoRedoColl[this.appliedUndoRedoColl.length-1].currentText),i){var a=this.getZeroZoomObjPointValue(i.currentObjColl,i.currentPointColl);i.currentObjColl=a.obj,i.currentPointColl=a.point,this.appliedUndoRedoColl.push(i)}this.tempUndoRedoColl=[],this.tempUndoRedoStep=0}else this.tempUndoRedoColl.length>0&&(this.appliedUndoRedoColl=sf.base.extend([],this.tempUndoRedoColl,[],!0),this.undoRedoStep=this.tempUndoRedoStep,this.tempUndoRedoColl=[],this.tempUndoRedoStep=0);this.appliedUndoRedoColl.length>16&&this.appliedUndoRedoColl.splice(0,1),this.undoRedoColl=[],this.undoRedoColl=sf.base.extend([],this.appliedUndoRedoColl,[],!0),"ok"===e&&(this.undoRedoStep=this.undoRedoColl.length,sf.base.isBlazor()?t.updateToolbar(t.element,"enableDisableToolbarBtn"):t.notify("toolbar",{prop:"enable-disable-btns"})),t.transform.zoomFactor>0&&(t.togglePan=!0,t.notify("selection",{prop:"setDragCanvas",value:{bool:!0}}))},e.prototype.cancelCropSelection=function(){var e,t=this.parent,o=!1;t.activeObj.shape&&(e=t.activeObj.shape.split("-")),(t.currObjType.isCustomCrop||e&&"crop"===e[0])&&(o=!0),o&&t.notify("draw",{prop:"performCancel",value:{isContextualToolbar:null}}),0===this.tempUndoRedoColl.length&&0===this.tempUndoRedoStep||(this.appliedUndoRedoColl=sf.base.extend([],this.tempUndoRedoColl,[],!0),this.undoRedoColl=sf.base.extend([],this.tempUndoRedoColl,[],!0),this.undoRedoStep=this.tempUndoRedoStep,this.tempUndoRedoColl=[],this.tempUndoRedoStep=0,sf.base.isBlazor()||t.notify("toolbar",{prop:"setEnableDisableUndoRedo",value:{isPrevent:!1}}))},e.prototype.refreshToolbarActions=function(){var e=this.parent;sf.base.isBlazor()?sf.base.isNullOrUndefined(e.activeObj.shape)&&e.updateToolbar(e.element,"imageLoaded"):e.activeObj.shape?(e.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"shapes",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}),e.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1})):e.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1})},e.prototype.applyCurrentChanges=function(){var e=this.parent;e.currObjType.isFiltered=!1,0===e.transform.zoomFactor&&(e.togglePan=!1,e.notify("selection",{prop:"setDragCanvas",value:{bool:!1}})),e.element.querySelector(".e-contextual-toolbar-wrapper")&&!sf.base.isBlazor()&&e.element.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hide"),e.togglePen&&(e.togglePen=!1,e.upperCanvas.style.cursor=e.cursor="default",this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height)),this.appliedUndoRedoColl.length>0&&(this.undoRedoColl=sf.base.extend([],this.appliedUndoRedoColl,[],!0))},e.prototype.callUndo=function(){this.applyCurrentChanges(),this.undo()},e.prototype.callRedo=function(){this.applyCurrentChanges(),this.redo()},e.prototype.undo=function(){var e=this.parent;if(this.cancelCropSelection(),!e.disabled&&e.isImageLoaded&&this.undoRedoStep>0){this.refreshToolbarActions(),e.activeObj.activePoint&&0!==e.activeObj.activePoint.width&&(this.tempActObj=e.activeObj),e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.undoRedoStep--,sf.base.isBlazor()?e.updateToolbar(e.element,"enableDisableToolbarBtn"):(e.notify("toolbar",{prop:"enable-disable-btns"}),e.element.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hide")),e.isUndoRedo=!0;var t=this.undoRedoColl[this.undoRedoStep];this.undoRedoColl.length===this.undoRedoStep?e.currObjType.isUndoAction=!1:e.currObjType.isUndoAction=!0,"textAreaCustomization"!==t.operation&&"block"===e.textArea.style.display&&(e.textArea.style.display="none"),e.notify("draw",{prop:"setCancelAction",onPropertyChange:!1,value:{bool:!0}});switch(e.cropObj=sf.base.extend({},t.previousCropObj,{},!0),e.afterCropActions=t.previousObj.afterCropActions,this.lowerContext.filter=t.previousObj.filter,e.canvasFilter=this.lowerContext.filter,t.operation){case"shapeTransform":this.shapeTransform(t.previousObjColl);break;case"freehanddraw":case"freehand-draw":this.updateFreehandDraw(t.previousPointColl);break;case"freehanddrawCustomized":this.updateFreehandDrawCustomized(t.previousPointColl);break;case"deleteFreehandDrawing":case"deleteObj":this.updateDelete(t.operation,t.previousObjColl,t.previousPointColl);break;case"textAreaCustomization":this.updateTextAreaCustomization(void 0,t.previousObjColl);break;case"text":this.updateText(t.previousObjColl,!0);break;default:this.undoDefault(t),e.notify("filter",{prop:"set-adjustment",value:{operation:t.operation}}),e.notify("filter",{prop:"update-filter",value:{operation:t.operation,filter:t.filter}})}"crop"===t.operation&&(t.previousObj.currSelectionPoint&&(e.currSelectionPoint=sf.base.extend({},t.previousObj.currSelectionPoint,{},!0),e.currSelectionPoint&&sf.base.isNullOrUndefined(e.currSelectionPoint.shape)&&(e.currSelectionPoint=null)),e.updateCropTransformItems(),e.select("custom"),e.isCircleCrop&&(e.isCircleCrop=!1,this.tempCurrSelPoint=sf.base.extend({},e.currSelectionPoint,{},!0),e.currSelectionPoint=null),e.notify("draw",{prop:"performCancel",value:{isContextualToolbar:null}})),this.undoRedoColl[this.undoRedoStep-1]&&this.undoRedoColl[this.undoRedoStep-1].isCircleCrop&&(e.isCircleCrop=!0,e.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}})),this.endUndoRedo(t.operation,!0)}},e.prototype.redo=function(){var e=this.parent;if(this.cancelCropSelection(),!e.disabled&&e.isImageLoaded&&this.undoRedoStep<this.appliedUndoRedoColl.length){this.refreshToolbarActions(),this.undoRedoStep++,sf.base.isBlazor()?e.updateToolbar(e.element,"enableDisableToolbarBtn"):e.notify("toolbar",{prop:"enable-disable-btns"}),e.isUndoRedo=!0;var t=this.undoRedoColl[this.undoRedoStep-1];this.undoRedoColl.length===this.undoRedoStep?e.currObjType.isUndoAction=!1:e.currObjType.isUndoAction=!0,"textAreaCustomization"!==t.operation&&"block"===e.textArea.style.display&&(e.textArea.style.display="none"),e.notify("draw",{prop:"setCancelAction",onPropertyChange:!1,value:{bool:!0}}),e.cropObj=sf.base.extend({},t.currentCropObj,{},!0),e.afterCropActions=t.currentObj.afterCropActions,this.lowerContext.filter=t.currentObj.filter,sf.base.isBlazor()||e.element.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hide"),e.canvasFilter=this.lowerContext.filter;var o=void 0;switch(t.operation){case"shapeTransform":this.shapeTransform(t.currentObjColl);break;case"freehanddraw":case"freehand-draw":this.updateFreehandDraw(t.currentPointColl);break;case"freehanddrawCustomized":this.updateFreehandDrawCustomized(t.currentPointColl);break;case"deleteFreehandDrawing":case"deleteObj":this.updateDelete(t.operation,t.currentObjColl,t.currentPointColl);break;case"textAreaCustomization":this.updateTextAreaCustomization(o,t.currentObjColl);break;case"text":this.updateText(t.currentObjColl,!1);break;default:e.objColl=[],e.pointColl=[],e.freehandCounter=0,e.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),e.notify("draw",{prop:"setCurrentObj",onPropertyChange:!1,value:{obj:t.currentObj}}),e.img.destLeft=t.currentObj.destPoints.startX,e.img.destTop=t.currentObj.destPoints.startY,o=sf.base.extend({},e.activeObj,{},!0),e.objColl=sf.base.extend([],t.currentObjColl,[],!0),e.pointColl=sf.base.extend([],t.currentPointColl,[],!0),e.freehandCounter=e.pointColl.length,e.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:sf.base.extend([],t.currentSelPointColl,[],!0)}}}),this.lowerContext.filter="none",e.notify("shape",{prop:"zoomObjColl",onPropertyChange:!1,value:{isPreventApply:null}}),e.notify("freehand-draw",{prop:"zoomFHDColl",onPropertyChange:!1,value:{isPreventApply:null}}),this.lowerContext.filter=t.currentObj.filter,e.activeObj=o,this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),0!==e.activeObj.activePoint.width&&0!==e.activeObj.activePoint.height&&e.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),e.notify("filter",{prop:"set-adjustment",value:{operation:t.operation}}),e.notify("filter",{prop:"update-filter",value:{operation:t.operation}})}"crop"===t.operation&&t.isCircleCrop&&(e.isCircleCrop=!0,e.currSelectionPoint=sf.base.extend({},this.tempCurrSelPoint,{},!0),this.tempCurrSelPoint=null),"crop"!==t.operation||t.isCircleCrop||(e.isCircleCrop=!1),"crop"===t.operation&&t.currentObj.currSelectionPoint&&(e.currSelectionPoint=sf.base.extend({},t.currentObj.currSelectionPoint,{},!0)),e.currSelectionPoint&&sf.base.isNullOrUndefined(e.currSelectionPoint.shape)&&(e.currSelectionPoint=null),this.endUndoRedo(t.operation,!1)}},e.prototype.shapeTransform=function(e){var t=this.parent;t.objColl=sf.base.extend([],e,[],!0),t.notify("shape",{prop:"zoomObjColl",onPropertyChange:!1,value:{isPreventApply:null}}),this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.isUndoRedo=!0,t.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1}),t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1})},e.prototype.updateFreehandDraw=function(e){var t=this.parent;t.pointColl=e,t.freehandCounter=t.pointColl.length,t.notify("freehand-draw",{prop:"zoomFHDColl",onPropertyChange:!1,value:{isPreventApply:null}}),this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.isUndoRedo=!0,t.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1})},e.prototype.updateFreehandDrawCustomized=function(e){var t=this.parent;t.pointColl=e,t.notify("freehand-draw",{prop:"zoomFHDColl",onPropertyChange:!1,value:{isPreventApply:null}}),this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.isUndoRedo=!0,t.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1})},e.prototype.updateDelete=function(e,t,o){var i=this.parent;"deleteFreehandDrawing"===e?(i.pointColl=o,i.freehandCounter=i.pointColl.length,i.notify("freehand-draw",{prop:"zoomFHDColl",onPropertyChange:!1,value:{isPreventApply:null}})):"deleteObj"===e&&(i.objColl=t,i.notify("shape",{prop:"zoomObjColl",onPropertyChange:!1,value:{isPreventApply:null}})),this.lowerContext.clearRect(0,0,i.lowerCanvas.width,i.lowerCanvas.height),this.upperContext.clearRect(0,0,i.upperCanvas.width,i.upperCanvas.height),i.isUndoRedo=!0,i.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1})},e.prototype.updateTextAreaCustomization=function(e,t){var o=this.parent;o.objColl=sf.base.extend([],t,[],!0),o.notify("shape",{prop:"zoomObjColl",onPropertyChange:!1,value:{isPreventApply:!0}}),this.lowerContext.clearRect(0,0,o.lowerCanvas.width,o.lowerCanvas.height),o.isUndoRedo=!0,o.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1});for(var i=0,a=t.length;i<a;i++){if(!this.tempActObj){e=sf.base.extend({},t[t.length-1],{},!0),o.objColl.splice(i,1);break}if(this.tempActObj.currIndex===t[i].currIndex){e=sf.base.extend({},t[i],{},!0),o.objColl.splice(i,1);break}}e&&this.updateTextBox(e),"block"===o.textArea.style.display&&o.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}})},e.prototype.updateText=function(e,t){var o=this.parent;if(this.tempActObj&&(o.activeObj=sf.base.extend({},this.tempActObj,{},!0)),0===e.length&&1===o.objColl.length)this.tempActObj=sf.base.extend({},o.objColl[0],{},!0);else for(var i=0;i<o.objColl.length;i++){if(o.objColl[i]&&sf.base.isNullOrUndefined(e[i])){this.tempActObj=sf.base.extend({},o.objColl[i],{},!0);break}if(e[i].currIndex!==o.objColl[i].currIndex){this.tempActObj=sf.base.extend({},o.objColl[i],{},!0);break}}t&&(o.activeObj=sf.base.extend({},this.tempActObj,{},!0)),o.objColl=sf.base.extend([],e,[],!0),o.notify("shape",{prop:"zoomObjColl",onPropertyChange:!1,value:{isPreventApply:!0}}),this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),this.lowerContext.clearRect(0,0,o.lowerCanvas.width,o.lowerCanvas.height),o.isUndoRedo=!0,o.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1}),o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1})},e.prototype.updateTextBox=function(e){var t=this.parent;this.upperContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),t.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1}),sf.base.isBlazor()?t.updateToolbar(t.element,"destroyQuickAccessToolbar"):t.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1}),t.textArea.style.display="block",t.textArea.style.fontFamily=e.textSettings.fontFamily,t.textArea.style.fontSize=e.textSettings.fontSize+"px",t.textArea.style.color=e.strokeSettings.strokeColor,t.textArea.style.fontWeight=e.textSettings.bold?"bold":"normal",t.textArea.style.fontStyle=e.textSettings.italic?"italic":"normal",t.textArea.style.border="2px solid "+t.themeColl[t.theme].primaryColor,t.textArea.value=e.keyHistory,t.activeObj=sf.base.extend({},e,{},!0),t.notify("shape",{prop:"updateFontStyles",onPropertyChange:!1,value:{isTextBox:null}}),t.textArea.style.width=t.activeObj.activePoint.width+"px"},e.prototype.undoDefault=function(e){this.lowerContext.filter=e.previousObj.filter;var t=this.parent;t.objColl=[],t.pointColl=[],t.freehandCounter=0,t.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),t.notify("draw",{prop:"setCurrentObj",onPropertyChange:!1,value:{obj:e.previousObj}}),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),t.img.destLeft=e.previousObj.destPoints.startX,t.img.destTop=e.previousObj.destPoints.startY;var o=sf.base.extend({},t.activeObj,{},!0);t.objColl=sf.base.extend([],e.previousObjColl,[],!0),t.pointColl=sf.base.extend([],e.previousPointColl,[],!0),t.freehandCounter=t.pointColl.length,t.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:sf.base.extend([],e.previousSelPointColl,[],!0)}}}),this.lowerContext.filter="none",t.notify("shape",{prop:"zoomObjColl",onPropertyChange:!1,value:{isPreventApply:null}}),t.notify("freehand-draw",{prop:"zoomFHDColl",onPropertyChange:!1,value:{isPreventApply:null}}),this.lowerContext.filter=e.previousObj.filter,t.activeObj=o,this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),0!==t.activeObj.activePoint.width&&0!==t.activeObj.activePoint.height&&t.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}})},e.prototype.endUndoRedo=function(e,t){var o=this.parent;o.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),o.isCircleCrop&&(t&&"crop"!==e||!t)&&o.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),o.transform.zoomFactor>0&&o.notify("selection",{prop:"setDragCanvas",value:{bool:!0}}),o.notify("draw",{prop:"setCancelAction",onPropertyChange:!1,value:{bool:!1}}),sf.base.isBlazor()?(sf.base.isNullOrUndefined(o.activeObj.shape)||"crop"!==o.activeObj.shape.split("-")[0])&&(o.updateToolbar(o.element,"imageLoaded"),o.updateToolbar(o.element,"enableDisableToolbarBtn")):(o.activeObj.shape&&"crop"===o.activeObj.shape.split("-")[0]?o.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:!0,isCropping:!0,isZooming:null,cType:null}}):o.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1}),o.notify("toolbar",{prop:"enable-disable-btns"})),document.getElementById(o.element.id+"_quickAccessToolbarArea")&&(document.getElementById(o.element.id+"_quickAccessToolbarArea").style.display="none"),sf.base.isBlazor()?o.updateToolbar(o.element,"enableDisableToolbarBtn"):o.notify("toolbar",{prop:"enable-disable-btns"}),0!==o.transform.degree&&o.notify("transform",{prop:"drawPannedImage",onPropertyChange:!1,value:{xDiff:0,yDiff:0}}),o.notify("filter",{prop:"setAdjustmentValue",onPropertyChange:!1,value:{adjustmentValue:this.lowerContext.filter}}),o.currObjType.isCustomCrop=!1},e.prototype.updateUrc=function(e,t,o,i,a,r,n,s,l,p){var h=this.parent,c={isInitialLoaded:!1};if(h.currObjType.isUndoAction&&this.refreshUrc(!0),h.notify("draw",{prop:"isInitialLoaded",onPropertyChange:!1,value:{object:c}}),!c.isInitialLoaded&&h.allowUndoRedo){var d={currObj:{}};h.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:d}});var v=d.currObj;v.objColl=sf.base.extend([],h.objColl,[],!0),v.pointColl=sf.base.extend([],h.pointColl,[],!0),v.afterCropActions=sf.base.extend([],h.afterCropActions,[],!0);var u={selPointColl:null};h.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:u}}),v.selPointColl=sf.base.extend([],u.selPointColl,[],!0),"crop"===e&&(v.currSelectionPoint=sf.base.extend({},h.currSelectionPoint,{},!0)),this.undoRedoColl.push({operation:e,previousObj:t,currentObj:v,previousObjColl:o,currentObjColl:v.objColl,previousPointColl:i,currentPointColl:v.pointColl,previousSelPointColl:a,currentSelPointColl:v.selPointColl,previousCropObj:r,currentCropObj:sf.base.extend({},h.cropObj,{},!0),previousText:n,currentText:s,filter:l,isCircleCrop:p}),sf.base.isBlazor()?h.updateToolbar(h.element,"enableDisableToolbarBtn"):h.notify("toolbar",{prop:"enable-disable-btns",onPropertyChange:!1})}},e.prototype.updateUrObj=function(e){var t=this.parent;if(t.allowUndoRedo){t.currObjType.isUndoAction&&this.refreshUrc(!0),t.objColl.push(t.activeObj);var o=sf.base.extend({},t.cropObj,{},!0),i={currObj:{}};t.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:i}});var a=i.currObj;a.objColl=sf.base.extend([],t.objColl,[],!0),a.pointColl=sf.base.extend([],t.pointColl,[],!0),a.afterCropActions=sf.base.extend([],t.afterCropActions,[],!0);var r={selPointColl:null};t.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:r}}),a.selPointColl=sf.base.extend([],r.selPointColl,[],!0),this.undoRedoColl.push({operation:"shapeTransform",previousObj:a,currentObj:a,previousObjColl:e,currentObjColl:a.objColl,previousPointColl:a.pointColl,currentPointColl:a.pointColl,previousSelPointColl:a.selPointColl,currentSelPointColl:a.selPointColl,previousCropObj:o,currentCropObj:o}),t.notify("selection",{prop:"redrawShape",onPropertyChange:!1,value:{obj:t.objColl[t.objColl.length-1]}})}},e.prototype.updateUndoRedo=function(){var e=this.parent,t=sf.base.extend({},e.cropObj,{},!0),o={currObj:{}};e.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:o}});var i=o.currObj;i.objColl=sf.base.extend([],e.objColl,[],!0),i.pointColl=sf.base.extend([],e.pointColl,[],!0),i.afterCropActions=sf.base.extend([],e.afterCropActions,[],!0);var a={selPointColl:null};e.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:a}}),i.selPointColl=sf.base.extend([],a.selPointColl,[],!0),e.objColl.push(e.activeObj),this.updateUrc("shapeTransform",i,i.objColl,i.pointColl,i.selPointColl,t),e.objColl.pop(),e.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:null}}),e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),sf.base.isBlazor()?e.updateToolbar(e.element,"imageLoaded"):(e.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"shapes",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}),e.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}))},e.prototype.getZeroZoomObjPointValue=function(e,t){var o=this.parent,i={currObj:{}};o.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:i}});var a=i.currObj;a.objColl=sf.base.extend([],o.objColl,[],!0),a.pointColl=sf.base.extend([],o.pointColl,[],!0),a.afterCropActions=sf.base.extend([],o.afterCropActions,[],!0);var r={selPointColl:null};o.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:r}}),a.selPointColl=sf.base.extend([],r.selPointColl,[],!0);var n={cropDimension:null};o.notify("transform",{prop:"getCropDimension",onPropertyChange:!1,value:{obj:n}});var s=sf.base.extend([],o.objColl,[],!0),l=sf.base.extend([],o.pointColl,[],!0),p={arrowDimension:null};this.parent.notify("draw",{prop:"getArrowDimension",onPropertyChange:!1,value:{obj:p}});var h=sf.base.extend({},p.arrowDimension,{},!0);if(o.transform.zoomFactor>0&&(e.length>0||t.length>0)){o.objColl=e,o.pointColl=t;var c=o.isUndoRedo;if(0!==o.transform.zoomFactor){o.isUndoRedo=o.isCropTab=!0,o.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1});var d=sf.base.extend({},o.zoomSettings,null,!0);o.transform.zoomFactor>0?o.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-o.transform.zoomFactor,zoomPoint:null}}):o.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:Math.abs(o.transform.zoomFactor),zoomPoint:null}}),o.zoomSettings=d,o.isCropTab=!1,o.isUndoRedo=c,s=sf.base.extend([],o.objColl,[],!0),l=sf.base.extend([],o.pointColl,[],!0),o.objColl=[],o.pointColl=[],o.freehandCounter=0,o.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),o.notify("transform",{prop:"setCropDimension",onPropertyChange:!1,value:{width:n.cropDimension.width,height:n.cropDimension.height}});var v={width:n.cropDimension.width,height:n.cropDimension.height};v.width+=v.width*a.defaultZoom,v.height+=v.height*a.defaultZoom,o.notify("draw",{prop:"setZoomCropWidth",value:{width:v.width,height:v.height}}),o.notify("draw",{prop:"setCurrentObj",onPropertyChange:!1,value:{obj:a}}),o.img.destLeft=a.destPoints.startX,o.img.destTop=a.destPoints.startY,o.panPoint.totalPannedPoint=a.totalPannedPoint,o.panPoint.totalPannedClientPoint=a.totalPannedClientPoint,o.panPoint.totalPannedInternalPoint=a.totalPannedInternalPoint,o.objColl=sf.base.extend([],a.objColl,[],!0),o.pointColl=sf.base.extend([],a.pointColl,[],!0),o.freehandCounter=o.pointColl.length,o.notify("draw",{prop:"setArrowDimension",onPropertyChange:!1,value:{arrowDimension:h}}),o.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:sf.base.extend([],a.selPointColl,[],!0)}}}),this.lowerContext.filter="none",o.notify("shape",{prop:"iterateObjColl",onPropertyChange:!1}),o.notify("freehand-draw",{prop:"freehandRedraw",onPropertyChange:!1,value:{context:this.lowerContext,points:null}}),o.notify("freehand-draw",{prop:"updateFHDCurPts",onPropertyChange:!1}),this.lowerContext.filter=a.filter,0!==o.transform.degree&&o.notify("transform",{prop:"drawPannedImage",onPropertyChange:!1,value:{xDiff:0,yDiff:0}})}}return{obj:s,point:l}},e}();!function(e){e.Png="Png",e.Jpeg="Jpeg",e.Svg="Svg"}(e||(e={})),function(e){e.Horizontal="Horizontal",e.Vertical="Vertical"}(t||(t={})),function(e){e.Rectangle="Rectangle",e.Ellipse="Ellipse",e.Line="Line",e.Arrow="Arrow",e.Path="Path",e.Text="Text",e.FreehandDraw="FreehandDraw"}(i||(i={})),function(e){e[e.MouseWheel=1]="MouseWheel",e[e.Pinch=2]="Pinch",e[e.Commands=4]="Commands",e[e.Toolbar=8]="Toolbar"}(a||(a={})),function(e){e.Bootstrap5="Bootstrap5",e.Bootstrap5Dark="Bootstrap5Dark",e.Tailwind="Tailwind",e.TailwindDark="TailwindDark",e.Fluent="Fluent",e.FluentDark="FluentDark",e.Bootstrap4="Bootstrap4",e.Bootstrap="Bootstrap",e.BootstrapDark="BootstrapDark",e.Material="Material",e.MaterialDark="MaterialDark",e.Fabric="Fabric",e.FabricDark="FabricDark",e.Highcontrast="Highcontrast"}(r||(r={})),function(e){e.Crop="Crop",e.Transform="Transform",e.Annotate="Annotate",e.ZoomIn="ZoomIn",e.ZoomOut="ZoomOut",e.Open="Open",e.Reset="Reset",e.Save="Save",e.Pan="Pan",e.Move="Move",e.Pen="Pen",e.Line="Line",e.Arrow="Arrow",e.Path="Path",e.Rectangle="Rectangle",e.Ellipse="Ellipse",e.Text="Text",e.CustomSelection="CustomSelection",e.CircleSelection="CircleSelection",e.SquareSelection="SquareSelection",e.RatioSelection="RatioSelection",e.RotateLeft="RotateLeft",e.RotateRight="RotateRight",e.FlipHorizontal="FlipHorizontal",e.FlipVertical="FlipVertical"}(n||(n={})),function(e){e.Default="Default",e.Chrome="Chrome",e.Cold="Cold",e.Warm="Warm",e.Grayscale="Grayscale",e.Sepia="Sepia",e.Invert="Invert"}(s||(s={})),function(e){e.Brightness="Brightness",e.Contrast="Contrast",e.Hue="Hue",e.Saturation="Saturation",e.Exposure="Exposure",e.Opacity="Opacity",e.Blur="Blur"}(l||(l={})),function(e){e.None="None",e.Arrow="Arrow",e.SolidArrow="SolidArrow",e.Circle="Circle",e.SolidCircle="SolidCircle",e.Square="Square",e.SolidSquare="SolidSquare",e.Bar="Bar"}(p||(p={}));var m,y,P=function(){function e(e){this.defToolbarItems=[],this.toolbarHeight=46,this.currToolbar="",this.preventZoomBtn=!1,this.currentToolbar="main",this.selFhdColor="#42a5f5",this.preventEnableDisableUr=!1,this.parent=e,this.addEventListener(),this.initLocale()}return e.prototype.destroy=function(){this.parent.isDestroyed||this.removeEventListener()},e.prototype.addEventListener=function(){this.parent.on("toolbar",this.toolbar,this),this.parent.on("destroyed",this.destroy,this)},e.prototype.removeEventListener=function(){this.parent.off("toolbar",this.toolbar),this.parent.off("destroyed",this.destroy)},e.prototype.initLocale=function(){this.defaultLocale={Crop:"Crop",ZoomIn:"Zoom In",ZoomOut:"Zoom Out",Undo:"Undo",Redo:"Redo",Transform:"Transform",Annotation:"Annotation",Finetune:"Finetune",Brightness:"Brightness",Contrast:"Contrast",Hue:"Hue",Saturation:"Saturation",Opacity:"Opacity",Blur:"Blur",Sharpen:"Sharpen",Exposure:"Exposure",Filter:"Filter",Default:"Default",Chrome:"Chrome",Cold:"Cold",Warm:"Warm",Grayscale:"Grayscale",BlackAndWhite:"Black and White",Sepia:"Sepia",Invert:"Invert",Text:"Add Text",Pen:"Pen",Reset:"Reset",Save:"Save",Select:"Select",RotateLeft:"Rotate Left",RotateRight:"Rotate Right",HorizontalFlip:"Horizontal Flip",VerticalFlip:"Vertical Flip",OK:"OK",Cancel:"Cancel",FillColor:"Fill Color",StrokeColor:"Stroke Color",StrokeWidth:"Stroke Width",FontFamily:"Font Family",FontStyle:"Font Style",FontSize:"Font Size",FontColor:"Font Color",Pan:"Pan",Move:"Move",Load:"Load",Custom:"Custom",Square:"Square",Circle:"Circle",Ellipse:"Ellipse",Rectangle:"Rectangle",Line:"Line",Arrow:"Arrow",Path:"Path",Bold:"Bold",Italic:"Italic",BoldItalic:"Bold Italic",XSmall:"X-Small",Small:"Small",Medium:"Medium",Large:"Large",XLarge:"X-Large",ABC:"ABC",Browse:"Browse",Duplicate:"Duplicate",Remove:"Remove",EditText:"Edit Text",Start:"Start",End:"End",Bar:"Bar",ArrowSolid:"Arrow Solid",CircleSolid:"Circle Solid",SquareSolid:"Square Solid",None:"None",CropAndTransform:"Crop and Transform",CropSelection:"Crop Selection"},this.l10n=new sf.base.L10n("image-editor",this.defaultLocale,this.parent.locale)},e.prototype.toolbar=function(e){var t=this.parent;switch(this.updatePrivateVariables(),e.prop){case"create-toolbar":this.createToolbar();break;case"create-contextual-toolbar":this.createContextualToolbar();break;case"update-toolbar-items":this.updateToolbarItems();break;case"refresh-toolbar":this.refreshToolbar(e.value.type,e.value.isApplyBtn,e.value.isCropping,e.value.isZooming,e.value.cType);break;case"renderQAT":this.renderQAT(e.value.isPenEdit);break;case"enable-disable-btns":this.enableDisableTbrBtn();break;case"init-main-toolbar":this.initMainToolbar(e.value.isApplyBtn,e.value.isDevice,e.value.isOkBtn);break;case"create-bottom-toolbar":this.createBottomToolbar();break;case"refresh-main-toolbar":this.refreshMainToolbar();break;case"create-qa-toolbar":this.createQuickAccessToolbar();break;case"destroy-qa-toolbar":this.destroyQuickAccessToolbar();break;case"zoom-up-handler":this.zoomBtnMouseUpHandler();break;case"refresh-dropdown-btn":this.refreshDropDownBtn(e.value.isDisabled);break;case"close-contextual-toolbar":this.closeContextualToolbar();break;case"destroy-bottom-toolbar":this.destroyBottomToolbar();break;case"destroy-top-toolbar":this.destroyTopToolbar();break;case"destroySubComponents":this.destroySubComponents();break;case"setLocale":this.l10n.setLocale(e.value.locale);break;case"setPreventZoomBtn":this.preventZoomBtn=e.value.isPrevent;break;case"getToolbarHeight":e.value.obj.toolbarHeight=this.toolbarHeight;break;case"setToolbarHeight":this.toolbarHeight=e.value.height;break;case"setCurrentToolbar":this.currentToolbar=e.value.type;break;case"setSelectedFreehandColor":this.selFhdColor=e.value.color;break;case"getCurrentFilter":e.value.obj.currentFilter=t.currentFilter;break;case"setCurrentFilter":t.currentFilter=e.value.filter;break;case"setInitialAdjustmentValue":t.initialAdjustmentValue=e.value.value;break;case"getCanvasFilter":e.value.obj.canvasFilter=t.canvasFilter;break;case"setCanvasFilter":t.canvasFilter=e.value.filter;break;case"getDefToolbarItems":e.value.obj.defToolbarItems=this.defToolbarItems;break;case"getPenStroke":this.getPenStroke(e.value.value);break;case"performDefToolbarClickAction":this.performDefTbrClick(e.value.type,e.value.isContextualToolbar,e.value.isDisabledAdjustment,e.value.isDisabledFilter,e.value.isFilterFinetune);break;case"setTempFilterProperties":t.setTempFilterProperties();break;case"refreshSlider":this.refreshSlider();break;case"renderSlider":this.renderSlider(e.value.type);break;case"getCurrAdjustmentValue":t.getCurrAdjustmentValue(e.value.type);break;case"setCurrAdjustmentValue":t.setCurrAdjustmentValue(e.value.type,e.value.value);break;case"refreshShapeDrawing":this.refreshShapeDrawing();break;case"getCropToolbar":e.value.obj.isCropToolbar=t.isCropToolbar;break;case"getPrevCurrSelectionPoint":e.value.obj.prevCurrSelectionPoint=t.prevCurrSelectionPoint;break;case"setPrevCurrSelectionPoint":t.prevCurrSelectionPoint=e.value.point;break;case"updateCropTransformItems":t.updateCropTransformItems();break;case"setEnableDisableUndoRedo":this.preventEnableDisableUr=e.value.isPrevent;break;case"reset":this.reset()}},e.prototype.updatePrivateVariables=function(){var e=this.parent;this.inMemoryCanvas=e.inMemoryCanvas,e.lowerCanvas&&(this.lowerContext=e.lowerCanvas.getContext("2d")),e.upperCanvas&&(this.upperContext=e.upperCanvas.getContext("2d")),this.inMemoryCanvas&&(this.inMemoryContext=this.inMemoryCanvas.getContext("2d"))},e.prototype.reset=function(){var e=this.parent;this.defToolbarItems=[],this.toolbarHeight=46,e.prevCurrSelectionPoint=null,this.zoomBtnHold=null,this.currToolbar="",this.currentToolbar="main",this.selFhdColor="#42a5f5",e.currentFilter="",this.preventZoomBtn=e.isCropToolbar=this.preventEnableDisableUr=!1,e.initialAdjustmentValue=e.canvasFilter="brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)"},e.prototype.destroyTopToolbar=function(){var e=this.parent,t=document.getElementById(e.element.id+"_toolbar");this.isToolbar()&&t&&t.classList.contains("e-control")&&sf.base.getComponent(document.getElementById(e.element.id+"_toolbar"),"toolbar").destroy()},e.prototype.destroyBottomToolbar=function(){var e=this.parent,t=document.getElementById(e.element.id+"_bottomToolbar");t&&t.classList.contains("e-control")&&sf.base.getComponent(document.getElementById(e.element.id+"_bottomToolbar"),"toolbar").destroy()},e.prototype.isToolbar=function(){var e=this.parent;return sf.base.isNullOrUndefined(e.toolbar)||e.toolbar&&e.toolbar.length>0||!sf.base.isNullOrUndefined(e.toolbarTemplate)},e.prototype.createToolbar=function(){var e=this,t=this.parent;if(sf.base.isNullOrUndefined(t.toolbar)||t.toolbar&&t.toolbar.length>0){t.element.appendChild(t.createElement("div",{id:t.element.id+"_toolbarArea",className:"e-toolbar-area"}));var o={cssClass:"e-image-upload",align:"Left",type:"Input",tooltipText:this.l10n.getConstant("Browse"),template:new sf.inputs.Uploader({allowedExtensions:".jpg, .jpeg, .png,.svg"})};sf.base.isNullOrUndefined(this.defToolbarItems)&&(this.defToolbarItems=[]),this.defToolbarItems.push(o);var i=document.getElementById(t.element.id+"_toolbarArea"),a=t.createElement("div",{id:t.element.id+"_toolbar"});i.appendChild(a);var r=[{cssClass:"e-image-upload",align:"Left",type:"Input",tooltipText:this.l10n.getConstant("Browse"),template:new sf.inputs.Uploader({allowedExtensions:".jpg, .jpeg, .png,.svg",selected:function(){t.disabled||(sf.base.Browser.isDevice?(e.defToolbarItems.length>0&&document.getElementById(t.element.id+"_toolbar")&&sf.base.getComponent(document.getElementById(t.element.id+"_toolbar"),"toolbar").destroy(),document.getElementById(t.element.id+"_bottomToolbar")&&sf.base.getComponent(document.getElementById(t.element.id+"_bottomToolbar"),"toolbar").destroy(),e.initMainToolbar(!1,sf.base.Browser.isDevice,null),e.createBottomToolbar()):(e.defToolbarItems.length>0&&document.getElementById(t.element.id+"_toolbar")&&sf.base.getComponent(document.getElementById(t.element.id+"_toolbar"),"toolbar").destroy(),e.initMainToolbar(!1,!1,null)))}})}];new sf.navigations.Toolbar({items:r,width:"100%",created:function(){t.trigger("toolbarCreated",{toolbarType:"main"})},clicked:this.defToolbarClicked.bind(this)}).appendTo("#"+t.element.id+"_toolbar"),this.createLeftToolbarControls(),document.getElementById(t.element.id+"_toolbar")&&(this.toolbarHeight=document.getElementById(t.element.id+"_toolbar").clientHeight)}else this.toolbarHeight=0},e.prototype.createContextualToolbar=function(){var e=this.parent;if(sf.base.isNullOrUndefined(e.toolbar)||e.toolbar&&e.toolbar.length>0){e.element.appendChild(e.createElement("div",{id:e.element.id+"_contextualToolbarArea",className:"e-contextual-toolbar-wrapper e-hide",attrs:{style:"position: absolute;"}}));var t=document.getElementById(e.element.id+"_contextualToolbarArea"),o=e.createElement("div",{id:e.element.id+"_contextualToolbar"});t.appendChild(o)}},e.prototype.createBottomToolbar=function(){var e=this.parent;if(sf.base.isNullOrUndefined(e.toolbar)||e.toolbar&&e.toolbar.length>0){if(e.element.appendChild(e.createElement("div",{id:e.element.id+"_bottomToolbarArea",className:"e-bottom-toolbar"})),!e.toolbarTemplate){document.getElementById(e.element.id+"_canvasWrapper").style.height=e.element.offsetHeight-2*this.toolbarHeight-3+"px";var t=document.getElementById(e.element.id+"_bottomToolbarArea"),o=e.createElement("div",{id:e.element.id+"_bottomToolbar"});t.appendChild(o)}this.initBottomToolbar()}},e.prototype.createQuickAccessToolbar=function(){var e=this.parent;if(e.showQuickAccessToolbar){var t={cssClass:"e-image-upload",align:"Left",type:"Input",tooltipText:this.l10n.getConstant("Browse"),template:new sf.inputs.Uploader({allowedExtensions:".jpg, .jpeg, .png,.svg"})};sf.base.isNullOrUndefined(this.defToolbarItems)&&(this.defToolbarItems=[]),this.defToolbarItems.push(t);var o=document.getElementById(e.element.id+"_quickAccessToolbarArea"),i=e.createElement("div",{id:e.element.id+"_quickAccessToolbar"});o.appendChild(i),new sf.navigations.Toolbar({clicked:this.defToolbarClicked.bind(this)}).appendTo("#"+e.element.id+"_quickAccessToolbar")}},e.prototype.initMainToolbar=function(e,t,o){var i=this,a=this.parent;if(this.isToolbar()){var r=this.getLeftToolbarItem(o),n=this.getRightToolbarItem(o),s=this.getMainToolbarItem(e),l=this.getZoomToolbarItem();if(this.defToolbarItems=t?r.concat(n):r.concat(s,n,l),new sf.navigations.Toolbar({width:"100%",items:this.defToolbarItems,clicked:this.defToolbarClicked.bind(this),created:function(){t||i.renderAnnotationBtn(),i.wireZoomBtnEvents(),i.renderSaveBtn(),a.trigger("toolbarCreated",{toolbarType:"main"})}}).appendTo("#"+a.element.id+"_toolbar"),this.createLeftToolbarControls(),this.enableDisableTbrBtn(),this.isToolbar()&&document.getElementById(a.element.id+"_toolbar"))sf.base.getComponent(a.element.id+"_toolbar","toolbar").refreshOverflow()}},e.prototype.initBottomToolbar=function(){var e=this,t=this.parent;if(sf.base.isNullOrUndefined(t.toolbar)||t.toolbar&&t.toolbar.length>0){var o=this.getMainToolbarItem();if(new sf.navigations.Toolbar({items:o,width:"100%",created:function(){e.renderAnnotationBtn(),e.renderCropBtn(),e.renderTransformBtn(),t.trigger("toolbarCreated",{toolbarType:"main"})},clicked:this.defToolbarClicked.bind(this)}).appendTo("#"+t.element.id+"_bottomToolbar"),this.defToolbarItems.length>0&&document.getElementById(t.element.id+"_bottomToolbar"))sf.base.getComponent(t.element.id+"_bottomToolbar","toolbar").refreshOverflow()}},e.prototype.getLeftToolbarItem=function(e){var t=this.parent,o=[];e||(o.push({id:t.element.id+"_upload",cssClass:"e-image-upload",align:"Left",type:"Input",template:new sf.inputs.Uploader({allowedExtensions:".jpg, .jpeg, .png,.svg"})}),o.push({visible:!1,cssClass:"e-image-position e-btn e-flat",tooltipText:this.l10n.getConstant("Browse"),align:"Left"})),t.allowUndoRedo&&((sf.base.isNullOrUndefined(t.toolbar)||t.toolbar&&t.toolbar.indexOf("Undo")>-1)&&o.push({id:t.element.id+"_undo",prefixIcon:"e-icons e-undo",cssClass:"top-icon e-undo",tooltipText:this.l10n.getConstant("Undo"),align:"Left"}),(sf.base.isNullOrUndefined(t.toolbar)||t.toolbar&&t.toolbar.indexOf("Redo")>-1)&&o.push({id:t.element.id+"_redo",prefixIcon:"e-icons e-redo",cssClass:"top-icon e-redo",tooltipText:this.l10n.getConstant("Redo"),align:"Left"})),this.preventZoomBtn||(t.zoomSettings.zoomTrigger&a.Toolbar)!==a.Toolbar||((sf.base.isNullOrUndefined(t.toolbar)||t.toolbar&&t.toolbar.indexOf("ZoomOut")>-1)&&o.push({id:t.element.id+"_zoomOut",prefixIcon:"e-icons e-zoom-out",cssClass:"top-icon e-dec-zoom",tooltipText:this.l10n.getConstant("ZoomOut"),align:"Left"}),(sf.base.isNullOrUndefined(t.toolbar)||t.toolbar&&t.toolbar.indexOf("ZoomIn")>-1)&&o.push({id:t.element.id+"_zoomIn",prefixIcon:"e-icons e-zoom-in",cssClass:"top-icon e-inc-zoom",tooltipText:this.l10n.getConstant("ZoomIn"),align:"Left"}));for(var i=this.processToolbar("left"),r=0,n=i.length;r<n;r++)o.push(i[r]);return o},e.prototype.getRightToolbarItem=function(e){var t=this.parent,o=[];e&&(o.push({id:t.element.id+"_ok",prefixIcon:"e-icons e-check",cssClass:"top-icon e-tick",tooltipText:this.l10n.getConstant("OK"),align:"Right"}),o.push({id:t.element.id+"_cancel",prefixIcon:"e-icons e-close",cssClass:"top-icon e-save",tooltipText:this.l10n.getConstant("Cancel"),align:"Right"})),(sf.base.isNullOrUndefined(t.toolbar)||t.toolbar&&t.toolbar.indexOf("Reset")>-1)&&o.push({id:t.element.id+"_reset",prefixIcon:"e-icons e-btn-reset",cssClass:"top-icon e-img-reset",tooltipText:this.l10n.getConstant("Reset"),align:"Right"}),e||(sf.base.isNullOrUndefined(t.toolbar)||t.toolbar&&t.toolbar.indexOf("Save")>-1)&&o.push({id:t.element.id+"_save",prefixIcon:"e-icons e-btn-save",cssClass:"top-icon e-save",tooltipText:this.l10n.getConstant("Save"),align:"Right",template:'<button id="'+t.element.id+'_saveBtn"></button>'});for(var i=this.processToolbar("right"),a=0,r=i.length;a<r;a++)o.push(i[a]);return o},e.prototype.getMainToolbarItem=function(e){var t=this.parent,o=[];(sf.base.isNullOrUndefined(t.toolbar)||t.toolbar&&t.toolbar.indexOf("Crop")>-1)&&o.push({id:t.element.id+"_cropTransform",prefixIcon:"e-icons e-crop",cssClass:"top-icon e-crop",tooltipText:this.l10n.getConstant("CropAndTransform"),align:"Center"}),(sf.base.isNullOrUndefined(t.toolbar)||t.toolbar&&t.toolbar.indexOf("Annotate")>-1)&&o.push({id:t.element.id+"_annotation",tooltipText:this.l10n.getConstant("Annotation"),align:"Center",template:'<button id="'+t.element.id+'_annotationBtn"></button>'}),(sf.base.isNullOrUndefined(t.toolbar)||t.toolbar&&t.toolbar.indexOf("Finetune")>-1)&&o.push({id:t.element.id+"_adjustment",prefixIcon:"e-icons e-adjustment",cssClass:"top-icon e-adjustment",tooltipText:this.l10n.getConstant("Finetune"),align:"Center"}),(sf.base.isNullOrUndefined(t.toolbar)||t.toolbar&&t.toolbar.indexOf("Filter")>-1)&&o.push({id:t.element.id+"_filter",prefixIcon:"e-icons e-filters",cssClass:"top-icon e-filters",tooltipText:this.l10n.getConstant("Filter"),align:"Center"});for(var i=this.processToolbar("center"),a=0,r=i.length;a<r;a++)o.push(i[a]);return e&&(o.push({id:t.element.id+"_ok",prefixIcon:"e-icons e-check",cssClass:"top-icon e-tick",tooltipText:this.l10n.getConstant("OK"),align:"Right"}),o.push({id:t.element.id+"_cancel",prefixIcon:"e-icons e-close",cssClass:"top-icon e-save",tooltipText:this.l10n.getConstant("Cancel"),align:"Right"})),o},e.prototype.getZoomToolbarItem=function(){return[]},e.prototype.updateContextualToolbar=function(e,t){var o=this.parent,i=o.element.querySelector("#"+o.element.id+"_toolbarArea"),a=o.element.querySelector("#"+o.element.id+"_contextualToolbarArea");if(a.classList.remove("e-hide"),a.style.left=i.offsetLeft+"px","filter"===e?(document.getElementById(o.element.id+"_toolbar")&&this.defToolbarItems.length>0&&sf.base.getComponent(document.getElementById(o.element.id+"_toolbar"),"toolbar").destroy(),sf.base.Browser.isDevice?this.initMainToolbar(!1,!0,!0):this.initMainToolbar(!0,null,null),this.refreshSlider(),this.initFilterToolbarItem()):(document.querySelector("#"+o.element.id+"_contextualToolbar").classList.contains("e-control")&&sf.base.getComponent(document.getElementById(o.element.id+"_contextualToolbar"),"toolbar").destroy(),this.refreshSlider(),this.renderSlider(t)),sf.base.Browser.isDevice){var r=a.offsetHeight,n=o.element.querySelector("#"+o.element.id+"_canvasWrapper").offsetHeight;a.style.top=this.toolbarHeight+n-r+"px"}else a.style.top=this.toolbarHeight+"px"},e.prototype.processToolbar=function(e){var t=this.parent,i=[];if(t.toolbar)for(var a=0,r=t.toolbar.length;a<r;a++)"object"===o(t.toolbar[a])&&(sf.base.isNullOrUndefined(t.toolbar[a].align)?"left"===e&&i.push(t.toolbar[a]):t.toolbar[a].align.toLowerCase()===e&&i.push(t.toolbar[a]));return i},e.prototype.processSubToolbar=function(e){var t=[];if(e)for(var i=0,a=e.length;i<a;i++)"object"===o(e[i])&&(e[i].align="Center",t.push(e[i]));return t},e.prototype.wireZoomBtnEvents=function(){var e=document.querySelector("#"+this.parent.element.id+"_zoomIn"),t=document.querySelector("#"+this.parent.element.id+"_zoomOut");e&&(e.addEventListener("mousedown",this.zoomInBtnMouseDownHandler.bind(this)),e.addEventListener("mouseup",this.zoomBtnMouseUpHandler.bind(this)),e.addEventListener("click",this.zoomInBtnClickHandler.bind(this)),e.addEventListener("touchstart",this.zoomInBtnClickHandler.bind(this))),t&&(t.addEventListener("mousedown",this.zoomOutBtnMouseDownHandler.bind(this)),t.addEventListener("mouseup",this.zoomBtnMouseUpHandler.bind(this)),t.addEventListener("click",this.zoomOutBtnClickHandler.bind(this)),e.addEventListener("touchstart",this.zoomInBtnClickHandler.bind(this)))},e.prototype.enableDisableTbrBtn=function(){var e=this.parent;if(!this.preventEnableDisableUr){var t={appliedUndoRedoColl:[]};e.notify("undo-redo",{prop:"getAppliedUndoRedoColl",value:{obj:t}});var o={undoRedoStep:null};e.notify("undo-redo",{prop:"getUndoRedoStep",value:{obj:o}});var i=document.querySelector("#"+e.element.id+"_undo");i&&0===o.undoRedoStep?(i.classList.add("e-disabled"),i.parentElement.classList.add("e-overlay")):i&&o.undoRedoStep>0&&(i.classList.remove("e-disabled"),i.parentElement.classList.remove("e-overlay"));var a=document.querySelector("#"+e.element.id+"_redo");a&&o.undoRedoStep===t.appliedUndoRedoColl.length?(a.classList.add("e-disabled"),a.parentElement.classList.add("e-overlay")):(a&&0===o.undoRedoStep&&t.appliedUndoRedoColl.length>0||a&&o.undoRedoStep>0)&&(a.classList.remove("e-disabled"),a.parentElement.classList.remove("e-overlay"))}var r=document.querySelector("#"+e.element.id+"_zoomIn");r&&e.zoomSettings.zoomFactor>=e.zoomSettings.maxZoomFactor?(r.classList.add("e-disabled"),r.parentElement.classList.add("e-overlay")):r&&(r.classList.remove("e-disabled"),r.parentElement.classList.remove("e-overlay"));var n=document.querySelector("#"+e.element.id+"_zoomOut");n&&e.zoomSettings.zoomFactor<=e.zoomSettings.minZoomFactor?(n.classList.add("e-disabled"),n.parentElement.classList.add("e-overlay")):n&&(n.classList.remove("e-disabled"),n.parentElement.classList.remove("e-overlay"));var s=document.querySelector("#"+e.element.id+"_pan");s&&e.zoomSettings.zoomFactor<=e.zoomSettings.minZoomFactor?s.style.display="none":s&&(s.style.display="block")},e.prototype.createLeftToolbarControls=function(){var e=this.parent;if(void 0!==this.defToolbarItems&&this.defToolbarItems.length>0&&document.getElementById(e.element.id+"_toolbar")){var t=document.getElementById(e.element.id+"_toolbar").querySelector(".e-image-upload");if(t){var o=t.getElementsByTagName("input")[0],i=t.getElementsByTagName("button")[0];i.className="e-tbar-btn e-tbtn-txt top-icon",i.innerHTML="",i.appendChild(e.createElement("span",{className:"e-btn-icon e-icons e-upload-icon e-icon-left"})),o.onchange=this.fileSelect.bind(this,o)}}},e.prototype.fileSelect=function(e,t){this.parent.notify("draw",{prop:"fileSelect",value:{inputElement:e,args:t}})},e.prototype.renderAnnotationBtn=function(e){var t=this,o=this.parent,i=[];(sf.base.isNullOrUndefined(o.toolbar)||o.toolbar&&o.toolbar.indexOf("Pen")>-1)&&i.push({text:this.l10n.getConstant("Pen"),id:"pen",iconCss:"e-icons e-free-pen"}),(sf.base.isNullOrUndefined(o.toolbar)||o.toolbar&&o.toolbar.indexOf("Line")>-1)&&i.push({text:this.l10n.getConstant("Line"),id:"line",iconCss:"e-icons e-line"}),(sf.base.isNullOrUndefined(o.toolbar)||o.toolbar&&o.toolbar.indexOf("Rectangle")>-1)&&i.push({text:this.l10n.getConstant("Rectangle"),id:"rectangle",iconCss:"e-icons e-rectangle"}),(sf.base.isNullOrUndefined(o.toolbar)||o.toolbar&&o.toolbar.indexOf("Ellipse")>-1)&&i.push({text:this.l10n.getConstant("Ellipse"),id:"ellipse",iconCss:"e-icons e-circle"}),(sf.base.isNullOrUndefined(o.toolbar)||o.toolbar&&o.toolbar.indexOf("Arrow")>-1)&&i.push({text:this.l10n.getConstant("Arrow"),id:"arrow",iconCss:"e-icons e-arrow-right-up"}),(sf.base.isNullOrUndefined(o.toolbar)||o.toolbar&&o.toolbar.indexOf("Path")>-1)&&i.push({text:this.l10n.getConstant("Path"),id:"path",iconCss:"e-icons e-critical-path"}),(sf.base.isNullOrUndefined(o.toolbar)||o.toolbar&&o.toolbar.indexOf("Text")>-1)&&i.push({text:this.l10n.getConstant("Text"),id:"text",iconCss:"e-icons e-add-text"});var a={freehandDrawSelectedId:null};o.notify("freehand-draw",{prop:"getFreehandDrawSelectedId",onPropertyChange:!1,value:{obj:a}});var r=document.querySelector("#"+o.element.id+"_duplicate"),n=document.querySelector("#"+o.element.id+"_remove"),s=document.querySelector("#"+o.element.id+"_editText");0===o.activeObj.activePoint.width&&0===o.activeObj.activePoint.height&&(sf.base.isNullOrUndefined(o.activeObj.pointColl)||o.activeObj.pointColl&&0===o.activeObj.pointColl.length)&&sf.base.isNullOrUndefined(a.freehandDrawSelectedId)?(r&&r.classList.add("e-disabled"),n&&n.classList.add("e-disabled"),s&&s.classList.add("e-disabled")):(r&&r.classList.remove("e-disabled"),n&&n.classList.remove("e-disabled"),s&&s.classList.remove("e-disabled"));var l=e?this.getCurrentShapeIcon(o.activeObj.shape):"e-annotation",p=new sf.splitbuttons.DropDownButton({items:i,iconCss:"e-icons "+l,cssClass:"e-image-popup",open:function(e){sf.base.Browser.isDevice&&(e.element.parentElement.style.top=p.element.getBoundingClientRect().top-e.element.parentElement.offsetHeight+"px"),o.activeObj.shape?document.getElementById(o.activeObj.shape).classList.add("e-selected"):o.togglePen&&document.getElementById("pen").classList.add("e-selected")},select:function(e){o.okBtn();var i,a=!1;void 0!==o.activeObj.shape&&(i=o.activeObj.shape.split("-")),(void 0===i&&o.currObjType.isCustomCrop||void 0!==i&&"crop"===i[0])&&(a=!0),o.currObjType.isCustomCrop=!1,(a||o.togglePan)&&(o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),t.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),t.refreshToolbar("main"));var r={currentFreehandDrawIndex:null};switch(o.notify("freehand-draw",{prop:"getCurrentFreehandDrawIndex",value:{obj:r}}),p.iconCss="e-icons "+t.getCurrentShapeIcon(e.item.id),e.item.id){case"pen":o.notify("draw",{prop:"setTempFreehandCounter",value:{tempFreehandCounter:o.freehandCounter}}),o.notify("draw",{prop:"setTempCurrentFreehandDrawIndex",value:{tempCurrentFreehandDrawIndex:r.currentFreehandDrawIndex}}),t.currentToolbar="pen",o.freeHandDraw(!0);break;case"text":t.currentToolbar="text",o.notify("shape",{prop:"draw-shape-text"});break;default:t.currentToolbar="shapes",t.setInitialShapeSettings(e),o.notify("selection",{prop:"annotate",value:{shape:e.item.id}}),o.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"shapes",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}})}t.updateToolbarItems()}});p.appendTo("#"+o.element.id+"_annotationBtn")},e.prototype.renderCropBtn=function(){var e,t,o=this,i=this.parent,a=[];(sf.base.isNullOrUndefined(i.toolbar)||i.toolbar&&i.toolbar.indexOf("CustomSelection")>-1)&&a.push({text:this.l10n.getConstant("Custom"),id:"custom",iconCss:"e-icons e-custom"}),(sf.base.isNullOrUndefined(i.toolbar)||i.toolbar&&i.toolbar.indexOf("CircleSelection")>-1)&&a.push({text:this.l10n.getConstant("Circle"),id:"circle",iconCss:"e-icons e-circle"}),(sf.base.isNullOrUndefined(i.toolbar)||i.toolbar&&i.toolbar.indexOf("SquareSelection")>-1)&&a.push({text:this.l10n.getConstant("Square"),id:"square",iconCss:"e-icons e-square"}),(sf.base.isNullOrUndefined(i.toolbar)||i.toolbar&&i.toolbar.indexOf("RatioSelection")>-1)&&(a.push({text:"3:2",id:"3:2",iconCss:"e-icons e-custom-a"}),a.push({text:"4:3",id:"4:3",iconCss:"e-icons e-custom-b"}),a.push({text:"5:4",id:"5:4",iconCss:"e-icons e-custom-c"}),a.push({text:"7:5",id:"7:5",iconCss:"e-icons e-custom-d"}),a.push({text:"16:9",id:"16:9",iconCss:"e-icons e-custom-e"})),i.activeObj.shape?(e=this.getCurrentShapeIcon(i.activeObj.shape),t=i.activeObj.shape):i.currSelectionPoint?(e=this.getCurrentShapeIcon(i.currSelectionPoint.shape),t=i.currSelectionPoint.shape):(e="e-custom",t="custom");var r=new sf.splitbuttons.DropDownButton({open:function(e){i.togglePan&&o.cancelPan(),sf.base.Browser.isDevice&&(e.element.parentElement.style.top=r.element.getBoundingClientRect().top-e.element.parentElement.offsetHeight+"px"),i.activeObj.shape&&i.activeObj.shape.split("-").length>1&&document.getElementById(i.activeObj.shape.split("-")[1]).classList.add("e-selected"),i.notify("transform",{prop:"disableZoomOutBtn",value:{isZoomOut:!0}})},items:a,select:function(e){o.cropSelect(e),r.iconCss="e-icons "+o.getCurrentShapeIcon("crop-"+e.item.id),r.content=i.toPascalCase(e.item.id)},iconCss:"e-icons "+e,cssClass:"e-image-popup",content:i.toPascalCase(t.replace("crop-",""))});r.appendTo("#"+i.element.id+"_cropBtn")},e.prototype.renderTransformBtn=function(){var e=this.parent,t=[];(sf.base.isNullOrUndefined(e.toolbar)||e.toolbar&&e.toolbar.indexOf("RotateLeft")>-1)&&t.push({text:this.l10n.getConstant("RotateLeft"),id:"rotateleft",iconCss:"e-icons e-anti-clock-wise"}),(sf.base.isNullOrUndefined(e.toolbar)||e.toolbar&&e.toolbar.indexOf("RotateRight")>-1)&&t.push({text:this.l10n.getConstant("RotateRight"),id:"rotateright",iconCss:"e-icons e-clock-wise"}),(sf.base.isNullOrUndefined(e.toolbar)||e.toolbar&&e.toolbar.indexOf("FlipHorizontal")>-1)&&t.push({text:this.l10n.getConstant("HorizontalFlip"),id:"horizontalflip",iconCss:"e-icons e-horizontal-flip"}),(sf.base.isNullOrUndefined(e.toolbar)||e.toolbar&&e.toolbar.indexOf("FlipVertical")>-1)&&t.push({text:this.l10n.getConstant("VerticalFlip"),id:"verticalflip",iconCss:"e-icons e-vertical-flip"});var o=new sf.splitbuttons.DropDownButton({open:function(e){if(sf.base.Browser.isDevice){var t=e.element.parentElement.offsetHeight;e.element.parentElement.style.display="none",e.element.parentElement.style.top=o.element.getBoundingClientRect().top-t+"px",e.element.parentElement.style.display="block"}},items:t,select:e.transformSelect.bind(this),iconCss:"e-icons e-transform",cssClass:"e-image-popup"});o.appendTo("#"+e.element.id+"_transformBtn")},e.prototype.renderSaveBtn=function(){var e=this.parent;document.getElementById(e.element.id+"_saveBtn")&&new sf.splitbuttons.DropDownButton({items:[{text:"JPEG",id:"jpeg"},{text:"PNG",id:"png"},{text:"SVG",id:"svg"}],cssClass:"e-caret-hide e-image-popup",iconCss:"e-icons e-save",select:function(t){e.export(t.item.text)}}).appendTo("#"+e.element.id+"_saveBtn")},e.prototype.getCropTransformToolbarItem=function(){var e=this.parent,t=[];return t.push({id:e.element.id+"_crop",tooltipText:this.l10n.getConstant("CropSelection"),align:"Center",template:'<button id="'+e.element.id+'_cropBtn"></button>'}),t.push({align:"Center",type:"Separator"}),t.push({id:e.element.id+"_rotateLeft",prefixIcon:"e-icons e-anti-clock-wise",tooltipText:this.l10n.getConstant("RotateLeft"),align:"Center"}),t.push({id:e.element.id+"_rotateRight",prefixIcon:"e-icons e-clock-wise",tooltipText:this.l10n.getConstant("RotateRight"),align:"Center"}),t.push({align:"Center",type:"Separator"}),t.push({id:e.element.id+"_horizontalFlip",prefixIcon:"e-icons e-horizontal-flip",tooltipText:this.l10n.getConstant("HorizontalFlip"),align:"Center"}),t.push({id:e.element.id+"_verticalFlip",prefixIcon:"e-icons e-vertical-flip",tooltipText:this.l10n.getConstant("VerticalFlip"),align:"Center"}),sf.base.Browser.isDevice||(t.push({id:e.element.id+"_ok",prefixIcon:"e-icons e-check",cssClass:"top-icon e-tick",tooltipText:this.l10n.getConstant("OK"),align:"Right"}),t.push({id:e.element.id+"_cancel",prefixIcon:"e-icons e-close",cssClass:"top-icon e-save",tooltipText:this.l10n.getConstant("Cancel"),align:"Right"})),t},e.prototype.getShapesToolbarItem=function(e){var t=this.parent,o=[];(sf.base.isNullOrUndefined(t.toolbar)||t.toolbar)&&o.push({id:t.element.id+"_annotation",tooltipText:this.l10n.getConstant("Annotation"),align:"Center",template:'<button id="'+t.element.id+'_annotationBtn"></button>'}),e.indexOf("fillColor")>-1&&o.push({prefixIcon:"e-icons e-copy",id:t.element.id+"_fillcolor",cssClass:"top-icon e-fill",tooltipText:this.l10n.getConstant("FillColor"),align:"Center",type:"Input",template:'<button id="'+t.element.id+'_fillColorBtn"></button>'}),e.indexOf("strokeColor")>-1&&o.push({prefixIcon:"e-icons e-copy",id:t.element.id+"_strokecolor",cssClass:"top-icon e-stroke",tooltipText:this.l10n.getConstant("StrokeColor"),align:"Center",type:"Input",template:'<button id="'+t.element.id+'_borderColorBtn"></button>'}),e.indexOf("strokeWidth")>-1&&o.push({id:t.element.id+"_strokeWidth",cssClass:"top-icon e-size",tooltipText:"Stroke Width",align:"Center",type:"Input",template:'<button id="'+t.element.id+'_borderWidthBtn"></button>'}),e.indexOf("start")>-1&&o.push({id:t.element.id+"_start",cssClass:"top-icon e-size",tooltipText:"Start",align:"Center",type:"Input",template:'<button id="'+t.element.id+'_startBtn"></button>'}),e.indexOf("end")>-1&&o.push({id:t.element.id+"_end",cssClass:"top-icon e-size",tooltipText:"End",align:"Center",type:"Input",template:'<button id="'+t.element.id+'_endBtn"></button>'}),o.push({align:"Center",type:"Separator"}),e.indexOf("duplicate")>-1&&o.push({id:t.element.id+"_duplicate",prefixIcon:"e-icons e-order",cssClass:"top-icon e-order",tooltipText:this.l10n.getConstant("Duplicate"),align:"Center"}),e.indexOf("remove")>-1&&o.push({id:t.element.id+"_remove",prefixIcon:"e-icons e-trash",cssClass:"top-icon e-trash",tooltipText:this.l10n.getConstant("Remove"),align:"Center"}),e.indexOf("text")>-1&&o.push({id:t.element.id+"_editText",prefixIcon:"e-icons e-annotation-edit",cssClass:"top-icon e-annotation-edit",tooltipText:this.l10n.getConstant("EditText"),align:"Center"});for(var i=this.processSubToolbar(e),a=0,r=i.length;a<r;a++)o.push(i[a]);if(!sf.base.Browser.isDevice){var n={shape:null};t.notify("selection",{prop:"getCurrentDrawingShape",value:{obj:n}}),"path"!==n.shape&&(o.push({id:t.element.id+"_ok",prefixIcon:"e-icons e-check",cssClass:"top-icon e-tick",tooltipText:this.l10n.getConstant("OK"),align:"Right"}),o.push({id:t.element.id+"_cancel",prefixIcon:"e-icons e-close",cssClass:"top-icon e-save",tooltipText:this.l10n.getConstant("Cancel"),align:"Right"}))}return o},e.prototype.initCropTransformToolbar=function(){var e=this,t=this.parent,o=this.getLeftToolbarItem(),i=this.getRightToolbarItem(),a=this.getCropTransformToolbarItem(),r=this.getZoomToolbarItem();sf.base.Browser.isDevice?this.defToolbarItems=a:this.defToolbarItems=o.concat(r,a,i);var n=new sf.navigations.Toolbar({width:"100%",items:this.defToolbarItems,clicked:this.defToolbarClicked.bind(this),created:function(){e.renderCropBtn(),e.wireZoomBtnEvents(),sf.base.Browser.isDevice||e.renderSaveBtn(),t.trigger("toolbarCreated",{toolbarType:"shapes"}),sf.base.Browser.isDevice?e.defToolbarItems.length>0&&document.getElementById(t.element.id+"_bottomToolbar")&&(n.refreshOverflow(),n.refreshOverflow(),n.refreshOverflow()):(e.createLeftToolbarControls(),e.defToolbarItems.length>0&&document.getElementById(t.element.id+"_toolbar")&&n.refreshOverflow()),t.select("custom")}});sf.base.Browser.isDevice?n.appendTo("#"+t.element.id+"_bottomToolbar"):n.appendTo("#"+t.element.id+"_toolbar"),this.enableDisableTbrBtn(),t.notify("transform",{prop:"disableZoomOutBtn",value:{isZoomOut:!0}})},e.prototype.getCurrentShapeIcon=function(e){var t="";switch(e){case"rectangle":t="e-rectangle";break;case"ellipse":t="e-circle";break;case"line":t="e-line";break;case"arrow":t="e-arrow-right-up";break;case"path":t="e-critical-path";break;case"text":t="e-add-text";break;case"pen":t="e-free-pen";break;case"crop-custom":t="e-custom";break;case"crop-circle":t="e-circle";break;case"crop-square":t="e-square";break;case"crop-3:2":t="e-custom-a";break;case"crop-4:3":t="e-custom-b";break;case"crop-5:4":t="e-custom-c";break;case"crop-7:5":t="e-custom-d";break;case"crop-16:9":t="e-custom-e";break;default:t="e-free-pen"}return t},e.prototype.initShapesToolbarItem=function(e){var t=this,o=this.parent,i=this.getLeftToolbarItem(),a=this.getRightToolbarItem(),r=this.getShapesToolbarItem(e),n=this.getZoomToolbarItem();sf.base.Browser.isDevice?this.defToolbarItems=r:this.defToolbarItems=i.concat(n,r,a);var s=new sf.navigations.Toolbar({width:"100%",items:this.defToolbarItems,clicked:this.defToolbarClicked.bind(this),created:function(){t.renderAnnotationBtn(!0),t.createShapeColor(e),t.createShapeBtn(e),"arrow"===o.activeObj.shape&&(t.createStartBtn(),t.createEndBtn()),t.wireZoomBtnEvents(),sf.base.Browser.isDevice||t.renderSaveBtn(),o.trigger("toolbarCreated",{toolbarType:"shapes"}),sf.base.Browser.isDevice?t.defToolbarItems.length>0&&document.getElementById(o.element.id+"_bottomToolbar")&&(s.refreshOverflow(),s.refreshOverflow(),s.refreshOverflow()):(t.createLeftToolbarControls(),t.defToolbarItems.length>0&&document.getElementById(o.element.id+"_toolbar")&&s.refreshOverflow())}});sf.base.Browser.isDevice?s.appendTo("#"+o.element.id+"_bottomToolbar"):s.appendTo("#"+o.element.id+"_toolbar"),this.enableDisableTbrBtn()},e.prototype.createShapeColor=function(e){var t=this.parent;if(e.indexOf("fillColor")>-1){t.element.querySelector(".e-template.e-fill").appendChild(t.createElement("input",{id:t.element.id+"_shape_fill"}));var o=new sf.inputs.ColorPicker({modeSwitcher:!1,noColor:!0,value:"",showButtons:!1,mode:"Palette",cssClass:"e-shape-fill-color",change:function(e){t.updateFillColor(e.currentValue.hex),""===e.currentValue.rgba?i.element.children[0].classList.add("e-nocolor-item"):(i.element.children[0].classList.remove("e-nocolor-item"),i.element.children[0].style.backgroundColor=e.currentValue.rgba),i.toggle()}},"#"+t.element.id+"_shape_fill"),i=new sf.splitbuttons.DropDownButton({open:function(e){sf.base.Browser.isDevice&&(e.element.parentElement.style.top=i.element.getBoundingClientRect().top-e.element.parentElement.offsetHeight+"px",e.element.parentElement.style.left=t.element.offsetLeft+"px")},target:".e-shape-fill-color",iconCss:"e-dropdownbtn-preview"},"#"+t.element.id+"_fillColorBtn");o.inline=!0,t.element.querySelector(".e-fill.e-template .e-dropdownbtn-preview").classList.add("e-nocolor-item")}if(e.indexOf("strokeColor")>-1){t.element.querySelector(".e-template.e-stroke").appendChild(t.createElement("input",{id:t.element.id+"_shape_stroke"}));var a=new sf.inputs.ColorPicker({modeSwitcher:!1,noColor:!1,value:"#fff",showButtons:!1,mode:"Palette",cssClass:"e-shape-stroke-color",change:function(e){t.updateStrokeColor(e.currentValue.hex),r.element.children[0].style.backgroundColor=e.currentValue.rgba,r.toggle()}},"#"+t.element.id+"_shape_stroke"),r=new sf.splitbuttons.DropDownButton({open:function(e){sf.base.Browser.isDevice&&(e.element.parentElement.style.top=r.element.getBoundingClientRect().top-e.element.parentElement.offsetHeight+"px",e.element.parentElement.style.left=t.element.offsetLeft+"px")},target:".e-shape-stroke-color",iconCss:"e-dropdownbtn-preview"},"#"+t.element.id+"_borderColorBtn");a.inline=!0,t.element.querySelector(".e-stroke.e-template .e-dropdownbtn-preview").style.background="#fff"}},e.prototype.createShapeBtn=function(e){var t=this.parent,o=[{id:"1",text:this.l10n.getConstant("XSmall")},{id:"2",text:this.l10n.getConstant("Small")},{id:"3",text:this.l10n.getConstant("Medium")},{id:"4",text:this.l10n.getConstant("Large")},{id:"5",text:this.l10n.getConstant("XLarge")}];if(e.indexOf("strokeWidth")>-1){var i=document.getElementById(t.element.id+"_borderWidthBtn"),a=document.createElement("span");a.innerHTML=this.l10n.getConstant("XSmall"),a.className="e-shape-stroke-width",i.appendChild(a);var r=new sf.splitbuttons.DropDownButton({items:o,open:function(e){sf.base.Browser.isDevice&&(e.element.parentElement.style.top=r.element.getBoundingClientRect().top-e.element.parentElement.offsetHeight+"px");var t=a.innerHTML;""!==t&&e.element.querySelector('[aria-label = "'+t+'"]').classList.add("e-selected-btn")},select:function(e){(a.textContent=e.item.text,t.updateStrokeWidth(e.item.id),sf.base.Browser.isDevice)?document.getElementById(t.element.id+"_bottomToolbar")&&sf.base.getComponent(t.element.id+"_bottomToolbar","toolbar").refreshOverflow():document.getElementById(t.element.id+"_toolbar")&&sf.base.getComponent(t.element.id+"_toolbar","toolbar").refreshOverflow()}});r.appendTo("#"+t.element.id+"_borderWidthBtn")}},e.prototype.createStartBtn=function(){var e=this.parent,t=[{id:"1",text:this.l10n.getConstant("None")},{id:"2",text:this.l10n.getConstant("Bar")},{id:"3",text:this.l10n.getConstant("Arrow")},{id:"4",text:this.l10n.getConstant("ArrowSolid")},{id:"5",text:this.l10n.getConstant("Circle")},{id:"6",text:this.l10n.getConstant("CircleSolid")},{id:"7",text:this.l10n.getConstant("Square")},{id:"8",text:this.l10n.getConstant("SquareSolid")}],o=document.getElementById(e.element.id+"_startBtn"),i=document.createElement("span");sf.base.isNullOrUndefined(e.activeObj.start)&&(e.activeObj.start="none"),i.innerHTML=e.pascalToSplitWords(e.activeObj.start),i.className="e-shape-start",o.appendChild(i);var a=new sf.splitbuttons.DropDownButton({items:t,open:function(e){sf.base.Browser.isDevice&&(e.element.parentElement.style.top=a.element.getBoundingClientRect().top-e.element.parentElement.offsetHeight+"px");var t=i.innerHTML;""!==t&&e.element.querySelector('[aria-label = "'+t+'"]').classList.add("e-selected-btn")},select:function(t){i.textContent=t.item.text,e.updateArrow("startArrow",t.item.id)}});a.appendTo("#"+e.element.id+"_startBtn")},e.prototype.createEndBtn=function(){var e=this.parent,t=[{id:"1",text:this.l10n.getConstant("None")},{id:"2",text:this.l10n.getConstant("Bar")},{id:"3",text:this.l10n.getConstant("Arrow")},{id:"4",text:this.l10n.getConstant("ArrowSolid")},{id:"5",text:this.l10n.getConstant("Circle")},{id:"6",text:this.l10n.getConstant("CircleSolid")},{id:"7",text:this.l10n.getConstant("Square")},{id:"8",text:this.l10n.getConstant("SquareSolid")}],o=document.getElementById(e.element.id+"_endBtn"),i=document.createElement("span");sf.base.isNullOrUndefined(e.activeObj.end)&&(e.activeObj.end="arrowSolid"),i.innerHTML=e.pascalToSplitWords(e.activeObj.end),i.className="e-shape-end",o.appendChild(i);var a=new sf.splitbuttons.DropDownButton({items:t,open:function(e){sf.base.Browser.isDevice&&(e.element.parentElement.style.top=a.element.getBoundingClientRect().top-e.element.parentElement.offsetHeight+"px");var t=i.innerHTML;""!==t&&e.element.querySelector('[aria-label = "'+t+'"]').classList.add("e-selected-btn")},select:function(t){i.textContent=t.item.text,e.updateArrow("endArrow",t.item.id)}});a.appendTo("#"+e.element.id+"_endBtn")},e.prototype.getTextToolbarItem=function(e){var t=this.parent,o=[];(sf.base.isNullOrUndefined(t.toolbar)||t.toolbar)&&o.push({id:t.element.id+"_annotation",tooltipText:this.l10n.getConstant("Annotation"),align:"Center",template:'<button id="'+t.element.id+'_annotationBtn"></button>'}),e.indexOf("fontFamily")>-1&&o.push({id:t.element.id+"_fontFamily",cssClass:"top-icon e-img-font-family",tooltipText:this.l10n.getConstant("FontFamily"),align:"Center",template:'<button id="'+t.element.id+'_fontFamilyBtn"></button>'}),e.indexOf("fontSize")>-1&&o.push({id:t.element.id+"_fontSize",cssClass:"top-icon e-img-font-size",tooltipText:this.l10n.getConstant("FontSize"),align:"Center",template:'<button id="'+t.element.id+'_fontSizeBtn"></button>'}),e.indexOf("fontColor")>-1&&o.push({cssClass:"top-icon e-text-font-color",id:t.element.id+"_text_strokecolor",tooltipText:this.l10n.getConstant("FontColor"),align:"Center",type:"Input",template:'<button id="'+t.element.id+'_fontColorBtn"></button>'}),e.indexOf("bold")>-1&&o.push({id:t.element.id+"_bold",prefixIcon:"e-icons e-bold",cssClass:"top-icon e-bold",tooltipText:this.l10n.getConstant("Bold"),align:"Center"}),e.indexOf("italic")>-1&&o.push({id:t.element.id+"_italic",prefixIcon:"e-icons e-italic",cssClass:"top-icon e-italic",tooltipText:this.l10n.getConstant("Italic"),align:"Center"}),o.push({align:"Center",type:"Separator"}),e.indexOf("duplicate")>-1&&o.push({id:t.element.id+"_duplicate",prefixIcon:"e-icons e-order",cssClass:"top-icon e-order",tooltipText:this.l10n.getConstant("Duplicate"),align:"Center"}),e.indexOf("remove")>-1&&o.push({id:t.element.id+"_remove",prefixIcon:"e-icons e-trash",cssClass:"top-icon e-trash",tooltipText:this.l10n.getConstant("Remove"),align:"Center"}),e.indexOf("text")>-1&&o.push({id:t.element.id+"_editText",prefixIcon:"e-icons e-annotation-edit",cssClass:"top-icon e-annotation-edit",tooltipText:this.l10n.getConstant("EditText"),align:"Center"});for(var i=this.processSubToolbar(e),a=0,r=i.length;a<r;a++)o.push(i[a]);return sf.base.Browser.isDevice||(o.push({id:t.element.id+"_ok",prefixIcon:"e-icons e-check",cssClass:"top-icon e-tick",tooltipText:this.l10n.getConstant("OK"),align:"Right"}),o.push({id:t.element.id+"_cancel",prefixIcon:"e-icons e-close",cssClass:"top-icon e-save",tooltipText:this.l10n.getConstant("Cancel"),align:"Right"})),o},e.prototype.getFontFamilyItems=function(){return sf.base.Browser.isDevice?[{id:"arial",text:"ABC"},{id:"calibri",text:"ABC"},{id:"georgia",text:"ABC"},{id:"roboto",text:"ABC"},{id:"tahoma",text:"ABC"}]:[{id:"arial",text:"Arial"},{id:"calibri",text:"Calibri"},{id:"georgia",text:"Georgia"},{id:"roboto",text:"Roboto"},{id:"tahoma",text:"Tahoma"}]},e.prototype.initTextToolbarItem=function(e){var t=this,o=this.parent,i=this.getLeftToolbarItem(),a=this.getRightToolbarItem(),r=this.getTextToolbarItem(e),n=this.getZoomToolbarItem();sf.base.Browser.isDevice?this.defToolbarItems=r:this.defToolbarItems=i.concat(n,r,a);var s=new sf.navigations.Toolbar({width:"100%",items:this.defToolbarItems,clicked:this.defToolbarClicked.bind(this),created:function(){t.renderAnnotationBtn(!0),t.createTextColor(e),t.createTextBtn(e),t.wireZoomBtnEvents(),sf.base.Browser.isDevice||t.renderSaveBtn(),o.trigger("toolbarCreated",{toolbarType:"text"}),sf.base.Browser.isDevice?t.defToolbarItems.length>0&&document.getElementById(o.element.id+"_bottomToolbar")&&(s.refreshOverflow(),s.refreshOverflow(),s.refreshOverflow()):(t.createLeftToolbarControls(),t.defToolbarItems.length>0&&document.getElementById(o.element.id+"_toolbar")&&s.refreshOverflow())}});sf.base.Browser.isDevice?s.appendTo("#"+o.element.id+"_bottomToolbar"):s.appendTo("#"+o.element.id+"_toolbar"),this.enableDisableTbrBtn()},e.prototype.createTextColor=function(e){var t=this.parent;if(e.indexOf("fontColor")>-1&&t.element.querySelector(".e-template.e-text-font-color")){t.element.querySelector(".e-template.e-text-font-color").appendChild(t.createElement("input",{id:t.element.id+"_text_font"}));var o=new sf.inputs.ColorPicker({modeSwitcher:!1,value:"#fff",showButtons:!1,mode:"Palette",cssClass:"e-text-fontt-color",change:function(e){t.updateFontColor(e.currentValue.hex),i.element.children[0].style.backgroundColor=e.currentValue.rgba,i.toggle()}},"#"+t.element.id+"_text_font"),i=new sf.splitbuttons.DropDownButton({open:function(e){sf.base.Browser.isDevice&&(e.element.parentElement.style.top=i.element.getBoundingClientRect().top-e.element.parentElement.offsetHeight+"px",e.element.parentElement.style.left=t.element.offsetLeft+"px")},target:".e-text-fontt-color",iconCss:"e-dropdownbtn-preview"},"#"+t.element.id+"_fontColorBtn");o.inline=!0,t.element.querySelector(".e-text-font-color.e-template .e-dropdownbtn-preview").style.background="#fff"}},e.prototype.createTextBtn=function(e){var t=this.parent;if(e.indexOf("fontFamily")>-1){var o=document.getElementById(t.element.id+"_fontFamilyBtn"),i=document.createElement("span");sf.base.Browser.isDevice?(i.innerHTML="ABC",i.setAttribute("style","font-family: arial")):i.innerHTML="Arial",i.className="e-text-font-family",o&&o.appendChild(i);var a=new sf.splitbuttons.DropDownButton({items:this.getFontFamilyItems(),cssClass:"e-font-family",createPopupOnClick:!0,beforeItemRender:function(e){e.element.setAttribute("style","font-family:"+e.element.id)},open:function(e){var o;sf.base.Browser.isDevice&&(e.element.parentElement.style.top=a.element.getBoundingClientRect().top-e.element.parentElement.offsetHeight+"px"),o="block"===t.textArea.style.display?t.textArea.style.fontFamily:t.activeObj.textSettings.fontFamily,e.element.querySelector('[id *= "'+o.toLowerCase()+'"]').classList.add("e-selected-btn")},select:function(e){i.textContent=e.item.text,sf.base.Browser.isDevice&&i.setAttribute("style","font-family:"+e.item.id),t.updateFontFamily(e.item.id)}});a.appendTo("#"+t.element.id+"_fontFamilyBtn")}if(e.indexOf("fontSize")>-1){var r=document.getElementById(t.element.id+"_fontSizeBtn"),n=document.createElement("span"),s=t.getFontSizes();n.innerHTML=s[0].text,n.className="e-text-font-size",r.appendChild(n);var l=new sf.splitbuttons.DropDownButton({cssClass:"e-font-size",items:s,open:function(e){sf.base.Browser.isDevice&&(e.element.parentElement.style.top=l.element.getBoundingClientRect().top-e.element.parentElement.offsetHeight+"px");var t=n.innerHTML;e.element.querySelector('[aria-label *= "'+t+'"]').classList.add("e-selected-btn")},select:function(e){n.textContent=e.item.text,t.updateFontSize(e.item.text)}});l.appendTo("#"+t.element.id+"_fontSizeBtn")}},e.prototype.refreshToolbar=function(e,t,o,i,a){var r=this.parent;if(r.isImageLoaded&&!r.isCropToolbar){var n={toolbarType:e};switch("filter"!==e&&"color"!==e&&(document.getElementById(r.element.id+"_toolbar")&&this.defToolbarItems.length>0&&(sf.base.getComponent(document.getElementById(r.element.id+"_toolbar"),"toolbar").destroy(),document.getElementById(r.element.id+"_toolbar").innerHTML=""),document.getElementById(r.element.id+"_bottomToolbar")&&this.defToolbarItems.length>0&&document.getElementById(r.element.id+"_bottomToolbar").className.indexOf("e-control")>-1&&(sf.base.getComponent(document.getElementById(r.element.id+"_bottomToolbar"),"toolbar").destroy(),document.getElementById(r.element.id+"_bottomToolbar").innerHTML="")),this.refreshSlider(),r.isCropTab=!1,e){case"main":sf.base.Browser.isDevice?o?this.initMainToolbar(!1,!0,!0):this.initMainToolbar(!1,!0,null):sf.base.Browser.isDevice&&!i||this.initMainToolbar(t,sf.base.Browser.isDevice,null),sf.base.Browser.isDevice&&this.initBottomToolbar();break;case"shapes":sf.base.Browser.isDevice&&this.initMainToolbar(!1,!0,!0),"line"===r.activeObj.shape||"path"===r.activeObj.shape?n.toolbarItems=["strokeColor","strokeWidth","duplicate","remove"]:"arrow"===r.activeObj.shape?n.toolbarItems=["strokeColor","strokeWidth","start","end","duplicate","remove"]:n.toolbarItems=["fillColor","strokeColor","strokeWidth","duplicate","remove"],r.trigger("toolbarUpdating",n),this.initShapesToolbarItem(n.toolbarItems);break;case"text":sf.base.Browser.isDevice&&this.initMainToolbar(!1,!0,!0),n.toolbarItems=["fontFamily","fontSize","fontColor","bold","italic","duplicate","remove","text"],r.trigger("toolbarUpdating",n),this.initTextToolbarItem(n.toolbarItems);break;case"pen":sf.base.Browser.isDevice&&this.initMainToolbar(!1,!0,!0),n.toolbarItems=["strokeColor","strokeWidth","remove"],r.trigger("toolbarUpdating",n),this.initPenToolbarItem(n.toolbarItems);break;case"adjustment":sf.base.Browser.isDevice&&this.initMainToolbar(!1,!0,!0),this.initAdjustmentToolbarItem();break;case"filter":this.updateContextualToolbar(e);break;case"color":this.updateContextualToolbar(e,a);break;case"croptransform":r.isCropTab=!0,sf.base.Browser.isDevice&&this.initMainToolbar(!1,!0,!0),r.updateCropTransformItems(),this.initCropTransformToolbar()}this.currToolbar=e,this.refreshDropDownBtn(o)}},e.prototype.getAdjustmentToolbarItem=function(){var e=[],t=this.parent;(sf.base.isNullOrUndefined(t.toolbar)||t.toolbar&&t.toolbar.indexOf("Brightness")>-1)&&e.push({id:t.element.id+"_brightness",prefixIcon:"e-icons e-brightness",cssClass:"top-icon e-brightness",tooltipText:this.l10n.getConstant("Brightness"),align:"Center"}),(sf.base.isNullOrUndefined(t.toolbar)||t.toolbar&&t.toolbar.indexOf("Contrast")>-1)&&e.push({id:t.element.id+"_contrast",prefixIcon:"e-icons e-contrast",cssClass:"top-icon e-contrast",tooltipText:this.l10n.getConstant("Contrast"),align:"Center"}),(sf.base.isNullOrUndefined(t.toolbar)||t.toolbar&&t.toolbar.indexOf("Hue")>-1)&&e.push({id:t.element.id+"_hue",prefixIcon:"e-icons e-fade",cssClass:"top-icon e-fade",tooltipText:this.l10n.getConstant("Hue"),align:"Center"}),(sf.base.isNullOrUndefined(t.toolbar)||t.toolbar&&t.toolbar.indexOf("Saturation")>-1)&&e.push({id:t.element.id+"_saturation",prefixIcon:"e-icons e-saturation",cssClass:"top-icon e-saturation",tooltipText:this.l10n.getConstant("Saturation"),align:"Center"}),(sf.base.isNullOrUndefined(t.toolbar)||t.toolbar&&t.toolbar.indexOf("Exposure")>-1)&&e.push({id:t.element.id+"_exposure",prefixIcon:"e-icons e-grain",cssClass:"top-icon e-grain",tooltipText:this.l10n.getConstant("Exposure"),align:"Center"}),(sf.base.isNullOrUndefined(t.toolbar)||t.toolbar&&t.toolbar.indexOf("Opacity")>-1)&&e.push({id:t.element.id+"_opacity",prefixIcon:"e-icons e-opacity",cssClass:"top-icon e-opacity",tooltipText:this.l10n.getConstant("Opacity"),align:"Center"}),(sf.base.isNullOrUndefined(t.toolbar)||t.toolbar&&t.toolbar.indexOf("Blur")>-1)&&e.push({id:t.element.id+"_blur",prefixIcon:"e-icons e-tint",cssClass:"top-icon e-tint",tooltipText:this.l10n.getConstant("Blur"),align:"Center"});for(var o=this.processToolbar("center"),i=0,a=o.length;i<a;i++)e.push(o[i]);return sf.base.Browser.isDevice||(e.push({id:t.element.id+"_ok",prefixIcon:"e-icons e-check",cssClass:"top-icon e-tick",tooltipText:this.l10n.getConstant("OK"),align:"Right"}),e.push({id:t.element.id+"_cancel",prefixIcon:"e-icons e-close",cssClass:"top-icon e-save",tooltipText:this.l10n.getConstant("Cancel"),align:"Right"})),e},e.prototype.getFilterToolbarItem=function(){var e=[],t=this.parent;(sf.base.isNullOrUndefined(t.toolbar)||t.toolbar&&t.toolbar.indexOf("Default")>-1)&&e.push({id:t.element.id+"_default",prefixIcon:"e-icons e-none",cssClass:"top-icon e-none",tooltipText:this.l10n.getConstant("Default"),align:"Center",template:'<div class="filter-wrapper" style="box-sizing: content-box;"><canvas id='+t.element.id+'_defaultCanvas></canvas><div style="text-align:center;"><span>'+this.l10n.getConstant("Default")+"</span></div></div>"}),(sf.base.isNullOrUndefined(t.toolbar)||t.toolbar&&t.toolbar.indexOf("Chrome")>-1)&&e.push({id:t.element.id+"_chrome",prefixIcon:"e-icons e-none",cssClass:"top-icon e-none",tooltipText:this.l10n.getConstant("Chrome"),align:"Center",template:'<div class="filter-wrapper" style="box-sizing: content-box;"><canvas id='+t.element.id+'_chromeCanvas></canvas><div style="text-align:center;"><span>'+this.l10n.getConstant("Chrome")+"</span></div></div>"}),(sf.base.isNullOrUndefined(t.toolbar)||t.toolbar&&t.toolbar.indexOf("Cold")>-1)&&e.push({id:t.element.id+"_cold",prefixIcon:"e-icons e-none",cssClass:"top-icon e-none",tooltipText:this.l10n.getConstant("Cold"),align:"Center",template:'<div class="filter-wrapper" style="box-sizing: content-box;"><canvas id='+t.element.id+'_coldCanvas></canvas><div style="text-align:center;"><span>'+this.l10n.getConstant("Cold")+"</span></div></div>"}),(sf.base.isNullOrUndefined(t.toolbar)||t.toolbar&&t.toolbar.indexOf("Warm")>-1)&&e.push({id:t.element.id+"_warm",prefixIcon:"e-icons e-none",cssClass:"top-icon e-none",tooltipText:this.l10n.getConstant("Warm"),align:"Center",template:'<div class="filter-wrapper" style="box-sizing: content-box;"><canvas id='+t.element.id+'_warmCanvas></canvas><div style="text-align:center;"><span>'+this.l10n.getConstant("Warm")+"</span></div></div>"}),(sf.base.isNullOrUndefined(t.toolbar)||t.toolbar&&t.toolbar.indexOf("Grayscale")>-1)&&e.push({id:t.element.id+"_grayscale",prefixIcon:"e-icons e-none",cssClass:"top-icon e-none",tooltipText:this.l10n.getConstant("Grayscale"),align:"Center",template:'<div class="filter-wrapper" style="box-sizing: content-box;"><canvas id='+t.element.id+'_grayscaleCanvas></canvas><div style="text-align:center;"><span>'+this.l10n.getConstant("Grayscale")+"</span></div></div>"}),(sf.base.isNullOrUndefined(t.toolbar)||t.toolbar&&t.toolbar.indexOf("Sepia")>-1)&&e.push({id:t.element.id+"_sepia",prefixIcon:"e-icons e-none",cssClass:"top-icon e-none",tooltipText:this.l10n.getConstant("Sepia"),align:"Center",template:'<div class="filter-wrapper" style="box-sizing: content-box;"><canvas id='+t.element.id+'_sepiaCanvas></canvas><div style="text-align:center;"><span>'+this.l10n.getConstant("Sepia")+"</span></div></div>"}),(sf.base.isNullOrUndefined(t.toolbar)||t.toolbar&&t.toolbar.indexOf("Invert")>-1)&&e.push({id:t.element.id+"_invert",prefixIcon:"e-icons e-none",cssClass:"top-icon e-none",tooltipText:this.l10n.getConstant("Invert"),align:"Center",template:'<div class="filter-wrapper" style="box-sizing: content-box;"><canvas id='+t.element.id+'_invertCanvas></canvas><div style="text-align:center;"><span>'+this.l10n.getConstant("Invert")+"</span></div></div>"});for(var o=this.processToolbar("center"),i=0,a=o.length;i<a;i++)e.push(o[i]);return e},e.prototype.getPenToolbarItem=function(e){var t=this.parent,o=[];(sf.base.isNullOrUndefined(t.toolbar)||t.toolbar)&&o.push({id:t.element.id+"_annotation",tooltipText:this.l10n.getConstant("Annotation"),align:"Center",template:'<button id="'+t.element.id+'_annotationBtn"></button>'}),e.indexOf("strokeColor")>-1&&o.push({prefixIcon:"e-icons e-copy",id:t.element.id+"_pen_strokecolor",cssClass:"top-icon e-pen-stroke-color",tooltipText:this.l10n.getConstant("StrokeColor"),align:"Center",type:"Input",template:'<button id="'+t.element.id+'_penColorBtn"></button>'}),e.indexOf("strokeWidth")>-1&&o.push({prefixIcon:"e-icons e-copy",cssClass:"top-icon e-size",tooltipText:this.l10n.getConstant("StrokeWidth"),align:"Center",type:"Input",template:'<button id="'+t.element.id+'_penStrokeWidth"></button>'}),o.push({align:"Center",type:"Separator"}),e.indexOf("remove")>-1&&o.push({id:t.element.id+"_remove",prefixIcon:"e-icons e-trash",cssClass:"top-icon e-trash",tooltipText:this.l10n.getConstant("Remove"),align:"Center"});for(var i=this.processSubToolbar(e),a=0,r=i.length;a<r;a++)o.push(i[a]);return sf.base.Browser.isDevice||(o.push({id:t.element.id+"_ok",prefixIcon:"e-icons e-check",cssClass:"top-icon e-tick",tooltipText:this.l10n.getConstant("OK"),align:"Right"}),o.push({id:t.element.id+"_cancel",prefixIcon:"e-icons e-close",cssClass:"top-icon e-save",tooltipText:this.l10n.getConstant("Cancel"),align:"Right"})),o},e.prototype.initPenToolbarItem=function(e){var t=this,o=this.parent,i=this.getLeftToolbarItem(),a=this.getRightToolbarItem(),r=this.getPenToolbarItem(e),n=this.getZoomToolbarItem();sf.base.Browser.isDevice?this.defToolbarItems=r:this.defToolbarItems=i.concat(n,r,a);var s=new sf.navigations.Toolbar({width:"100%",items:this.defToolbarItems,clicked:this.defToolbarClicked.bind(this),created:function(){t.renderAnnotationBtn(!0),t.createPenColor(e),t.createPenBtn(e),t.wireZoomBtnEvents(),sf.base.Browser.isDevice||t.renderSaveBtn(),o.trigger("toolbarCreated",{toolbarType:"pen"}),sf.base.Browser.isDevice?t.defToolbarItems.length>0&&document.getElementById(o.element.id+"_toolbar")&&(s.refreshOverflow(),s.refreshOverflow()):(t.createLeftToolbarControls(),t.defToolbarItems.length>0&&document.getElementById(o.element.id+"_toolbar")&&s.refreshOverflow())}});sf.base.Browser.isDevice?s.appendTo("#"+o.element.id+"_bottomToolbar"):s.appendTo("#"+o.element.id+"_toolbar"),this.enableDisableTbrBtn()},e.prototype.createPenColor=function(e){var t=this,o=this.parent;if(e.indexOf("strokeColor")>-1){o.element.querySelector(".e-template.e-pen-stroke-color").appendChild(o.createElement("input",{id:o.element.id+"_pen_stroke"}));var i=new sf.inputs.ColorPicker({modeSwitcher:!1,value:"#fff",showButtons:!1,mode:"Palette",cssClass:"e-pen-color",change:function(e){o.updatePenStrokeColor(e.currentValue.hex),t.selFhdColor=e.currentValue.hex,a.element.children[0].style.backgroundColor=e.currentValue.rgba,a.toggle()}},"#"+o.element.id+"_pen_stroke"),a=new sf.splitbuttons.DropDownButton({open:function(e){sf.base.Browser.isDevice&&(e.element.parentElement.style.top=a.element.getBoundingClientRect().top-e.element.parentElement.offsetHeight+"px",e.element.parentElement.style.left=o.element.offsetLeft+"px")},target:".e-pen-color",iconCss:"e-dropdownbtn-preview"},"#"+o.element.id+"_penColorBtn");i.inline=!0;var r={tempFreeHandDrawEditingStyles:null};o.notify("freehand-draw",{prop:"getTempFreeHandDrawEditingStyles",value:{obj:r}});var n={freehandSelectedIndex:null};o.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:n}}),!sf.base.isNullOrUndefined(n.freehandSelectedIndex)&&n.freehandSelectedIndex>-1?o.element.querySelector(".e-pen-stroke-color.e-template .e-dropdownbtn-preview").style.background="#42a5f5"===this.selFhdColor?r.tempFreeHandDrawEditingStyles.strokeColor:o.pointColl[n.freehandSelectedIndex].strokeColor:o.element.querySelector(".e-pen-stroke-color.e-template .e-dropdownbtn-preview").style.background="#fff"}},e.prototype.createPenBtn=function(e){var t=this.parent,o=[{id:"1",text:this.l10n.getConstant("XSmall")},{id:"2",text:this.l10n.getConstant("Small")},{id:"3",text:this.l10n.getConstant("Medium")},{id:"4",text:this.l10n.getConstant("Large")},{id:"5",text:this.l10n.getConstant("XLarge")}];if(e.indexOf("strokeWidth")>-1){var i=document.getElementById(t.element.id+"_penStrokeWidth"),a=document.createElement("span"),r={freehandSelectedIndex:null};t.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:r}}),!sf.base.isNullOrUndefined(r.freehandSelectedIndex)&&r.freehandSelectedIndex>-1?a.innerHTML=this.getPenStroke(t.pointColl[r.freehandSelectedIndex].strokeWidth):a.innerHTML=this.l10n.getConstant("Small"),a.className="e-pen-stroke-width",i.appendChild(a);var n=new sf.splitbuttons.DropDownButton({items:o,open:function(e){sf.base.Browser.isDevice&&(e.element.parentElement.style.top=n.element.getBoundingClientRect().top-e.element.parentElement.offsetHeight+"px");var t=a.innerHTML;e.element.querySelector('[aria-label = "'+t+'"]').classList.add("e-selected-btn")},select:function(e){(a.textContent=e.item.text,t.updatePenStrokeWidth(e.item.id),sf.base.Browser.isDevice)?document.getElementById(t.element.id+"_bottomToolbar")&&sf.base.getComponent(t.element.id+"_bottomToolbar","toolbar").refreshOverflow():document.getElementById(t.element.id+"_toolbar")&&sf.base.getComponent(t.element.id+"_toolbar","toolbar").refreshOverflow()}});n.appendTo("#"+t.element.id+"_penStrokeWidth")}},e.prototype.getPenStroke=function(e){var t="",o={1:this.l10n.getConstant("XSmall"),2:this.l10n.getConstant("Small"),3:this.l10n.getConstant("Medium"),4:this.l10n.getConstant("Large"),5:this.l10n.getConstant("XLarge")};return e>=1&&e<=5&&(t=o[e]),t},e.prototype.initAdjustmentToolbarItem=function(){var e=this,t=this.parent,o=this.getLeftToolbarItem(null),i=this.getRightToolbarItem(),a=this.getAdjustmentToolbarItem(),r=this.getZoomToolbarItem();sf.base.Browser.isDevice?this.defToolbarItems=a:this.defToolbarItems=o.concat(r,a,i);var n=new sf.navigations.Toolbar({width:"100%",items:this.defToolbarItems,clicked:this.defToolbarClicked.bind(this),created:function(){e.wireZoomBtnEvents(),sf.base.Browser.isDevice||e.renderSaveBtn(),sf.base.Browser.isDevice||e.createLeftToolbarControls(),e.defToolbarItems.length>0&&document.getElementById(t.element.id+"_toolbar")&&n.refreshOverflow()}});sf.base.Browser.isDevice?n.appendTo("#"+t.element.id+"_bottomToolbar"):n.appendTo("#"+t.element.id+"_toolbar"),this.enableDisableTbrBtn()},e.prototype.initFilterToolbarItem=function(){var e=this,t=this.parent,o=this.getFilterToolbarItem();document.querySelector("#"+t.element.id+"_contextualToolbar").classList.contains("e-control")&&sf.base.getComponent(document.getElementById(t.element.id+"_contextualToolbar"),"toolbar").destroy();var i=new sf.navigations.Toolbar({width:"100%",items:o,clicked:this.contextualToolbarClicked.bind(this),created:function(){e.updatePrivateVariables(),e.createCanvasFilter(),""===t.currentFilter&&(t.currentFilter=t.element.id+"_default");var o=document.querySelector("#"+t.element.id+"_headWrapper");o&&(o.style.display="none"),document.getElementById(t.currentFilter+"Canvas").parentElement.parentElement.classList.add("e-selected"),e.enableDisableTbrBtn(),i.refreshOverflow()}});i.appendTo("#"+t.element.id+"_contextualToolbar")},e.prototype.createCanvasFilter=function(){var e=this.parent;sf.popups.showSpinner(e.element),e.element.style.opacity="0.5";var t=e.getCurrentCanvasData();this.inMemoryCanvas.width=t.width,this.inMemoryCanvas.height=t.height,this.inMemoryContext.putImageData(t,0,0),this.updateFilterCanvas("_defaultCanvas","default"),this.updateFilterCanvas("_chromeCanvas","chrome"),this.updateFilterCanvas("_coldCanvas","cold"),this.updateFilterCanvas("_warmCanvas","warm"),this.updateFilterCanvas("_grayscaleCanvas","grayscale"),this.updateFilterCanvas("_sepiaCanvas","sepia"),this.updateFilterCanvas("_invertCanvas","invert"),sf.popups.hideSpinner(e.element),e.element.style.opacity="1",e.initialAdjustmentValue=this.lowerContext.filter},e.prototype.updateFilterCanvas=function(e,t){var o=this.parent,i=o.element.querySelector("#"+o.element.id+e);if(i){var a=i.getContext("2d");a=i.getContext("2d"),i.style.width="100px",i.style.height="100px",o.notify("filter",{prop:"updateAdj",value:{type:t,value:null,isPreview:!0,ctx:a}}),a.drawImage(this.inMemoryCanvas,0,0,300,150)}},e.prototype.getQuickAccessToolbarItem=function(e){var t=this.parent,o={cancel:!1,toolbarItems:[]},i=[];sf.base.isNullOrUndefined(e)?(i.push("Clone"),i.push("Delete"),"text"===t.activeObj.shape&&i.push("EditText"),o.shape=t.toPascalCase(t.activeObj.shape)):e&&(i.push("Delete"),o.shape="Freehand draw"),o.toolbarItems=sf.base.extend([],i,null,!0),t.trigger("quickAccessToolbarOpen",o);var a=[];if(o.cancel)a=[];else for(var r=0;r<o.toolbarItems.length;r++)switch(o.toolbarItems[r]){case"Clone":a.push({id:t.element.id+"_duplicate",prefixIcon:"e-icons e-order",cssClass:"top-icon e-order",tooltipText:this.l10n.getConstant("Duplicate"),align:"Left"});break;case"Delete":a.push({id:t.element.id+"_remove",prefixIcon:"e-icons e-trash",cssClass:"top-icon e-trash",tooltipText:this.l10n.getConstant("Remove"),align:"Left"});break;case"EditText":a.push({id:t.element.id+"_editText",prefixIcon:"e-icons e-annotation-edit",cssClass:"top-icon e-annotation-edit",tooltipText:this.l10n.getConstant("EditText"),align:"Left"});break;default:a.push(o.toolbarItems[r])}return a},e.prototype.renderQAT=function(e){var t=this.parent;if(t.activeObj&&t.showQuickAccessToolbar){var o=document.getElementById(t.element.id+"_quickAccessToolbarArea");o&&(this.destroyQuickAccessToolbar(),o.style.display="block");var i=this.getQuickAccessToolbarItem(e);if(0===i.length)return;if(sf.base.isNullOrUndefined(t.quickAccessToolbarTemplate))new sf.navigations.Toolbar({items:i,clicked:this.quickAccessToolbarClicked.bind(this)}).appendTo("#"+t.element.id+"_quickAccessToolbar");if(sf.base.isNullOrUndefined(e)){o.style.width="auto",t.activeObj.activePoint.width=Math.abs(t.activeObj.activePoint.width),t.activeObj.activePoint.height=Math.abs(t.activeObj.activePoint.height);var a=t.activeObj.activePoint.startX<t.activeObj.activePoint.endX?t.activeObj.activePoint.startX:t.activeObj.activePoint.endX,r=t.activeObj.activePoint.startY<t.activeObj.activePoint.endY?t.activeObj.activePoint.startY:t.activeObj.activePoint.endY,n=t.activeObj.activePoint.width;if(0!==t.activeObj.rotatedAngle&&"arrow"!==t.activeObj.shape){var s={activePoint:null};t.notify("shape",{prop:"getSquarePointForRotatedShape",onPropertyChange:!1,value:{obj:t.activeObj,object:s}}),a=(c=s.activePoint).startX,r=c.startY,n=c.width}else if("path"===t.activeObj.shape){var l=t.getSquarePointForPath(t.activeObj);a=l.startX,r=l.startY,n=l.width}o.style.left=a+n/2-25*i.length+"px",r-60<t.img.destTop?o.style.top=t.img.destTop+"px":o.style.top=r-60+"px"}else if(e){var p={activePoint:null},h={freehandSelectedIndex:null};t.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:h}}),t.notify("freehand-draw",{prop:"getSqPtFD",value:{idx:h.freehandSelectedIndex,obj:p}});var c=p.activePoint;o.style.width="auto",o.style.left=c.startX+c.width/2-27*i.length+"px",c.startY-60<t.img.destTop?o.style.top=t.img.destTop+"px":o.style.top=c.startY-60+"px"}}},e.prototype.refreshDropDownBtn=function(e){if(!sf.base.isNullOrUndefined(e)){var t=this.parent,o=document.querySelector("#"+t.element.id+"_annotationBtn");o&&(e?(o.classList.add("e-disabled"),o.parentElement.classList.add("e-overlay")):(o.classList.remove("e-disabled"),o.parentElement.classList.remove("e-overlay")),sf.base.getComponent(o,"dropdown-btn").disabled=e);var i=document.querySelector("#"+t.element.id+"_transformBtn");i&&(e?(i.classList.add("e-disabled"),i.parentElement.classList.add("e-overlay")):(i.classList.remove("e-disabled"),i.parentElement.classList.remove("e-overlay")),sf.base.getComponent(i,"dropdown-btn").disabled=e);var a=document.querySelector("#"+t.element.id+"_adjustment");a&&(e?(a.classList.add("e-disabled"),a.parentElement.classList.add("e-overlay")):(a.classList.remove("e-disabled"),a.parentElement.classList.remove("e-overlay")),sf.base.getComponent(a,"btn").disabled=e);var r=document.querySelector("#"+t.element.id+"_filter");r&&(e?(r.classList.add("e-disabled"),r.parentElement.classList.add("e-overlay")):(r.classList.remove("e-disabled"),r.parentElement.classList.remove("e-overlay")),sf.base.getComponent(r,"btn").disabled=e)}},e.prototype.cropSelect=function(e){var t=this.parent;t.isCropTab=!0,sf.base.isNullOrUndefined(t.transform.cropZoomFactor)&&(t.transform.cropZoomFactor=t.transform.zoomFactor,t.notify("draw",{prop:"setTempZoomFactor",onPropertyChange:!1,value:{tempZoomFactor:t.transform.zoomFactor}})),t.transform.zoomFactor=t.transform.cropZoomFactor;var o=e.item.id;this.currentToolbar="crop",t.currSelectionPoint=null,t.select(o),this.enableDisableTbrBtn(),t.notify("transform",{prop:"disableZoomOutBtn",value:{isZoomOut:!0}})},e.prototype.quickAccessToolbarClicked=function(e,t){var o=this.parent,i={x:o.activeObj.activePoint.startX,y:o.activeObj.activePoint.startY};if(e.item){var a=void 0,r=void 0,n=null,s={prevActObj:null},l={tempObj:null};o.notify("draw",{prop:"getPrevActObj",onPropertyChange:!1,value:{obj:s}}),o.notify("selection",{prop:"getTempActObj",onPropertyChange:!1,value:{obj:l}}),l.tempObj.activePoint.height=Math.abs(l.tempObj.activePoint.height);var p={isNewPath:null};switch(o.notify("draw",{prop:"getNewPath",value:{obj:p}}),e.item.id.replace(o.element.id+"_","").toLowerCase()){case"duplicate":if(!o.element.querySelector("#"+o.element.id+"_duplicate").classList.contains("e-disabled")){if(p.isNewPath||JSON.stringify(l.tempObj)!==JSON.stringify(o.activeObj)||(n=!0),a=sf.base.extend({},o.activeObj,{},!0),sf.base.isNullOrUndefined(o.activeObj.currIndex)?o.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:n}}):s.prevActObj?(o.activeObj.currIndex=null,a.currIndex=null,o.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:n}})):o.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:!0}}),p.isNewPath&&o.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),r=sf.base.extend([],o.objColl,[],!0),a.activePoint.startX+=10,a.activePoint.startY-=10,a.activePoint.endX+=10,a.activePoint.endY-=10,"path"===a.shape)for(var h=0;h<a.pointColl.length;h++)a.pointColl[h].x+=10,a.pointColl[h].y-=10;o.activeObj=a,"line"!==o.activeObj.shape&&"arrow"!==o.activeObj.shape||o.notify("shape",{prop:"setPointCollForLineArrow",onPropertyChange:!1,value:{obj:o.activeObj}}),o.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:o.activeObj}}),o.notify("undo-redo",{prop:"updateUrObj",onPropertyChange:!1,value:{objColl:r}}),this.renderQAT()}break;case"remove":o.element.querySelector("#"+o.element.id+"_remove").classList.contains("e-disabled")||o.notify("selection",{prop:"deleteItem",onPropertyChange:!1});break;case"edittext":o.element.querySelector("#"+o.element.id+"_editText").classList.contains("e-disabled")||(this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),o.notify("selection",{prop:"setTempActObj",onPropertyChange:!1,value:{obj:sf.base.extend({},o.activeObj,{},!0)}}),o.notify("selection",{prop:"setInitialTextEdit",onPropertyChange:!1,value:{bool:!0}}),o.notify("draw",{prop:"setPrevActObj",onPropertyChange:!1,value:{prevActObj:sf.base.extend({},o.activeObj,{},!0)}}),0!==o.activeObj.rotatedAngle&&(i.x=o.activeObj.horTopLinePointColl[0].x,i.y=o.activeObj.horTopLinePointColl[0].y),o.notify("shape",{prop:"renderTextArea",onPropertyChange:!1,value:{x:i.x,y:i.y,actObj:o.activeObj}}),(sf.base.isNullOrUndefined(o.activeObj.currIndex)||s.prevActObj)&&o.notify("draw",{prop:"setShapeTextInsert",onPropertyChange:!1,value:{bool:!0}}),document.getElementById(o.element.id+"_quickAccessToolbarArea")&&(document.getElementById(o.element.id+"_quickAccessToolbarArea").style.display="none"))}}sf.base.isNullOrUndefined(t)&&o.trigger("quickAccessToolbarItemClick",e)},e.prototype.defToolbarClicked=function(e){var t=this.parent,o=!1,i=!1;if(t.element.querySelector(".e-contextual-toolbar-wrapper")&&(t.element.querySelector(".e-contextual-toolbar-wrapper").classList.contains("e-hide")||(o=i=!0),t.element.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hide")),e.item){var a=e.item.id.replace(t.element.id+"_","").toLowerCase();if("duplicate"===a||"remove"===a||"edittext"===a)this.quickAccessToolbarClicked(e,!0),t.trigger("toolbarItemClicked",e);else{var r=!1,n=!1,s=document.querySelector("#"+t.element.id+"_adjustment");s&&s.classList.contains("e-disabled")&&(n=!0);var l=document.querySelector("#"+t.element.id+"_filter");l&&l.classList.contains("e-disabled")&&(r=!0),this.enableDisableTbrBtn(),this.performDefTbrClick(a,o,n,r,i),t.trigger("toolbarItemClicked",e)}}},e.prototype.performDefTbrClick=function(e,t,o,i,a){var r,n,s=this.parent,l=s.element.querySelector("#"+s.element.id+"_zoomIn"),p=!1;if(void 0!==s.activeObj.shape&&(n=s.activeObj.shape.split("-")),(void 0===n&&s.currObjType.isCustomCrop||void 0!==n&&"crop"===n[0])&&(p=!0),!s.disabled)switch(e){case"pan":s.currObjType.isCustomCrop=s.currObjType.isFiltered=!1,s.currObjType.isUndoAction&&s.notify("undo-redo",{prop:"refreshUrc",value:{bool:null}}),p&&(s.currObjType.isCustomCrop=!1,s.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,s.upperCanvas.width,s.upperCanvas.height),this.refreshToolbar("main")),s.togglePan?(this.cancelPan(),s.notify("transform",{prop:"setDisablePan",onPropertyChange:!1,value:{bool:!0}}),"pen"===this.currentToolbar&&s.freehandDraw(!0)):((r=s.element.querySelector(".e-img-pan .e-btn"))&&r.classList.add("e-selected-btn"),s.pan(!0),s.notify("transform",{prop:"setDisablePan",onPropertyChange:!1,value:{bool:!1}})),l&&s.zoomSettings.zoomFactor>=s.zoomSettings.maxZoomFactor?(l.classList.add("e-disabled"),l.parentElement.classList.add("e-overlay")):l&&(l.classList.remove("e-disabled"),l.parentElement.classList.remove("e-overlay")),this.refreshToolbar("main");break;case"cancel":s.notify("draw",{prop:"performCancel",value:{isContextualToolbar:t}});break;case"ok":s.okBtn(),this.refreshDropDownBtn(!1),this.currentToolbar="main";break;case"crop":s.notify("transform",{prop:"disableZoomOutBtn",value:{isZoomOut:!0}});break;case"reset":s.reset(),this.currentToolbar="main";break;case"undo":s.notify("undo-redo",{prop:"call-undo"});break;case"redo":s.notify("undo-redo",{prop:"call-redo"});break;case"adjustment":o||(s.currObjType.isFiltered&&s.okBtn(),this.refreshToolbar("adjustment"),s.setTempFilterProperties(),this.openSlider("brightness"));break;case"brightness":case"contrast":case"hue":case"saturation":case"opacity":case"blur":case"exposure":this.openSlider(e);break;case"filter":i||(sf.popups.showSpinner(s.element),this.refreshToolbar("filter"),s.setTempFilterProperties(),sf.popups.hideSpinner(s.element));break;case"default":case"chrome":case"cold":case"warm":case"grayscale":case"blackandwhite":case"sepia":case"invert":case"sharpen":s.currObjType.isFiltered=!0,s.notify("filter",{prop:"applyImageFilter",value:{option:e}});break;case"upload":a&&s.element.querySelector(".e-contextual-toolbar-wrapper").classList.remove("e-hide");break;case"bold":s.notify("selection",{prop:"setInitialTextEdit",value:{bool:!1}}),s.activeObj.textSettings.bold&&s.activeObj.textSettings.italic?s.notify("shape",{prop:"applyFontStyle",onPropertyChange:!1,value:{item:"italic"}}):s.activeObj.textSettings.bold&&!s.activeObj.textSettings.italic?s.notify("shape",{prop:"applyFontStyle",onPropertyChange:!1,value:{item:"default"}}):!s.activeObj.textSettings.bold&&s.activeObj.textSettings.italic?s.notify("shape",{prop:"applyFontStyle",onPropertyChange:!1,value:{item:"bolditalic"}}):s.activeObj.textSettings.bold||s.activeObj.textSettings.italic||s.notify("shape",{prop:"applyFontStyle",onPropertyChange:!1,value:{item:"bold"}}),s.element.querySelector("#"+s.element.id+"_bold").classList.contains("e-selected-btn")?s.element.querySelector("#"+s.element.id+"_bold").classList.remove("e-selected-btn"):s.element.querySelector("#"+s.element.id+"_bold").classList.add("e-selected-btn");break;case"italic":s.notify("selection",{prop:"setInitialTextEdit",value:{bool:!1}}),s.activeObj.textSettings.bold&&s.activeObj.textSettings.italic?s.notify("shape",{prop:"applyFontStyle",onPropertyChange:!1,value:{item:"bold"}}):s.activeObj.textSettings.bold&&!s.activeObj.textSettings.italic?s.notify("shape",{prop:"applyFontStyle",onPropertyChange:!1,value:{item:"bolditalic"}}):!s.activeObj.textSettings.bold&&s.activeObj.textSettings.italic?s.notify("shape",{prop:"applyFontStyle",onPropertyChange:!1,value:{item:"default"}}):s.activeObj.textSettings.bold||s.activeObj.textSettings.italic||s.notify("shape",{prop:"applyFontStyle",onPropertyChange:!1,value:{item:"italic"}}),s.element.querySelector("#"+s.element.id+"_italic").classList.contains("e-selected-btn")?s.element.querySelector("#"+s.element.id+"_italic").classList.remove("e-selected-btn"):s.element.querySelector("#"+s.element.id+"_italic").classList.add("e-selected-btn");break;case"croptransform":this.refreshToolbar("croptransform");break;case"rotateleft":case"rotateright":case"horizontalflip":case"verticalflip":s.transformSelect(e),s.notify("transform",{prop:"disableZoomOutBtn",value:{isZoomOut:!0}});break;case"save":if(s.element.querySelector("#"+s.element.id+"_saveBtn").classList.contains("e-hide")){s.element.querySelector("#"+s.element.id+"_saveBtn").classList.remove("e-hide");break}s.okBtn(),s.element.querySelector("#"+s.element.id+"_saveBtn").classList.add("e-hide"),s.element.querySelector("#"+s.element.id+"_saveBtn").click()}},e.prototype.contextualToolbarClicked=function(e){var t=this.parent,o=t.element.querySelector(".e-contextual-toolbar-wrapper .e-toolbar-item.e-selected");o&&o.classList.remove("e-selected");var i=e.item.id.replace(t.element.id,"").split("_")[1],a={filter:t.toPascalCase(i),cancel:!1};t.trigger("imageFiltering",a),a.cancel||(document.getElementById(e.item.id+"Canvas").parentElement.parentElement.classList.add("e-selected"),t.currObjType.isFiltered=!0,t.notify("filter",{prop:"applyImageFilter",value:{option:i.toLowerCase()}}),t.currentFilter=e.item.id,this.enableDisableTbrBtn())},e.prototype.refreshShapeDrawing=function(){var e=this.parent,t={shape:""};e.notify("selection",{prop:"getCurrentDrawingShape",onPropertyChange:!1,value:{obj:t}}),""!==t.shape&&(e.notify("selection",{prop:"setCurrentDrawingShape",onPropertyChange:!1,value:{value:""}}),e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.refreshToolbar("main",!1))},e.prototype.zoomInBtnClickHandler=function(e){var t=this.parent;if((t.zoomSettings.zoomTrigger&a.Toolbar)===a.Toolbar){if(this.refreshShapeDrawing(),sf.base.Browser.isDevice&&"touchstart"===e.type){if(!e.returnValue)return;e.preventDefault()}var o=document.querySelector("#"+t.element.id+"_zoomIn");sf.base.EventHandler.trigger(o,"click");var i={bool:!1};t.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:i}}),i.bool&&(t.notify("freehand-draw",{prop:"applyFhd",onPropertyChange:!1}),this.destroyQuickAccessToolbar()),this.applyPreviewFilter(),t.currObjType.isFiltered=!1,t.togglePen&&(t.currObjType.isZoomed=!0,t.freeHandDraw(!1),t.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}})),t.notify("draw",{prop:"resetCurrentSelectionPoint"}),t.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:.1,zoomPoint:null}})}},e.prototype.zoomOutBtnClickHandler=function(e){var t=this.parent;if((t.zoomSettings.zoomTrigger&a.Toolbar)===a.Toolbar){if(this.refreshShapeDrawing(),sf.base.Browser.isDevice&&"touchstart"===e.type){if(!e.returnValue)return;e.preventDefault()}var o=document.querySelector("#"+t.element.id+"_zoomOut");sf.base.EventHandler.trigger(o,"click");var i={bool:!1};t.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:i}}),i.bool&&(t.notify("freehand-draw",{prop:"applyFhd",onPropertyChange:!1}),this.destroyQuickAccessToolbar()),this.applyPreviewFilter(),t.currObjType.isFiltered=!1,t.togglePen&&(t.currObjType.isZoomed=!0,t.freeHandDraw(!1),t.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}})),t.notify("draw",{prop:"resetCurrentSelectionPoint"}),t.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.1,zoomPoint:null}})}},e.prototype.zoomInBtnMouseDownHandler=function(e){e.preventDefault(),this.zoomBtnHold=setInterval(this.zoomInBtnClickHandler.bind(this),250)},e.prototype.zoomOutBtnMouseDownHandler=function(e){e.preventDefault(),this.zoomBtnHold=setInterval(this.zoomOutBtnClickHandler.bind(this),250)},e.prototype.zoomBtnMouseUpHandler=function(){clearInterval(this.zoomBtnHold),this.zoomBtnHold=0},e.prototype.closeContextualToolbar=function(){var e=this.parent,t=!1;return(e.element.querySelector("#"+e.element.id+"_contextualToolbar")&&!e.element.querySelector("#"+e.element.id+"_contextualToolbar").parentElement.classList.contains("e-hide")||e.element.querySelector("#"+e.element.id+"_headWrapper")&&!e.element.querySelector("#"+e.element.id+"_headWrapper").parentElement.classList.contains("e-hide"))&&(e.element.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hide"),e.okBtn(),this.refreshMainToolbar(),t=!0),t},e.prototype.destroyQuickAccessToolbar=function(){var e=this.parent,t=document.getElementById(e.element.id+"_quickAccessToolbar");t&&t.classList.contains("e-control")&&sf.base.getComponent(t,"toolbar").destroy();var o=document.getElementById(e.element.id+"_quickAccessToolbarArea");o&&(o.style.display="none")},e.prototype.renderSlider=function(e){var t=this.parent,o=document.querySelector("#"+t.element.id+"_contextualToolbarArea"),i=document.querySelector("#"+t.element.id+"_headWrapper"),a=document.querySelector("#"+t.element.id+"_labelWrapper");i?i.style.display="block":a=(i=o.appendChild(t.createElement("div",{id:t.element.id+"_headWrapper",styles:"position: relative"}))).appendChild(t.createElement("label",{id:t.element.id+"_labelWrapper",styles:sf.base.Browser.isDevice?"position: absolute; top: 25%; left: calc(50% - 150px); font-size: 15px; text-transform: capitalize; font-weight: 400;":"position: absolute; top: 25%; left: calc(50% - 226px); font-size: 15px; text-transform: capitalize; font-weight: 400;"})),a.textContent=this.l10n.getConstant(t.toPascalCase(e));var r,n,s,l=i.appendChild(t.createElement("div",{id:t.element.id+"_sliderWrapper",styles:"position: absolute"})),p=t.getCurrAdjustmentValue(e);"brightness"===e||"contrast"===e||"saturation"===e||"exposure"===e?(t.finetuneSettings?"brightness"===e&&t.finetuneSettings.brightness?(r=t.finetuneSettings.brightness.min,n=t.finetuneSettings.brightness.max):"contrast"===e&&t.finetuneSettings.contrast?(r=t.finetuneSettings.contrast.min,n=t.finetuneSettings.contrast.max):"saturation"===e&&t.finetuneSettings.saturation?(r=t.finetuneSettings.saturation.min,n=t.finetuneSettings.saturation.max):"exposure"===e&&t.finetuneSettings.exposure?(r=t.finetuneSettings.exposure.min,n=t.finetuneSettings.exposure.max):(r=-100,n=100):(r=-100,n=100),s=this.createSlider(r,n,p,e)):"hue"!==e&&"blur"!==e&&"opacity"!==e||(t.finetuneSettings?"hue"===e&&t.finetuneSettings.hue?(r=t.finetuneSettings.hue.min,n=t.finetuneSettings.hue.max):"blur"===e&&t.finetuneSettings.blur?(r=t.finetuneSettings.blur.min,n=t.finetuneSettings.blur.max):"opacity"===e&&t.finetuneSettings.opacity?(r=t.finetuneSettings.opacity.min,n=t.finetuneSettings.opacity.max):(r=0,n=100):(r=0,n=100),s=this.createSlider(r,n,p,e)),s.appendTo("#"+t.element.id+"_sliderWrapper"),l.style.left=(parseFloat(o.style.width)-parseFloat(s.width))/2+"px"},e.prototype.createSlider=function(e,t,o,i){var a=this,r=this.parent;return new sf.inputs.Slider({value:o,tooltip:{isVisible:!0,placement:"Before",showOn:"Always"},type:"MinRange",min:e,max:t,step:10,width:sf.base.Browser.isDevice?"200px":"300px",cssClass:"e-slider",change:function(e){r.setCurrAdjustmentValue(i,e.value),a.enableDisableTbrBtn()}})},e.prototype.applyPreviewFilter=function(){var e=this.parent;(document.querySelector("#"+e.element.id+"_sliderWrapper")||e.currObjType.isFiltered)&&(e.initialAdjustmentValue=e.canvasFilter=this.lowerContext.filter,e.currObjType.isFiltered=!1)},e.prototype.unselectBtn=function(){for(var e=this.parent,t=0,o=["#"+e.element.id+"_brightness","#"+e.element.id+"_contrast","#"+e.element.id+"_hue","#"+e.element.id+"_saturation","#"+e.element.id+"_opacity","#"+e.element.id+"_blur","#"+e.element.id+"_exposure"];t<o.length;t++){var i=o[t],a=document.querySelector(i);if(a.classList.contains("e-selected-btn")){a.classList.remove("e-selected-btn");break}}},e.prototype.openSlider=function(e){this.unselectBtn(),this.parent.currObjType.isFiltered=!0,this.refreshToolbar("color",null,null,null,e),document.getElementById(this.parent.element.id+"_"+e).classList.add("e-selected-btn")},e.prototype.refreshSlider=function(){var e=document.querySelector("#"+this.parent.element.id+"_sliderWrapper"),t=document.querySelector(".e-slider"),o=document.querySelector("#"+this.parent.element.id+"_headWrapper");o&&(o.style.display="none"),e&&t&&(t.ej2_instances[0].destroy(),e.remove())},e.prototype.updateToolbarItems=function(){var e=this.parent,t=e.element.querySelector(".e-fill.e-template .e-dropdownbtn-preview"),o=e.element.querySelector(".e-stroke.e-template .e-dropdownbtn-preview"),i=e.element.querySelector(".e-text-font-color.e-template .e-dropdownbtn-preview"),a=e.element.querySelector(".e-pen-stroke-color.e-template .e-dropdownbtn-preview"),r=e.element.querySelector(".e-shape-stroke-width"),n=e.element.querySelector(".e-text-font-family"),s=e.element.querySelector(".e-text-font-size"),l=e.element.querySelector("#"+e.element.id+"_bold"),p=e.element.querySelector("#"+e.element.id+"_italic");if(sf.base.isNullOrUndefined(e.activeObj.strokeSettings.strokeWidth)&&(e.activeObj.strokeSettings.strokeWidth=2),t&&(""===e.activeObj.strokeSettings.fillColor?t.classList.add("e-nocolor-item"):(t.classList.remove("e-nocolor-item"),t.style.background=e.activeObj.strokeSettings.fillColor),sf.base.getComponent(e.element.id+"_shape_fill","colorpicker").value=e.activeObj.strokeSettings.fillColor+"ff"),o&&(o.style.background=e.activeObj.strokeSettings.strokeColor,sf.base.getComponent(e.element.id+"_shape_stroke","colorpicker").value=e.activeObj.strokeSettings.strokeColor+"ff"),i&&(i.style.background=e.activeObj.strokeSettings.strokeColor,sf.base.getComponent(e.element.id+"_text_font","colorpicker").value=e.activeObj.strokeSettings.strokeColor+"ff"),a&&(a.style.background=e.activeObj.strokeSettings.strokeColor,sf.base.getComponent(e.element.id+"_pen_stroke","colorpicker").value=e.activeObj.strokeSettings.strokeColor+"ff"),n&&(sf.base.Browser.isDevice?n.setAttribute("style","font-family:"+e.activeObj.textSettings.fontFamily.toLowerCase()):n.textContent=e.activeObj.textSettings.fontFamily),s)for(var h=0;h<e.fontSizeColl.length;h++)if(parseInt(e.fontSizeColl[h].text,10)>=Math.round(e.activeObj.textSettings.fontSize)){s.textContent=(h+1).toString();break}if(l&&(e.activeObj.textSettings.bold?l.classList.add("e-selected-btn"):l.classList.remove("e-selected-btn")),p&&(e.activeObj.textSettings.italic?p.classList.add("e-selected-btn"):p.classList.remove("e-selected-btn")),r){var c=Math.round(e.activeObj.strokeSettings.strokeWidth).toString();r.textContent=this.getStrokeWidth(c)}},e.prototype.getStrokeWidth=function(e){var t;switch(parseInt(e,10)/2){case 1:t=this.l10n.getConstant("XSmall");break;case 2:t=this.l10n.getConstant("Small");break;case 3:t=this.l10n.getConstant("Medium");break;case 4:t=this.l10n.getConstant("Large");break;case 5:t=this.l10n.getConstant("XLarge")}return t},e.prototype.cancelPan=function(){var e=this.parent;e.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:!0}});var t=e.element.querySelector(".e-img-pan .e-btn");t&&t.classList.remove("e-selected-btn"),e.pan(!1)},e.prototype.refreshMainToolbar=function(){"main"!==this.currToolbar&&this.refreshToolbar("main")},e.prototype.destroySubComponents=function(){for(var e=this.parent,t=e.element.querySelectorAll("input.e-control"),o=e.element.querySelectorAll("button.e-control"),i=0,a=t.length;i<a;i++)t[i].classList.contains("e-color-picker")&&(sf.base.getComponent(t[i],"color-picker").destroy(),sf.base.detach(sf.base.select("input#"+t[i].id,e.element)));for(i=0,a=o.length;i<a;i++)o[i].classList.contains("e-dropdown-btn")?(sf.base.getComponent(o[i],"dropdown-btn").destroy(),sf.base.detach(sf.base.select("button#"+o[i].id,e.element))):o[i].classList.contains("e-btn")&&(sf.base.getComponent(o[i],"btn").destroy(),sf.base.detach(sf.base.select("button#"+o[i].id,e.element)))},e.prototype.setInitialShapeSettings=function(e){var t=this.parent;t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),t.currObjType.shape=e.item.id,t.activeObj.shape=t.currObjType.shape.toLowerCase(),t.currObjType.isDragging=t.currObjType.isCustomCrop=!1,t.activeObj.shapeDegree=t.transform.degree,t.activeObj.shapeFlip=t.transform.currFlipState,t.activeObj.textFlip=t.transform.currFlipState,t.activeObj.flipObjColl=[]},e.prototype.getModuleName=function(){return"toolbar-module"},e}(),j=(m=function(e,t){return(m=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])})(e,t)},function(e,t){function o(){this.constructor=e}m(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}),O=function(e,t,i,a){var r,n=arguments.length,s=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,i):a;if("object"===("undefined"==typeof Reflect?"undefined":o(Reflect))&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,a);else for(var l=e.length-1;l>=0;l--)(r=e[l])&&(s=(n<3?r(s):n>3?r(t,i,s):r(t,i))||s);return n>3&&s&&Object.defineProperty(t,i,s),s},x=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return j(t,e),O([sf.base.Property(null)],t.prototype,"brightness",void 0),O([sf.base.Property(null)],t.prototype,"contrast",void 0),O([sf.base.Property(null)],t.prototype,"hue",void 0),O([sf.base.Property(null)],t.prototype,"saturation",void 0),O([sf.base.Property(null)],t.prototype,"exposure",void 0),O([sf.base.Property(null)],t.prototype,"opacity",void 0),O([sf.base.Property(null)],t.prototype,"blur",void 0),t}(sf.base.ChildProperty),w=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return j(t,e),O([sf.base.Property(null)],t.prototype,"zoomTrigger",void 0),O([sf.base.Property(1)],t.prototype,"minZoomFactor",void 0),O([sf.base.Property(10)],t.prototype,"maxZoomFactor",void 0),O([sf.base.Property(1)],t.prototype,"zoomFactor",void 0),O([sf.base.Property(null)],t.prototype,"zoomPoint",void 0),t}(sf.base.ChildProperty),S=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return j(t,e),O([sf.base.Property(!0)],t.prototype,"showCircle",void 0),O([sf.base.Property(null)],t.prototype,"strokeColor",void 0),O([sf.base.Property(null)],t.prototype,"fillColor",void 0),t}(sf.base.ChildProperty),T=function(e){function t(t,i){var a=e.call(this,t)||this;return a.isImageLoaded=!1,a.activeObj={activePoint:{startX:0,startY:0,endX:0,endY:0,width:0,height:0},flipObjColl:[],triangle:[],triangleRatio:[],rotatedAngle:0},a.currObjType={shape:"",isDragging:!1,isActiveObj:!1,isText:!1,isInitialText:!1,isLine:!1,isInitialLine:!1,isCustomCrop:!1,isZoomed:!1,isUndoZoom:!1,isUndoAction:!1,isFiltered:!1,isSave:!1,isResize:!1},a.objColl=[],a.pointColl={},a.freehandCounter=0,a.points=[],a.togglePen=!1,a.togglePan=!1,a.img={destLeft:0,destTop:0,destWidth:0,destHeight:0,srcLeft:0,srcTop:0,srcWidth:0,srcHeight:0},a.rotateFlipColl=[],a.cropObj={cropZoom:0,defaultZoom:0,totalPannedPoint:{x:0,y:0},totalPannedClientPoint:{x:0,y:0},totalPannedInternalPoint:{x:0,y:0},tempFlipPanPoint:{x:0,y:0},activeObj:{},rotateFlipColl:[],degree:0,currFlipState:"",destPoints:{startX:0,startY:0,width:0,height:0},srcPoints:{startX:0,startY:0,width:0,height:0},filter:"",zoomFactor:0,previousZoomValue:0},a.afterCropActions=[],a.transform={degree:0,currFlipState:"",zoomFactor:0,cropZoomFactor:null,defaultZoomFactor:0},a.panPoint={currentPannedPoint:{x:0,y:0},totalPannedPoint:{x:0,y:0},totalPannedInternalPoint:{x:0,y:0},totalPannedClientPoint:{x:0,y:0}},a.isUndoRedo=!1,a.isCropTab=!1,a.isCircleCrop=!1,a.fontSizeColl=[],a.initialAdjustmentValue="",a.currentFilter="",a.canvasFilter="brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)",a.toolbarHeight=0,a.isPublicMethod=!1,a.isCropToolbar=!1,a.cursor="default",sf.base.isBlazor()?(new h(a),new c(a),new v(a),new u(a),new b(a),new g(a),new f(a),new C(a),new d(a)):(o.Inject(h,c,b,f,d,P),o.Inject(C),o.Inject(v),o.Inject(g),o.Inject(u),i&&a.appendTo(i)),a}var o;return j(t,e),o=t,t.prototype.requiredModules=function(){var e=[];return e.push({member:"crop",args:[this]}),e.push({member:"draw",args:[this]}),e.push({member:"selection",args:[this]}),e.push({member:"transform",args:[this]}),e.push({member:"export",args:[this]}),e.push({member:"toolbar-module",args:[this]}),e.push({member:"undo-redo",args:[this]}),e.push({member:"filter",args:[this]}),e.push({member:"shape",args:[this]}),e.push({member:"freehand-draw",args:[this]}),e},t.prototype.preRender=function(){this.element.id=this.element.id||sf.base.getUniqueID("ej2-image-editor"),sf.base.Browser.isDevice&&this.element.classList.add("e-device"),this.initializeThemeColl()},t.prototype.render=function(){this.initialize()},t.prototype.getModuleName=function(){return"image-editor"},t.prototype.getPersistData=function(){return this.addOnPersist([])},t.prototype.onPropertyChanged=function(e,t){for(var o=0,i=Object.keys(e);o<i.length;o++){switch(i[o]){case"cssClass":t.cssClass&&sf.base.removeClass([this.element],t.cssClass.replace(/\s+/g," ").trim().split(" ")),e.cssClass&&sf.base.addClass([this.element],e.cssClass.replace(/\s+/g," ").trim().split(" "));break;case"disabled":e.disabled?(this.element.classList.add("e-disabled"),this.unwireEvent()):(this.element.classList.remove("e-disabled"),this.wireEvent());break;case"height":this.element.style.height=e.height;break;case"width":this.element.style.width=e.width;break;case"theme":e.theme&&(this.theme&&""!==this.theme?this.theme=this.toPascalCase(this.theme):this.theme="Bootstrap5",this.upperContext.strokeStyle=this.themeColl[this.theme].primaryColor,this.upperContext.fillStyle=this.themeColl[this.theme].secondaryColor);break;case"finetuneSettings":e.finetuneSettings&&(this.finetuneSettings=e.finetuneSettings,this.notify("filter",{prop:"update-finetunes"}));break;case"locale":e.locale&&(this.notify("toolbar",{prop:"setLocale",onPropertyChange:!1,value:{locale:e.locale}}),this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}));break;case"allowUndoRedo":e.allowUndoRedo?this.allowUndoRedo=!0:this.allowUndoRedo=!1,this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}});break;case"showQuickAccessToolbar":e.showQuickAccessToolbar?(this.showQuickAccessToolbar=!0,this.notify("toolbar",{prop:"create-qa-toolbar",onPropertyChange:!1}),this.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}})):(this.showQuickAccessToolbar=!1,this.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1}));break;case"zoomSettings":e.zoomSettings&&(this.zoomSettings.zoomTrigger=e.zoomSettings.zoomTrigger),sf.base.isNullOrUndefined(this.zoomSettings.zoomTrigger)?(this.zoomSettings.zoomTrigger=a.MouseWheel|a.Pinch|a.Toolbar|a.Commands,this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}})):(e.zoomSettings.zoomTrigger&a.Toolbar)===a.Toolbar&&this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}});break;case"selectionSettings":e.selectionSettings&&(this.selectionSettings=e.selectionSettings,this.activeObj.shape&&(this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:this.activeObj}})))}}},t.prototype.destroy=function(){var t=[];this.element.removeAttribute("tabindex"),this.cssClass&&(t=t.concat(this.cssClass.replace(/\s+/g," ").trim().split(" "))),sf.base.removeClass([this.element],t),this.element.getAttribute("class")||this.element.removeAttribute("class"),sf.base.isBlazor()?this.element.classList.remove("e-image-editor"):(this.notify("toolbar",{prop:"destroySubComponents",onPropertyChange:!1}),this.notify("destroyed",null),e.prototype.destroy.call(this)),this.unwireEvent(),this.element.innerHTML=""},t.prototype.initialize=function(){if(this.toolbarTemplate?(this.element.appendChild(this.createElement("div",{id:this.element.id+"_toolbarArea",className:"e-toolbar-area"})),this.toolbarTemplateFn()):(this.notify("toolbar",{prop:"create-toolbar",onPropertyChange:!1}),this.notify("toolbar",{prop:"create-contextual-toolbar",onPropertyChange:!1})),this.createCanvas(),this.showQuickAccessToolbar){document.querySelector("#"+this.element.id+"_canvasWrapper").appendChild(this.createElement("div",{id:this.element.id+"_quickAccessToolbarArea",className:"e-quick-access-toolbar-area"}));var e=document.getElementById(this.element.id+"_quickAccessToolbarArea");e.style.position="absolute",e.style.display="none",this.activeObj&&(e.style.left=this.activeObj.activePoint.startX+"px",e.style.top=this.activeObj.activePoint.startY+"px"),e.style.width="100%"}this.quickAccessToolbarTemplate?this.quickAccessToolbarTemplateFn():this.notify("toolbar",{prop:"create-qa-toolbar",onPropertyChange:!1}),this.wireEvent(),this.lowerContext=this.lowerCanvas.getContext("2d"),this.upperContext=this.upperCanvas.getContext("2d"),this.inMemoryContext=this.inMemoryCanvas.getContext("2d"),this.lowerContext.filter=this.getDefaultFilter(),this.notify("filter",{prop:"setAdjustmentValue",onPropertyChange:!1,value:{adjustmentValue:this.lowerContext.filter}}),this.notify("toolbar",{prop:"setCanvasFilter",onPropertyChange:!1,value:{filter:this.lowerContext.filter}}),this.notify("toolbar",{prop:"setInitialAdjustmentValue",onPropertyChange:!1,value:{value:this.lowerContext.filter}}),this.cssClass&&sf.base.addClass([this.element],this.cssClass.replace(/\s+/g," ").trim().split(" ")),this.element&&sf.popups.createSpinner({target:this.element}),this.initializeZoomSettings()},t.prototype.wireEvent=function(){sf.base.EventHandler.add(document,"keydown",this.keyDownEventHandler,this),sf.base.EventHandler.add(document,"keypress",this.keyUpEventHandler,this),sf.base.EventHandler.add(this.upperCanvas,"mousedown",this.mouseDownEventHandler,this),sf.base.EventHandler.add(this.upperCanvas,"mousemove",this.mouseMoveEventHandler,this),sf.base.EventHandler.add(this.upperCanvas,"mouseup",this.mouseUpEventHandler,this),sf.base.EventHandler.add(document,"mouseup",this.mouseUpEventHandler,this),sf.base.EventHandler.add(this.lowerCanvas,"mousedown",this.canvasMouseDownHandler,this),sf.base.EventHandler.add(this.lowerCanvas,"mousemove",this.canvasMouseMoveHandler,this),sf.base.EventHandler.add(this.lowerCanvas,"mouseup",this.canvasMouseUpHandler,this),sf.base.EventHandler.add(document,"mouseup",this.canvasMouseUpHandler,this),sf.base.EventHandler.add(this.upperCanvas,"touchstart",this.touchStartHandler,this),sf.base.EventHandler.add(this.lowerCanvas,"touchstart",this.touchStartHandler,this),sf.base.EventHandler.add(this.lowerCanvas,"mousewheel DOMMouseScroll",this.handleScroll,this),sf.base.EventHandler.add(this.upperCanvas,"mousewheel DOMMouseScroll",this.handleScroll,this),window.addEventListener("resize",this.windowResizeHandler.bind(this)),sf.base.Browser.isIos||"safari"===sf.base.Browser.info.name||screen.orientation.addEventListener("change",this.screenOrientation.bind(this)),this.notify("shape",{prop:"wireEvent",onPropertyChange:!1})},t.prototype.unwireEvent=function(){sf.base.EventHandler.remove(document,"keydown",this.keyDownEventHandler),sf.base.EventHandler.remove(document,"keypress",this.keyUpEventHandler),sf.base.EventHandler.remove(this.upperCanvas,"mousedown",this.mouseDownEventHandler),sf.base.EventHandler.remove(this.upperCanvas,"mousemove",this.mouseMoveEventHandler),sf.base.EventHandler.remove(this.upperCanvas,"mouseup",this.mouseUpEventHandler),sf.base.EventHandler.remove(document,"mouseup",this.mouseUpEventHandler),sf.base.EventHandler.remove(this.lowerCanvas,"mousedown",this.canvasMouseDownHandler),sf.base.EventHandler.remove(this.lowerCanvas,"mousemove",this.canvasMouseMoveHandler),sf.base.EventHandler.remove(this.lowerCanvas,"mouseup",this.canvasMouseUpHandler),sf.base.EventHandler.remove(document,"mouseup",this.canvasMouseUpHandler),sf.base.EventHandler.remove(this.upperCanvas,"touchstart",this.touchStartHandler),sf.base.EventHandler.remove(this.lowerCanvas,"touchstart",this.touchStartHandler),sf.base.EventHandler.remove(this.lowerCanvas,"mousewheel DOMMouseScroll",this.handleScroll),sf.base.EventHandler.remove(this.upperCanvas,"mousewheel DOMMouseScroll",this.handleScroll),window.removeEventListener("resize",this.windowResizeHandler.bind(this)),sf.base.Browser.isIos||"safari"===sf.base.Browser.info.name||screen.orientation.removeEventListener("change",this.screenOrientation.bind(this)),this.notify("shape",{prop:"unWireEvent",onPropertyChange:!1})},t.prototype.createCanvas=function(){this.element.style.boxSizing="border-box";var e={toolbarHeight:0};this.notify("toolbar",{prop:"getToolbarHeight",value:{obj:e}});var t=e.toolbarHeight;this.element.style.width=this.width,this.element.style.height=this.height;var o=this.element.appendChild(this.createElement("div",{id:this.element.id+"_canvasWrapper",className:"e-canvas-wrapper",attrs:{style:"height:"+(this.element.offsetHeight-t-2)+"px; width:"+(this.element.offsetWidth-2)+"px; position: relative; overflow: hidden; margin: 0 auto;"}}));this.lowerCanvas=o.appendChild(this.createElement("canvas",{id:this.element.id+"_lowerCanvas",attrs:{name:"canvasImage"}})),this.upperCanvas=o.appendChild(this.createElement("canvas",{id:this.element.id+"_upperCanvas",attrs:{name:"canvasImage"}})),this.inMemoryCanvas=this.createElement("canvas",{id:this.element.id+"_inMemoryCanvas",attrs:{name:"canvasImage"}}),this.textArea=o.appendChild(this.createElement("textarea",{id:this.element.id+"_textArea",className:"e-textarea",attrs:{name:"textArea"}})),this.element.appendChild(this.createElement("div",{id:this.element.id+"_dialog",className:"e-dialog"})).style.display="none",this.textArea.setAttribute("spellcheck","false"),this.textArea.style.lineHeight="normal",this.lowerCanvas.style.width=this.upperCanvas.style.width=this.inMemoryCanvas.style.width="100%",this.lowerCanvas.style.height=this.upperCanvas.style.height=this.inMemoryCanvas.style.height="100%",this.upperCanvas.style.position=this.lowerCanvas.style.position=this.textArea.style.position="absolute",this.textArea.style.backgroundColor="transparent",this.textArea.style.display="none",this.textArea.style.resize="none",this.lowerContext=this.lowerCanvas.getContext("2d"),this.baseImg=this.createElement("img",{id:this.element.id+"_orgImg",attrs:{name:"Image",crossorigin:"anonymous"}}),this.upperCanvas.style.cursor=this.cursor="default",this.upperCanvas.style.display="block",this.upperContext=this.upperCanvas.getContext("2d")},t.prototype.touchStartHandler=function(e){this.notify("selection",{prop:"touchStartHandler",onPropertyChange:!1,value:{e:e}})},t.prototype.mouseDownEventHandler=function(e){this.notify("selection",{prop:"mouseDownEventHandler",onPropertyChange:!1,value:{e:e}})},t.prototype.mouseMoveEventHandler=function(e){this.notify("selection",{prop:"mouseMoveEventHandler",onPropertyChange:!1,value:{e:e}})},t.prototype.mouseUpEventHandler=function(e){this.notify("selection",{prop:"mouseUpEventHandler",onPropertyChange:!1,value:{e:e}})},t.prototype.keyDownEventHandler=function(e){this.notify("selection",{prop:"keyDownEventHandler",onPropertyChange:!1,value:{e:e}})},t.prototype.keyUpEventHandler=function(e){"block"===this.textArea.style.display&&e.target.id===this.element.id+"_textArea"&&this.notify("selection",{prop:"textKeyDown",value:{e:e}})},t.prototype.canvasMouseDownHandler=function(e){this.notify("selection",{prop:"canvasMouseDownHandler",onPropertyChange:!1,value:{e:e}})},t.prototype.canvasMouseMoveHandler=function(e){this.notify("selection",{prop:"canvasMouseMoveHandler",onPropertyChange:!1,value:{e:e}})},t.prototype.canvasMouseUpHandler=function(e){this.notify("selection",{prop:"canvasMouseUpHandler",onPropertyChange:!1,value:{e:e}})},t.prototype.handleScroll=function(e){this.notify("selection",{prop:"handleScroll",onPropertyChange:!1,value:{e:e}})},t.prototype.adjustToScreen=function(){this.update()},t.prototype.screenOrientation=function(){sf.base.Browser.isDevice&&setTimeout(this.adjustToScreen.bind(this),100)},t.prototype.windowResizeHandler=function(){!sf.base.Browser.isDevice&&this.element.classList.contains("e-image-editor")&&this.adjustToScreen()},t.prototype.notifyResetForAllModules=function(){for(var e=this.requiredModules(),t=0;t<e.length;t++)this.notify(e[t].member,{prop:"reset",onPropertyChange:!1})},t.prototype.allowShape=function(e,t){this.isPublicMethod=!0;var o={inRange:!1};return this.notify("shape",{prop:"isPointsInRange",onPropertyChange:!1,value:{x:e,y:t,obj:o}}),o.inRange},t.prototype.clearSelection=function(){this.notify("selection",{prop:"clearSelection",onPropertyChange:!1})},t.prototype.crop=function(){var e={isCrop:!1};return this.notify("crop",{prop:"crop",onPropertyChange:!1,value:{obj:e}}),e.isCrop},t.prototype.flip=function(e){this.notify("transform",{prop:"flip",value:{direction:e}}),this.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}})},t.prototype.getImageData=function(){var e={canvas:null};return this.notify("export",{prop:"exportToCanvas",value:{object:e}}),e.canvas.getContext("2d").getImageData(0,0,e.canvas.width,e.canvas.height)},t.prototype.open=function(e){this.notify("draw",{prop:"open",value:{data:e}})},t.prototype.reset=function(){var e={isErrorImage:!1};if(this.notify("draw",{prop:"getErrorImage",value:{obj:e}}),!this.disabled&&!e.isErrorImage){this.clearContext(this.inMemoryContext),this.clearContext(this.lowerContext),this.clearContext(this.upperContext),this.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),sf.base.isBlazor()||(this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:!1,isCropping:!1,isZooming:null,cType:null}}),sf.base.Browser.isDevice&&document.getElementById(this.element.id+"_bottomToolbar")&&(sf.base.getComponent(document.getElementById(this.element.id+"_bottomToolbar"),"toolbar").destroy(),this.notify("toolbar",{prop:"create-bottom-toolbar",onPropertyChange:!1}))),this.currObjType.isUndoAction=this.isUndoRedo=this.togglePan=this.togglePen=this.isImageLoaded=!1,this.isCircleCrop=this.isCropTab=!1,this.objColl=[],this.transform.degree=0,this.upperCanvas.style.display="block",this.transform.currFlipState="",this.upperCanvas.style.cursor=this.cursor=this.lowerCanvas.style.cursor="default",this.lowerContext.lineWidth=this.upperContext.lineWidth=void 0,this.textArea.value=this.textArea.textContent="",this.textArea.style.display="none",this.lowerContext.filter=this.canvasFilter=this.getDefaultFilter(),this.img.destLeft=this.img.destTop=this.img.srcLeft=this.img.srcTop=0,this.img.destWidth=this.img.destHeight=this.img.srcWidth=this.img.srcHeight=null,this.currSelectionPoint=null,this.panPoint.currentPannedPoint={x:0,y:0},this.rotateFlipColl=[],this.points=[],this.pointColl={},this.freehandCounter=0,this.notify("draw",{prop:"resetPanPoints"}),this.lowerCanvas.style.left=this.upperCanvas.style.left="",this.fontSizeColl=[],this.lowerCanvas.style.top=this.upperCanvas.style.top="",this.lowerCanvas.style.maxWidth=this.upperCanvas.style.maxWidth="",this.lowerCanvas.style.maxHeight=this.upperCanvas.style.maxHeight="",this.transform.defaultZoomFactor=this.transform.zoomFactor=0,this.transform.cropZoomFactor=null,this.currObjType={shape:"",isDragging:!1,isActiveObj:!1,isText:!1,isInitialText:!1,isLine:!1,isInitialLine:!1,isCustomCrop:!1,isZoomed:!1,isUndoZoom:!1,isUndoAction:!1,isFiltered:!1,isSave:!1,isResize:!1},this.cropObj={cropZoom:0,defaultZoom:0,totalPannedPoint:{x:0,y:0},totalPannedClientPoint:{x:0,y:0},totalPannedInternalPoint:{x:0,y:0},tempFlipPanPoint:{x:0,y:0},activeObj:{},rotateFlipColl:[],degree:0,currFlipState:"",zoomFactor:0,previousZoomValue:0,destPoints:{startX:0,startY:0,width:0,height:0},srcPoints:{startX:0,startY:0,width:0,height:0},filter:""},this.afterCropActions=[],this.currentFilter="";var t={initialZoomValue:!1};this.notify("draw",{prop:"getInitialZoomValue",onPropertyChange:!1,value:{obj:t}}),t.initialZoomValue&&this.setProperties({zoomSettings:{zoomFactor:t.initialZoomValue}},!0),document.getElementById(this.element.id+"_quickAccessToolbarArea")&&(document.getElementById(this.element.id+"_quickAccessToolbarArea").style.display="none"),this.notifyResetForAllModules(),this.notify("filter",{prop:"update-finetunes"}),this.isImageLoaded=!1,this.notify("draw",{prop:"update-canvas",onPropertyChange:!1}),this.isImageLoaded=!0,sf.base.isBlazor()||(this.element.querySelector(".e-contextual-toolbar-wrapper")&&this.element.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hide"),this.notify("toolbar",{prop:"refresh-dropdown-btn",value:{isDisabled:!1}}),this.notify("toolbar",{prop:"enable-disable-btns"}))}},t.prototype.rotate=function(e){var t={isRotate:!1};return this.notify("transform",{prop:"rotate",value:{degree:e,obj:t}}),this.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),t.isRotate},t.prototype.export=function(e,t){this.notify("export",{prop:"export",onPropertyChange:!1,value:{type:e,fileName:t}})},t.prototype.select=function(e,t,o,i,a){this.notify("draw",{prop:"select",onPropertyChange:!1,value:{type:e,startX:t,startY:o,width:i,height:a}})},t.prototype.freeHandDraw=function(e){this.notify("freehand-draw",{prop:"freeHandDraw",onPropertyChange:!1,value:{value:e}})},t.prototype.freehandDraw=function(e){!this.disabled&&this.isImageLoaded&&this.freeHandDraw(e)},t.prototype.pan=function(e){this.notify("transform",{prop:"pan",onPropertyChange:!1,value:{value:e}})},t.prototype.zoom=function(e,t){this.notify("transform",{prop:"zoom",onPropertyChange:!1,value:{zoomFactor:e,zoomPoint:t}})},t.prototype.drawEllipse=function(e,t,o,i,a,r,n){var s=!1,l=this.allowShape(e,t);return!this.disabled&&this.isImageLoaded&&l&&(s=!0,this.notify("shape",{prop:"drawEllipse",onPropertyChange:!1,value:{x:e,y:t,radiusX:o,radiusY:i,strokeWidth:a,strokeColor:r,fillColor:n}})),s},t.prototype.drawLine=function(e,t,o,i,a,r){var n=!1,s=this.allowShape(e,t);return!this.disabled&&this.isImageLoaded&&s&&(n=!0,this.notify("shape",{prop:"drawLine",onPropertyChange:!1,value:{startX:e,startY:t,endX:o,endY:i,strokeWidth:a,strokeColor:r}})),n},t.prototype.drawArrow=function(e,t,o,i,a,r,n,s){var l=!1,p=this.allowShape(e,t);return!this.disabled&&this.isImageLoaded&&p&&(l=!0,this.notify("shape",{prop:"drawArrow",onPropertyChange:!1,value:{startX:e,startY:t,endX:o,endY:i,strokeWidth:a,strokeColor:r,arrowStart:n,arrowEnd:s}})),l},t.prototype.drawPath=function(e,t,o){this.isPublicMethod=!0;var i={inRange:!1},a=!1;if(e.length>0)for(var r=0;r<e.length&&!i.inRange;r++)this.notify("shape",{prop:"isPointsInRange",onPropertyChange:!1,value:{x:e[r].x,y:e[r].y,obj:i}});return!this.disabled&&this.isImageLoaded&&i.inRange&&(a=!0,this.notify("shape",{prop:"drawPath",onPropertyChange:!1,value:{pointColl:e,strokeWidth:t,strokeColor:o}})),a},t.prototype.drawRectangle=function(e,t,o,i,a,r,n){var s=!1,l=this.allowShape(e,t);return!this.disabled&&this.isImageLoaded&&l&&(s=!0,this.notify("shape",{prop:"drawRectangle",onPropertyChange:!1,value:{x:e,y:t,width:o,height:i,strokeWidth:a,strokeColor:r,fillColor:n}})),s},t.prototype.drawText=function(e,t,o,i,a,r,n,s){var l=!1,p=this.allowShape(e,t);return!this.disabled&&this.isImageLoaded&&p&&(l=!0,this.notify("shape",{prop:"drawText",onPropertyChange:!1,value:{x:e,y:t,text:o,fontFamily:i,fontSize:a,bold:r,italic:n,color:s}})),l},t.prototype.selectShape=function(e){var t={isSelected:!1};return this.notify("shape",{prop:"selectShape",onPropertyChange:!1,value:{id:e,obj:t}}),t.isSelected},t.prototype.deleteShape=function(e){this.notify("shape",{prop:"deleteShape",onPropertyChange:!1,value:{id:e}})},t.prototype.getShapeSetting=function(e){var t={};return this.notify("shape",{prop:"getShapeSetting",onPropertyChange:!1,value:{id:e,obj:t}}),t},t.prototype.getShapeSettings=function(){var e={shapeDetailsColl:[]};return this.notify("shape",{prop:"getShapeSettings",onPropertyChange:!1,value:{obj:e}}),e.shapeDetailsColl},t.prototype.update=function(){this.notify("transform",{prop:"update"})},t.prototype.finetuneImage=function(e,t){!this.disabled&&this.isImageLoaded&&this.notify("filter",{prop:"finetuneImage",value:{value:t,option:e}})},t.prototype.applyImageFilter=function(e){!this.disabled&&this.isImageLoaded&&(this.notify("filter",{prop:"applyImageFilter",value:{option:e.toString()}}),this.canvasFilter=this.lowerContext.filter,this.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}))},t.prototype.undo=function(){this.notify("undo-redo",{prop:"undo",onPropertyChange:!1})},t.prototype.redo=function(){this.notify("undo-redo",{prop:"redo",onPropertyChange:!1})},t.prototype.getImageDimension=function(){return{x:this.img.destLeft,y:this.img.destTop,width:this.img.destWidth,height:this.img.destHeight}},t.prototype.toolbarTemplateFn=function(){var e,t=this.element.id+"_toolbar",o=this.element.querySelector("#"+this.element.id+"_toolbarArea");if(this.toolbarTemplate){if(this.toolbarFn=this.templateParser(this.toolbarTemplate),this.isReact)e=this.toolbarFn({type:"toolbar"},this,"Template",t)[0];else if(this.isAngular){var i=this.toolbarFn({type:"toolbar"},this,"Template",t);e=3===i[0].nodeType?i[1]:i[0]}else e=this.toolbarFn({type:"toolbar"},this,"Template",t)[0];o.appendChild(e),this.toolbarHeight=o.clientHeight,this.notify("toolbar",{prop:"setToolbarHeight",value:{height:this.toolbarHeight}}),this.renderReactTemplates()}},t.prototype.quickAccessToolbarTemplateFn=function(){var e,t=this.element.id+"_quickAccessToolbar",o=this.element.querySelector("#"+this.element.id+"_quickAccessToolbarArea");if(this.quickAccessToolbarTemplate){if(this.qatFn=this.templateParser(this.quickAccessToolbarTemplate),this.isReact)e=this.qatFn({type:"toolbar"},this,"Template",t)[0];else if(this.isAngular){var i=this.qatFn({type:"toolbar"},this,"Template",t);e=3===i[0].nodeType?i[1]:i[0]}else e=this.qatFn({type:"toolbar"},this,"Template",t)[0];o.appendChild(e),this.renderReactTemplates()}},t.prototype.templateParser=function(e){if(e)try{return"function"!=typeof e&&document.querySelectorAll(e).length?sf.base.compile(document.querySelector(e).innerHTML.trim()):sf.base.compile(e)}catch(t){return sf.base.compile(e)}},t.prototype.getTextFromId=function(e){return{1:"none",2:"bar",3:"arrow",4:"arrowSolid",5:"circle",6:"circleSolid",7:"square",8:"squareSolid"}[""+e]},t.prototype.getFinetuneOption=function(e){return{brightness:l.Brightness,contrast:l.Contrast,hue:l.Hue,saturation:l.Saturation,opacity:l.Opacity,blur:l.Blur,exposure:l.Exposure}[""+e]},t.prototype.setPenStroke=function(e){this.notify("freehand-draw",{prop:"setPenStrokeWidth",onPropertyChange:!1,value:{value:parseInt(e,10)}})},t.prototype.updateFreehandDrawColorChange=function(){var e={tempFreeHandDrawEditingStyles:null};this.notify("freehand-draw",{prop:"getTempFreeHandDrawEditingStyles",value:{obj:e}}),this.notify("freehand-draw",{prop:"color-change",value:{color:e.tempFreeHandDrawEditingStyles.strokeColor}})},t.prototype.setInitialZoomState=function(){this.objColl.push(this.activeObj),this.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1});var e=this.isUndoRedo;this.isCropTab=!1,this.isUndoRedo=!0,this.transform.cropZoomFactor&&this.transform.cropZoomFactor>0?this.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-this.transform.cropZoomFactor,zoomPoint:null}}):this.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:Math.abs(this.transform.cropZoomFactor),zoomPoint:null}}),this.isUndoRedo=e,this.panPoint.totalPannedPoint={x:0,y:0},this.transform.cropZoomFactor=0,this.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1}),this.activeObj=sf.base.extend({},this.objColl[this.objColl.length-1],{},!0),this.objColl.pop(),this.isCropTab=!0,this.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:this.activeObj}})},t.prototype.updateCropTransformItems=function(){this.prevCurrSelectionPoint=sf.base.extend({},this.currSelectionPoint,{},!0);var e={currObj:{}};this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:e}});var t=e.currObj;t.objColl=sf.base.extend([],this.objColl,[],!0),t.pointColl=sf.base.extend([],this.pointColl,[],!0),t.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0);var o={selPointColl:null};this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:o}}),t.selPointColl=sf.base.extend([],o.selPointColl,[],!0),this.cancelCropSelection={operation:"cropTransform",previousObj:t,currentObj:t,previousObjColl:t.objColl,currentObjColl:t.objColl,previousPointColl:t.pointColl,currentPointColl:t.pointColl,previousSelPointColl:t.selPointColl,currentSelPointColl:t.selPointColl,previousCropObj:sf.base.extend({},this.cropObj,{},!0),currentCropObj:sf.base.extend({},this.cropObj,{},!0),previousText:null,currentText:null,filter:null,isCircleCrop:this.isCircleCrop}},t.prototype.toPascalCase=function(e,t){var o=[];sf.base.isNullOrUndefined(e)||(o=e.toLowerCase().split("-"));for(var i=0;i<o.length;i++)o[i]=o[i].charAt(0).toUpperCase()+o[i].slice(1);return t&&(t.maxText=o.join("")),o.join("")},t.prototype.getFontSizes=function(){var e,t=[];this.fontSizeColl=[],e=0===this.transform.degree||this.transform.degree%180==0?this.img.destWidth/25:this.img.destHeight/25;for(var o=1;o<=10;o++)this.fontSizeColl.push({text:(o*Math.round(e/2)).toString()}),t.push({text:o.toString()});return t},t.prototype.okBtn=function(e){var t,o=!1;void 0!==this.activeObj.shape&&(t=this.activeObj.shape.split("-")),(void 0===t&&this.currObjType.isCustomCrop||void 0!==t&&"crop"===t[0])&&(o=!0);var i=this.element.querySelector(".e-contextual-toolbar-wrapper .e-toolbar-item.e-selected"),a={bool:!1};if(this.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:a}}),i&&(this.currentFilter=i.children[0].children[0].id.replace("Canvas","")),o)this.crop();else if(this.togglePen)this.freeHandDraw(!1),this.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}});else if("block"===this.textArea.style.display)this.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),sf.base.isNullOrUndefined(e)&&this.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}});else if(!sf.base.isBlazor()&&document.querySelector("#"+this.element.id+"_sliderWrapper")||sf.base.isBlazor()&&!this.element.querySelector(".e-ie-contextual-slider").classList.contains("e-hidden")||this.currObjType.isFiltered){this.initialAdjustmentValue=this.canvasFilter=this.lowerContext.filter,this.currObjType.isFiltered=!1;var r={value:null};this.notify("draw",{prop:"getTempAdjustmentValue",value:{obj:r}}),r.value!==this.lowerContext.filter&&this.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}})}else a.bool?(this.notify("freehand-draw",{prop:"applyFhd",onPropertyChange:!1}),this.notify("selection",{prop:"setFreehandDrawCustomized",value:{isFreehandDrawCustomized:!1}}),sf.base.isBlazor()?this.updateToolbar(this.element,"destroyQuickAccessToolbar"):this.notify("toolbar",{prop:"destroy-qa-toolbar"}),this.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}})):(0!==this.activeObj.activePoint.width&&0!==this.activeObj.activePoint.height||"path"===this.activeObj.shape&&this.activeObj.pointColl.length>0)&&this.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:e}});sf.base.isBlazor()||a.isCropToolbar||this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:!1,isCropping:null,isZooming:null,cType:null}}),this.notify("draw",{prop:"setNewPath",value:{bool:!1}}),this.isCropTab=!1,this.transform.zoomFactor=this.transform.defaultZoomFactor,this.notify("selection",{prop:"setCurrentDrawingShape",onPropertyChange:!1,value:{value:""}})},t.prototype.setTempFilterProperties=function(){this.upperCanvas.style.display="block",this.cropSelectedState();var e={adjustmentLevel:null};this.notify("filter",{prop:"getAdjustmentLevel",onPropertyChange:!1,value:{obj:e}}),this.lowerContext.filter=this.initialAdjustmentValue,this.notify("draw",{prop:"setTempAdjustmentValue",value:{tempAdjustmentValue:this.lowerContext.filter}}),this.notify("filter",{prop:"setTempAdjustmentLevel",onPropertyChange:!1,value:{tempAdjustmentLevel:sf.base.extend({},e.adjustmentLevel,{},!0)}}),this.notify("draw",{prop:"setTempFilter",value:{tempFilter:this.currentFilter}});var t={undoRedoStep:null};this.notify("undo-redo",{prop:"getUndoRedoStep",value:{obj:t}}),this.notify("draw",{prop:"setTempUndoRedoStep",value:{tempUndoRedoStep:t.undoRedoStep}})},t.prototype.cropSelectedState=function(){this.activeObj.shape&&"crop"===this.activeObj.shape.split("-")[0]&&this.okBtn()},t.prototype.getCurrentCanvasData=function(){var e=this.lowerContext.filter;this.lowerContext.filter=this.canvasFilter="none";var t=sf.base.extend([],this.objColl,null,!0),o=sf.base.extend([],this.pointColl,null,!0);this.objColl=[],this.pointColl=[],this.freehandCounter=0,this.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}});var i=this.getImageData();return sf.base.isBlazor()||(this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:!0,isCropping:!1}}),this.element.querySelector("#"+this.element.id+"_contextualToolbarArea").classList.remove("e-hide")),this.objColl=t,this.pointColl=o,this.freehandCounter=o.length,this.notify("shape",{prop:"iterateObjColl",onPropertyChange:!1}),this.lowerContext.filter=this.canvasFilter=e,i},t.prototype.setCurrAdjustmentValue=function(e,t){var o=this,i={finetune:this.getFinetuneOption(e),value:t,cancel:!1};if(sf.base.isBlazor()&&this.events&&!0===this.events.finetuneValueChanging.hasDelegate)this.dotNetRef.invokeMethodAsync("OnFinetuneValueChangeAsync",i).then((function(i){i.cancel||o.notify("filter",{prop:"setCurrAdjValue",value:{type:e.toLowerCase(),value:t}})}));else{if(this.trigger("finetuneValueChanging",i),i.cancel)return;this.notify("filter",{prop:"setCurrAdjValue",value:{type:e.toLowerCase(),value:t}})}},t.prototype.getSquarePointForPath=function(e){var t={startX:0,startY:0,endX:0,endY:0,width:0,height:0};if(e.pointColl.length>0){t={startX:e.pointColl[0].x,startY:e.pointColl[0].y,endX:e.pointColl[0].x,endY:e.pointColl[0].y};for(var o=1;o<e.pointColl.length;o++)e.pointColl[o].x<t.startX&&(t.startX=e.pointColl[o].x),e.pointColl[o].y<t.startY&&(t.startY=e.pointColl[o].y),e.pointColl[o].x>t.endX&&(t.endX=e.pointColl[o].x),e.pointColl[o].y>t.endY&&(t.endY=e.pointColl[o].y);t.width=t.endX-t.startX,t.height=t.endY-t.startY}return t},t.prototype.getSelectionType=function(e){return{CropCustom:"Custom",CropSquare:"Square",CropCircle:"Circle","Crop3:2":"3:2","Crop4:3":"4:3","Crop5:4":"5:4","Crop7:5":"7:5","Crop16:9":"16:9"}[""+e]},t.prototype.clearContext=function(e){e.clearRect(0,0,e.canvas.width,e.canvas.height),e.clearRect(0,0,e.canvas.height,e.canvas.width)},t.prototype.updateArrow=function(e,t){this.notify("shape",{prop:"pushActItemIntoObj"});var o=sf.base.extend({},this.cropObj,{},!0),i={currObj:{}};this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:i}});var a=i.currObj;(a.objColl=sf.base.extend([],this.objColl,[],!0),a.pointColl=sf.base.extend([],this.pointColl,[],!0),a.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0),this.objColl.pop(),"startArrow"===e?this.activeObj.start=this.getTextFromId(t):"endArrow"===e&&(this.activeObj.end=this.getTextFromId(t)),this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:null,strokeWidth:this.activeObj.strokeSettings.strokeWidth}}),this.objColl.push(this.activeObj),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:a,previousObjColl:a.objColl,previousPointColl:a.pointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}}),sf.base.isBlazor())||(sf.base.Browser.isDevice?document.getElementById(this.element.id+"_bottomToolbar")&&sf.base.getComponent(this.element.id+"_bottomToolbar","toolbar").refreshOverflow():document.getElementById(this.element.id+"_toolbar")&&sf.base.getComponent(this.element.id+"_toolbar","toolbar").refreshOverflow())},t.prototype.updateFontFamily=function(e){this.notify("selection",{prop:"setInitialTextEdit",value:{bool:!1}}),this.notify("shape",{prop:"pushActItemIntoObj"});var t=sf.base.extend([],this.objColl,[],!0),o=sf.base.extend({},this.cropObj,{},!0),i={currObj:{}};this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:i}});var a=i.currObj;a.objColl=sf.base.extend([],this.objColl,[],!0),a.pointColl=sf.base.extend([],this.pointColl,[],!0),a.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0);var r={selPointColl:null};if(this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:r}}),a.selPointColl=sf.base.extend([],r.selPointColl,[],!0),this.objColl.pop(),"block"===this.textArea.style.display){this.notify("shape",{prop:"updateFontRatio",onPropertyChange:!1,value:{obj:this.activeObj,isTextArea:!0}});var n=this.activeObj.textSettings.fontFamily;this.activeObj.textSettings.fontFamily=this.toPascalCase(e),this.notify("shape",{prop:"redraw-text"}),this.objColl.push(this.activeObj),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"textAreaCustomization",previousObj:a,previousObjColl:a.objColl,previousPointColl:a.pointColl,previousSelPointColl:a.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.objColl.pop(),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height);var s=this.activeObj.activePoint.width+.25*this.activeObj.textSettings.fontSize;this.textArea.style.width=s+"px",this.textArea.style.fontFamily=this.toPascalCase(e),this.activeObj.textSettings.fontFamily=n,this.notify("shape",{prop:"updateFontStyles",onPropertyChange:!1,value:{isTextBox:null}})}else{this.notify("shape",{prop:"updateFontRatio",onPropertyChange:!1,value:{obj:this.activeObj,isTextArea:null}});var l=this.activeObj.textSettings.fontFamily=this.toPascalCase(e);this.notify("shape",{prop:"setTextSettings",onPropertyChange:!1,value:{textSettings:null,fontFamily:l,fontSize:null}}),this.notify("shape",{prop:"redraw-text"}),this.objColl.push(this.activeObj),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:a,previousObjColl:t,previousPointColl:sf.base.extend([],this.pointColl,[],!0),previousSelPointColl:a.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}})}},t.prototype.updateFontSize=function(e){var t=e;this.notify("selection",{prop:"setInitialTextEdit",value:{bool:!1}}),this.notify("shape",{prop:"pushActItemIntoObj"});var o=sf.base.extend({},this.cropObj,{},!0),i={currObj:{}};this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:i}});var a=i.currObj;a.objColl=sf.base.extend([],this.objColl,[],!0),a.pointColl=sf.base.extend([],this.pointColl,[],!0),a.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0);var r={selPointColl:null};if(this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:r}}),a.selPointColl=sf.base.extend([],r.selPointColl,[],!0),this.objColl.pop(),"block"===this.textArea.style.display){this.notify("shape",{prop:"updateFontRatio",onPropertyChange:!1,value:{obj:this.activeObj,isTextArea:!0}});var n=this.activeObj.textSettings.fontSize;this.activeObj.textSettings.fontSize=parseInt(this.fontSizeColl[parseInt(t,10)-1].text,10),this.objColl.push(this.activeObj),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"textAreaCustomization",previousObj:a,previousObjColl:a.objColl,previousPointColl:a.pointColl,previousSelPointColl:a.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.objColl.pop();var s="";"bold"===this.textArea.style.fontWeight&&(s="bold "),"italic"===this.textArea.style.fontStyle&&(s="italic "),"bold"===this.textArea.style.fontWeight&&"italic"===this.textArea.style.fontStyle&&(s="italic bold "),this.upperContext.font=s+this.activeObj.textSettings.fontSize+"px "+this.textArea.style.fontFamily;var l=this.textArea.value.split("\n"),p={maxText:""};this.notify("shape",{prop:"getMaxText",onPropertyChange:!1,value:{isTextBox:!0,text:null,obj:p}});var h=p.maxText,c=this.upperContext.measureText(h).width+.5*this.activeObj.textSettings.fontSize;this.textArea.style.width=c+"px",this.textArea.style.height=l.length*(this.activeObj.textSettings.fontSize+.25*this.activeObj.textSettings.fontSize)+"px",this.activeObj.textSettings.fontSize=n,this.upperContext.font=this.activeObj.textSettings.fontSize+"px "+this.activeObj.textSettings.fontFamily,this.textArea.style.fontSize=parseInt(this.fontSizeColl[parseInt(t,10)-1].text,10)+"px","georgia"===this.textArea.style.fontFamily&&(this.textArea.style.width=parseFloat(this.textArea.style.width)+parseFloat(this.textArea.style.fontSize)+"px")}else{this.notify("shape",{prop:"updateFontRatio",onPropertyChange:!1,value:{obj:this.activeObj,isTextArea:null}});var d=this.activeObj.textSettings.fontSize=parseInt(this.fontSizeColl[parseInt(t,10)-1].text,10);this.notify("shape",{prop:"setTextSettings",onPropertyChange:!1,value:{textSettings:null,fontFamily:null,fontSize:d}}),this.upperContext.font=this.activeObj.textSettings.fontSize+"px "+this.activeObj.textSettings.fontFamily;l=this.activeObj.keyHistory.split("\n"),p={maxText:""};this.notify("shape",{prop:"getMaxText",onPropertyChange:!1,value:{isTextBox:null,text:null,obj:p}});var v=p.maxText,u=(c=this.upperContext.measureText(v).width+.5*this.activeObj.textSettings.fontSize,l.length*(this.activeObj.textSettings.fontSize+.25*this.activeObj.textSettings.fontSize));this.notify("selection",{prop:"setTextSelection",onPropertyChange:!1,value:{width:c,height:u}}),this.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:this.activeObj.activePoint,obj:this.activeObj,isMouseMove:null,x:null,y:null}}),this.notify("shape",{prop:"redraw-text"}),this.objColl.push(this.activeObj),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:a,previousObjColl:a.objColl,previousPointColl:a.pointColl,previousSelPointColl:a.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}})}},t.prototype.updateFontColor=function(e){this.notify("selection",{prop:"setInitialTextEdit",value:{bool:!1}}),this.notify("shape",{prop:"pushActItemIntoObj"});var t=sf.base.extend({},this.cropObj,{},!0),o={currObj:{}};this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:o}});var i=o.currObj;i.objColl=sf.base.extend([],this.objColl,[],!0),i.pointColl=sf.base.extend([],this.pointColl,[],!0),i.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0);var a={selPointColl:null};if(this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:a}}),i.selPointColl=sf.base.extend([],a.selPointColl,[],!0),this.objColl.pop(),"none"===this.textArea.style.display)this.activeObj.strokeSettings.strokeColor=e,this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:this.activeObj.strokeSettings.strokeColor,fillColor:null,strokeWidth:null}}),this.togglePen||(this.objColl.push(this.activeObj),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:i,previousObjColl:i.objColl,previousPointColl:i.pointColl,previousSelPointColl:i.selPointColl,previousCropObj:t,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}}));else if("block"===this.textArea.style.display){this.textArea.style.color=e;var r=this.activeObj.strokeSettings.strokeColor;this.activeObj.strokeSettings.strokeColor=e,this.objColl.push(this.activeObj),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"textAreaCustomization",previousObj:i,previousObjColl:i.objColl,previousPointColl:i.pointColl,previousSelPointColl:i.selPointColl,previousCropObj:t,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.objColl.pop(),this.activeObj.strokeSettings.strokeColor=r}else this.togglePen||(this.objColl.push(this.activeObj),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:i,previousObjColl:i.objColl,previousPointColl:i.pointColl,previousSelPointColl:i.selPointColl,previousCropObj:t,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}}))},t.prototype.updatePenStrokeWidth=function(e){var t=sf.base.extend([],this.pointColl,[],!0);this.updateFreehandDrawColorChange();var o=sf.base.extend({},this.cropObj,{},!0),i={currObj:{}};this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:i}});var a=i.currObj;a.objColl=sf.base.extend([],this.objColl,[],!0),a.pointColl=sf.base.extend([],this.pointColl,[],!0),a.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0);var r={selPointColl:null};this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:r}}),a.selPointColl=sf.base.extend([],r.selPointColl,[],!0),this.pointColl=t,this.notify("selection",{prop:"setFreehandDrawCustomized",value:{isFreehandDrawCustomized:!0}}),this.setPenStroke(e);var n={bool:!1};if(this.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:n}}),n.bool){var s={penStrokeWidth:null};this.notify("freehand-draw",{prop:"getPenStrokeWidth",onPropertyChange:!1,value:{obj:s}}),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.notify("freehand-draw",{prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:null,strokeWidth:s.penStrokeWidth}});var l={freehandSelectedIndex:null};this.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:l}}),this.pointColl[l.freehandSelectedIndex].strokeWidth=s.penStrokeWidth,this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"freehanddrawCustomized",previousObj:a,previousObjColl:a.objColl,previousPointColl:a.pointColl,previousSelPointColl:a.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}})}},t.prototype.updatePenStrokeColor=function(e){var t=sf.base.extend([],this.pointColl,[],!0);this.updateFreehandDrawColorChange();var o=sf.base.extend({},this.cropObj,{},!0),i={currObj:{}};this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:i}});var a=i.currObj;a.objColl=sf.base.extend([],this.objColl,[],!0),a.pointColl=sf.base.extend([],this.pointColl,[],!0),a.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0);var r={selPointColl:null};this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:r}}),a.selPointColl=sf.base.extend([],r.selPointColl,[],!0),this.pointColl=t,this.notify("selection",{prop:"setFreehandDrawCustomized",value:{isFreehandDrawCustomized:!0}}),this.activeObj.strokeSettings.strokeColor=e;var n={bool:!1};if(this.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:n}}),n.bool){var s={freehandSelectedIndex:null};this.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:s}}),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.pointColl[s.freehandSelectedIndex].strokeColor=e,this.notify("freehand-draw",{prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:e}}),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"freehanddrawCustomized",previousObj:a,previousObjColl:a.objColl,previousPointColl:a.pointColl,previousSelPointColl:a.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}})}else this.togglePen||this.notify("selection",{prop:"redrawShape",value:{obj:this.activeObj}})},t.prototype.updateStrokeWidth=function(e){this.notify("shape",{prop:"pushActItemIntoObj"});var t=sf.base.extend({},this.cropObj,{},!0),o={currObj:{}};this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:o}});var i=o.currObj;i.objColl=sf.base.extend([],this.objColl,[],!0),i.pointColl=sf.base.extend([],this.pointColl,[],!0),i.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0);var a={selPointColl:null};this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:a}}),i.selPointColl=sf.base.extend([],a.selPointColl,[],!0),this.objColl.pop(),this.activeObj.strokeSettings.strokeWidth=parseInt(e,10),this.activeObj.strokeSettings.strokeWidth*=2,this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:null,strokeWidth:this.activeObj.strokeSettings.strokeWidth}}),this.objColl.push(this.activeObj),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:i,previousObjColl:i.objColl,previousPointColl:i.pointColl,previousSelPointColl:i.selPointColl,previousCropObj:t,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}})},t.prototype.updateStrokeColor=function(e){this.notify("shape",{prop:"pushActItemIntoObj"});var t=sf.base.extend({},this.cropObj,{},!0),o={currObj:{}};this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:o}});var i=o.currObj;i.objColl=sf.base.extend([],this.objColl,[],!0),i.pointColl=sf.base.extend([],this.pointColl,[],!0),i.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0);var a={selPointColl:null};this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:a}}),i.selPointColl=sf.base.extend([],a.selPointColl,[],!0),this.objColl.pop(),this.activeObj.strokeSettings.strokeColor=e,this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:this.activeObj.strokeSettings.strokeColor,fillColor:null,strokeWidth:null}}),this.togglePen||(this.objColl.push(this.activeObj),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:i,previousObjColl:i.objColl,previousPointColl:i.pointColl,previousSelPointColl:i.selPointColl,previousCropObj:t,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}}))},t.prototype.updateFillColor=function(e){this.notify("shape",{prop:"pushActItemIntoObj"});var t=sf.base.extend({},this.cropObj,{},!0),o={currObj:{}};this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:o}});var i=o.currObj;i.objColl=sf.base.extend([],this.objColl,[],!0),i.pointColl=sf.base.extend([],this.pointColl,[],!0),i.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0);var a={selPointColl:null};this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:a}}),i.selPointColl=sf.base.extend([],a.selPointColl,[],!0),this.objColl.pop(),this.activeObj.strokeSettings.fillColor=e,this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:this.activeObj.strokeSettings.fillColor,strokeWidth:null}}),this.objColl.push(this.activeObj),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:i,previousObjColl:i.objColl,previousPointColl:i.pointColl,previousSelPointColl:i.selPointColl,previousCropObj:t,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}})},t.prototype.pascalToSplitWords=function(e){var t=(e=e.charAt(0).toUpperCase()+e.slice(1)).match(/[A-Z][a-z]+/g);return sf.base.isNullOrUndefined(t)?e:t.map((function(e){return e.charAt(0).toUpperCase()+e.slice(1)})).join(" ")},t.prototype.getCurrAdjustmentValue=function(e){var t={adjustmentLevel:null};return this.notify("filter",{prop:"getAdjustmentLevel",onPropertyChange:!1,value:{obj:t}}),{brightness:t.adjustmentLevel.brightness,contrast:t.adjustmentLevel.contrast,hue:t.adjustmentLevel.hue,saturation:t.adjustmentLevel.saturation,opacity:t.adjustmentLevel.opacity,blur:t.adjustmentLevel.blur,exposure:t.adjustmentLevel.exposure}[""+e]},t.prototype.transformSelect=function(e){this.isCropToolbar=!0,this.setInitialZoomState();var t=sf.base.extend({},this.activeObj,{},!0);this.cropSelectedState(),this.notify("draw",{prop:"resetCurrentSelectionPoint"}),this.notify("transform",{prop:"performTransformation",value:{text:e}}),this.notify("draw",{prop:"moveToSelectionRange",value:{type:e,activeObj:t}}),this.isCropToolbar=!1},t.prototype.getDefaultFilter=function(){return"brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)"},t.prototype.initializeImageEditor=function(e,t){this.element=e;var o=this.element.querySelector(".e-canvas-wrapper");this.element.querySelector("#"+this.element.id+"_toolbar")?this.toolbarHeight=this.element.querySelector("#"+this.element.id+"_toolbar").clientHeight:this.toolbarHeight=0,o.style.height=this.element.offsetHeight-this.toolbarHeight-2+"px",o.style.width=this.element.offsetWidth-2+"px",this.lowerCanvas=this.element.querySelector(".e-lower-canvas"),this.upperCanvas=this.element.querySelector(".e-upper-canvas"),this.lowerCanvas.id=this.element.id+"_lowerCanvas",this.upperCanvas.id=this.element.id+"_upperCanvas",this.textArea=this.element.querySelector(".e-textbox"),this.inMemoryCanvas=this.createElement("canvas",{id:this.element.id+"_inMemoryCanvas",attrs:{name:"canvasImage"}}),this.upperCanvas.width=this.lowerCanvas.width=this.inMemoryCanvas.width=this.element.offsetWidth,this.upperCanvas.height=this.lowerCanvas.height=this.inMemoryCanvas.height=this.element.offsetHeight-this.toolbarHeight,this.baseImg=this.createElement("img",{id:this.element.id+"_orgImg",attrs:{name:"Image",crossorigin:"anonymous"}}),this.lowerContext=this.lowerCanvas.getContext("2d"),this.baseImg=this.createElement("img",{id:this.element.id+"_orgImg",attrs:{name:"Image",crossorigin:"anonymous"}}),this.upperContext=this.upperCanvas.getContext("2d"),this.inMemoryContext=this.inMemoryCanvas.getContext("2d"),t&&(this.dotNetRef=t),this.prerender(),this.wireEvent(),this.lowerContext.filter=this.getDefaultFilter(),this.notify("filter",{prop:"setAdjustmentValue",onPropertyChange:!1,value:{adjustmentValue:this.lowerContext.filter}}),this.canvasFilter=this.initialAdjustmentValue=this.lowerContext.filter,this.cssClass&&sf.base.addClass([this.element],this.cssClass.replace(/\s+/g," ").trim().split(" ")),this.element&&sf.popups.createSpinner({target:this.element}),this.initializeZoomSettings()},t.prototype.prerender=function(){this.element.id=this.element.id||sf.base.getUniqueID("ej2-image-editor"),sf.base.Browser.isDevice&&this.element.classList.add("e-device"),this.initializeThemeColl()},t.prototype.initializeZoomSettings=function(){sf.base.isNullOrUndefined(this.zoomSettings.zoomTrigger)&&(this.zoomSettings.zoomTrigger=a.MouseWheel|a.Pinch|a.Toolbar|a.Commands),sf.base.isNullOrUndefined(this.selectionSettings.strokeColor)&&(this.selectionSettings.strokeColor=this.themeColl[this.theme].primaryColor),sf.base.isNullOrUndefined(this.selectionSettings.fillColor)&&(this.selectionSettings.fillColor=this.themeColl[this.theme].secondaryColor)},t.prototype.initializeThemeColl=function(){this.themeColl={Bootstrap5:{primaryColor:"#0d6efd",secondaryColor:"#fff"},Bootstrap5Dark:{primaryColor:"#0d6efd",secondaryColor:"#fff"},Tailwind:{primaryColor:"#4f46e5",secondaryColor:"#fff"},TailwindDark:{primaryColor:"#22d3ee",secondaryColor:"#fff"},Fluent:{primaryColor:"#0078d4",secondaryColor:"#fff"},FluentDark:{primaryColor:"#0078d4",secondaryColor:"#fff"},Bootstrap4:{primaryColor:"#007bff",secondaryColor:"#fff"},Bootstrap:{primaryColor:"#317ab9",secondaryColor:"#fff"},BootstrapDark:{primaryColor:"#317ab9",secondaryColor:"#fff"},Material:{primaryColor:"#e3165b",secondaryColor:"#fff"},MaterialDark:{primaryColor:"#00b0ff",secondaryColor:"#fff"},Fabric:{primaryColor:"#0078d6",secondaryColor:"#fff"},FabricDark:{primaryColor:"#0074cc",secondaryColor:"#fff"},Highcontrast:{primaryColor:"#000000",secondaryColor:"#fff"},Material3:{primaryColor:"#6750a4",secondaryColor:"#fff"},Material3Dark:{primaryColor:"#d0bcff",secondaryColor:"#fff"}}},t.prototype.updateToolbar=function(e,t,o){},O([sf.base.Property("")],t.prototype,"cssClass",void 0),O([sf.base.Property(!1)],t.prototype,"disabled",void 0),O([sf.base.Property("100%")],t.prototype,"height",void 0),O([sf.base.Property("Bootstrap5")],t.prototype,"theme",void 0),O([sf.base.Property()],t.prototype,"toolbar",void 0),O([sf.base.Property()],t.prototype,"toolbarTemplate",void 0),O([sf.base.Property("100%")],t.prototype,"width",void 0),O([sf.base.Property(!0)],t.prototype,"allowUndoRedo",void 0),O([sf.base.Property(!0)],t.prototype,"showQuickAccessToolbar",void 0),O([sf.base.Property()],t.prototype,"quickAccessToolbarTemplate",void 0),O([sf.base.Property(!1)],t.prototype,"isReadOnly",void 0),O([sf.base.Property(!1)],t.prototype,"enableRtl",void 0),O([sf.base.Property(!1)],t.prototype,"enablePersistence",void 0),O([sf.base.Complex({},x)],t.prototype,"finetuneSettings",void 0),O([sf.base.Complex({},w)],t.prototype,"zoomSettings",void 0),O([sf.base.Complex({},S)],t.prototype,"selectionSettings",void 0),O([sf.base.Event()],t.prototype,"beforeSave",void 0),O([sf.base.Event()],t.prototype,"created",void 0),O([sf.base.Event()],t.prototype,"destroyed",void 0),O([sf.base.Event()],t.prototype,"zooming",void 0),O([sf.base.Event()],t.prototype,"panning",void 0),O([sf.base.Event()],t.prototype,"cropping",void 0),O([sf.base.Event()],t.prototype,"rotating",void 0),O([sf.base.Event()],t.prototype,"flipping",void 0),O([sf.base.Event()],t.prototype,"shapeChanging",void 0),O([sf.base.Event()],t.prototype,"selectionChanging",void 0),O([sf.base.Event()],t.prototype,"fileOpened",void 0),O([sf.base.Event()],t.prototype,"saved",void 0),O([sf.base.Event()],t.prototype,"toolbarCreated",void 0),O([sf.base.Event()],t.prototype,"toolbarUpdating",void 0),O([sf.base.Event()],t.prototype,"toolbarItemClicked",void 0),O([sf.base.Event()],t.prototype,"imageFiltering",void 0),O([sf.base.Event()],t.prototype,"finetuneValueChanging",void 0),O([sf.base.Event()],t.prototype,"click",void 0),O([sf.base.Event()],t.prototype,"quickAccessToolbarOpen",void 0),O([sf.base.Event()],t.prototype,"quickAccessToolbarItemClick",void 0),t=o=O([sf.base.NotifyPropertyChanges],t)}(sf.base.Component),k=(y=function(e,t){return(y=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])})(e,t)},function(e,t){function o(){this.constructor=e}y(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}),L=function(e,t,o,i,a){this.dataId=e,this.element=t,this.element.id=o.id,window.sfBlazor.setCompInstance(this),this.dotNetRef=a,this.imageEditorBase=new A,this.imageEditorBase.cssClass=o.cssClass,this.imageEditorBase.disabled=o.disabled,this.imageEditorBase.height=o.height,this.imageEditorBase.theme=o.theme,this.imageEditorBase.width=o.width,this.imageEditorBase.allowUndoRedo=o.allowUndoRedo,this.imageEditorBase.isReadOnly=o.isReadOnly,this.imageEditorBase.enableRtl=o.enableRtl,this.imageEditorBase.zoomSettings=o.zoomSettings,this.imageEditorBase.selectionSettings=o.selectionSettings,this.imageEditorBase.finetuneSettings=o.finetuneSettings,this.imageEditorBase.events=i,this.imageEditorBase.showQuickAccessToolbar=o.showQuickAccessToolbar,this.imageEditorBase.quickAccessToolbarTemplate=o.quickAccessToolbarTemplate},A=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.currentToolbar="main-toolbar",t.CTTOOLBAR=".e-ie-contextual-toolbar",t.CTWRAPPER=".e-contextual-toolbar-wrapper",t.CHECKBTN=".e-ie-toolbar-check-btn",t.CLOSEBTN=".e-ie-toolbar-close-btn",t.ANNOTATEBTN=".e-ie-toolbar-annotation",t.MAINSEP=".e-ie-toolbar-main-separator",t.MCLONEBTN=".e-ie-toolbar-main-clone-btn",t.MDELBTN=".e-ie-toolbar-main-delete-btn",t.MEDITBTN=".e-ie-toolbar-main-editText-btn",t.CLONEBTN=".e-ie-toolbar-clone-btn",t.DELBTN=".e-ie-toolbar-delete-btn",t.EDITBTN=".e-ie-toolbar-editText-btn",t.FONTFAM=".e-ie-toolbar-e-font-family",t.FONTSIZE=".e-ie-toolbar-e-font-size",t.FONTCLR=".e-ie-toolbar-e-font-color",t.SHAPECLR=".e-ie-toolbar-e-shape-color",t.LINECLR=".e-ie-toolbar-e-line-color",t.PENCLR=".e-ie-toolbar-e-pen-color",t.SHAPEFILLCLR=".e-ie-toolbar-e-shape-fill-color",t.DDBPREVIEW=" .e-dropdownbtn-preview",t.BOLDBTN=".e-ie-toolbar-bold-btn",t.ITALICBTN=".e-ie-toolbar-italic-btn",t}return k(t,e),t.prototype.onPropertyChanged=function(){},t.prototype.preRender=function(){},t.prototype.render=function(){},t.prototype.wireZoomBtnEvents=function(){var e=this.element.querySelector("#zoomin"),t=this.element.querySelector("#zoomout");e&&e.addEventListener("click",this.zoomInBtnClickHandler.bind(this)),t&&t.addEventListener("click",this.zoomOutBtnClickHandler.bind(this))},t.prototype.zoomInBtnClickHandler=function(e){if((this.zoomSettings.zoomTrigger&a.Toolbar)===a.Toolbar){if(this.refreshShapeDrawing(),sf.base.Browser.isDevice&&"touchstart"===e.type){if(!e.returnValue)return;e.preventDefault()}var t={bool:!1};this.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:t}}),t.bool&&this.notify("freehand-draw",{prop:"applyFhd",onPropertyChange:!1}),this.applyPreviewFilter(),this.currObjType.isFiltered=!1,this.togglePen&&(this.currObjType.isZoomed=!0,this.freeHandDraw(!1),this.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}})),this.notify("draw",{prop:"resetCurrentSelectionPoint"}),this.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:.1,zoomPoint:null}})}},t.prototype.zoomOutBtnClickHandler=function(e){if((this.zoomSettings.zoomTrigger&a.Toolbar)===a.Toolbar){if(this.refreshShapeDrawing(),sf.base.Browser.isDevice&&"touchstart"===e.type){if(!e.returnValue)return;e.preventDefault()}var t={bool:!1};this.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:t}}),t.bool&&this.notify("freehand-draw",{prop:"applyFhd",onPropertyChange:!1}),this.applyPreviewFilter(),this.currObjType.isFiltered=!1,this.togglePen&&(this.currObjType.isZoomed=!0,this.freeHandDraw(!1),this.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}})),this.notify("draw",{prop:"resetCurrentSelectionPoint"}),this.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.1,zoomPoint:null}})}},t.prototype.applyPreviewFilter=function(){(document.querySelector("#"+this.element.id+"_sliderWrapper")||this.currObjType.isFiltered)&&(this.initialAdjustmentValue=this.canvasFilter=this.lowerCanvas.getContext("2d").filter,this.currObjType.isFiltered=!1)},t.prototype.refreshShapeDrawing=function(){var e={shape:""};this.notify("selection",{prop:"getCurrentDrawingShape",onPropertyChange:!1,value:{obj:e}}),""!==e.shape&&(this.notify("selection",{prop:"setCurrentDrawingShape",onPropertyChange:!1,value:{value:""}}),this.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.updateToolbar(this.element,"imageLoaded"))},t.prototype.updateToolbar=function(e,t,o){switch(t){case"imageLoaded":switch(this.currentToolbar){case"text-toolbar":this.updateTextToolbar(e,!1);break;case"line-toolbar":this.updateLineToolbar(e,!1);break;case"arrow-toolbar":this.updateArrowToolbar(e,!1),this.updateLineToolbar(e,!1);break;case"rectangle-toolbar":this.updateRectangleToolbar(e,!1);break;case"crop-toolbar":this.updateCropToolbar(e,!1);break;case"contextual-toolbar":this.updateContextualToolbar(e,!1),"okBtnClick"===o&&this.okBtn();break;case"pen-toolbar":this.updatePenToolbar(e,!1)}"main-toolbar"!==this.currentToolbar&&(this.updateMainToolbar(e,!0),this.queryToAddRemoveClass(e,this.CHECKBTN,"e-hidden",!1),this.queryToAddRemoveClass(e,this.CLOSEBTN,"e-hidden",!1)),"initial"===o&&(this.queryToAddRemoveClass(e,".e-ie-toolbar-undo","e-hidden",!0),this.queryToAddRemoveClass(e,".e-ie-toolbar-redo","e-hidden",!0),this.queryToAddRemoveClass(e,".e-ie-toolbar-zoom-in","e-hidden",!0),this.queryToAddRemoveClass(e,".e-ie-toolbar-zoom-out","e-hidden",!0),this.updateMainToolbar(e,!0),this.updateRightToolbar(e,!0)),this.enableDisableToolbarBtn(),"quick-access-toolbar"===this.quickAccessToolbar&&this.destroyQuickAccessToolbar(),this.currentToolbar="main-toolbar";break;case"line":case"path":switch(this.currentToolbar){case"main-toolbar":this.updateMainToolbar(e,!1);break;case"rectangle-toolbar":this.updateRectangleToolbar(e,!1);break;case"text-toolbar":this.updateTextToolbar(e,!1);break;case"arrow-toolbar":this.updateArrowToolbar(e,!1);break;case"pen-toolbar":this.updatePenToolbar(e,!1)}"line"===t||"pathQuickAccessToolbar"===o?(this.queryToAddRemoveClass(e,this.CHECKBTN,"e-hidden",!0),this.queryToAddRemoveClass(e,this.CLOSEBTN,"e-hidden",!0)):"path"===t&&(this.queryToAddRemoveClass(e,this.CHECKBTN,"e-hidden",!1),this.queryToAddRemoveClass(e,this.CLOSEBTN,"e-hidden",!1)),this.updateLineToolbar(e,!0,o),this.updateColorToolbar(this.element,this.activeObj.strokeSettings,t),this.currentToolbar="line-toolbar";break;case"arrow":switch(this.currentToolbar){case"main-toolbar":this.updateMainToolbar(e,!1);break;case"rectangle-toolbar":this.updateRectangleToolbar(e,!1);break;case"text-toolbar":this.updateTextToolbar(e,!1);break;case"pen-toolbar":this.updatePenToolbar(e,!1)}"arrow-toolbar"!==this.currentToolbar&&(this.updateLineToolbar(e,!0),this.updateArrowToolbar(e,!0),this.updateColorToolbar(this.element,this.activeObj.strokeSettings,t),this.queryToAddRemoveClass(e,this.CHECKBTN,"e-hidden",!0),this.queryToAddRemoveClass(e,this.CLOSEBTN,"e-hidden",!0)),this.currentToolbar="arrow-toolbar";break;case"text":switch(this.currentToolbar){case"main-toolbar":this.updateMainToolbar(e,!1);break;case"rectangle-toolbar":this.updateRectangleToolbar(e,!1);break;case"line-toolbar":this.updateLineToolbar(e,!1);break;case"arrow-toolbar":this.updateLineToolbar(e,!1),this.updateArrowToolbar(e,!1);break;case"pen-toolbar":this.updatePenToolbar(e,!1)}"text-toolbar"!==this.currentToolbar&&(this.updateTextToolbar(e,!0),this.updateColorToolbar(this.element,this.activeObj.strokeSettings,t),this.queryToAddRemoveClass(e,this.CHECKBTN,"e-hidden",!0),this.queryToAddRemoveClass(e,this.CLOSEBTN,"e-hidden",!0)),this.currentToolbar="text-toolbar";break;case"rectangle":case"ellipse":switch(this.currentToolbar){case"main-toolbar":this.updateMainToolbar(e,!1);break;case"line-toolbar":this.updateLineToolbar(e,!1);break;case"text-toolbar":this.updateTextToolbar(e,!1);break;case"arrow-toolbar":this.updateArrowToolbar(e,!1),this.updateLineToolbar(e,!1);break;case"pen-toolbar":this.updatePenToolbar(e,!1)}"rectangle-toolbar"!==this.currentToolbar&&(this.updateRectangleToolbar(e,!0),this.updateColorToolbar(this.element,this.activeObj.strokeSettings,t),this.queryToAddRemoveClass(e,this.CHECKBTN,"e-hidden",!0),this.queryToAddRemoveClass(e,this.CLOSEBTN,"e-hidden",!0)),this.currentToolbar="rectangle-toolbar";break;case"cropToolbar":"contextual-toolbar"===this.currentToolbar&&this.updateContextualToolbar(e,!1),this.updateMainToolbar(e,!1),this.updateCropToolbar(e,!0),this.queryToAddRemoveClass(e,this.CHECKBTN,"e-hidden",!0),this.queryToAddRemoveClass(e,this.CLOSEBTN,"e-hidden",!0),this.currentToolbar="crop-toolbar";break;case"pen":switch(this.currentToolbar){case"main-toolbar":this.updateMainToolbar(e,!1);break;case"rectangle-toolbar":this.updateRectangleToolbar(e,!1);break;case"line-toolbar":this.updateLineToolbar(e,!1);break;case"text-toolbar":this.updateTextToolbar(e,!1);break;case"arrow-toolbar":this.updateArrowToolbar(e,!1),this.updateLineToolbar(e,!1)}"pen-toolbar"!==this.currentToolbar&&(this.updatePenToolbar(e,!0),this.updateColorToolbar(this.element,this.activeObj.strokeSettings,t)),this.currentToolbar="pen-toolbar";break;case"enableDisableToolbarBtn":this.enableDisableToolbarBtn();break;case"quickAccessToolbar":this.updateQuickAccessToolbar(o);break;case"destroyQuickAccessToolbar":this.destroyQuickAccessToolbar();break;case"closeContextualToolbar":this.updateContextualToolbar(e,!1),"main-toolbar"!==this.currentToolbar&&(this.updateMainToolbar(e,!0),this.queryToAddRemoveClass(e,this.CHECKBTN,"e-hidden",!1),this.queryToAddRemoveClass(e,this.CLOSEBTN,"e-hidden",!1)),this.currentToolbar="main-toolbar"}var i=window.sfBlazor.getCompInstance(this.toolbarId);if(i&&i.refreshOverflow(),sf.base.Browser.isDevice){var a=window.sfBlazor.getCompInstance(this.bottomToolbarId);a&&a.refreshOverflow()}},t.prototype.queryToAddRemoveClass=function(e,t,o,i){var a=e.querySelector(t);a&&(i?a.classList.remove(o):a.classList.add(o))},t.prototype.updateMainToolbar=function(e,t){var o=this,i=[".e-ie-toolbar-crop-btn",".e-ie-toolbar-main-annotation",".e-ie-toolbar-finetune-btn",".e-ie-toolbar-filter-btn"];sf.base.Browser.isDevice&&i.push(".e-ie-toolbar-upload"),i.forEach((function(i){o.queryToAddRemoveClass(e,i,"e-hidden",t)})),e.querySelectorAll(".e-ie-toolbar-custom").forEach((function(e){e.classList.toggle("e-hidden",!t)}))},t.prototype.updateCropToolbar=function(e,t){var o=this;[".e-ie-toolbar-crop",".e-ie-toolbar-crop-separator",".e-ie-toolbar-rotateleft-btn",".e-ie-toolbar-rotateright-btn",".e-ie-toolbar-horizontalflip-btn",".e-ie-toolbar-verticalflip-btn"].forEach((function(i){o.queryToAddRemoveClass(e,i,"e-hidden",t)}))},t.prototype.updateRightToolbar=function(e,t){var o=this;[".e-ie-toolbar-reset-btn",".e-ie-toolbar-save-btn"].forEach((function(i){o.queryToAddRemoveClass(e,i,"e-hidden",t)}))},t.prototype.updateRectangleToolbar=function(e,t){var o=this;[this.ANNOTATEBTN,this.SHAPEFILLCLR,this.SHAPECLR,".e-ie-toolbar-e-shape-size",this.MAINSEP,this.MCLONEBTN,this.MDELBTN].forEach((function(i){o.queryToAddRemoveClass(e,i,"e-hidden",t)})),[this.MCLONEBTN,this.MDELBTN].forEach((function(i){o.queryToAddRemoveClass(e,i,"e-overlay",!t)}))},t.prototype.updatePenToolbar=function(e,t){var o=this;[this.ANNOTATEBTN,this.PENCLR,".e-ie-toolbar-e-pen-size",this.MAINSEP,this.MDELBTN,this.CHECKBTN,this.CLOSEBTN].forEach((function(i){o.queryToAddRemoveClass(e,i,"e-hidden",t)})),[this.MDELBTN].forEach((function(i){o.queryToAddRemoveClass(e,i,"e-overlay",!t)}))},t.prototype.updateLineToolbar=function(e,t,o){var i=this;[this.ANNOTATEBTN,this.LINECLR,".e-ie-toolbar-e-line-size",this.MAINSEP,this.MCLONEBTN,this.MDELBTN].forEach((function(o){i.queryToAddRemoveClass(e,o,"e-hidden",t)})),[this.MCLONEBTN,this.MDELBTN].forEach((function(a){var r="pathQuickAccessToolbar"===o;i.queryToAddRemoveClass(e,a,"e-overlay",t&&r)}))},t.prototype.updateArrowToolbar=function(e,t){var o=this;[this.ANNOTATEBTN,".e-ie-toolbar-e-arrow-start",".e-ie-toolbar-e-arrow-end",this.MAINSEP,this.MCLONEBTN,this.MDELBTN].forEach((function(i){o.queryToAddRemoveClass(e,i,"e-hidden",t)})),[this.MCLONEBTN,this.MDELBTN].forEach((function(t){o.queryToAddRemoveClass(e,t,"e-overlay",!1)}))},t.prototype.updateTextToolbar=function(e,t){var o=this;[this.ANNOTATEBTN,this.FONTFAM,this.BOLDBTN,this.ITALICBTN,this.FONTCLR,this.FONTSIZE,this.MAINSEP,this.MCLONEBTN,this.MDELBTN,this.MEDITBTN].forEach((function(i){o.queryToAddRemoveClass(e,i,"e-hidden",t)}))},t.prototype.updateColorToolbar=function(e,t,o){if(t){[this.FONTCLR+this.DDBPREVIEW,this.SHAPECLR+this.DDBPREVIEW,this.LINECLR+this.DDBPREVIEW].forEach((function(o){var i=e.querySelector(o);i&&(i.style.background=t.strokeColor)})),(c=e.querySelector(this.SHAPEFILLCLR+this.DDBPREVIEW))&&(""===t.fillColor?c.classList.add("e-nocolor-item"):c.style.background=t.fillColor);var i=e.querySelector(this.PENCLR+this.DDBPREVIEW);i&&(i.style.background=t.strokeColor);var a=void 0,r=void 0;if("arrow"===o)a=this.activeObj.start?this.pascalToSplitWords(this.activeObj.start):void 0,r=this.activeObj.end?this.pascalToSplitWords(this.activeObj.end):void 0;else if("text"===o){var n=this.element.querySelector(this.FONTFAM),s=this.element.querySelector(this.FONTSIZE);if(n&&(a=this.activeObj.textSettings.fontFamily),s)for(var l=0;l<this.fontSizeColl.length;l++)if(parseInt(this.fontSizeColl[l].text,10)>=Math.round(this.activeObj.textSettings.fontSize)){r=(l+1).toString();break}var p=this.element.querySelector(this.BOLDBTN+" .e-btn"),h=this.element.querySelector(this.ITALICBTN+" .e-btn");p&&(this.activeObj.textSettings.bold?p.classList.add("e-selected-btn"):p.classList.remove("e-selected-btn")),h&&(this.activeObj.textSettings.italic?h.classList.add("e-selected-btn"):h.classList.remove("e-selected-btn"))}this.dotNetRef.invokeMethodAsync("UpdateColorValue",t.strokeColor,t.fillColor,this.getStrokeWidth(t.strokeWidth,o),o,a,r)}else{var c;[this.FONTCLR+this.DDBPREVIEW,this.SHAPECLR+this.DDBPREVIEW,this.LINECLR+this.DDBPREVIEW,this.PENCLR+this.DDBPREVIEW].forEach((function(t){var o=e.querySelector(t);o&&(o.style.background="#fff")})),(c=e.querySelector(this.SHAPEFILLCLR+this.DDBPREVIEW))&&c.classList.add("e-nocolor-item")}},t.prototype.updateContextualToolbar=function(e,t){var o=this;if(t&&e.querySelector(this.CTWRAPPER)){this.updateMainToolbar(e,!1),this.queryToAddRemoveClass(e,this.CHECKBTN,"e-hidden",!0),this.queryToAddRemoveClass(e,this.CLOSEBTN,"e-hidden",!0),this.queryToAddRemoveClass(e,this.CTWRAPPER,"e-hidden",!0),this.queryToAddRemoveClass(e,this.CTTOOLBAR,"e-hidden",!1),this.queryToAddRemoveClass(e,".e-ie-contextual-slider","e-hidden",!0),this.queryToAddRemoveClass(e,".e-ie-toolbar-brightness-btn","e-hidden",!0);var i=e.querySelector(".e-ie-toolbar-brightness-btn");i&&i.children.length>0&&i.children[0].classList.add("e-selected-btn");[".e-ie-toolbar-contrast-btn",".e-ie-toolbar-hue-btn",".e-ie-toolbar-saturation-btn",".e-ie-toolbar-grain-btn",".e-ie-toolbar-opacity-btn",".e-ie-toolbar-blur-btn"].forEach((function(t){o.queryToAddRemoveClass(e,t,"e-hidden",!0)}));var a=e.querySelector("#"+e.id+"_toolbarArea"),r=e.querySelector("#"+e.id+"_contextualToolbarArea");if(r.style.left=a.offsetLeft+"px",sf.base.Browser.isDevice){var n=r.offsetHeight,s=e.querySelector("#"+e.id+"_canvasWrapper").offsetHeight;r.style.top=this.toolbarHeight+s-n+"px"}else r.style.top=this.toolbarHeight+"px";var l=window.sfBlazor.getCompInstance(this.toolbarId);if(l&&l.refreshOverflow(),sf.base.Browser.isDevice){var p=window.sfBlazor.getCompInstance(this.bottomToolbarId);p&&p.refreshOverflow()}this.currentToolbar="contextual-toolbar"}else{[this.CHECKBTN,this.CLOSEBTN,this.CTWRAPPER,this.CTTOOLBAR,".e-ie-contextual-slider",".e-ie-toolbar-brightness-btn",".e-ie-toolbar-contrast-btn",".e-ie-toolbar-hue-btn",".e-ie-toolbar-saturation-btn",".e-ie-toolbar-grain-btn",".e-ie-toolbar-opacity-btn",".e-ie-toolbar-blur-btn"].forEach((function(t){o.queryToAddRemoveClass(e,t,"e-hidden",!1)}))}},t.prototype.updateFilterCanvas=function(e,t){var o=this.element.querySelector("#"+e),i=o.getContext("2d");this.notify("filter",{prop:"updateAdj",value:{type:t,value:null,isPreview:!0,ctx:i}}),i.drawImage(this.inMemoryCanvas,0,0,300,150),"default"===t&&o.parentElement.parentElement.classList.add("e-selected")},t.prototype.updateFilterToolBar=function(){sf.popups.showSpinner(this.element),this.queryToAddRemoveClass(this.element,this.CTWRAPPER,"e-hidden",!0),this.queryToAddRemoveClass(this.element,this.CTTOOLBAR,"e-hidden",!0),sf.base.Browser.isDevice||(this.queryToAddRemoveClass(this.element,this.CLOSEBTN,"e-hidden",!0),this.queryToAddRemoveClass(this.element,this.CHECKBTN,"e-hidden",!0)),this.setTempFilterProperties();var e=this.getCurrentCanvasData(),t=this.element.querySelector(this.CTWRAPPER+" .e-toolbar-item.e-selected");t&&t.classList.remove("e-selected"),this.inMemoryCanvas.width=e.width,this.inMemoryCanvas.height=e.height,this.inMemoryCanvas.getContext("2d").putImageData(e,0,0),this.updateFilterCanvas("e-ie-toolbar-default","default"),this.updateFilterCanvas("e-ie-toolbar-chrome","chrome"),this.updateFilterCanvas("e-ie-toolbar-cold","cold"),this.updateFilterCanvas("e-ie-toolbar-warm","warm"),this.updateFilterCanvas("e-ie-toolbar-grayscale","grayscale"),this.updateFilterCanvas("e-ie-toolbar-sepia","sepia"),this.updateFilterCanvas("e-ie-toolbar-invert","invert"),this.initialAdjustmentValue=this.lowerCanvas.getContext("2d").filter;var o=this.element.querySelector("#"+this.element.id+"_toolbarArea"),i=this.element.querySelector("#"+this.element.id+"_contextualToolbarArea");if(i.style.left=o.offsetLeft+"px",sf.base.Browser.isDevice){var a=i.offsetHeight,r=this.element.querySelector("#"+this.element.id+"_canvasWrapper").offsetHeight;i.style.top=this.toolbarHeight+r-a+"px";var n=window.sfBlazor.getCompInstance(this.canvasToolbarId);n&&n.refreshOverflow()}else i.style.top=this.toolbarHeight+"px";this.currentToolbar="contextual-toolbar",sf.popups.hideSpinner(this.element);var s=window.sfBlazor.getCompInstance(this.toolbarId);s&&s.refreshOverflow()},t.prototype.updateQuickAccessToolbar=function(e){var t=this,o=[];switch(e){case"pen":this.queryToAddRemoveClass(this.element,this.MDELBTN,"e-overlay",!0),o.push("Delete");break;case"shape":case"ellipse":case"rectangle":case"arrow":case"line":case"path":this.queryToAddRemoveClass(this.element,this.MCLONEBTN,"e-overlay",!0),this.queryToAddRemoveClass(this.element,this.MDELBTN,"e-overlay",!0),o.push("Clone","Delete");break;case"text":o.push("Clone","Delete","EditText")}var i={cancel:!1,shape:e,toolbarItems:o};"pen"===e&&(i.shape="freehanddraw"),this.events&&this.events.quickAccessToolbarOpening.hasDelegate?this.dotNetRef.invokeMethodAsync("QuickAccessToolbarEventAsync",i).then((function(o){o.cancel||t.renderQuickAccessToolbar(o.toolbarItems,e)})):this.renderQuickAccessToolbar(o,e)},t.prototype.renderQuickAccessToolbar=function(e,t){if(this.activeObj&&this.showQuickAccessToolbar){var o=document.getElementById(this.element.id+"_quickAccessToolbarArea");document.getElementById(this.element.id+"_quickAccessToolbarArea")&&(document.getElementById(this.element.id+"_quickAccessToolbarArea").style.display="block");var i=e.length;if(sf.base.isNullOrUndefined(this.quickAccessToolbarTemplate)){for(var a=0;a<i;a++)switch(e[a]){case"Clone":this.queryToAddRemoveClass(this.element,this.CLONEBTN,"e-hidden",!0);break;case"Delete":this.queryToAddRemoveClass(this.element,this.DELBTN,"e-hidden",!0);break;case"EditText":this.queryToAddRemoveClass(this.element,this.EDITBTN,"e-hidden",!0)}var r=this.element.querySelector(this.CLONEBTN),n=this.element.querySelector(this.DELBTN),s=this.element.querySelector(this.EDITBTN);switch(t){case"shape":case"ellipse":case"rectangle":case"arrow":case"line":case"path":n&&s&&(n.style.marginRight=window.getComputedStyle(s).marginRight);break;case"pen":r&&n&&s&&(n.style.marginLeft=window.getComputedStyle(r).marginLeft,n.style.marginRight=window.getComputedStyle(s).marginRight)}}if("pen"!==t){o.style.width="auto",this.activeObj.activePoint.width=Math.abs(this.activeObj.activePoint.width),this.activeObj.activePoint.height=Math.abs(this.activeObj.activePoint.height);var l=this.activeObj.activePoint.startX<this.activeObj.activePoint.endX?this.activeObj.activePoint.startX:this.activeObj.activePoint.endX,p=this.activeObj.activePoint.startY<this.activeObj.activePoint.endY?this.activeObj.activePoint.startY:this.activeObj.activePoint.endY,h=this.activeObj.activePoint.width;if(0!==this.activeObj.rotatedAngle&&"arrow"!==this.activeObj.shape){var c={activePoint:null};this.notify("shape",{prop:"getSquarePointForRotatedShape",onPropertyChange:!1,value:{obj:this.activeObj,object:c}}),l=(b=c.activePoint).startX,p=b.startY,h=b.width}else if("path"===this.activeObj.shape){var d=this.getSquarePointForPath(this.activeObj);l=d.startX,p=d.startY,h=d.width}o.style.left=l+h/2-25*i+"px",p-60<this.img.destTop?o.style.top=this.img.destTop+this.toolbarHeight+"px":o.style.top=p-60+this.toolbarHeight+"px"}else if("pen"===t){var v={activePoint:null},u={freehandSelectedIndex:null};this.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:u}}),this.notify("freehand-draw",{prop:"getSqPtFD",value:{idx:u.freehandSelectedIndex,obj:v}});var b=v.activePoint;o.style.width="auto",o.style.left=b.startX+b.width/2-27*i+"px",b.startY-60<this.img.destTop?o.style.top=this.img.destTop+this.toolbarHeight+"px":o.style.top=b.startY-60+this.toolbarHeight+"px"}this.quickAccessToolbar="quick-access-toolbar"}},t.prototype.destroyQuickAccessToolbar=function(){document.getElementById(this.element.id+"_quickAccessToolbarArea")&&(document.getElementById(this.element.id+"_quickAccessToolbarArea").style.display="none");var e=this.element.querySelector(this.DELBTN);e&&(e.style.marginLeft="0px",e.style.marginRight="0px"),this.queryToAddRemoveClass(this.element,this.CLONEBTN,"e-hidden",!1),this.queryToAddRemoveClass(this.element,this.DELBTN,"e-hidden",!1),this.queryToAddRemoveClass(this.element,this.EDITBTN,"e-hidden",!1),this.quickAccessToolbar=""},t.prototype.getStrokeWidth=function(e,t){var o,i;if("pen"===t){var a={freehandSelectedIndex:null};this.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:a}}),i=!sf.base.isNullOrUndefined(a.freehandSelectedIndex)&&a.freehandSelectedIndex>-1?parseInt(this.pointColl[a.freehandSelectedIndex].strokeWidth,10):2}else i=parseInt(e,10)/2;switch(i){case 1:o="X-Small";break;case 2:o="Small";break;case 3:o="Medium";break;case 4:o="Large";break;case 5:o="X-Large"}return o},t.prototype.enableDisableToolbarBtn=function(){var e={appliedUndoRedoColl:[]};this.notify("undo-redo",{prop:"getAppliedUndoRedoColl",value:{obj:e}});var t={undoRedoStep:null};if(this.notify("undo-redo",{prop:"getUndoRedoStep",value:{obj:t}}),this.element.querySelector(".e-ie-toolbar-undo")){var o=this.element.querySelector("#undo");o&&(0===t.undoRedoStep?o.classList.add("e-overlay"):(o.classList.remove("e-disabled"),o.classList.remove("e-overlay")));var i=this.element.querySelector("#redo");i&&(t.undoRedoStep===e.appliedUndoRedoColl.length?i.classList.add("e-overlay"):(0===t.undoRedoStep&&e.appliedUndoRedoColl.length>0||t.undoRedoStep>0)&&i.classList.remove("e-overlay"))}var a=this.element.querySelector("#zoomin");a&&(this.zoomSettings.zoomFactor>=this.zoomSettings.maxZoomFactor?a.classList.add("e-overlay"):a.classList.remove("e-overlay"));var r=this.element.querySelector("#zoomout");r&&(this.zoomSettings.zoomFactor<=this.zoomSettings.minZoomFactor?r.classList.add("e-overlay"):r.classList.remove("e-overlay"))},t.prototype.createToolbar=function(){var e=this.element.querySelector(".e-ie-toolbar-upload-div");if(e){var t=e.getElementsByTagName("input")[0],o=e.getElementsByTagName("button")[0];o.className="e-tbar-btn e-tbtn-txt e-btn top-icon",o.innerHTML="",o.appendChild(this.createElement("span",{className:"e-btn-icon e-icons e-upload-icon e-icon-left"})),t.onchange=this.fileSelect.bind(this,t)}this.element.querySelector(".e-ie-toolbar-zoom-in")&&this.wireZoomBtnEvents()},t.prototype.fileSelect=function(e,t){this.notify("draw",{prop:"fileSelect",value:{inputElement:e,args:t}})},t}(T);return{initialize:function(e,t,o,i,a){new L(e,t,o,i,a);var r=window.sfBlazor.getCompInstance(e);return r.imageEditorBase.isDevice=/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini|mobile/i.test(navigator.userAgent),r.imageEditorBase.initializeImageEditor(t,a),o.theme||(r.imageEditorBase.theme="Tailwind"),r.imageEditorBase.isDevice},flip:function(e,t){window.sfBlazor.getCompInstance(e).imageEditorBase.flip(t)},rotate:function(e,t){window.sfBlazor.getCompInstance(e).imageEditorBase.rotate(t)},zoom:function(e,t){window.sfBlazor.getCompInstance(e).imageEditorBase.zoom(t)},reset:function(e){window.sfBlazor.getCompInstance(e).imageEditorBase.reset()},undo:function(e){window.sfBlazor.getCompInstance(e).imageEditorBase.undo()},redo:function(e){window.sfBlazor.getCompInstance(e).imageEditorBase.redo()},onPropertyChanged:function(e,t,o){var i=window.sfBlazor.getCompInstance(e);switch(t){case"cssClass":i.imageEditorBase.cssClass&&sf.base.removeClass([i.imageEditorBase.element],i.imageEditorBase.cssClass.replace(/\s+/g," ").trim().split(" ")),o&&sf.base.addClass([i.imageEditorBase.element],o.replace(/\s+/g," ").trim().split(" "));break;case"disabled":o?(i.imageEditorBase.element.classList.add("e-disabled"),i.imageEditorBase.unwireEvent()):(i.imageEditorBase.element.classList.remove("e-disabled"),i.imageEditorBase.wireEvent());break;case"height":i.imageEditorBase.element.style.height=o;break;case"width":i.imageEditorBase.element.style.width=o;break;case"theme":o&&(i.imageEditorBase.theme&&""!==i.imageEditorBase.theme?i.imageEditorBase.theme=i.imageEditorBase.toPascalCase(o):i.imageEditorBase.theme="Bootstrap5",i.imageEditorBase.upperContext.strokeStyle=i.imageEditorBase.themeColl[i.imageEditorBase.theme].primaryColor,i.imageEditorBase.upperContext.fillStyle=i.imageEditorBase.themeColl[i.imageEditorBase.theme].secondaryColor);break;case"allowUndoRedo":i.imageEditorBase.allowUndoRedo=o;break;case"showQuickAccessToolbar":i.imageEditorBase.showQuickAccessToolbar=o;break;case"isReadOnly":i.imageEditorBase.isReadOnly=o}},destroy:function(e){window.sfBlazor.getCompInstance(e).imageEditorBase.destroy()},toolbarCreated:function(e){var t=window.sfBlazor.getCompInstance(e);t.element.querySelector(".e-ie-toolbar-upload-btn").remove(),t.element.querySelector(".e-ie-toolbar-upload-div").classList.remove("e-hide"),t.imageEditorBase.createToolbar(),t.imageEditorBase.updateColorToolbar(t.element);for(var o=0;o<Object.keys(window.sfBlazor.instances).length;o++)if(Object.keys(window.sfBlazor.instances)[o].includes("sfToolbar")){var i=Object.keys(window.sfBlazor.instances)[o],a=window.sfBlazor.getCompInstance(i);if(a.element.attributes.dataId&&a.element.attributes.dataId.value===e+"_main-toolbar"){t.imageEditorBase.toolbarId=i;break}}},bottomToolbarCreated:function(e){for(var t=window.sfBlazor.getCompInstance(e),o=0;o<Object.keys(window.sfBlazor.instances).length;o++)if(Object.keys(window.sfBlazor.instances)[o].includes("sfToolbar")){var i=Object.keys(window.sfBlazor.instances)[o],a=window.sfBlazor.getCompInstance(i);if(a.element.attributes.dataId&&a.element.attributes.dataId.value===e+"_bottom-toolbar"){t.imageEditorBase.bottomToolbarId=i;break}}},canvasToolbarCreated:function(e){for(var t=window.sfBlazor.getCompInstance(e),o=0;o<Object.keys(window.sfBlazor.instances).length;o++)if(Object.keys(window.sfBlazor.instances)[o].includes("sfToolbar")){var i=Object.keys(window.sfBlazor.instances)[o],a=window.sfBlazor.getCompInstance(i);if(a.element.attributes.dataId&&a.element.attributes.dataId.value===e+"_canvas-toolbar"){t.imageEditorBase.canvasToolbarId=i;break}}},toolbarClicked:function(e,t){var o,i,a,r,n=window.sfBlazor.getCompInstance(e);switch(t){case"reset":n.imageEditorBase.reset(),n.imageEditorBase.updateColorToolbar(n.element),n.imageEditorBase.updateToolbar(n.element,"imageLoaded"),n.imageEditorBase.zoomBtnHold=null,i=n.imageEditorBase.element.querySelector(n.imageEditorBase.BOLDBTN+" .e-btn"),a=n.imageEditorBase.element.querySelector(n.imageEditorBase.ITALICBTN+" .e-btn"),i.classList.contains("e-selected-btn")&&i.classList.remove("e-selected-btn"),a.classList.contains("e-selected-btn")&&a.classList.remove("e-selected-btn");break;case"undo":n.imageEditorBase.notify("undo-redo",{prop:"call-undo"});break;case"redo":n.imageEditorBase.notify("undo-redo",{prop:"call-redo"});break;case"annotation":"contextual-toolbar"===n.imageEditorBase.currentToolbar&&(n.imageEditorBase.updateContextualToolbar(n.imageEditorBase.element,!1),n.imageEditorBase.currentToolbar="main-toolbar");break;case"crop":n.imageEditorBase.updateToolbar(n.element,"cropToolbar"),n.imageEditorBase.updateCropTransformItems(),n.imageEditorBase.select("Custom");break;case"rotateleft":case"rotateright":case"horizontalflip":case"verticalflip":n.imageEditorBase.isCropToolbar=!0,n.imageEditorBase.transformSelect(t),n.imageEditorBase.isCropToolbar=!1,n.imageEditorBase.notify("transform",{prop:"disableZoomOutBtn",value:{isZoomOut:!0}});break;case"ok":n.imageEditorBase.okBtn(),n.imageEditorBase.updateToolbar(n.element,"imageLoaded");break;case"cancel":n.imageEditorBase.notify("draw",{prop:"performCancel",onPropertyChange:!1,value:{isContextualToolbar:!n.element.querySelector(n.imageEditorBase.CTWRAPPER).classList.contains("e-hidden")}});break;case"finetune":n.imageEditorBase.currObjType.isFiltered&&n.imageEditorBase.okBtn(),n.imageEditorBase.currObjType.isFiltered=!0,n.imageEditorBase.setTempFilterProperties(),n.imageEditorBase.updateContextualToolbar(n.element,!0);break;case"filter":n.imageEditorBase.updateFilterToolBar();break;case"save":n.imageEditorBase.okBtn(),n.imageEditorBase.updateToolbar(n.element,"imageLoaded");break;case"bold":n.imageEditorBase.notify("selection",{prop:"setInitialTextEdit",value:{bool:!1}}),r=(o=n.imageEditorBase.activeObj.textSettings).bold?o.italic?"italic":"default":o.italic?"bolditalic":"bold",n.imageEditorBase.notify("shape",{prop:"applyFontStyle",onPropertyChange:!1,value:{item:r}}),(i=n.imageEditorBase.element.querySelector(n.imageEditorBase.BOLDBTN+" .e-btn")).classList.contains("e-selected-btn")?i.classList.remove("e-selected-btn"):i.classList.add("e-selected-btn");break;case"italic":n.imageEditorBase.notify("selection",{prop:"setInitialTextEdit",value:{bool:!1}}),r=(o=n.imageEditorBase.activeObj.textSettings).bold&&o.italic?"bold":o.bold&&!o.italic?"bolditalic":!o.bold&&o.italic?"default":"italic",n.imageEditorBase.notify("shape",{prop:"applyFontStyle",onPropertyChange:!1,value:{item:r}}),(a=n.imageEditorBase.element.querySelector(n.imageEditorBase.ITALICBTN+" .e-btn")).classList.contains("e-selected-btn")?a.classList.remove("e-selected-btn"):a.classList.add("e-selected-btn")}if("finetune"!==t&&"filter"!==t&&"crop"!==t){var s=n.imageEditorBase.element.querySelector(".e-ie-toolbar-brightness-btn .e-btn");s.classList.contains("e-selected-btn")&&s.classList.remove("e-selected-btn"),n.imageEditorBase.enableDisableToolbarBtn()}},contextualToolbarClicked:function(e,t){var o=window.sfBlazor.getCompInstance(e),i=o.element.querySelector(o.imageEditorBase.CTWRAPPER+" .e-toolbar-item.e-selected");i&&i.classList.remove("e-selected"),o.element.querySelector("#"+t).classList.add("e-selected"),o.imageEditorBase.currObjType.isFiltered=!0;var a={filter:o.imageEditorBase.toPascalCase(t),cancel:!1};if(o.imageEditorBase.events&&!0===o.imageEditorBase.events.imageFiltering.hasDelegate)o.dotNetRef.invokeMethodAsync("OnImageFilterEventAsync",a).then((function(e){e.cancel||(o.imageEditorBase.notify("filter",{prop:"applyImageFilter",value:{option:t.toLowerCase()}}),o.imageEditorBase.currentFilter=t,o.imageEditorBase.enableDisableToolbarBtn())}));else{if(a.cancel)return;o.imageEditorBase.notify("filter",{prop:"applyImageFilter",value:{option:t.toLowerCase()}}),o.imageEditorBase.currentFilter=t,o.imageEditorBase.enableDisableToolbarBtn()}},quickAccessToolbarClicked:function(e,t){var o=window.sfBlazor.getCompInstance(e);if(!sf.base.isNullOrUndefined(t)){var i=void 0,a=void 0,r=null,n={prevActObj:null},s={tempObj:null},l=void 0,p=void 0,h=void 0,c=void 0,d=void 0;switch(o.imageEditorBase.notify("draw",{prop:"getPrevActObj",onPropertyChange:!1,value:{obj:n}}),o.imageEditorBase.notify("selection",{prop:"getTempActObj",onPropertyChange:!1,value:{obj:s}}),s.tempObj.activePoint.height=Math.abs(s.tempObj.activePoint.height),t){case"clone":if(JSON.stringify(s.tempObj)===JSON.stringify(o.imageEditorBase.activeObj)&&(r=!0),i=sf.base.extend({},o.imageEditorBase.activeObj,{},!0),sf.base.isNullOrUndefined(o.imageEditorBase.activeObj.currIndex)?o.imageEditorBase.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:r}}):n.prevActObj?(o.imageEditorBase.activeObj.currIndex=null,i.currIndex=null,o.imageEditorBase.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:r}})):o.imageEditorBase.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:!0}}),a=sf.base.extend([],o.imageEditorBase.objColl,[],!0),i.activePoint.startX+=10,i.activePoint.startY-=10,i.activePoint.endX+=10,i.activePoint.endY-=10,"path"===i.shape)for(var v=0;v<i.pointColl.length;v++)i.pointColl[v].x+=10,i.pointColl[v].y-=10;o.imageEditorBase.activeObj=i,"line"!==o.imageEditorBase.activeObj.shape&&"arrow"!==o.imageEditorBase.activeObj.shape||o.imageEditorBase.notify("shape",{prop:"setPointCollForLineArrow",onPropertyChange:!1,value:{obj:o.imageEditorBase.activeObj}}),o.imageEditorBase.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:o.imageEditorBase.activeObj}}),o.imageEditorBase.notify("undo-redo",{prop:"updateUrObj",onPropertyChange:!1,value:{objColl:a}}),o.imageEditorBase.updateToolbar(o.imageEditorBase.element,"quickAccessToolbar",o.imageEditorBase.activeObj.shape);break;case"delete":o.imageEditorBase.notify("selection",{prop:"deleteItem",onPropertyChange:!1}),o.imageEditorBase.updateToolbar(o.element,"imageLoaded");break;case"editText":o.imageEditorBase.upperContext.clearRect(0,0,o.imageEditorBase.upperCanvas.width,o.imageEditorBase.upperCanvas.height),o.imageEditorBase.notify("selection",{prop:"setTempActObj",onPropertyChange:!1,value:{obj:sf.base.extend({},o.imageEditorBase.activeObj,{},!0)}}),o.imageEditorBase.notify("selection",{prop:"setInitialTextEdit",onPropertyChange:!1,value:{bool:!0}}),o.imageEditorBase.notify("draw",{prop:"setPrevActObj",onPropertyChange:!1,value:{prevActObj:sf.base.extend({},o.imageEditorBase.activeObj,{},!0)}}),l={x:o.imageEditorBase.activeObj.activePoint.startX,y:o.imageEditorBase.activeObj.activePoint.startY},0!==o.imageEditorBase.activeObj.rotatedAngle&&(l.x=o.imageEditorBase.activeObj.horTopLinePointColl[0].x,l.y=o.imageEditorBase.activeObj.horTopLinePointColl[0].y),o.imageEditorBase.notify("shape",{prop:"renderTextArea",onPropertyChange:!1,value:{x:l.x,y:l.y,actObj:o.imageEditorBase.activeObj}}),(sf.base.isNullOrUndefined(o.imageEditorBase.activeObj.currIndex)||n.prevActObj)&&o.imageEditorBase.notify("draw",{prop:"setShapeTextInsert",onPropertyChange:!1,value:{bool:!0}}),(p=document.getElementById(o.imageEditorBase.element.id+"_quickAccessToolbarArea"))&&(p.style.display="none"),(h=o.imageEditorBase.element.querySelector(o.imageEditorBase.MCLONEBTN))&&h.classList.add("e-overlay"),(c=o.imageEditorBase.element.querySelector(o.imageEditorBase.MDELBTN))&&c.classList.add("e-overlay"),(d=o.imageEditorBase.element.querySelector(o.imageEditorBase.MEDITBTN))&&d.classList.add("e-overlay")}}},updateDialog:function(e,t){window.sfBlazor.getCompInstance(e).imageEditorBase.notify("draw",{prop:t,onPropertyChange:!1})},updateSliderValue:function(e,t,o){var i=window.sfBlazor.getCompInstance(e);i.imageEditorBase.setCurrAdjustmentValue(t.toLowerCase(),o),i.imageEditorBase.enableDisableToolbarBtn()},getSliderValue:function(e,t){return window.sfBlazor.getCompInstance(e).imageEditorBase.getCurrAdjustmentValue(t)},select:function(e,t,o,i,a,r,n){var s=window.sfBlazor.getCompInstance(e);s.imageEditorBase.select(t,i,a,r,n),o&&s.imageEditorBase.updateToolbar(s.element,"cropToolbar")},clearSelection:function(e){window.sfBlazor.getCompInstance(e).imageEditorBase.clearSelection()},crop:function(e){window.sfBlazor.getCompInstance(e).imageEditorBase.crop()},open:function(e,t){window.sfBlazor.getCompInstance(e).imageEditorBase.open(t)},save:function(e,t,o){t=t||"Png",o=o||"",window.sfBlazor.getCompInstance(e).imageEditorBase.export(t,o)},finetuneImage:function(e,t,o){var i=window.sfBlazor.getCompInstance(e);switch(t.toLowerCase()){case"brightness":i.imageEditorBase.setBrightness(o);break;case"contrast":i.imageEditorBase.setContrast(o);break;case"hue":i.imageEditorBase.setHue(o);break;case"saturation":i.imageEditorBase.setSaturation(o);break;case"opacity":i.imageEditorBase.setOpacity(o);break;case"blur":i.imageEditorBase.setBlur(o);break;case"exposure":i.imageEditorBase.setExposure(o)}},applyImageFilter:function(e,t){window.sfBlazor.getCompInstance(e).imageEditorBase.applyImageFilter(t)},drawEllipse:function(e,t,o,i,a,r,n,s){window.sfBlazor.getCompInstance(e).imageEditorBase.drawEllipse(t,o,i,a,r,n,s)},drawLine:function(e,t,o,i,a,r,n){window.sfBlazor.getCompInstance(e).imageEditorBase.drawLine(t,o,i,a,r,n)},drawArrow:function(e,t,o,i,a,r,n,s,l){window.sfBlazor.getCompInstance(e).imageEditorBase.drawArrow(t,o,i,a,r,n,s,l)},drawPath:function(e,t,o,i){window.sfBlazor.getCompInstance(e).imageEditorBase.drawPath(t,o,i)},drawRectangle:function(e,t,o,i,a,r,n,s){window.sfBlazor.getCompInstance(e).imageEditorBase.drawRectangle(t,o,i,a,r,n,s)},drawText:function(e,t,o,i,a,r,n){window.sfBlazor.getCompInstance(e).imageEditorBase.drawText(t,o,i,a,r,n)},getImageDimension:function(e){return window.sfBlazor.getCompInstance(e).imageEditorBase.getImageDimension()},getImageData:function(e){return window.sfBlazor.getCompInstance(e).imageEditorBase.getImageData()},selectShape:function(e,t){window.sfBlazor.getCompInstance(e).imageEditorBase.selectShape(t)},deleteShape:function(e,t){window.sfBlazor.getCompInstance(e).imageEditorBase.deleteShape(t)},getShapeSettings:function(e,t){return window.sfBlazor.getCompInstance(e).imageEditorBase.getShapeSettings(t)},drawShape:function(e,t){var o=window.sfBlazor.getCompInstance(e);o.imageEditorBase.okBtn();var i,a=!1;void 0!==o.imageEditorBase.activeObj.shape&&(i=o.imageEditorBase.activeObj.shape.split("-")),(void 0===i&&o.imageEditorBase.currObjType.isCustomCrop||void 0!==i&&"crop"===i[0])&&(a=!0),o.imageEditorBase.currObjType.isCustomCrop=!1,(a||o.imageEditorBase.togglePan)&&(o.imageEditorBase.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),o.imageEditorBase.upperContext.clearRect(0,0,o.imageEditorBase.upperCanvas.width,o.imageEditorBase.upperCanvas.height));var r={currentFreehandDrawIndex:null};switch(o.imageEditorBase.notify("freehand-draw",{prop:"getCurrentFreehandDrawIndex",value:{obj:r}}),t){case"text":o.imageEditorBase.notify("shape",{prop:"draw-shape-text"}),o.imageEditorBase.getFontSizes(),o.imageEditorBase.updateToolbar(o.element,t);break;case"pen":o.imageEditorBase.notify("draw",{prop:"setTempFreehandCounter",value:{tempFreehandCounter:o.imageEditorBase.freehandCounter}}),o.imageEditorBase.notify("draw",{prop:"setTempCurrentFreehandDrawIndex",value:{tempCurrentFreehandDrawIndex:r.currentFreehandDrawIndex}}),o.imageEditorBase.freehandDraw(!0);break;default:o.imageEditorBase.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),o.imageEditorBase.currObjType.shape=t,o.imageEditorBase.activeObj.shape=o.imageEditorBase.currObjType.shape.toLowerCase(),o.imageEditorBase.currObjType.isDragging=o.imageEditorBase.currObjType.isCustomCrop=!1,o.imageEditorBase.activeObj.shapeDegree=o.imageEditorBase.transform.degree,o.imageEditorBase.activeObj.shapeFlip=o.imageEditorBase.transform.currFlipState,o.imageEditorBase.activeObj.textFlip=o.imageEditorBase.transform.currFlipState,o.imageEditorBase.activeObj.flipObjColl=[],o.imageEditorBase.notify("selection",{prop:"annotate",value:{shape:t}}),o.imageEditorBase.updateToolbar(o.element,t)}},freehandDraw:function(e,t){window.sfBlazor.getCompInstance(e).imageEditorBase.freehandDraw(t)},updateToolbar:function(e,t,o){window.sfBlazor.getCompInstance(e).imageEditorBase.updateToolbar(t,o);for(var i=0;i<Object.keys(window.sfBlazor.instances).length;i++)if(Object.keys(window.sfBlazor.instances)[i].includes("sfToolbar")){var a=Object.keys(window.sfBlazor.instances)[i];window.sfBlazor.getCompInstance(a).refreshOverflow(a)}},updateArrow:function(e,t,o){window.sfBlazor.getCompInstance(e).imageEditorBase.updateArrow(t,o)},updateFillColor:function(e,t,o){var i=window.sfBlazor.getCompInstance(e);if(t.querySelector(".e-fill")){if(""===i.imageEditorBase.activeObj.strokeSettings.fillColor){var a=document.querySelector("#"+i.imageEditorBase.element.id+"_shapeFillColor");a&&a.querySelector(".e-nocolor-item").classList.remove("e-selected"),t.querySelector(i.imageEditorBase.SHAPEFILLCLR+i.imageEditorBase.DDBPREVIEW).classList.remove("e-nocolor-item")}t.querySelector(i.imageEditorBase.SHAPEFILLCLR+i.imageEditorBase.DDBPREVIEW).style.background=o,i.imageEditorBase.updateFillColor(o)}},selFillColor:function(e,t){t.querySelector(".e-nocolor-item").classList.add("e-selected"),t.id=e},updateStrokeColor:function(e,t,o){var i=window.sfBlazor.getCompInstance(e);i.element.querySelector(t)&&(i.imageEditorBase.updateStrokeColor(o),i.imageEditorBase.updateColorToolbar(i.element,i.imageEditorBase.activeObj.strokeSettings))},updateStrokeWidth:function(e,t){window.sfBlazor.getCompInstance(e).imageEditorBase.updateStrokeWidth(t)},updatePenStrokeColor:function(e,t,o){var i=window.sfBlazor.getCompInstance(e);i.element.querySelector(t)&&(i.imageEditorBase.updatePenStrokeColor(o),i.imageEditorBase.updateColorToolbar(i.element,i.imageEditorBase.activeObj.strokeSettings))},updatePenStrokeWidth:function(e,t){window.sfBlazor.getCompInstance(e).imageEditorBase.updatePenStrokeWidth(t)},updateShapeStroke:function(e,t){e.querySelector('[id = "'+t+'"]').classList.add("e-selected-btn")},updateFontColor:function(e,t,o){var i=window.sfBlazor.getCompInstance(e);if(i.element.querySelector(t)){i.imageEditorBase.updateFontColor(o);var a=i.imageEditorBase.activeObj.strokeSettings;"block"===i.imageEditorBase.textArea.style.display&&(a.strokeColor=o),i.imageEditorBase.updateColorToolbar(i.element,a)}},updateFontFamily:function(e,t){window.sfBlazor.getCompInstance(e).imageEditorBase.updateFontFamily(t)},updateFontSize:function(e,t){window.sfBlazor.getCompInstance(e).imageEditorBase.updateFontSize(t)}}}()}}]);(async()=>{await import(`${document.baseURI}_content/Syncfusion.Blazor/scripts/syncfusion-blazor-base.min.js?v=22.1.undefined`).then(()=>{sfBlazor.loadDependencies('sfimageeditor');})})();